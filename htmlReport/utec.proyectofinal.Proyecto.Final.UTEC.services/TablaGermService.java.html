<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TablaGermService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">TablaGermService.java</span></div><h1>TablaGermService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.TablaGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.RepGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TablaGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.RepGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ValoresGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.TablaGermRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PorcentajesRedondeoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TablaGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.RepGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.ValoresGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Instituto;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;

@Service
<span class="fc" id="L29">public class TablaGermService {</span>

    @Autowired
    private TablaGermRepository tablaGermRepository;

    @Autowired
    private RepGermRepository repGermRepository;

    @Autowired
    private ValoresGermRepository valoresGermRepository;

    @Autowired
    private GerminacionRepository germinacionRepository;

    @Autowired
    private AnalisisService analisisService;

    
    public TablaGermDTO crearTablaGerm(Long germinacionId, TablaGermRequestDTO solicitud) {
        try {
<span class="fc" id="L49">            Optional&lt;Germinacion&gt; germinacionOpt = germinacionRepository.findById(germinacionId);</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (germinacionOpt.isEmpty()) {</span>
<span class="fc" id="L51">                throw new RuntimeException(&quot;Germinación no encontrada con ID: &quot; + germinacionId);</span>
            }
            
<span class="fc" id="L54">            Germinacion germinacion = germinacionOpt.get();</span>
            
            
            
<span class="fc" id="L58">            validarDatosTablaGerm(solicitud, germinacion);</span>

            
<span class="fc" id="L61">            List&lt;TablaGerm&gt; tablasExistentes = tablaGermRepository.findByGerminacionId(germinacionId);</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">            if (!tablasExistentes.isEmpty()) {</span>
                
<span class="nc" id="L64">                boolean algunaTablaNoFinalizada = tablasExistentes.stream()</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">                    .anyMatch(tabla -&gt; tabla.getFinalizada() == null || !tabla.getFinalizada());</span>
                
<span class="nc bnc" id="L67" title="All 2 branches missed.">                if (algunaTablaNoFinalizada) {</span>
<span class="nc" id="L68">                    throw new RuntimeException(&quot;No se puede crear una nueva tabla hasta que todas las tablas anteriores estén finalizadas&quot;);</span>
                }
                
            
<span class="nc" id="L72">            } else {</span>
                
<span class="fc" id="L74">                germinacion.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L75">                germinacionRepository.save(germinacion);</span>
            }

<span class="fc" id="L78">            TablaGerm tablaGerm = mapearSolicitudAEntidad(solicitud, germinacion);</span>
            
            
<span class="fc" id="L81">            calcularYActualizarTotales(tablaGerm);</span>
            
<span class="fc" id="L83">            TablaGerm tablaGermGuardada = tablaGermRepository.save(tablaGerm);</span>

            
<span class="fc" id="L86">            crearValoresGermAutomaticos(tablaGermGuardada);</span>

<span class="fc" id="L88">            return mapearEntidadADTO(tablaGermGuardada);</span>
<span class="fc" id="L89">        } catch (Exception e) {</span>
<span class="fc" id="L90">            throw new RuntimeException(&quot;Error al crear tabla de germinación: &quot; + e.getMessage(), e);</span>
        }
    }
    
    
    
    
    private void validarDatosTablaGerm(TablaGermRequestDTO solicitud, Germinacion germinacion) {
        
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        if (solicitud.getFechaFinal() == null) {</span>
<span class="nc" id="L100">            throw new RuntimeException(&quot;La fecha final es obligatoria&quot;);</span>
        }
        
<span class="pc bpc" id="L103" title="2 of 4 branches missed.">        if (solicitud.getTratamiento() == null || solicitud.getTratamiento().trim().isEmpty()) {</span>
<span class="nc" id="L104">            throw new RuntimeException(&quot;El tratamiento es obligatorio&quot;);</span>
        }
        
<span class="pc bpc" id="L107" title="2 of 4 branches missed.">        if (solicitud.getMetodo() == null || solicitud.getMetodo().trim().isEmpty()) {</span>
<span class="nc" id="L108">            throw new RuntimeException(&quot;El método es obligatorio&quot;);</span>
        }
        
<span class="pc bpc" id="L111" title="2 of 4 branches missed.">        if (solicitud.getNumSemillasPRep() == null || solicitud.getNumSemillasPRep() &lt;= 0) {</span>
<span class="nc" id="L112">            throw new RuntimeException(&quot;El número de semillas por repetición es obligatorio y debe ser mayor a 0&quot;);</span>
        }
        
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">        if (solicitud.getTemperatura() == null || solicitud.getTemperatura().trim().isEmpty()) {</span>
<span class="nc" id="L116">            throw new RuntimeException(&quot;La temperatura es obligatoria&quot;);</span>
        }
        
        
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (solicitud.getFechaIngreso() == null) {</span>
<span class="nc" id="L121">            throw new RuntimeException(&quot;La fecha de ingreso es obligatoria&quot;);</span>
        }
        
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        if (solicitud.getFechaGerminacion() == null) {</span>
<span class="nc" id="L125">            throw new RuntimeException(&quot;La fecha de germinación es obligatoria&quot;);</span>
        }
        
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (solicitud.getFechaUltConteo() == null) {</span>
<span class="nc" id="L129">            throw new RuntimeException(&quot;La fecha de último conteo es obligatoria&quot;);</span>
        }
        
        
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (!solicitud.getFechaGerminacion().isAfter(solicitud.getFechaIngreso())) {</span>
<span class="fc" id="L134">            throw new RuntimeException(&quot;La fecha de germinación debe ser posterior a la fecha de ingreso&quot;);</span>
        }
        
        
<span class="fc bfc" id="L138" title="All 2 branches covered.">        int diasPrefrio = (solicitud.getDiasPrefrio() != null) ? solicitud.getDiasPrefrio() : 0;</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (diasPrefrio &gt; 0) {</span>
<span class="fc" id="L140">            long diasEntreFechas = java.time.temporal.ChronoUnit.DAYS.between(</span>
<span class="fc" id="L141">                solicitud.getFechaIngreso(), </span>
<span class="fc" id="L142">                solicitud.getFechaGerminacion()</span>
            );
<span class="fc bfc" id="L144" title="All 2 branches covered.">            if (diasEntreFechas &lt; diasPrefrio) {</span>
<span class="fc" id="L145">                throw new RuntimeException(&quot;Debe haber al menos &quot; + diasPrefrio + </span>
                    &quot; días entre la fecha de ingreso y la fecha de germinación (días de prefrío requeridos). &quot; +
                    &quot;Actualmente hay &quot; + diasEntreFechas + &quot; días.&quot;);
            }
        }
        
        
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (!solicitud.getFechaUltConteo().isAfter(solicitud.getFechaGerminacion())) {</span>
<span class="nc" id="L153">            throw new RuntimeException(&quot;La fecha de último conteo debe ser posterior a la fecha de germinación&quot;);</span>
        }
        
        
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (solicitud.getFechaFinal().isBefore(solicitud.getFechaGerminacion())) {</span>
<span class="fc" id="L158">            throw new RuntimeException(&quot;La fecha final debe ser posterior o igual a la fecha de germinación&quot;);</span>
        }
        
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        if (solicitud.getFechaFinal().isBefore(solicitud.getFechaUltConteo())) {</span>
<span class="nc" id="L162">            throw new RuntimeException(&quot;La fecha final debe ser igual o posterior a la fecha de último conteo&quot;);</span>
        }
        
        
<span class="pc bpc" id="L166" title="2 of 4 branches missed.">        if (solicitud.getNumeroRepeticiones() == null || solicitud.getNumeroRepeticiones() &lt;= 0) {</span>
<span class="nc" id="L167">            throw new RuntimeException(&quot;Debe especificar un número válido de repeticiones (mayor a 0)&quot;);</span>
        }
        
<span class="pc bpc" id="L170" title="1 of 4 branches missed.">        if (solicitud.getNumeroRepeticiones() &lt; 1 || solicitud.getNumeroRepeticiones() &gt; 20) {</span>
<span class="fc" id="L171">            throw new RuntimeException(&quot;El número de repeticiones debe estar entre 1 y 20&quot;);</span>
        }
        
<span class="pc bpc" id="L174" title="2 of 4 branches missed.">        if (solicitud.getNumeroConteos() == null || solicitud.getNumeroConteos() &lt;= 0) {</span>
<span class="nc" id="L175">            throw new RuntimeException(&quot;Debe especificar un número válido de conteos (mayor a 0)&quot;);</span>
        }
        
<span class="pc bpc" id="L178" title="1 of 4 branches missed.">        if (solicitud.getNumeroConteos() &lt; 1 || solicitud.getNumeroConteos() &gt; 15) {</span>
<span class="fc" id="L179">            throw new RuntimeException(&quot;El número de conteos debe estar entre 1 y 15&quot;);</span>
        }
        
        
<span class="pc bpc" id="L183" title="2 of 4 branches missed.">        if (solicitud.getFechaConteos() == null || solicitud.getFechaConteos().isEmpty()) {</span>
<span class="nc" id="L184">            throw new RuntimeException(&quot;Debe especificar al menos una fecha de conteo&quot;);</span>
        }
        
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (solicitud.getFechaConteos().size() != solicitud.getNumeroConteos()) {</span>
<span class="nc" id="L188">            throw new RuntimeException(&quot;El número de fechas de conteos debe coincidir con el número de conteos definido&quot;);</span>
        }
        
        
<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (Boolean.TRUE.equals(solicitud.getTienePrefrio())) {</span>
<span class="pc bpc" id="L193" title="2 of 4 branches missed.">            if (solicitud.getDiasPrefrio() != null &amp;&amp; solicitud.getDiasPrefrio() &gt; 0) {</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">                if (diasPrefrio &lt; 0) {</span>
<span class="nc" id="L195">                    throw new RuntimeException(&quot;Los días de prefrío deben ser mayores o iguales a 0&quot;);</span>
                }
            }
        }
        
        
        
        
<span class="fc bfc" id="L203" title="All 2 branches covered.">        for (int i = 0; i &lt; solicitud.getFechaConteos().size(); i++) {</span>
<span class="fc" id="L204">            java.time.LocalDate fechaConteo = solicitud.getFechaConteos().get(i);</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">            if (fechaConteo == null) {</span>
<span class="nc" id="L206">                throw new RuntimeException(&quot;La fecha de conteo &quot; + (i + 1) + &quot; no puede ser nula&quot;);</span>
            }
            
            
<span class="fc bfc" id="L210" title="All 4 branches covered.">            if (i == 0 &amp;&amp; !fechaConteo.isAfter(solicitud.getFechaGerminacion())) {</span>
<span class="fc" id="L211">                throw new RuntimeException(&quot;El primer conteo debe realizarse después de la fecha de germinación (fecha mínima: &quot; + </span>
<span class="fc" id="L212">                    solicitud.getFechaGerminacion().plusDays(1) + &quot;)&quot;);</span>
            }
            
            
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">            if (fechaConteo.isBefore(solicitud.getFechaGerminacion()) || </span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">                fechaConteo.isAfter(solicitud.getFechaUltConteo())) {</span>
<span class="nc" id="L218">                throw new RuntimeException(&quot;La fecha de conteo &quot; + (i + 1) + </span>
                    &quot; debe estar entre la fecha de germinación y la fecha de último conteo&quot;);
            }
            
            
<span class="fc bfc" id="L223" title="All 4 branches covered.">            if (i &gt; 0 &amp;&amp; fechaConteo.isBefore(solicitud.getFechaConteos().get(i - 1))) {</span>
<span class="fc" id="L224">                throw new RuntimeException(&quot;La fecha de conteo &quot; + (i + 1) + </span>
                    &quot; debe ser igual o posterior a la fecha de conteo &quot; + i);
            }
        }
<span class="fc" id="L228">    }</span>
    
    
    private void validarPorcentajes(PorcentajesRedondeoRequestDTO solicitud) {
        
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeNormalesConRedondeo() != null) {</span>
<span class="fc" id="L234">            validarRangoPorcentaje(&quot;Normales&quot;, solicitud.getPorcentajeNormalesConRedondeo());</span>
        }
        
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeAnormalesConRedondeo() != null) {</span>
<span class="fc" id="L238">            validarRangoPorcentaje(&quot;Anormales&quot;, solicitud.getPorcentajeAnormalesConRedondeo());</span>
        }
        
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeDurasConRedondeo() != null) {</span>
<span class="fc" id="L242">            validarRangoPorcentaje(&quot;Duras&quot;, solicitud.getPorcentajeDurasConRedondeo());</span>
        }
        
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeFrescasConRedondeo() != null) {</span>
<span class="fc" id="L246">            validarRangoPorcentaje(&quot;Frescas&quot;, solicitud.getPorcentajeFrescasConRedondeo());</span>
        }
        
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeMuertasConRedondeo() != null) {</span>
<span class="fc" id="L250">            validarRangoPorcentaje(&quot;Muertas&quot;, solicitud.getPorcentajeMuertasConRedondeo());</span>
        }
        
        
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">        if (solicitud.getPorcentajeNormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">            solicitud.getPorcentajeAnormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">            solicitud.getPorcentajeDurasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">            solicitud.getPorcentajeFrescasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">            solicitud.getPorcentajeMuertasConRedondeo() != null) {</span>
            
<span class="fc" id="L260">            double suma = solicitud.getPorcentajeNormalesConRedondeo().doubleValue() +</span>
<span class="fc" id="L261">                         solicitud.getPorcentajeAnormalesConRedondeo().doubleValue() +</span>
<span class="fc" id="L262">                         solicitud.getPorcentajeDurasConRedondeo().doubleValue() +</span>
<span class="fc" id="L263">                         solicitud.getPorcentajeFrescasConRedondeo().doubleValue() +</span>
<span class="fc" id="L264">                         solicitud.getPorcentajeMuertasConRedondeo().doubleValue();</span>
            
            
<span class="pc bpc" id="L267" title="2 of 4 branches missed.">            if (suma &lt; 99.0 || suma &gt; 101.0) {</span>
<span class="nc" id="L268">                throw new RuntimeException(&quot;La suma de todos los porcentajes debe ser aproximadamente 100% (actual: &quot; + suma + &quot;%)&quot;);</span>
            }
        }
<span class="fc" id="L271">    }</span>
    
    
    private void validarRangoPorcentaje(String tipo, BigDecimal porcentaje) {
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (porcentaje.compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="nc" id="L276">            throw new RuntimeException(&quot;El porcentaje de &quot; + tipo + &quot; no puede ser negativo&quot;);</span>
        }
        
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        if (porcentaje.compareTo(new BigDecimal(&quot;100&quot;)) &gt; 0) {</span>
<span class="nc" id="L280">            throw new RuntimeException(&quot;El porcentaje de &quot; + tipo + &quot; no puede ser mayor a 100%&quot;);</span>
        }
<span class="fc" id="L282">    }</span>

    
    public TablaGermDTO obtenerTablaGermPorId(Long id) {
<span class="fc" id="L286">        Optional&lt;TablaGerm&gt; tablaGerm = tablaGermRepository.findById(id);</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">        if (tablaGerm.isPresent()) {</span>
<span class="fc" id="L288">            return mapearEntidadADTO(tablaGerm.get());</span>
        } else {
<span class="fc" id="L290">            throw new RuntimeException(&quot;Tabla de germinación no encontrada con ID: &quot; + id);</span>
        }
    }

    
    public TablaGermDTO actualizarTablaGerm(Long id, TablaGermRequestDTO solicitud) {
<span class="fc" id="L296">        Optional&lt;TablaGerm&gt; tablaGermExistente = tablaGermRepository.findById(id);</span>
        
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (tablaGermExistente.isPresent()) {</span>
<span class="fc" id="L299">            TablaGerm tablaGerm = tablaGermExistente.get();</span>
            
<span class="fc" id="L301">            System.out.println(&quot; Actualizando tabla ID: &quot; + id);</span>
<span class="fc" id="L302">            System.out.println(&quot;  Fecha último conteo anterior: &quot; + tablaGerm.getFechaUltConteo());</span>
<span class="fc" id="L303">            System.out.println(&quot;  Fecha último conteo nueva: &quot; + solicitud.getFechaUltConteo());</span>
            
            
<span class="fc" id="L306">            boolean debeReiniciarCamposUltimoConteo = false;</span>
<span class="pc bpc" id="L307" title="2 of 4 branches missed.">            if (solicitud.getFechaUltConteo() != null &amp;&amp; tablaGerm.getFechaUltConteo() != null) {</span>
<span class="fc" id="L308">                java.time.LocalDate hoy = java.time.LocalDate.now();</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">                boolean fechaAnteriorEsPresenteOPasada = !tablaGerm.getFechaUltConteo().isAfter(hoy);</span>
<span class="fc" id="L310">                boolean fechaNuevaEsFutura = solicitud.getFechaUltConteo().isAfter(hoy);</span>
                
<span class="fc" id="L312">                System.out.println(&quot;  Fecha anterior es presente/pasada: &quot; + fechaAnteriorEsPresenteOPasada);</span>
<span class="fc" id="L313">                System.out.println(&quot;  Fecha nueva es futura: &quot; + fechaNuevaEsFutura);</span>
                
<span class="pc bpc" id="L315" title="1 of 4 branches missed.">                if (fechaAnteriorEsPresenteOPasada &amp;&amp; fechaNuevaEsFutura) {</span>
<span class="fc" id="L316">                    debeReiniciarCamposUltimoConteo = true;</span>
<span class="fc" id="L317">                    System.out.println(&quot;   Se detectó cambio de fecha último conteo a futuro - se reiniciarán campos&quot;);</span>
                }
            }
            
            
<span class="fc" id="L322">            analisisService.manejarEdicionAnalisisFinalizado(tablaGerm.getGerminacion());</span>
            
            
<span class="fc" id="L325">            validarDatosTablaGerm(solicitud, tablaGerm.getGerminacion());</span>
            
            
<span class="fc bfc" id="L328" title="All 2 branches covered.">            if (debeReiniciarCamposUltimoConteo) {</span>
<span class="fc" id="L329">                reiniciarCamposUltimoConteo(tablaGerm);</span>
            }
            
<span class="fc" id="L332">            actualizarEntidadDesdeSolicitud(tablaGerm, solicitud);</span>
            
            
<span class="fc" id="L335">            calcularYActualizarTotales(tablaGerm);</span>
            
<span class="fc" id="L337">            TablaGerm tablaGermActualizada = tablaGermRepository.save(tablaGerm);</span>

<span class="fc" id="L339">            return mapearEntidadADTO(tablaGermActualizada);</span>
        } else {
<span class="nc" id="L341">            throw new RuntimeException(&quot;Tabla de germinación no encontrada con ID: &quot; + id);</span>
        }
    }

    
    public void eliminarTablaGerm(Long id) {
<span class="fc" id="L347">        Optional&lt;TablaGerm&gt; tablaGermExistente = tablaGermRepository.findById(id);</span>
        
<span class="fc bfc" id="L349" title="All 2 branches covered.">        if (tablaGermExistente.isPresent()) {</span>
            
<span class="fc" id="L351">            List&lt;ValoresGerm&gt; valores = valoresGermRepository.findByTablaGermId(id);</span>
<span class="fc" id="L352">            valoresGermRepository.deleteAll(valores);</span>
            
<span class="fc" id="L354">            tablaGermRepository.deleteById(id);</span>
<span class="fc" id="L355">        } else {</span>
<span class="fc" id="L356">            throw new RuntimeException(&quot;Tabla de germinación no encontrada con ID: &quot; + id);</span>
        }
<span class="fc" id="L358">    }</span>

    
    public List&lt;TablaGermDTO&gt; obtenerTablasPorGerminacion(Long germinacionId) {
<span class="fc" id="L362">        List&lt;TablaGerm&gt; tablas = tablaGermRepository.findByGerminacionId(germinacionId);</span>
<span class="fc" id="L363">        return tablas.stream().map(this::mapearEntidadADTO).collect(Collectors.toList());</span>
    }

    
    public Long contarTablasPorGerminacion(Long germinacionId) {
<span class="fc" id="L368">        return tablaGermRepository.countByGerminacionId(germinacionId);</span>
    }

    
    public TablaGermDTO actualizarPorcentajes(Long tablaId, PorcentajesRedondeoRequestDTO solicitud) {
<span class="fc" id="L373">        Optional&lt;TablaGerm&gt; tablaExistente = tablaGermRepository.findById(tablaId);</span>
        
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">        if (tablaExistente.isPresent()) {</span>
<span class="fc" id="L376">            TablaGerm tabla = tablaExistente.get();</span>
            
            
<span class="fc" id="L379">            analisisService.manejarEdicionAnalisisFinalizado(tabla.getGerminacion());</span>
            
            
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">            if (!puedeIngresarPorcentajes(tablaId)) {</span>
<span class="nc" id="L383">                throw new RuntimeException(&quot;No se pueden ingresar porcentajes hasta completar todas las repeticiones&quot;);</span>
            }
            
            
<span class="fc" id="L387">            validarPorcentajes(solicitud);</span>
            
            
<span class="fc" id="L390">            tabla.setPorcentajeNormalesConRedondeo(solicitud.getPorcentajeNormalesConRedondeo());</span>
<span class="fc" id="L391">            tabla.setPorcentajeAnormalesConRedondeo(solicitud.getPorcentajeAnormalesConRedondeo());</span>
<span class="fc" id="L392">            tabla.setPorcentajeDurasConRedondeo(solicitud.getPorcentajeDurasConRedondeo());</span>
<span class="fc" id="L393">            tabla.setPorcentajeFrescasConRedondeo(solicitud.getPorcentajeFrescasConRedondeo());</span>
<span class="fc" id="L394">            tabla.setPorcentajeMuertasConRedondeo(solicitud.getPorcentajeMuertasConRedondeo());</span>
            
<span class="fc" id="L396">            TablaGerm tablaActualizada = tablaGermRepository.save(tabla);</span>
            
            
<span class="fc" id="L399">            actualizarValoresInia(tablaActualizada);</span>
            
<span class="fc" id="L401">            return mapearEntidadADTO(tablaActualizada);</span>
        } else {
<span class="nc" id="L403">            throw new RuntimeException(&quot;Tabla no encontrada con ID: &quot; + tablaId);</span>
        }
    }

    
    public TablaGermDTO finalizarTabla(Long tablaId) {
<span class="fc" id="L409">        Optional&lt;TablaGerm&gt; tablaExistente = tablaGermRepository.findById(tablaId);</span>
        
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">        if (tablaExistente.isPresent()) {</span>
<span class="fc" id="L412">            TablaGerm tabla = tablaExistente.get();</span>
            
            
<span class="pc bpc" id="L415" title="2 of 4 branches missed.">            if (tabla.getFinalizada() != null &amp;&amp; tabla.getFinalizada()) {</span>
<span class="nc" id="L416">                throw new RuntimeException(&quot;La tabla ya está finalizada&quot;);</span>
            }
            
            
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">            if (!todasLasRepeticionesCompletas(tabla)) {</span>
<span class="nc" id="L421">                throw new RuntimeException(&quot;No se puede finalizar la tabla. Faltan repeticiones por completar.&quot;);</span>
            }
            
            
<span class="fc" id="L425">            validarRangoToleranciaRepeticiones(tabla);</span>
            
            
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">            if (!camposPorcentajeCompletos(tabla)) {</span>
<span class="nc" id="L429">                throw new RuntimeException(&quot;No se puede finalizar la tabla. Debe ingresar todos los porcentajes con redondeo.&quot;);</span>
            }
            
            
<span class="fc" id="L433">            tabla.setFinalizada(true);</span>
<span class="fc" id="L434">            TablaGerm tablaActualizada = tablaGermRepository.save(tabla);</span>
            
<span class="fc" id="L436">            System.out.println(&quot;Tabla finalizada exitosamente con ID: &quot; + tablaId);</span>
<span class="fc" id="L437">            return mapearEntidadADTO(tablaActualizada);</span>
        } else {
<span class="nc" id="L439">            throw new RuntimeException(&quot;Tabla no encontrada con ID: &quot; + tablaId);</span>
        }
    }
    
    
    private void validarRangoToleranciaRepeticiones(TablaGerm tabla) {
<span class="pc bpc" id="L445" title="2 of 4 branches missed.">        if (tabla.getRepGerm() == null || tabla.getRepGerm().isEmpty()) {</span>
<span class="nc" id="L446">            return;</span>
        }
        
<span class="fc" id="L449">        Integer numSemillasPRep = tabla.getNumSemillasPRep();</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">        if (numSemillasPRep == null) {</span>
<span class="nc" id="L451">            return;</span>
        }
        
<span class="fc" id="L454">        int limiteMinimo = (int) Math.floor(numSemillasPRep * 0.95);</span>
<span class="fc" id="L455">        int limiteMaximo = (int) Math.floor(numSemillasPRep * 1.05);</span>
        
<span class="fc" id="L457">        List&lt;String&gt; repeticionesFueraDeRango = new ArrayList&lt;&gt;();</span>
        
<span class="fc bfc" id="L459" title="All 2 branches covered.">        for (RepGerm rep : tabla.getRepGerm()) {</span>
<span class="fc" id="L460">            Integer total = rep.getTotal();</span>
<span class="pc bpc" id="L461" title="5 of 6 branches missed.">            if (total != null &amp;&amp; (total &lt; limiteMinimo || total &gt; limiteMaximo)) {</span>
<span class="nc" id="L462">                repeticionesFueraDeRango.add(&quot;Repetición &quot; + rep.getNumRep() + &quot; (total: &quot; + total + &quot;)&quot;);</span>
            }
<span class="fc" id="L464">        }</span>
        
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">        if (!repeticionesFueraDeRango.isEmpty()) {</span>
<span class="nc" id="L467">            throw new RuntimeException(&quot;No se puede finalizar la tabla. Las siguientes repeticiones están fuera del rango de tolerancia del 5% (&quot; + </span>
<span class="nc" id="L468">                limiteMinimo + &quot;-&quot; + limiteMaximo + &quot; semillas): &quot; + String.join(&quot;, &quot;, repeticionesFueraDeRango) + </span>
                &quot;. Se perdió más del 5% de las semillas o hay un exceso.&quot;);
        }
<span class="fc" id="L471">    }</span>

    
    private boolean todasLasRepeticionesCompletas(TablaGerm tabla) {
<span class="pc bpc" id="L475" title="2 of 4 branches missed.">        if (tabla == null || tabla.getNumeroRepeticiones() == null) {</span>
<span class="nc" id="L476">            return false;</span>
        }
        
        
<span class="fc" id="L480">        List&lt;RepGerm&gt; repeticiones = tabla.getRepGerm();</span>
<span class="fc bfc" id="L481" title="All 2 branches covered.">        if (repeticiones == null) {</span>
<span class="fc" id="L482">            return false;</span>
        }
        
<span class="fc" id="L485">        int repeticionesEsperadas = tabla.getNumeroRepeticiones();</span>
<span class="fc" id="L486">        int repeticionesExistentes = repeticiones.size();</span>
        
        
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">        if (repeticionesExistentes != repeticionesEsperadas) {</span>
<span class="nc" id="L490">            return false;</span>
        }
        
        
<span class="fc" id="L494">        Integer numeroConteos = tabla.getNumeroConteos();</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">        if (numeroConteos == null) {</span>
<span class="nc" id="L496">            return false;</span>
        }
        
<span class="fc bfc" id="L499" title="All 2 branches covered.">        for (RepGerm repeticion : repeticiones) {</span>
<span class="pc bpc" id="L500" title="2 of 4 branches missed.">            if (repeticion.getNormales() == null || repeticion.getNormales().size() != numeroConteos) {</span>
<span class="nc" id="L501">                return false;</span>
            }
            
            
            
<span class="fc bfc" id="L506" title="All 2 branches covered.">            for (Integer normal : repeticion.getNormales()) {</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">                if (normal == null) {</span>
<span class="nc" id="L508">                    return false;</span>
                }
<span class="fc" id="L510">            }</span>
            
            
<span class="fc" id="L513">            boolean tieneValoresIngresados = repeticion.getNormales().stream()</span>
<span class="pc bpc" id="L514" title="2 of 4 branches missed.">                .anyMatch(valor -&gt; valor != null &amp;&amp; valor &gt; 0);</span>
            
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">            if (!tieneValoresIngresados) {</span>
<span class="nc" id="L517">                return false; </span>
            }
<span class="fc" id="L519">        }</span>
        
<span class="fc" id="L521">        return true;</span>
    }

    
    private boolean camposPorcentajeCompletos(TablaGerm tabla) {
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">        return tabla.getPorcentajeNormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">               tabla.getPorcentajeAnormalesConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">               tabla.getPorcentajeDurasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L529" title="1 of 2 branches missed.">               tabla.getPorcentajeFrescasConRedondeo() != null &amp;&amp;</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">               tabla.getPorcentajeMuertasConRedondeo() != null;</span>
    }

    
    public boolean puedeIngresarPorcentajes(Long tablaId) {
<span class="fc" id="L535">        Optional&lt;TablaGerm&gt; tablaExistente = tablaGermRepository.findById(tablaId);</span>
        
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">        if (tablaExistente.isPresent()) {</span>
<span class="fc" id="L538">            TablaGerm tabla = tablaExistente.get();</span>
            
            
            
<span class="fc" id="L542">            return todasLasRepeticionesCompletas(tabla);</span>
        }
        
<span class="nc" id="L545">        return false;</span>
    }

    
    private void crearValoresGermAutomaticos(TablaGerm tablaGerm) {
        
<span class="fc" id="L551">        ValoresGerm valoresInia = new ValoresGerm();</span>
<span class="fc" id="L552">        valoresInia.setInstituto(Instituto.INIA);</span>
<span class="fc" id="L553">        valoresInia.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L554">        inicializarValoresEnCero(valoresInia);</span>
<span class="fc" id="L555">        valoresGermRepository.save(valoresInia);</span>

        
<span class="fc" id="L558">        ValoresGerm valoresInase = new ValoresGerm();</span>
<span class="fc" id="L559">        valoresInase.setInstituto(Instituto.INASE);</span>
<span class="fc" id="L560">        valoresInase.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L561">        inicializarValoresEnCero(valoresInase);</span>
<span class="fc" id="L562">        valoresGermRepository.save(valoresInase);</span>
<span class="fc" id="L563">    }</span>

    
    private void inicializarValoresEnCero(ValoresGerm valores) {
<span class="fc" id="L567">        valores.setNormales(BigDecimal.ZERO);</span>
<span class="fc" id="L568">        valores.setAnormales(BigDecimal.ZERO);</span>
<span class="fc" id="L569">        valores.setDuras(BigDecimal.ZERO);</span>
<span class="fc" id="L570">        valores.setFrescas(BigDecimal.ZERO);</span>
<span class="fc" id="L571">        valores.setMuertas(BigDecimal.ZERO);</span>
<span class="fc" id="L572">        valores.setGerminacion(BigDecimal.ZERO);</span>
<span class="fc" id="L573">    }</span>



    
    private void actualizarValoresInia(TablaGerm tablaGerm) {
<span class="fc" id="L579">        Optional&lt;ValoresGerm&gt; valoresIniaOpt = valoresGermRepository.findByTablaGermIdAndInstituto(</span>
<span class="fc" id="L580">            tablaGerm.getTablaGermID(), Instituto.INIA);</span>
        
<span class="fc bfc" id="L582" title="All 2 branches covered.">        if (valoresIniaOpt.isPresent()) {</span>
<span class="fc" id="L583">            ValoresGerm valoresInia = valoresIniaOpt.get();</span>
            
            
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeNormalesConRedondeo() != null) {</span>
<span class="fc" id="L587">                valoresInia.setNormales(tablaGerm.getPorcentajeNormalesConRedondeo());</span>
            }
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeAnormalesConRedondeo() != null) {</span>
<span class="fc" id="L590">                valoresInia.setAnormales(tablaGerm.getPorcentajeAnormalesConRedondeo());</span>
            }
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeDurasConRedondeo() != null) {</span>
<span class="fc" id="L593">                valoresInia.setDuras(tablaGerm.getPorcentajeDurasConRedondeo());</span>
            }
<span class="pc bpc" id="L595" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeFrescasConRedondeo() != null) {</span>
<span class="fc" id="L596">                valoresInia.setFrescas(tablaGerm.getPorcentajeFrescasConRedondeo());</span>
            }
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">            if (tablaGerm.getPorcentajeMuertasConRedondeo() != null) {</span>
<span class="fc" id="L599">                valoresInia.setMuertas(tablaGerm.getPorcentajeMuertasConRedondeo());</span>
            }
            
            
<span class="pc bpc" id="L603" title="1 of 2 branches missed.">            valoresInia.setGerminacion(tablaGerm.getPorcentajeNormalesConRedondeo() != null ? </span>
<span class="pc" id="L604">                tablaGerm.getPorcentajeNormalesConRedondeo() : BigDecimal.ZERO);</span>
            
<span class="fc" id="L606">            valoresGermRepository.save(valoresInia);</span>
        }
<span class="fc" id="L608">    }</span>

    
    private TablaGerm mapearSolicitudAEntidad(TablaGermRequestDTO solicitud, Germinacion germinacion) {
<span class="fc" id="L612">        TablaGerm tablaGerm = new TablaGerm();</span>
        
<span class="fc" id="L614">        tablaGerm.setGerminacion(germinacion);</span>
        
<span class="fc" id="L616">        tablaGerm.setTotal(0);</span>
        
<span class="fc" id="L618">        tablaGerm.setFechaFinal(solicitud.getFechaFinal());</span>
        
        
<span class="fc" id="L621">        tablaGerm.setFinalizada(false);</span>
        
        
<span class="fc" id="L624">        tablaGerm.setTratamiento(solicitud.getTratamiento());</span>
<span class="fc" id="L625">        tablaGerm.setProductoYDosis(solicitud.getProductoYDosis());</span>
<span class="fc" id="L626">        tablaGerm.setNumSemillasPRep(solicitud.getNumSemillasPRep());</span>
<span class="fc" id="L627">        tablaGerm.setMetodo(solicitud.getMetodo());</span>
<span class="fc" id="L628">        tablaGerm.setTemperatura(solicitud.getTemperatura());</span>
        
        
<span class="fc" id="L631">        tablaGerm.setTienePrefrio(solicitud.getTienePrefrio());</span>
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">        if (Boolean.TRUE.equals(solicitud.getTienePrefrio())) {</span>
<span class="nc" id="L633">            tablaGerm.setDescripcionPrefrio(solicitud.getDescripcionPrefrio());</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">            tablaGerm.setDiasPrefrio(solicitud.getDiasPrefrio() != null ? solicitud.getDiasPrefrio() : 0);</span>
        } else {
<span class="fc" id="L636">            tablaGerm.setDescripcionPrefrio(null);</span>
<span class="fc" id="L637">            tablaGerm.setDiasPrefrio(0);</span>
        }
        
<span class="fc" id="L640">        tablaGerm.setTienePretratamiento(solicitud.getTienePretratamiento());</span>
<span class="pc bpc" id="L641" title="1 of 2 branches missed.">        if (Boolean.TRUE.equals(solicitud.getTienePretratamiento())) {</span>
<span class="nc" id="L642">            tablaGerm.setDescripcionPretratamiento(solicitud.getDescripcionPretratamiento());</span>
        } else {
<span class="fc" id="L644">            tablaGerm.setDescripcionPretratamiento(null);</span>
        }
        
        
<span class="fc" id="L648">        tablaGerm.setFechaIngreso(solicitud.getFechaIngreso());</span>
<span class="fc" id="L649">        tablaGerm.setFechaGerminacion(solicitud.getFechaGerminacion());</span>
<span class="fc" id="L650">        tablaGerm.setFechaConteos(solicitud.getFechaConteos());</span>
<span class="fc" id="L651">        tablaGerm.setFechaUltConteo(solicitud.getFechaUltConteo());</span>
<span class="fc" id="L652">        tablaGerm.setNumDias(solicitud.getNumDias());</span>
<span class="fc" id="L653">        tablaGerm.setNumeroRepeticiones(solicitud.getNumeroRepeticiones());</span>
<span class="fc" id="L654">        tablaGerm.setNumeroConteos(solicitud.getNumeroConteos());</span>
        
<span class="fc" id="L656">        return tablaGerm;</span>
    }

    
    private void actualizarEntidadDesdeSolicitud(TablaGerm tablaGerm, TablaGermRequestDTO solicitud) {
        
        
<span class="fc" id="L663">        tablaGerm.setFechaFinal(solicitud.getFechaFinal());</span>
        
        
<span class="fc" id="L666">        tablaGerm.setTratamiento(solicitud.getTratamiento());</span>
<span class="fc" id="L667">        tablaGerm.setProductoYDosis(solicitud.getProductoYDosis());</span>
<span class="fc" id="L668">        tablaGerm.setNumSemillasPRep(solicitud.getNumSemillasPRep());</span>
<span class="fc" id="L669">        tablaGerm.setMetodo(solicitud.getMetodo());</span>
<span class="fc" id="L670">        tablaGerm.setTemperatura(solicitud.getTemperatura());</span>
        
        
<span class="fc" id="L673">        tablaGerm.setTienePrefrio(solicitud.getTienePrefrio());</span>
<span class="fc bfc" id="L674" title="All 2 branches covered.">        if (Boolean.TRUE.equals(solicitud.getTienePrefrio())) {</span>
<span class="fc" id="L675">            tablaGerm.setDescripcionPrefrio(solicitud.getDescripcionPrefrio());</span>
<span class="pc bpc" id="L676" title="1 of 2 branches missed.">            tablaGerm.setDiasPrefrio(solicitud.getDiasPrefrio() != null ? solicitud.getDiasPrefrio() : 0);</span>
        } else {
<span class="fc" id="L678">            tablaGerm.setDescripcionPrefrio(null);</span>
<span class="fc" id="L679">            tablaGerm.setDiasPrefrio(0);</span>
        }
        
<span class="fc" id="L682">        tablaGerm.setTienePretratamiento(solicitud.getTienePretratamiento());</span>
<span class="fc bfc" id="L683" title="All 2 branches covered.">        if (Boolean.TRUE.equals(solicitud.getTienePretratamiento())) {</span>
<span class="fc" id="L684">            tablaGerm.setDescripcionPretratamiento(solicitud.getDescripcionPretratamiento());</span>
        } else {
<span class="fc" id="L686">            tablaGerm.setDescripcionPretratamiento(null);</span>
        };
        
        
<span class="pc bpc" id="L690" title="2 of 4 branches missed.">        if (solicitud.getNumeroConteos() != null &amp;&amp; tablaGerm.getNumeroConteos() != null &amp;&amp;</span>
<span class="fc bfc" id="L691" title="All 2 branches covered.">            !solicitud.getNumeroConteos().equals(tablaGerm.getNumeroConteos())) {</span>
            
<span class="fc" id="L693">            Integer conteosAnteriores = tablaGerm.getNumeroConteos();</span>
<span class="fc" id="L694">            Integer conteosNuevos = solicitud.getNumeroConteos();</span>
            
<span class="fc" id="L696">            System.out.println(&quot; Cambio en número de conteos detectado: &quot; + conteosAnteriores + &quot; -&gt; &quot; + conteosNuevos);</span>
            
            
<span class="pc bpc" id="L699" title="2 of 4 branches missed.">            if (tablaGerm.getRepGerm() != null &amp;&amp; !tablaGerm.getRepGerm().isEmpty()) {</span>
<span class="fc bfc" id="L700" title="All 2 branches covered.">                for (RepGerm rep : tablaGerm.getRepGerm()) {</span>
<span class="pc bpc" id="L701" title="1 of 2 branches missed.">                    List&lt;Integer&gt; normalesActuales = rep.getNormales() != null ? </span>
<span class="pc" id="L702">                        new ArrayList&lt;&gt;(rep.getNormales()) : new ArrayList&lt;&gt;();</span>
                    
<span class="fc bfc" id="L704" title="All 2 branches covered.">                    if (conteosNuevos &gt; conteosAnteriores) {</span>
                        
<span class="fc" id="L706">                        int conteosAAgregar = conteosNuevos - conteosAnteriores;</span>
<span class="fc bfc" id="L707" title="All 2 branches covered.">                        for (int i = 0; i &lt; conteosAAgregar; i++) {</span>
<span class="fc" id="L708">                            normalesActuales.add(0);</span>
                        }
<span class="fc" id="L710">                        System.out.println(&quot;   Repetición &quot; + rep.getNumRep() + &quot;: agregados &quot; + conteosAAgregar + &quot; conteos al final&quot;);</span>
<span class="fc" id="L711">                    } else {</span>
                        
<span class="fc" id="L713">                        int conteosAEliminar = conteosAnteriores - conteosNuevos;</span>
<span class="pc bpc" id="L714" title="1 of 4 branches missed.">                        for (int i = 0; i &lt; conteosAEliminar &amp;&amp; !normalesActuales.isEmpty(); i++) {</span>
<span class="fc" id="L715">                            normalesActuales.remove(normalesActuales.size() - 1);</span>
                        }
<span class="fc" id="L717">                        System.out.println(&quot;   Repetición &quot; + rep.getNumRep() + &quot;: eliminados &quot; + conteosAEliminar + &quot; conteos desde el final&quot;);</span>
                    }
                    
<span class="fc" id="L720">                    rep.setNormales(normalesActuales);</span>
<span class="fc" id="L721">                    repGermRepository.save(rep);</span>
<span class="fc" id="L722">                }</span>
            }
            
            
<span class="fc" id="L726">            tablaGerm.setNumeroConteos(conteosNuevos);</span>
        }
        
        
<span class="pc bpc" id="L730" title="2 of 4 branches missed.">        if (solicitud.getNumeroRepeticiones() != null &amp;&amp; tablaGerm.getNumeroRepeticiones() != null &amp;&amp;</span>
<span class="fc bfc" id="L731" title="All 2 branches covered.">            !solicitud.getNumeroRepeticiones().equals(tablaGerm.getNumeroRepeticiones())) {</span>
            
<span class="fc" id="L733">            Integer repeticionesAnteriores = tablaGerm.getNumeroRepeticiones();</span>
<span class="fc" id="L734">            Integer repeticionesNuevas = solicitud.getNumeroRepeticiones();</span>
            
<span class="fc" id="L736">            System.out.println(&quot; Cambio en número de repeticiones detectado: &quot; + repeticionesAnteriores + &quot; -&gt; &quot; + repeticionesNuevas);</span>
            
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">            if (repeticionesNuevas &lt; repeticionesAnteriores) {</span>
                
<span class="fc" id="L740">                List&lt;RepGerm&gt; repeticiones = repGermRepository.findByTablaGermId(tablaGerm.getTablaGermID());</span>
<span class="fc" id="L741">                repeticiones.sort((r1, r2) -&gt; Integer.compare(r2.getNumRep(), r1.getNumRep())); </span>
                
<span class="fc" id="L743">                int repeticionesAEliminar = repeticionesAnteriores - repeticionesNuevas;</span>
<span class="pc bpc" id="L744" title="1 of 4 branches missed.">                for (int i = 0; i &lt; repeticionesAEliminar &amp;&amp; i &lt; repeticiones.size(); i++) {</span>
<span class="fc" id="L745">                    RepGerm repAEliminar = repeticiones.get(i);</span>
<span class="fc" id="L746">                    System.out.println(&quot;   Eliminando repetición &quot; + repAEliminar.getNumRep());</span>
<span class="fc" id="L747">                    repGermRepository.delete(repAEliminar);</span>
                }
            }
            
            
            
<span class="fc" id="L753">            tablaGerm.setNumeroRepeticiones(repeticionesNuevas);</span>
        }
        
        
<span class="pc bpc" id="L757" title="2 of 4 branches missed.">        if (solicitud.getFechaConteos() != null &amp;&amp; !solicitud.getFechaConteos().isEmpty()) {</span>
            
<span class="fc" id="L759">            boolean fechasCambiaron = false;</span>
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">            if (tablaGerm.getFechaConteos() == null || </span>
<span class="fc bfc" id="L761" title="All 2 branches covered.">                tablaGerm.getFechaConteos().size() != solicitud.getFechaConteos().size()) {</span>
<span class="fc" id="L762">                fechasCambiaron = true;</span>
            } else {
<span class="fc bfc" id="L764" title="All 2 branches covered.">                for (int i = 0; i &lt; solicitud.getFechaConteos().size(); i++) {</span>
<span class="fc bfc" id="L765" title="All 2 branches covered.">                    if (!solicitud.getFechaConteos().get(i).equals(tablaGerm.getFechaConteos().get(i))) {</span>
<span class="fc" id="L766">                        fechasCambiaron = true;</span>
                        
<span class="fc bfc" id="L768" title="All 2 branches covered.">                        if (solicitud.getFechaConteos().get(i).isAfter(tablaGerm.getFechaConteos().get(i))) {</span>
                            
<span class="fc" id="L770">                            reiniciarDatosConteo(tablaGerm, i);</span>
                        }
                    }
                }
            }
            
<span class="fc bfc" id="L776" title="All 2 branches covered.">            if (fechasCambiaron) {</span>
                
<span class="fc" id="L778">                validarFechasConteosEnEdicion(solicitud, tablaGerm);</span>
<span class="fc" id="L779">                tablaGerm.setFechaConteos(solicitud.getFechaConteos());</span>
            }
        }
        
        
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">        if (solicitud.getFechaIngreso() != null) {</span>
<span class="fc" id="L785">            tablaGerm.setFechaIngreso(solicitud.getFechaIngreso());</span>
        }
        
<span class="pc bpc" id="L788" title="1 of 2 branches missed.">        if (solicitud.getFechaGerminacion() != null) {</span>
<span class="fc" id="L789">            tablaGerm.setFechaGerminacion(solicitud.getFechaGerminacion());</span>
        }
        
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">        if (solicitud.getFechaUltConteo() != null) {</span>
<span class="fc" id="L793">            tablaGerm.setFechaUltConteo(solicitud.getFechaUltConteo());</span>
        }
        
<span class="pc bpc" id="L796" title="1 of 2 branches missed.">        if (solicitud.getNumDias() != null) {</span>
<span class="fc" id="L797">            tablaGerm.setNumDias(solicitud.getNumDias());</span>
        }
        
        
<span class="fc bfc" id="L801" title="All 2 branches covered.">        if (solicitud.getDiasPrefrio() != null) {</span>
<span class="fc" id="L802">            tablaGerm.setDiasPrefrio(solicitud.getDiasPrefrio());</span>
        }
<span class="fc" id="L804">    }</span>
    
    
    private void reiniciarDatosConteo(TablaGerm tablaGerm, int indiceConteo) {
<span class="fc bfc" id="L808" title="All 2 branches covered.">        if (tablaGerm.getRepGerm() != null) {</span>
<span class="fc bfc" id="L809" title="All 2 branches covered.">            for (RepGerm rep : tablaGerm.getRepGerm()) {</span>
<span class="pc bpc" id="L810" title="2 of 4 branches missed.">                if (rep.getNormales() != null &amp;&amp; indiceConteo &lt; rep.getNormales().size()) {</span>
<span class="fc" id="L811">                    rep.getNormales().set(indiceConteo, 0);</span>
<span class="fc" id="L812">                    repGermRepository.save(rep);</span>
                }
<span class="fc" id="L814">            }</span>
        }
<span class="fc" id="L816">    }</span>
    
    
    private void reiniciarCamposUltimoConteo(TablaGerm tablaGerm) {
<span class="fc" id="L820">        System.out.println(&quot; Reiniciando campos del último conteo para tabla ID: &quot; + tablaGerm.getTablaGermID());</span>
        
        
<span class="fc" id="L823">        List&lt;RepGerm&gt; repeticiones = repGermRepository.findByTablaGermId(tablaGerm.getTablaGermID());</span>
        
<span class="fc" id="L825">        System.out.println(&quot;   Repeticiones encontradas: &quot; + repeticiones.size());</span>
        
<span class="pc bpc" id="L827" title="2 of 4 branches missed.">        if (repeticiones != null &amp;&amp; !repeticiones.isEmpty()) {</span>
<span class="fc bfc" id="L828" title="All 2 branches covered.">            for (RepGerm rep : repeticiones) {</span>
<span class="fc" id="L829">                System.out.println(&quot;   Limpiando repetición &quot; + rep.getNumRep() + </span>
<span class="fc" id="L830">                    &quot; (ID: &quot; + rep.getRepGermID() + &quot;)&quot; +</span>
<span class="fc" id="L831">                    &quot; - Valores anteriores: anormales=&quot; + rep.getAnormales() + </span>
<span class="fc" id="L832">                    &quot;, duras=&quot; + rep.getDuras() + </span>
<span class="fc" id="L833">                    &quot;, frescas=&quot; + rep.getFrescas() + </span>
<span class="fc" id="L834">                    &quot;, muertas=&quot; + rep.getMuertas());</span>
                
                
<span class="fc" id="L837">                rep.setAnormales(0);</span>
<span class="fc" id="L838">                rep.setDuras(0);</span>
<span class="fc" id="L839">                rep.setFrescas(0);</span>
<span class="fc" id="L840">                rep.setMuertas(0);</span>
                
<span class="fc" id="L842">                RepGerm repGuardada = repGermRepository.save(rep);</span>
<span class="fc" id="L843">                System.out.println(&quot;   Repetición &quot; + rep.getNumRep() + &quot; limpiada - Nuevos valores: anormales=&quot; + </span>
<span class="fc" id="L844">                    repGuardada.getAnormales() + &quot;, duras=&quot; + repGuardada.getDuras() + </span>
<span class="fc" id="L845">                    &quot;, frescas=&quot; + repGuardada.getFrescas() + &quot;, muertas=&quot; + repGuardada.getMuertas());</span>
<span class="fc" id="L846">            }</span>
        } else {
<span class="nc" id="L848">            System.out.println(&quot;   No se encontraron repeticiones para limpiar&quot;);</span>
        }
        
<span class="fc" id="L851">        System.out.println(&quot; Campos del último conteo reiniciados completamente&quot;);</span>
<span class="fc" id="L852">    }</span>
    
    
    private void validarFechasConteosEnEdicion(TablaGermRequestDTO solicitud, TablaGerm tablaExistente) {
        
        
<span class="pc bpc" id="L858" title="1 of 2 branches missed.">        java.time.LocalDate fechaGerminacion = solicitud.getFechaGerminacion() != null ? </span>
<span class="pc" id="L859">            solicitud.getFechaGerminacion() : tablaExistente.getFechaGerminacion();</span>
        
<span class="fc bfc" id="L861" title="All 2 branches covered.">        for (int i = 0; i &lt; solicitud.getFechaConteos().size(); i++) {</span>
<span class="fc" id="L862">            java.time.LocalDate fechaConteo = solicitud.getFechaConteos().get(i);</span>
            
<span class="pc bpc" id="L864" title="1 of 4 branches missed.">            if (i == 0 &amp;&amp; !fechaConteo.isAfter(fechaGerminacion)) {</span>
<span class="nc" id="L865">                throw new RuntimeException(&quot;El primer conteo debe realizarse después de la fecha de germinación (fecha mínima: &quot; + </span>
<span class="nc" id="L866">                    fechaGerminacion.plusDays(1) + &quot;)&quot;);</span>
            }
        }
<span class="fc" id="L869">    }</span>

    
    private TablaGermDTO mapearEntidadADTO(TablaGerm tablaGerm) {
<span class="fc" id="L873">        TablaGermDTO dto = new TablaGermDTO();</span>
        
<span class="fc" id="L875">        dto.setTablaGermID(tablaGerm.getTablaGermID());</span>
        
        
<span class="fc bfc" id="L878" title="All 2 branches covered.">        if (tablaGerm.getRepGerm() != null) {</span>
<span class="fc" id="L879">            List&lt;RepGermDTO&gt; repGermDTOs = tablaGerm.getRepGerm().stream()</span>
<span class="fc" id="L880">                .map(this::mapearRepGermADTO)</span>
<span class="fc" id="L881">                .collect(Collectors.toList());</span>
<span class="fc" id="L882">            dto.setRepGerm(repGermDTOs);</span>
        }
        
<span class="fc" id="L885">        dto.setTotal(tablaGerm.getTotal());</span>
<span class="fc" id="L886">        dto.setPromedioSinRedondeo(tablaGerm.getPromedioSinRedondeo());</span>
<span class="fc" id="L887">        dto.setPromediosSinRedPorConteo(tablaGerm.getPromediosSinRedPorConteo());</span>
        
        
<span class="fc" id="L890">        dto.setPorcentajeNormalesConRedondeo(tablaGerm.getPorcentajeNormalesConRedondeo());</span>
<span class="fc" id="L891">        dto.setPorcentajeAnormalesConRedondeo(tablaGerm.getPorcentajeAnormalesConRedondeo());</span>
<span class="fc" id="L892">        dto.setPorcentajeDurasConRedondeo(tablaGerm.getPorcentajeDurasConRedondeo());</span>
<span class="fc" id="L893">        dto.setPorcentajeFrescasConRedondeo(tablaGerm.getPorcentajeFrescasConRedondeo());</span>
<span class="fc" id="L894">        dto.setPorcentajeMuertasConRedondeo(tablaGerm.getPorcentajeMuertasConRedondeo());</span>
        
        
<span class="fc bfc" id="L897" title="All 2 branches covered.">        if (tablaGerm.getValoresGerm() != null) {</span>
<span class="fc" id="L898">            List&lt;ValoresGermDTO&gt; valoresDTO = tablaGerm.getValoresGerm().stream()</span>
<span class="fc" id="L899">                .map(this::mapearValoresGermADTO)</span>
<span class="fc" id="L900">                .collect(Collectors.toList());</span>
<span class="fc" id="L901">            dto.setValoresGerm(valoresDTO);</span>
        }
        
<span class="fc" id="L904">        dto.setFechaFinal(tablaGerm.getFechaFinal());</span>
        
        
<span class="fc" id="L907">        dto.setFinalizada(tablaGerm.getFinalizada());</span>
        
        
<span class="fc" id="L910">        dto.setTratamiento(tablaGerm.getTratamiento());</span>
<span class="fc" id="L911">        dto.setProductoYDosis(tablaGerm.getProductoYDosis());</span>
<span class="fc" id="L912">        dto.setNumSemillasPRep(tablaGerm.getNumSemillasPRep());</span>
<span class="fc" id="L913">        dto.setMetodo(tablaGerm.getMetodo());</span>
<span class="fc" id="L914">        dto.setTemperatura(tablaGerm.getTemperatura());</span>
        
        
<span class="fc" id="L917">        dto.setTienePrefrio(tablaGerm.getTienePrefrio());</span>
<span class="fc" id="L918">        dto.setDescripcionPrefrio(tablaGerm.getDescripcionPrefrio());</span>
<span class="fc" id="L919">        dto.setTienePretratamiento(tablaGerm.getTienePretratamiento());</span>
<span class="fc" id="L920">        dto.setDescripcionPretratamiento(tablaGerm.getDescripcionPretratamiento());</span>
        
        
<span class="fc" id="L923">        dto.setFechaIngreso(tablaGerm.getFechaIngreso());</span>
<span class="fc" id="L924">        dto.setFechaGerminacion(tablaGerm.getFechaGerminacion());</span>
<span class="fc" id="L925">        dto.setFechaConteos(tablaGerm.getFechaConteos());</span>
<span class="fc" id="L926">        dto.setFechaUltConteo(tablaGerm.getFechaUltConteo());</span>
<span class="fc" id="L927">        dto.setNumDias(tablaGerm.getNumDias());</span>
<span class="fc" id="L928">        dto.setNumeroRepeticiones(tablaGerm.getNumeroRepeticiones());</span>
<span class="fc" id="L929">        dto.setNumeroConteos(tablaGerm.getNumeroConteos());</span>
<span class="fc" id="L930">        dto.setDiasPrefrio(tablaGerm.getDiasPrefrio());</span>
        
<span class="fc" id="L932">        return dto;</span>
    }
    
    
    private RepGermDTO mapearRepGermADTO(RepGerm repGerm) {
<span class="fc" id="L937">        RepGermDTO dto = new RepGermDTO();</span>
<span class="fc" id="L938">        dto.setRepGermID(repGerm.getRepGermID());</span>
<span class="fc" id="L939">        dto.setNumRep(repGerm.getNumRep());</span>
<span class="fc" id="L940">        dto.setNormales(repGerm.getNormales());</span>
<span class="fc" id="L941">        dto.setAnormales(repGerm.getAnormales());</span>
<span class="fc" id="L942">        dto.setDuras(repGerm.getDuras());</span>
<span class="fc" id="L943">        dto.setFrescas(repGerm.getFrescas());</span>
<span class="fc" id="L944">        dto.setMuertas(repGerm.getMuertas());</span>
<span class="fc" id="L945">        dto.setTotal(repGerm.getTotal());</span>
<span class="fc" id="L946">        dto.setTablaGermId(repGerm.getTablaGerm().getTablaGermID());</span>
<span class="fc" id="L947">        return dto;</span>
    }

    
    private ValoresGermDTO mapearValoresGermADTO(ValoresGerm valores) {
<span class="fc" id="L952">        ValoresGermDTO dto = new ValoresGermDTO();</span>
<span class="fc" id="L953">        dto.setValoresGermID(valores.getValoresGermID());</span>
<span class="fc" id="L954">        dto.setInstituto(valores.getInstituto());</span>
<span class="fc" id="L955">        dto.setNormales(valores.getNormales());</span>
<span class="fc" id="L956">        dto.setAnormales(valores.getAnormales());</span>
<span class="fc" id="L957">        dto.setDuras(valores.getDuras());</span>
<span class="fc" id="L958">        dto.setFrescas(valores.getFrescas());</span>
<span class="fc" id="L959">        dto.setMuertas(valores.getMuertas());</span>
<span class="fc" id="L960">        dto.setGerminacion(valores.getGerminacion());</span>
<span class="fc" id="L961">        dto.setTablaGermId(valores.getTablaGerm().getTablaGermID());</span>
<span class="fc" id="L962">        return dto;</span>
    }
    
    
    private void calcularYActualizarTotales(TablaGerm tablaGerm) {
<span class="fc bfc" id="L967" title="All 2 branches covered.">        if (tablaGerm.getTablaGermID() == null) {</span>
            
<span class="fc" id="L969">            tablaGerm.setTotal(0);</span>
<span class="fc" id="L970">            return;</span>
        }
        
        
<span class="fc" id="L974">        List&lt;RepGerm&gt; repeticiones = repGermRepository.findByTablaGermId(tablaGerm.getTablaGermID());</span>
        
        
<span class="fc" id="L977">        int totalCalculado = repeticiones.stream()</span>
<span class="pc bpc" id="L978" title="1 of 2 branches missed.">            .mapToInt(rep -&gt; rep.getTotal() != null ? rep.getTotal().intValue() : 0)</span>
<span class="fc" id="L979">            .sum();</span>
            
<span class="fc" id="L981">        tablaGerm.setTotal(totalCalculado);</span>
<span class="fc" id="L982">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>