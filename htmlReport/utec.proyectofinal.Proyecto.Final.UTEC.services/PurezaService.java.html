<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PurezaService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">PurezaService.java</span></div><h1>PurezaService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Listado;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pureza;
import utec.proyectofinal.Proyecto.Final.UTEC.business.mappers.MappingUtils;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.CatalogoRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ListadoRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.MalezasCatalogoRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.EspecieRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PurezaRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.specifications.PurezaSpecification;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ListadoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PurezaRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.ListadoDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.MalezasCatalogoDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PurezaDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PurezaListadoDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;
import utec.proyectofinal.Proyecto.Final.UTEC.responses.ResponseListadoPureza;

@Service
<span class="fc" id="L37">public class PurezaService {</span>

    @Autowired
    private PurezaRepository purezaRepository;

    @Autowired
    private ListadoRepository listadoRepository;

    @Autowired
    private CatalogoRepository catalogoRepository;

    @Autowired
    private MalezasCatalogoRepository malezasCatalogoRepository;

    @Autowired
    private EspecieRepository especieRepository;

    @Autowired
    private LoteRepository loteRepository;

    @Autowired
    private AnalisisHistorialService analisisHistorialService;
    
    @Autowired
    private AnalisisService analisisService;

    
    @Transactional
    public PurezaDTO crearPureza(PurezaRequestDTO solicitud) {
        
<span class="fc" id="L67">        validarPesos(solicitud.getPesoInicial_g(), solicitud.getPesoTotal_g());</span>
        
<span class="fc" id="L69">        Pureza pureza = mapearSolicitudAEntidad(solicitud);</span>
<span class="fc" id="L70">        pureza.setEstado(Estado.EN_PROCESO);</span>
        
        
<span class="fc" id="L73">        analisisService.establecerFechaInicio(pureza);</span>
        
<span class="fc" id="L75">        Pureza purezaGuardada = purezaRepository.save(pureza);</span>
        
        
<span class="fc" id="L78">        analisisHistorialService.registrarCreacion(purezaGuardada);</span>
        
<span class="fc" id="L80">        return mapearEntidadADTO(purezaGuardada);</span>
    }

    
    @Transactional
    public PurezaDTO actualizarPureza(Long id, PurezaRequestDTO solicitud) {
<span class="fc" id="L86">        Pureza pureza = purezaRepository.findById(id)</span>
<span class="fc" id="L87">                .orElseThrow(() -&gt; new RuntimeException(&quot;Pureza no encontrada con id: &quot; + id));</span>

        
<span class="fc" id="L90">        Estado estadoOriginal = pureza.getEstado();</span>
        
<span class="fc bfc" id="L92" title="All 4 branches covered.">        if (estadoOriginal == Estado.APROBADO &amp;&amp; analisisService.esAnalista()) {</span>
            
<span class="fc" id="L94">            pureza.setEstado(Estado.PENDIENTE_APROBACION);</span>
        }
        
        

        
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        BigDecimal pesoInicial = solicitud.getPesoInicial_g() != null ? solicitud.getPesoInicial_g() : pureza.getPesoInicial_g();</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        BigDecimal pesoTotal = solicitud.getPesoTotal_g() != null ? solicitud.getPesoTotal_g() : pureza.getPesoTotal_g();</span>
<span class="fc" id="L102">        validarPesos(pesoInicial, pesoTotal);</span>

<span class="fc" id="L104">        actualizarEntidadDesdeSolicitud(pureza, solicitud);</span>
<span class="fc" id="L105">        Pureza purezaActualizada = purezaRepository.save(pureza);</span>
        
        
<span class="fc" id="L108">        analisisHistorialService.registrarModificacion(purezaActualizada);</span>
        
<span class="fc" id="L110">        return mapearEntidadADTO(purezaActualizada);</span>
    }

    
    public void desactivarPureza(Long id) {
<span class="fc" id="L115">        analisisService.desactivarAnalisis(id, purezaRepository);</span>
<span class="fc" id="L116">    }</span>

    
    public PurezaDTO reactivarPureza(Long id) {
<span class="fc" id="L120">        return analisisService.reactivarAnalisis(id, purezaRepository, this::mapearEntidadADTO);</span>
    }

    
    public PurezaDTO obtenerPurezaPorId(Long id) {
<span class="fc" id="L125">        return purezaRepository.findById(id)</span>
<span class="fc" id="L126">                .map(this::mapearEntidadADTO)</span>
<span class="fc" id="L127">                .orElseThrow(() -&gt; new RuntimeException(&quot;Pureza no encontrada con id: &quot; + id));</span>
    }

    
    public List&lt;PurezaDTO&gt; obtenerPurezasPorIdLote(Long idLote) {
<span class="fc" id="L132">        return purezaRepository.findByIdLote(idLote)</span>
<span class="fc" id="L133">                .stream()</span>
<span class="fc" id="L134">                .map(this::mapearEntidadADTO)</span>
<span class="fc" id="L135">                .collect(Collectors.toList());</span>
    }


    
    public Page&lt;PurezaListadoDTO&gt; obtenerPurezaPaginadasConFiltros(
            Pageable pageable,
            String searchTerm,
            Boolean activo,
            String estado,
            Long loteId) {
        
        
<span class="fc" id="L148">        Specification&lt;Pureza&gt; spec = PurezaSpecification.conFiltros(searchTerm, activo, estado, loteId);</span>
        
        
<span class="fc" id="L151">        Page&lt;Pureza&gt; purezaPage = purezaRepository.findAll(spec, pageable);</span>
        
        
<span class="fc" id="L154">        return purezaPage.map(this::mapearEntidadAListadoDTO);</span>
    }

    
    private PurezaListadoDTO mapearEntidadAListadoDTO(Pureza pureza) {
<span class="fc" id="L159">        PurezaListadoDTO dto = new PurezaListadoDTO();</span>
<span class="fc" id="L160">        dto.setAnalisisID(pureza.getAnalisisID());</span>
<span class="fc" id="L161">        dto.setEstado(pureza.getEstado());</span>
<span class="fc" id="L162">        dto.setFechaInicio(pureza.getFechaInicio());</span>
<span class="fc" id="L163">        dto.setFechaFin(pureza.getFechaFin());</span>
<span class="fc" id="L164">        dto.setActivo(pureza.getActivo());</span>
        
        
<span class="fc" id="L167">        dto.setRedonSemillaPura(pureza.getRedonSemillaPura());</span>
<span class="fc" id="L168">        dto.setInasePura(pureza.getInasePura());</span>
        
<span class="fc bfc" id="L170" title="All 2 branches covered.">        if (pureza.getLote() != null) {</span>
<span class="fc" id="L171">            dto.setIdLote(pureza.getLote().getLoteID());</span>
<span class="fc" id="L172">            dto.setLote(pureza.getLote().getNomLote()); </span>
            
            
<span class="pc bpc" id="L175" title="1 of 4 branches missed.">            if (pureza.getLote().getCultivar() != null &amp;&amp; pureza.getLote().getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L176">                String nombreEspecie = pureza.getLote().getCultivar().getEspecie().getNombreComun();</span>
                
<span class="fc bfc" id="L178" title="All 4 branches covered.">                if (nombreEspecie == null || nombreEspecie.trim().isEmpty()) {</span>
<span class="fc" id="L179">                    nombreEspecie = pureza.getLote().getCultivar().getEspecie().getNombreCientifico();</span>
                }
<span class="fc" id="L181">                dto.setEspecie(nombreEspecie);</span>
            }
        }
        
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (pureza.getAnalisisID() != null) {</span>
<span class="fc" id="L186">            var historial = analisisHistorialService.obtenerHistorialAnalisis(pureza.getAnalisisID());</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">            if (!historial.isEmpty()) {</span>
<span class="fc" id="L188">                var primerRegistro = historial.get(historial.size() - 1);</span>
<span class="fc" id="L189">                dto.setUsuarioCreador(primerRegistro.getUsuario());</span>
<span class="fc" id="L190">                var ultimoRegistro = historial.get(0);</span>
<span class="fc" id="L191">                dto.setUsuarioModificador(ultimoRegistro.getUsuario());</span>
            }
        }
<span class="fc" id="L194">        return dto;</span>
    }


    

    private Pureza mapearSolicitudAEntidad(PurezaRequestDTO solicitud) {
<span class="fc" id="L201">        Pureza pureza = new Pureza();</span>

<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (solicitud.getIdLote() != null) {</span>
<span class="fc" id="L204">            Optional&lt;Lote&gt; loteOpt = loteRepository.findById(solicitud.getIdLote());</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">            if (loteOpt.isPresent()) {</span>
<span class="fc" id="L206">                Lote lote = loteOpt.get();</span>
                
                
<span class="fc bfc" id="L209" title="All 2 branches covered.">                if (!lote.getActivo()) {</span>
<span class="fc" id="L210">                    throw new RuntimeException(&quot;No se puede crear un análisis para un lote inactivo&quot;);</span>
                }
                
<span class="fc" id="L213">                pureza.setLote(lote);</span>
<span class="fc" id="L214">            } else {</span>
<span class="fc" id="L215">                throw new RuntimeException(&quot;Lote no encontrado con ID: &quot; + solicitud.getIdLote());</span>
            }
        }

        
<span class="fc" id="L220">        pureza.setCumpleEstandar(solicitud.getCumpleEstandar());</span>
<span class="fc" id="L221">        pureza.setComentarios(solicitud.getComentarios());</span>

        
<span class="fc" id="L224">        pureza.setFecha(solicitud.getFecha());</span>
<span class="fc" id="L225">        pureza.setPesoInicial_g(solicitud.getPesoInicial_g());</span>
<span class="fc" id="L226">        pureza.setSemillaPura_g(solicitud.getSemillaPura_g());</span>
<span class="fc" id="L227">        pureza.setMateriaInerte_g(solicitud.getMateriaInerte_g());</span>
<span class="fc" id="L228">        pureza.setOtrosCultivos_g(solicitud.getOtrosCultivos_g());</span>
<span class="fc" id="L229">        pureza.setMalezas_g(solicitud.getMalezas_g());</span>
<span class="fc" id="L230">        pureza.setMalezasToleradas_g(solicitud.getMalezasToleradas_g());</span>
<span class="fc" id="L231">        pureza.setMalezasTolCero_g(solicitud.getMalezasTolCero_g());</span>
<span class="fc" id="L232">        pureza.setPesoTotal_g(solicitud.getPesoTotal_g());</span>

<span class="fc" id="L234">        pureza.setRedonSemillaPura(solicitud.getRedonSemillaPura());</span>
<span class="fc" id="L235">        pureza.setRedonMateriaInerte(solicitud.getRedonMateriaInerte());</span>
<span class="fc" id="L236">        pureza.setRedonOtrosCultivos(solicitud.getRedonOtrosCultivos());</span>
<span class="fc" id="L237">        pureza.setRedonMalezas(solicitud.getRedonMalezas());</span>
<span class="fc" id="L238">        pureza.setRedonMalezasToleradas(solicitud.getRedonMalezasToleradas());</span>
<span class="fc" id="L239">        pureza.setRedonMalezasTolCero(solicitud.getRedonMalezasTolCero());</span>
<span class="fc" id="L240">        pureza.setRedonPesoTotal(solicitud.getRedonPesoTotal());</span>

<span class="fc" id="L242">        pureza.setInasePura(solicitud.getInasePura());</span>
<span class="fc" id="L243">        pureza.setInaseMateriaInerte(solicitud.getInaseMateriaInerte());</span>
<span class="fc" id="L244">        pureza.setInaseOtrosCultivos(solicitud.getInaseOtrosCultivos());</span>
<span class="fc" id="L245">        pureza.setInaseMalezas(solicitud.getInaseMalezas());</span>
<span class="fc" id="L246">        pureza.setInaseMalezasToleradas(solicitud.getInaseMalezasToleradas());</span>
<span class="fc" id="L247">        pureza.setInaseMalezasTolCero(solicitud.getInaseMalezasTolCero());</span>
<span class="fc" id="L248">        pureza.setInaseFecha(solicitud.getInaseFecha());</span>

<span class="pc bpc" id="L250" title="1 of 4 branches missed.">        if (solicitud.getOtrasSemillas() != null &amp;&amp; !solicitud.getOtrasSemillas().isEmpty()) {</span>
<span class="fc" id="L251">            List&lt;Listado&gt; otrasSemillas = solicitud.getOtrasSemillas().stream()</span>
<span class="fc" id="L252">                    .map(req -&gt; crearListadoDesdeSolicitud(req, pureza))</span>
<span class="fc" id="L253">                    .collect(Collectors.toList());</span>
<span class="fc" id="L254">            pureza.setListados(otrasSemillas);</span>
        }

<span class="fc" id="L257">        return pureza;</span>
    }

    private void actualizarEntidadDesdeSolicitud(Pureza pureza, PurezaRequestDTO solicitud) {
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (solicitud.getIdLote() != null) {</span>
<span class="fc" id="L262">            Optional&lt;Lote&gt; loteOpt = loteRepository.findById(solicitud.getIdLote());</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">            if (loteOpt.isPresent()) {</span>
<span class="fc" id="L264">                pureza.setLote(loteOpt.get());</span>
            } else {
<span class="fc" id="L266">                throw new RuntimeException(&quot;Lote no encontrado con ID: &quot; + solicitud.getIdLote());</span>
            }
        }


<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (solicitud.getCumpleEstandar() != null) pureza.setCumpleEstandar(solicitud.getCumpleEstandar());</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (solicitud.getComentarios() != null) pureza.setComentarios(solicitud.getComentarios());</span>

<span class="fc bfc" id="L274" title="All 2 branches covered.">        if (solicitud.getFecha() != null) pureza.setFecha(solicitud.getFecha());</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (solicitud.getPesoInicial_g() != null) pureza.setPesoInicial_g(solicitud.getPesoInicial_g());</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">        if (solicitud.getSemillaPura_g() != null) pureza.setSemillaPura_g(solicitud.getSemillaPura_g());</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">        if (solicitud.getMateriaInerte_g() != null) pureza.setMateriaInerte_g(solicitud.getMateriaInerte_g());</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">        if (solicitud.getOtrosCultivos_g() != null) pureza.setOtrosCultivos_g(solicitud.getOtrosCultivos_g());</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">        if (solicitud.getMalezas_g() != null) pureza.setMalezas_g(solicitud.getMalezas_g());</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">        if (solicitud.getMalezasToleradas_g() != null) pureza.setMalezasToleradas_g(solicitud.getMalezasToleradas_g());</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (solicitud.getMalezasTolCero_g() != null) pureza.setMalezasTolCero_g(solicitud.getMalezasTolCero_g());</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (solicitud.getPesoTotal_g() != null) pureza.setPesoTotal_g(solicitud.getPesoTotal_g());</span>

<span class="fc bfc" id="L284" title="All 2 branches covered.">        if (solicitud.getRedonSemillaPura() != null) pureza.setRedonSemillaPura(solicitud.getRedonSemillaPura());</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">        if (solicitud.getRedonMateriaInerte() != null) pureza.setRedonMateriaInerte(solicitud.getRedonMateriaInerte());</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">        if (solicitud.getRedonOtrosCultivos() != null) pureza.setRedonOtrosCultivos(solicitud.getRedonOtrosCultivos());</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">        if (solicitud.getRedonMalezas() != null) pureza.setRedonMalezas(solicitud.getRedonMalezas());</span>
<span class="fc bfc" id="L288" title="All 2 branches covered.">        if (solicitud.getRedonMalezasToleradas() != null) pureza.setRedonMalezasToleradas(solicitud.getRedonMalezasToleradas());</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">        if (solicitud.getRedonMalezasTolCero() != null) pureza.setRedonMalezasTolCero(solicitud.getRedonMalezasTolCero());</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">        if (solicitud.getRedonPesoTotal() != null) pureza.setRedonPesoTotal(solicitud.getRedonPesoTotal());</span>

<span class="fc bfc" id="L292" title="All 2 branches covered.">        if (solicitud.getInasePura() != null) pureza.setInasePura(solicitud.getInasePura());</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">        if (solicitud.getInaseMateriaInerte() != null) pureza.setInaseMateriaInerte(solicitud.getInaseMateriaInerte());</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (solicitud.getInaseOtrosCultivos() != null) pureza.setInaseOtrosCultivos(solicitud.getInaseOtrosCultivos());</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">        if (solicitud.getInaseMalezas() != null) pureza.setInaseMalezas(solicitud.getInaseMalezas());</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">        if (solicitud.getInaseMalezasToleradas() != null) pureza.setInaseMalezasToleradas(solicitud.getInaseMalezasToleradas());</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if (solicitud.getInaseMalezasTolCero() != null) pureza.setInaseMalezasTolCero(solicitud.getInaseMalezasTolCero());</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">        if (solicitud.getInaseFecha() != null) pureza.setInaseFecha(solicitud.getInaseFecha());</span>

<span class="fc bfc" id="L300" title="All 2 branches covered.">        if (solicitud.getOtrasSemillas() != null) {</span>
            
<span class="fc bfc" id="L302" title="All 2 branches covered.">            if (pureza.getListados() == null) {</span>
<span class="fc" id="L303">                pureza.setListados(new ArrayList&lt;&gt;());</span>
            }
            
            
<span class="fc" id="L307">            pureza.getListados().clear();</span>

            
<span class="fc bfc" id="L310" title="All 2 branches covered.">            if (!solicitud.getOtrasSemillas().isEmpty()) {</span>
<span class="fc" id="L311">                List&lt;Listado&gt; nuevosListados = solicitud.getOtrasSemillas().stream()</span>
<span class="fc" id="L312">                        .map(req -&gt; crearListadoDesdeSolicitud(req, pureza))</span>
<span class="fc" id="L313">                        .collect(Collectors.toList());</span>
                
<span class="fc" id="L315">                pureza.getListados().addAll(nuevosListados);</span>
            }
        }
<span class="fc" id="L318">    }</span>

    private PurezaDTO mapearEntidadADTO(Pureza pureza) {
<span class="fc" id="L321">        PurezaDTO dto = new PurezaDTO();</span>

<span class="fc" id="L323">        dto.setAnalisisID(pureza.getAnalisisID());</span>
<span class="fc" id="L324">        dto.setEstado(pureza.getEstado());</span>
<span class="fc" id="L325">        dto.setFechaInicio(pureza.getFechaInicio());</span>
<span class="fc" id="L326">        dto.setFechaFin(pureza.getFechaFin());</span>
<span class="fc" id="L327">        dto.setCumpleEstandar(pureza.getCumpleEstandar());</span>
<span class="fc" id="L328">        dto.setComentarios(pureza.getComentarios());</span>
        
        
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">        if (pureza.getLote() != null) {</span>
<span class="fc" id="L332">            dto.setIdLote(pureza.getLote().getLoteID());</span>
<span class="fc" id="L333">            dto.setLote(pureza.getLote().getNomLote());</span>
<span class="fc" id="L334">            dto.setFicha(pureza.getLote().getFicha());</span>
            
            
<span class="fc bfc" id="L337" title="All 2 branches covered.">            if (pureza.getLote().getCultivar() != null) {</span>
<span class="fc" id="L338">                dto.setCultivarNombre(pureza.getLote().getCultivar().getNombre());</span>
                
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">                if (pureza.getLote().getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L341">                    dto.setEspecieNombre(pureza.getLote().getCultivar().getEspecie().getNombreComun());</span>
                }
            }
        }

<span class="fc" id="L346">        dto.setFecha(pureza.getFecha());</span>
<span class="fc" id="L347">        dto.setPesoInicial_g(pureza.getPesoInicial_g());</span>
<span class="fc" id="L348">        dto.setSemillaPura_g(pureza.getSemillaPura_g());</span>
<span class="fc" id="L349">        dto.setMateriaInerte_g(pureza.getMateriaInerte_g());</span>
<span class="fc" id="L350">        dto.setOtrosCultivos_g(pureza.getOtrosCultivos_g());</span>
<span class="fc" id="L351">        dto.setMalezas_g(pureza.getMalezas_g());</span>
<span class="fc" id="L352">        dto.setMalezasToleradas_g(pureza.getMalezasToleradas_g());</span>
<span class="fc" id="L353">        dto.setMalezasTolCero_g(pureza.getMalezasTolCero_g());</span>
<span class="fc" id="L354">        dto.setPesoTotal_g(pureza.getPesoTotal_g());</span>

<span class="fc" id="L356">        dto.setRedonSemillaPura(pureza.getRedonSemillaPura());</span>
<span class="fc" id="L357">        dto.setRedonMateriaInerte(pureza.getRedonMateriaInerte());</span>
<span class="fc" id="L358">        dto.setRedonOtrosCultivos(pureza.getRedonOtrosCultivos());</span>
<span class="fc" id="L359">        dto.setRedonMalezas(pureza.getRedonMalezas());</span>
<span class="fc" id="L360">        dto.setRedonMalezasToleradas(pureza.getRedonMalezasToleradas());</span>
<span class="fc" id="L361">        dto.setRedonMalezasTolCero(pureza.getRedonMalezasTolCero());</span>
<span class="fc" id="L362">        dto.setRedonPesoTotal(pureza.getRedonPesoTotal());</span>

<span class="fc" id="L364">        dto.setInasePura(pureza.getInasePura());</span>
<span class="fc" id="L365">        dto.setInaseMateriaInerte(pureza.getInaseMateriaInerte());</span>
<span class="fc" id="L366">        dto.setInaseOtrosCultivos(pureza.getInaseOtrosCultivos());</span>
<span class="fc" id="L367">        dto.setInaseMalezas(pureza.getInaseMalezas());</span>
<span class="fc" id="L368">        dto.setInaseMalezasToleradas(pureza.getInaseMalezasToleradas());</span>
<span class="fc" id="L369">        dto.setInaseMalezasTolCero(pureza.getInaseMalezasTolCero());</span>
<span class="fc" id="L370">        dto.setInaseFecha(pureza.getInaseFecha());</span>

<span class="fc bfc" id="L372" title="All 2 branches covered.">        if (pureza.getListados() != null) {</span>
<span class="fc" id="L373">            List&lt;ListadoDTO&gt; otrasSemillasDTO = pureza.getListados().stream()</span>
<span class="fc" id="L374">                    .map(MappingUtils::toListadoDTO)</span>
<span class="fc" id="L375">                    .collect(Collectors.toList());</span>
<span class="fc" id="L376">            dto.setOtrasSemillas(otrasSemillasDTO);</span>
        }

        
<span class="fc" id="L380">        dto.setHistorial(analisisHistorialService.obtenerHistorialAnalisis(pureza.getAnalisisID()));</span>

<span class="fc" id="L382">        return dto;</span>
    }

    private Listado crearListadoDesdeSolicitud(ListadoRequestDTO solicitud, Pureza pureza) {
<span class="fc" id="L386">        Listado listado = MappingUtils.fromListadoRequest(solicitud, malezasCatalogoRepository, especieRepository);</span>
<span class="fc" id="L387">        listado.setPureza(pureza);</span>
<span class="fc" id="L388">        return listado;</span>
    }

    
    private void validarPesos(BigDecimal pesoInicial_g, BigDecimal pesoTotal_g) {
<span class="pc bpc" id="L393" title="1 of 4 branches missed.">        if (pesoInicial_g == null || pesoTotal_g == null) {</span>
<span class="fc" id="L394">            return; </span>
        }

        
<span class="fc bfc" id="L398" title="All 2 branches covered.">        if (pesoInicial_g.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="fc" id="L399">            throw new RuntimeException(&quot;El peso inicial debe ser mayor a cero para realizar el análisis&quot;);</span>
        }

        
<span class="fc bfc" id="L403" title="All 2 branches covered.">        if (pesoTotal_g.compareTo(pesoInicial_g) &gt; 0) {</span>
<span class="fc" id="L404">            throw new RuntimeException(&quot;El peso total (&quot; + pesoTotal_g + &quot;g) no puede ser mayor al peso inicial (&quot; + pesoInicial_g + &quot;g)&quot;);</span>
        }

        
        
<span class="fc" id="L409">        BigDecimal diferenciaPeso = pesoInicial_g.subtract(pesoTotal_g);</span>
<span class="fc" id="L410">        BigDecimal porcentajePerdida = diferenciaPeso.divide(pesoInicial_g, 4, java.math.RoundingMode.HALF_UP)</span>
<span class="fc" id="L411">                                                    .multiply(new BigDecimal(&quot;100&quot;));</span>
        
<span class="fc" id="L413">        BigDecimal limitePermitido = new BigDecimal(&quot;5.0&quot;);</span>
<span class="fc bfc" id="L414" title="All 2 branches covered.">        if (porcentajePerdida.compareTo(limitePermitido) &gt; 0) {</span>
            
<span class="fc" id="L416">            System.out.println(&quot;INFO: La muestra ha perdido &quot; + porcentajePerdida.setScale(2, java.math.RoundingMode.HALF_UP) + </span>
                             &quot;% de su peso inicial, lo cual excede el límite recomendado del 5%. &quot; +
<span class="fc" id="L418">                             &quot;Pérdida: &quot; + diferenciaPeso.setScale(2, java.math.RoundingMode.HALF_UP) + &quot;g&quot;);</span>
        }
<span class="fc" id="L420">    }</span>

    
    public PurezaDTO finalizarAnalisis(Long id) {
<span class="fc" id="L424">        return analisisService.finalizarAnalisisGenerico(</span>
            id,
            purezaRepository,
            this::mapearEntidadADTO,
            this::validarAntesDeFinalizar
        );
    }

    
    private void validarAntesDeFinalizar(Pureza pureza) {
        
<span class="nc bnc" id="L435" title="All 2 branches missed.">        boolean tieneDatosRedon = pureza.getRedonSemillaPura() != null</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                || pureza.getRedonMateriaInerte() != null</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                || pureza.getRedonOtrosCultivos() != null</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                || pureza.getRedonMalezas() != null</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                || pureza.getRedonMalezasToleradas() != null</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                || pureza.getRedonMalezasTolCero() != null;</span>

        
<span class="nc bnc" id="L443" title="All 2 branches missed.">        boolean tieneDatosINASE = (pureza.getInaseFecha() != null)</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">                &amp;&amp; (pureza.getInasePura() != null</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">                    || pureza.getInaseMateriaInerte() != null</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                    || pureza.getInaseOtrosCultivos() != null</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                    || pureza.getInaseMalezas() != null</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                    || pureza.getInaseMalezasToleradas() != null</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                    || pureza.getInaseMalezasTolCero() != null);</span>

        
<span class="nc bnc" id="L452" title="All 4 branches missed.">        boolean tieneListados = pureza.getListados() != null &amp;&amp; !pureza.getListados().isEmpty();</span>

        
<span class="nc bnc" id="L455" title="All 6 branches missed.">        if (!tieneDatosRedon &amp;&amp; !tieneDatosINASE &amp;&amp; !tieneListados) {</span>
<span class="nc" id="L456">            throw new RuntimeException(&quot;No se puede finalizar: el análisis de Pureza carece de evidencia. Agregue datos de pesos (Redon), datos INASE o listados antes de finalizar.&quot;);</span>
        }

        
<span class="nc bnc" id="L460" title="All 4 branches missed.">        if (pureza.getPesoInicial_g() != null &amp;&amp; pureza.getPesoInicial_g().compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L461">            throw new RuntimeException(&quot;El peso inicial debe ser mayor que 0&quot;);</span>
        }
<span class="nc bnc" id="L463" title="All 4 branches missed.">        if (pureza.getPesoTotal_g() != null &amp;&amp; pureza.getPesoTotal_g().compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L464">            throw new RuntimeException(&quot;El peso total debe ser mayor que 0&quot;);</span>
        }
<span class="nc" id="L466">    }</span>

    
    public PurezaDTO aprobarAnalisis(Long id) {
<span class="fc" id="L470">        return analisisService.aprobarAnalisisGenerico(</span>
            id,
            purezaRepository,
            this::mapearEntidadADTO,
            this::validarAntesDeFinalizar,
<span class="fc" id="L475">            purezaRepository::findByIdLote </span>
        );
    }

    
    public PurezaDTO marcarParaRepetir(Long id) {
<span class="fc" id="L481">        return analisisService.marcarParaRepetirGenerico(</span>
            id,
            purezaRepository,
            this::mapearEntidadADTO,
            this::validarAntesDeFinalizar
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>