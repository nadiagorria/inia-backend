<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">UsuarioService.java</span></div><h1>UsuarioService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Usuario;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.UsuarioRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ActualizarPerfilRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.AprobarUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.GestionarUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.RegistroUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.UsuarioDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.EstadoUsuario;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Rol;

@Service
<span class="fc" id="L28">public class UsuarioService {</span>

    @Autowired
    private UsuarioRepository usuarioRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private NotificacionService notificacionService;
    
    @Autowired
    private EmailService emailService;

    @Autowired
    private TotpService totpService;

    @Autowired
    private BackupCodeService backupCodeService;

    
    public Optional&lt;Usuario&gt; buscarPorId(Integer id) {
<span class="fc" id="L50">        return usuarioRepository.findById(id);</span>
    }

    
    public UsuarioDTO registrarSolicitud(RegistroUsuarioRequestDTO solicitud) {
        
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (usuarioRepository.findByNombre(solicitud.getNombre()).isPresent()) {</span>
<span class="fc" id="L57">            throw new RuntimeException(&quot;El nombre de usuario ya existe&quot;);</span>
        }

        
<span class="fc bfc" id="L61" title="All 2 branches covered.">        if (usuarioRepository.findByEmail(solicitud.getEmail()).isPresent()) {</span>
<span class="fc" id="L62">            throw new RuntimeException(&quot;El email ya está registrado&quot;);</span>
        }

        
<span class="fc" id="L66">        validarContrasenia(solicitud.getContrasenia());</span>

        
<span class="fc" id="L69">        Usuario usuario = new Usuario();</span>
<span class="fc" id="L70">        usuario.setNombre(solicitud.getNombre());</span>
<span class="fc" id="L71">        usuario.setNombres(solicitud.getNombres());</span>
<span class="fc" id="L72">        usuario.setApellidos(solicitud.getApellidos());</span>
<span class="fc" id="L73">        usuario.setEmail(solicitud.getEmail());</span>
<span class="fc" id="L74">        usuario.setContrasenia(passwordEncoder.encode(solicitud.getContrasenia()));</span>
<span class="fc" id="L75">        usuario.setEstado(EstadoUsuario.PENDIENTE);</span>
<span class="fc" id="L76">        usuario.setRol(null); </span>
<span class="fc" id="L77">        usuario.setActivo(false); </span>

<span class="fc" id="L79">        Usuario usuarioGuardado = usuarioRepository.save(usuario);</span>
        
        
        try {
<span class="fc" id="L83">            notificacionService.notificarNuevoUsuario(usuarioGuardado.getUsuarioID().longValue());</span>
<span class="nc" id="L84">        } catch (Exception e) {</span>
            
<span class="nc" id="L86">            System.err.println(&quot;Error creating notification for new user: &quot; + e.getMessage());</span>
<span class="fc" id="L87">        }</span>
        
        
        try {
            
<span class="fc" id="L92">            emailService.enviarEmailConfirmacionRegistro(</span>
<span class="fc" id="L93">                usuarioGuardado.getEmail(),</span>
<span class="fc" id="L94">                usuarioGuardado.getNombres() + &quot; &quot; + usuarioGuardado.getApellidos()</span>
            );
            
            
<span class="fc" id="L98">            List&lt;Usuario&gt; analistas = usuarioRepository.findAllByRol(Rol.ANALISTA);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">            for (Usuario analista : analistas) {</span>
<span class="pc bpc" id="L100" title="2 of 4 branches missed.">                if (analista.getActivo() &amp;&amp; analista.getEmail() != null) {</span>
<span class="fc" id="L101">                    emailService.enviarEmailNuevoRegistro(</span>
<span class="fc" id="L102">                        analista.getEmail(),</span>
<span class="fc" id="L103">                        analista.getNombres() + &quot; &quot; + analista.getApellidos(),</span>
<span class="fc" id="L104">                        usuarioGuardado.getNombres() + &quot; &quot; + usuarioGuardado.getApellidos(),</span>
<span class="fc" id="L105">                        usuarioGuardado.getEmail()</span>
                    );
                }
<span class="fc" id="L108">            }</span>
            
<span class="fc" id="L110">            System.out.println(&quot; Emails enviados: confirmación a usuario y notificación a &quot; + analistas.size() + &quot; analista(s)&quot;);</span>
<span class="nc" id="L111">        } catch (Exception e) {</span>
<span class="nc" id="L112">            System.err.println(&quot; Error enviando emails (registro continúa): &quot; + e.getMessage());</span>
<span class="fc" id="L113">        }</span>
        
<span class="fc" id="L115">        return mapearEntidadADTO(usuarioGuardado);</span>
    }

    
    public List&lt;UsuarioDTO&gt; listarSolicitudesPendientes() {
<span class="fc" id="L120">        return usuarioRepository.findByEstado(EstadoUsuario.PENDIENTE)</span>
<span class="fc" id="L121">                .stream()</span>
<span class="fc" id="L122">                .map(this::mapearEntidadADTO)</span>
<span class="fc" id="L123">                .collect(Collectors.toList());</span>
    }

    
    public Page&lt;UsuarioDTO&gt; listarSolicitudesPendientesPaginadas(int page, int size, String search) {
        
<span class="fc" id="L129">        Pageable pageable = PageRequest.of(page, size,</span>
<span class="fc" id="L130">            Sort.by(Sort.Direction.DESC, &quot;fechaCreacion&quot;));</span>
        Page&lt;Usuario&gt; usuariosPage;
        
<span class="pc bpc" id="L133" title="1 of 4 branches missed.">        if (search != null &amp;&amp; !search.trim().isEmpty()) {</span>
            
<span class="fc" id="L135">            usuariosPage = usuarioRepository.findByEstadoAndSearchTerm(EstadoUsuario.PENDIENTE, search, pageable);</span>
        } else {
<span class="fc" id="L137">            usuariosPage = usuarioRepository.findByEstado(EstadoUsuario.PENDIENTE, pageable);</span>
        }
        
<span class="fc" id="L140">        return usuariosPage.map(this::mapearEntidadADTO);</span>
    }

    
    public UsuarioDTO aprobarUsuario(Integer usuarioId, AprobarUsuarioRequestDTO solicitud) {
<span class="fc" id="L145">        Usuario usuario = usuarioRepository.findById(usuarioId)</span>
<span class="fc" id="L146">                .orElseThrow(() -&gt; new RuntimeException(&quot;Usuario no encontrado&quot;));</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (usuario.getEstado() != EstadoUsuario.PENDIENTE) {</span>
<span class="nc" id="L149">            throw new RuntimeException(&quot;Solo se pueden aprobar usuarios en estado PENDIENTE&quot;);</span>
        }

<span class="fc" id="L152">        usuario.setRol(solicitud.getRol());</span>
<span class="fc" id="L153">        usuario.setEstado(EstadoUsuario.ACTIVO);</span>
<span class="fc" id="L154">        usuario.setActivo(true);</span>

<span class="fc" id="L156">        Usuario usuarioActualizado = usuarioRepository.save(usuario);</span>
        
        
        try {
<span class="fc" id="L160">            notificacionService.notificarUsuarioAprobado(usuarioActualizado.getUsuarioID().longValue());</span>
<span class="nc" id="L161">        } catch (Exception e) {</span>
            
<span class="nc" id="L163">            System.err.println(&quot;Error creating notification for user approval: &quot; + e.getMessage());</span>
<span class="fc" id="L164">        }</span>
        
        
        try {
<span class="fc" id="L168">            emailService.enviarEmailBienvenida(</span>
<span class="fc" id="L169">                usuarioActualizado.getEmail(),</span>
<span class="fc" id="L170">                usuarioActualizado.getNombres() + &quot; &quot; + usuarioActualizado.getApellidos()</span>
            );
<span class="fc" id="L172">            System.out.println(&quot; Email de bienvenida enviado a: &quot; + usuarioActualizado.getEmail());</span>
<span class="nc" id="L173">        } catch (Exception e) {</span>
<span class="nc" id="L174">            System.err.println(&quot; Error enviando email de bienvenida (aprobación continúa): &quot; + e.getMessage());</span>
<span class="fc" id="L175">        }</span>
        
<span class="fc" id="L177">        return mapearEntidadADTO(usuarioActualizado);</span>
    }

    
    public void rechazarSolicitud(Integer usuarioId) {
<span class="fc" id="L182">        Usuario usuario = usuarioRepository.findById(usuarioId)</span>
<span class="pc" id="L183">                .orElseThrow(() -&gt; new RuntimeException(&quot;Usuario no encontrado&quot;));</span>

<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (usuario.getEstado() != EstadoUsuario.PENDIENTE) {</span>
<span class="fc" id="L186">            throw new RuntimeException(&quot;Solo se pueden rechazar usuarios en estado PENDIENTE&quot;);</span>
        }

        
        try {
<span class="fc" id="L191">            notificacionService.notificarUsuarioRechazado(usuario.getUsuarioID().longValue());</span>
<span class="nc" id="L192">        } catch (Exception e) {</span>
            
<span class="nc" id="L194">            System.err.println(&quot;Error creating notification for user rejection: &quot; + e.getMessage());</span>
<span class="fc" id="L195">        }</span>

<span class="fc" id="L197">        usuarioRepository.delete(usuario);</span>
<span class="fc" id="L198">    }</span>

    
    public List&lt;UsuarioDTO&gt; listarTodosUsuarios() {
<span class="nc" id="L202">        return usuarioRepository.findAll()</span>
<span class="nc" id="L203">                .stream()</span>
<span class="nc" id="L204">                .map(this::mapearEntidadADTO)</span>
<span class="nc" id="L205">                .collect(Collectors.toList());</span>
    }

    
    public Page&lt;UsuarioDTO&gt; listarTodosUsuariosPaginados(int page, int size, String search, Rol rol, Boolean activo) {
        
<span class="fc" id="L211">        Pageable pageable = PageRequest.of(page, size, </span>
<span class="fc" id="L212">            Sort.by(Sort.Direction.ASC, &quot;apellidos&quot;, &quot;nombres&quot;));</span>
        Page&lt;Usuario&gt; usuariosPage;
        
<span class="pc bpc" id="L215" title="1 of 4 branches missed.">        boolean hasSearch = search != null &amp;&amp; !search.trim().isEmpty();</span>
        
        
<span class="pc bpc" id="L218" title="3 of 6 branches missed.">        if (rol != null &amp;&amp; activo != null &amp;&amp; hasSearch) {</span>
            
<span class="nc" id="L220">            usuariosPage = usuarioRepository.findByRolAndActivoAndSearchTerm(rol, activo, search, pageable);</span>
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">        } else if (rol != null &amp;&amp; activo != null) {</span>
            
<span class="nc" id="L223">            usuariosPage = usuarioRepository.findByRolAndActivo(rol, activo, pageable);</span>
<span class="pc bpc" id="L224" title="1 of 4 branches missed.">        } else if (rol != null &amp;&amp; hasSearch) {</span>
            
<span class="nc" id="L226">            usuariosPage = usuarioRepository.findBySearchTermAndRol(search, rol, pageable);</span>
<span class="pc bpc" id="L227" title="1 of 4 branches missed.">        } else if (activo != null &amp;&amp; hasSearch) {</span>
            
<span class="nc" id="L229">            usuariosPage = usuarioRepository.findByActivoAndSearchTerm(activo, search, pageable);</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">        } else if (rol != null) {</span>
            
<span class="fc" id="L232">            usuariosPage = usuarioRepository.findByRol(rol, pageable);</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">        } else if (activo != null) {</span>
            
<span class="fc" id="L235">            usuariosPage = usuarioRepository.findByActivo(activo, pageable);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">        } else if (hasSearch) {</span>
            
<span class="fc" id="L238">            usuariosPage = usuarioRepository.findBySearchTerm(search, pageable);</span>
        } else {
            
<span class="fc" id="L241">            usuariosPage = usuarioRepository.findAll(pageable);</span>
        }
        
<span class="fc" id="L244">        return usuariosPage.map(this::mapearEntidadADTO);</span>
    }

    
    public List&lt;UsuarioDTO&gt; listarUsuariosActivos() {
<span class="nc" id="L249">        return usuarioRepository.findByEstado(EstadoUsuario.ACTIVO)</span>
<span class="nc" id="L250">                .stream()</span>
<span class="nc" id="L251">                .map(this::mapearEntidadADTO)</span>
<span class="nc" id="L252">                .collect(Collectors.toList());</span>
    }

    
    public UsuarioDTO gestionarUsuario(Integer usuarioId, GestionarUsuarioRequestDTO solicitud) {
<span class="fc" id="L257">        Usuario usuario = usuarioRepository.findById(usuarioId)</span>
<span class="pc" id="L258">                .orElseThrow(() -&gt; new RuntimeException(&quot;Usuario no encontrado&quot;));</span>

        
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (solicitud.getRol() != null) {</span>
<span class="fc" id="L262">            usuario.setRol(solicitud.getRol());</span>
        }

        
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">        if (solicitud.getEstado() != null) {</span>
<span class="nc" id="L267">            usuario.setEstado(solicitud.getEstado());</span>
            
<span class="nc bnc" id="L269" title="All 2 branches missed.">            usuario.setActivo(solicitud.getEstado() == EstadoUsuario.ACTIVO);</span>
        }
        
        
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        if (solicitud.getActivo() != null) {</span>
<span class="fc" id="L274">            usuario.setActivo(solicitud.getActivo());</span>
            
<span class="fc bfc" id="L276" title="All 2 branches covered.">            usuario.setEstado(solicitud.getActivo() ? EstadoUsuario.ACTIVO : EstadoUsuario.INACTIVO);</span>
        }

<span class="fc" id="L279">        Usuario usuarioActualizado = usuarioRepository.save(usuario);</span>
<span class="fc" id="L280">        return mapearEntidadADTO(usuarioActualizado);</span>
    }

    
    public UsuarioDTO obtenerPerfil() {
<span class="fc" id="L285">        Usuario usuario = obtenerUsuarioActual();</span>
<span class="fc" id="L286">        return mapearEntidadADTO(usuario);</span>
    }

    
    public UsuarioDTO actualizarPerfil(ActualizarPerfilRequestDTO solicitud) {
<span class="fc" id="L291">        Usuario usuario = obtenerUsuarioActual();</span>

        
<span class="pc bpc" id="L294" title="1 of 4 branches missed.">        if (solicitud.getContraseniaNueva() != null &amp;&amp; !solicitud.getContraseniaNueva().isEmpty()) {</span>
<span class="pc bpc" id="L295" title="2 of 4 branches missed.">            if (solicitud.getContraseniaActual() == null || solicitud.getContraseniaActual().isEmpty()) {</span>
<span class="nc" id="L296">                throw new RuntimeException(&quot;Debe proporcionar la contraseña actual para cambiarla&quot;);</span>
            }
            
<span class="fc bfc" id="L299" title="All 2 branches covered.">            if (!passwordEncoder.matches(solicitud.getContraseniaActual(), usuario.getContrasenia())) {</span>
<span class="fc" id="L300">                throw new RuntimeException(&quot;Contraseña actual incorrecta&quot;);</span>
            }
            
            
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">            if (passwordEncoder.matches(solicitud.getContraseniaNueva(), usuario.getContrasenia())) {</span>
<span class="nc" id="L305">                throw new RuntimeException(&quot;La nueva contraseña no puede ser igual a la contraseña actual&quot;);</span>
            }
            
            
<span class="fc" id="L309">            validarContrasenia(solicitud.getContraseniaNueva());</span>
            
<span class="fc" id="L311">            usuario.setContrasenia(passwordEncoder.encode(solicitud.getContraseniaNueva()));</span>
        }

        
<span class="pc bpc" id="L315" title="1 of 4 branches missed.">        if (solicitud.getNombre() != null &amp;&amp; !solicitud.getNombre().trim().isEmpty() </span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">            &amp;&amp; !solicitud.getNombre().equalsIgnoreCase(usuario.getNombre())) {</span>
            
<span class="fc" id="L318">            Optional&lt;Usuario&gt; usuarioExistente = usuarioRepository.findByNombreIgnoreCase(solicitud.getNombre());</span>
<span class="pc bpc" id="L319" title="1 of 4 branches missed.">            if (usuarioExistente.isPresent() &amp;&amp; !usuarioExistente.get().getUsuarioID().equals(usuario.getUsuarioID())) {</span>
<span class="fc" id="L320">                throw new RuntimeException(&quot;El nombre de usuario ya está en uso por otro usuario&quot;);</span>
            }
<span class="fc" id="L322">            usuario.setNombre(solicitud.getNombre());</span>
        }

        
<span class="pc bpc" id="L326" title="1 of 4 branches missed.">        if (solicitud.getNombres() != null &amp;&amp; !solicitud.getNombres().trim().isEmpty()) {</span>
<span class="fc" id="L327">            usuario.setNombres(solicitud.getNombres());</span>
        }
        
<span class="pc bpc" id="L330" title="1 of 4 branches missed.">        if (solicitud.getApellidos() != null &amp;&amp; !solicitud.getApellidos().trim().isEmpty()) {</span>
<span class="fc" id="L331">            usuario.setApellidos(solicitud.getApellidos());</span>
        }
        
<span class="pc bpc" id="L334" title="1 of 4 branches missed.">        if (solicitud.getEmail() != null &amp;&amp; !solicitud.getEmail().trim().isEmpty() </span>
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">            &amp;&amp; !solicitud.getEmail().equalsIgnoreCase(usuario.getEmail())) {</span>
            
<span class="fc" id="L337">            Optional&lt;Usuario&gt; usuarioExistente = usuarioRepository.findByEmailIgnoreCase(solicitud.getEmail());</span>
<span class="pc bpc" id="L338" title="1 of 4 branches missed.">            if (usuarioExistente.isPresent() &amp;&amp; !usuarioExistente.get().getUsuarioID().equals(usuario.getUsuarioID())) {</span>
<span class="fc" id="L339">                throw new RuntimeException(&quot;El email ya está en uso por otro usuario&quot;);</span>
            }
<span class="fc" id="L341">            usuario.setEmail(solicitud.getEmail());</span>
        }

<span class="fc" id="L344">        Usuario usuarioActualizado = usuarioRepository.save(usuario);</span>
<span class="fc" id="L345">        return mapearEntidadADTO(usuarioActualizado);</span>
    }

    
    public UsuarioDTO crearAdminPredeterminado() {
        
<span class="fc bfc" id="L351" title="All 2 branches covered.">        if (usuarioRepository.existsByRol(Rol.ADMIN)) {</span>
<span class="fc" id="L352">            throw new RuntimeException(&quot;Ya existe un administrador en el sistema&quot;);</span>
        }

<span class="fc" id="L355">        System.out.println(&quot;=&quot; .repeat(80));</span>
<span class="fc" id="L356">        System.out.println(&quot; CREANDO USUARIO ADMINISTRADOR CON 2FA OBLIGATORIO&quot;);</span>
<span class="fc" id="L357">        System.out.println(&quot;=&quot; .repeat(80));</span>

        
<span class="fc" id="L360">        Usuario admin = new Usuario();</span>
<span class="fc" id="L361">        admin.setNombre(&quot;admin&quot;);</span>
<span class="fc" id="L362">        admin.setNombres(&quot;Administrador&quot;);</span>
<span class="fc" id="L363">        admin.setApellidos(&quot;del Sistema&quot;);</span>
<span class="fc" id="L364">        admin.setEmail(&quot;admin@temporal.local&quot;); </span>
<span class="fc" id="L365">        admin.setContrasenia(passwordEncoder.encode(&quot;admin123&quot;)); </span>
<span class="fc" id="L366">        admin.setRol(Rol.ADMIN);</span>
<span class="fc" id="L367">        admin.setEstado(EstadoUsuario.ACTIVO);</span>
<span class="fc" id="L368">        admin.setActivo(true);</span>
<span class="fc" id="L369">        admin.setRequiereCambioCredenciales(true); </span>

        
<span class="fc" id="L372">        String secret = totpService.generateSecret();</span>
<span class="fc" id="L373">        admin.setTotpSecret(secret);</span>
<span class="fc" id="L374">        admin.setTotpEnabled(false); </span>

<span class="fc" id="L376">        Usuario adminGuardado = usuarioRepository.save(admin);</span>

        
        
        
<span class="fc" id="L381">        System.out.println(&quot;\n ADMINISTRADOR CREADO EXITOSAMENTE&quot;);</span>
<span class="fc" id="L382">        System.out.println(&quot;-&quot;.repeat(80));</span>
<span class="fc" id="L383">        System.out.println(&quot; Usuario: admin&quot;);</span>
<span class="fc" id="L384">        System.out.println(&quot; Contraseña temporal: admin123&quot;);</span>
<span class="fc" id="L385">        System.out.println(&quot;-&quot;.repeat(80));</span>
<span class="fc" id="L386">        System.out.println(&quot;\n  CONFIGURACIÓN INICIAL REQUERIDA&quot;);</span>
<span class="fc" id="L387">        System.out.println(&quot;-&quot;.repeat(80));</span>
<span class="fc" id="L388">        System.out.println(&quot;1. Ve a http://localhost:3000/login&quot;);</span>
<span class="fc" id="L389">        System.out.println(&quot;2. Ingresa las credenciales temporales (admin / admin123)&quot;);</span>
<span class="fc" id="L390">        System.out.println(&quot;3. Serás redirigido a configurar:&quot;);</span>
<span class="fc" id="L391">        System.out.println(&quot;   - Tu email real&quot;);</span>
<span class="fc" id="L392">        System.out.println(&quot;   - Tu contraseña segura&quot;);</span>
<span class="fc" id="L393">        System.out.println(&quot;   - Google Authenticator (2FA obligatorio)&quot;);</span>
<span class="fc" id="L394">        System.out.println(&quot;4. Recibirás códigos de respaldo (guárdalos en lugar seguro)&quot;);</span>
<span class="fc" id="L395">        System.out.println(&quot;-&quot;.repeat(80));</span>
<span class="fc" id="L396">        System.out.println(&quot;\n TIP: El sistema te guiará paso a paso en el navegador&quot;);</span>
<span class="fc" id="L397">        System.out.println(&quot;=&quot; .repeat(80));</span>
<span class="fc" id="L398">        System.out.println(&quot;\n&quot;);</span>

<span class="fc" id="L400">        return mapearEntidadADTO(adminGuardado);</span>
    }

    

    
    public Usuario guardar(Usuario usuario) {
<span class="fc" id="L407">        return usuarioRepository.save(usuario);</span>
    }

    
    public Optional&lt;Usuario&gt; buscarPorEmail(String email) {
<span class="fc" id="L412">        return usuarioRepository.findByEmail(email);</span>
    }

    
    public void cambiarContrasenia(Integer usuarioId, String nuevaContrasenia) {
<span class="fc" id="L417">        Usuario usuario = usuarioRepository.findById(usuarioId)</span>
<span class="pc" id="L418">                .orElseThrow(() -&gt; new RuntimeException(&quot;Usuario no encontrado&quot;));</span>
        
        
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">        if (passwordEncoder.matches(nuevaContrasenia, usuario.getContrasenia())) {</span>
<span class="nc" id="L422">            throw new RuntimeException(&quot;La nueva contraseña no puede ser igual a la contraseña actual&quot;);</span>
        }
        
        
<span class="fc" id="L426">        validarContrasenia(nuevaContrasenia);</span>
        
        
<span class="fc" id="L429">        usuario.setContrasenia(passwordEncoder.encode(nuevaContrasenia));</span>
<span class="fc" id="L430">        usuarioRepository.save(usuario);</span>
        
<span class="fc" id="L432">        System.out.println(&quot; Contraseña cambiada para usuario: &quot; + usuario.getNombre());</span>
<span class="fc" id="L433">    }</span>

    

    
    private void validarContrasenia(String contrasenia) {
<span class="pc bpc" id="L439" title="1 of 4 branches missed.">        if (contrasenia == null || contrasenia.trim().isEmpty()) {</span>
<span class="fc" id="L440">            throw new RuntimeException(&quot;La contraseña no puede estar vacía&quot;);</span>
        }
        
<span class="fc bfc" id="L443" title="All 2 branches covered.">        if (contrasenia.length() &lt; 8) {</span>
<span class="fc" id="L444">            throw new RuntimeException(&quot;La contraseña debe tener al menos 8 caracteres&quot;);</span>
        }
        
        
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">        if (!contrasenia.matches(&quot;.*[a-zA-Z].*&quot;)) {</span>
<span class="nc" id="L449">            throw new RuntimeException(&quot;La contraseña debe contener al menos una letra&quot;);</span>
        }
        
        
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">        if (!contrasenia.matches(&quot;.*\\d.*&quot;)) {</span>
<span class="nc" id="L454">            throw new RuntimeException(&quot;La contraseña debe contener al menos un número&quot;);</span>
        }
<span class="fc" id="L456">    }</span>

    private Usuario obtenerUsuarioActual() {
<span class="fc" id="L459">        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="pc bpc" id="L460" title="2 of 4 branches missed.">        if (auth == null || auth.getName() == null) {</span>
<span class="nc" id="L461">            throw new RuntimeException(&quot;No hay usuario autenticado&quot;);</span>
        }

<span class="fc" id="L464">        return usuarioRepository.findByNombre(auth.getName())</span>
<span class="pc" id="L465">                .orElseThrow(() -&gt; new RuntimeException(&quot;Usuario autenticado no encontrado en base de datos&quot;));</span>
    }

    private UsuarioDTO mapearEntidadADTO(Usuario usuario) {
<span class="fc" id="L469">        UsuarioDTO dto = new UsuarioDTO();</span>
<span class="fc" id="L470">        dto.setUsuarioID(usuario.getUsuarioID());</span>
<span class="fc" id="L471">        dto.setNombre(usuario.getNombre());</span>
<span class="fc" id="L472">        dto.setNombres(usuario.getNombres());</span>
<span class="fc" id="L473">        dto.setApellidos(usuario.getApellidos());</span>
<span class="fc" id="L474">        dto.setEmail(usuario.getEmail());</span>
        
        
<span class="fc" id="L477">        dto.setRol(usuario.getRol());</span>
        
        
<span class="fc bfc" id="L480" title="All 2 branches covered.">        if (usuario.getRol() != null) {</span>
<span class="fc" id="L481">            dto.setRoles(List.of(usuario.getRol().name()));</span>
        } else {
<span class="fc" id="L483">            dto.setRoles(List.of());</span>
        }
        
<span class="fc" id="L486">        dto.setEstado(usuario.getEstado());</span>
        
        
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">        if (usuario.getEstado() != null) {</span>
<span class="fc" id="L490">            dto.setEstadoSolicitud(usuario.getEstado().name());</span>
        }
        
<span class="fc" id="L493">        dto.setActivo(usuario.getActivo());</span>
        
        
<span class="fc" id="L496">        dto.setFechaCreacion(usuario.getFechaCreacion());</span>
        
        
<span class="fc bfc" id="L499" title="All 2 branches covered.">        if (usuario.getFechaCreacion() != null) {</span>
<span class="fc" id="L500">            dto.setFechaRegistro(usuario.getFechaCreacion().toString());</span>
        }
        
<span class="fc" id="L503">        dto.setFechaUltimaConexion(usuario.getFechaUltimaConexion());</span>
<span class="fc" id="L504">        dto.setNombreCompleto(usuario.getNombreCompleto());</span>
<span class="fc" id="L505">        return dto;</span>
    }

    
    public boolean esNombreUsuarioDisponible(String nombre) {
<span class="nc bnc" id="L510" title="All 4 branches missed.">        if (nombre == null || nombre.trim().isEmpty()) {</span>
<span class="nc" id="L511">            return false;</span>
        }
<span class="nc" id="L513">        return usuarioRepository.findByNombre(nombre.trim()).isEmpty();</span>
    }

    
    public boolean esEmailDisponible(String email) {
<span class="nc bnc" id="L518" title="All 4 branches missed.">        if (email == null || email.trim().isEmpty()) {</span>
<span class="nc" id="L519">            return false;</span>
        }
<span class="nc" id="L521">        return usuarioRepository.findByEmail(email.trim()).isEmpty();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>