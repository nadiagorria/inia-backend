<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">EmailServiceTest.java</span></div><h1>EmailServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import jakarta.mail.internet.MimeMessage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.test.util.ReflectionTestUtils;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de EmailService&quot;)
<span class="fc" id="L20">class EmailServiceTest {</span>

    @Mock
    private JavaMailSender mailSender;

    @Mock
    private MimeMessage mimeMessage;

    @InjectMocks
    private EmailService emailService;

    private static final String FROM_EMAIL = &quot;noreply@inia.org.uy&quot;;
    private static final String TEST_EMAIL = &quot;test@example.com&quot;;
    private static final String TEST_NOMBRE = &quot;Usuario Test&quot;;
    private static final String ANALISTA_EMAIL = &quot;analista@inia.org.uy&quot;;
    private static final String ANALISTA_NOMBRE = &quot;Analista Test&quot;;

    @BeforeEach
    void setUp() {
        // Configurar el valor de la propiedad fromEmail usando reflexión
<span class="fc" id="L40">        ReflectionTestUtils.setField(emailService, &quot;fromEmail&quot;, FROM_EMAIL);</span>
        
        // Mock del comportamiento de JavaMailSender
<span class="fc" id="L43">        when(mailSender.createMimeMessage()).thenReturn(mimeMessage);</span>
<span class="fc" id="L44">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailNuevoRegistro - debe enviar notificación a analista cuando usuario se registra&quot;)
    void enviarEmailNuevoRegistro_debeEnviarCorrectamente() {
        
<span class="fc" id="L50">        String usuarioEmail = &quot;nuevouser@example.com&quot;;</span>
<span class="fc" id="L51">        String usuarioNombre = &quot;Nuevo Usuario&quot;;</span>

        
<span class="fc" id="L54">        emailService.enviarEmailNuevoRegistro(ANALISTA_EMAIL, ANALISTA_NOMBRE, usuarioNombre, usuarioEmail);</span>

        
<span class="fc" id="L57">        verify(mailSender, times(1)).createMimeMessage();</span>
<span class="fc" id="L58">        verify(mailSender, times(1)).send(mimeMessage);</span>
<span class="fc" id="L59">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailNuevoRegistro - debe incluir datos del usuario en el contenido&quot;)
    void enviarEmailNuevoRegistro_debeIncluirDatosUsuario() {
        
<span class="fc" id="L65">        String usuarioEmail = &quot;usuario@example.com&quot;;</span>
<span class="fc" id="L66">        String usuarioNombre = &quot;Juan Pérez&quot;;</span>

        
<span class="fc" id="L69">        emailService.enviarEmailNuevoRegistro(ANALISTA_EMAIL, ANALISTA_NOMBRE, usuarioNombre, usuarioEmail);</span>

        
<span class="fc" id="L72">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L73">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L74">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailConfirmacionRegistro - debe enviar confirmación al usuario registrado&quot;)
    void enviarEmailConfirmacionRegistro_debeEnviarCorrectamente() {
        
<span class="fc" id="L80">        emailService.enviarEmailConfirmacionRegistro(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L83">        verify(mailSender, times(1)).createMimeMessage();</span>
<span class="fc" id="L84">        verify(mailSender, times(1)).send(mimeMessage);</span>
<span class="fc" id="L85">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailConfirmacionRegistro - debe notificar pendiente de aprobación&quot;)
    void enviarEmailConfirmacionRegistro_debeMostrarEstadoPendiente() {
        
<span class="fc" id="L91">        String email = &quot;pendiente@example.com&quot;;</span>
<span class="fc" id="L92">        String nombre = &quot;Usuario Pendiente&quot;;</span>

        
<span class="fc" id="L95">        emailService.enviarEmailConfirmacionRegistro(email, nombre);</span>

        
<span class="fc" id="L98">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L99">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L100">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailBienvenida - debe enviar email de bienvenida cuando usuario es aprobado&quot;)
    void enviarEmailBienvenida_debeEnviarCorrectamente() {
        
<span class="fc" id="L106">        emailService.enviarEmailBienvenida(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L109">        verify(mailSender, times(1)).createMimeMessage();</span>
<span class="fc" id="L110">        verify(mailSender, times(1)).send(mimeMessage);</span>
<span class="fc" id="L111">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailBienvenida - debe incluir enlace de inicio de sesión&quot;)
    void enviarEmailBienvenida_debeIncluirEnlaceLogin() {
        
<span class="fc" id="L117">        String email = &quot;aprobado@example.com&quot;;</span>
<span class="fc" id="L118">        String nombre = &quot;Usuario Aprobado&quot;;</span>

        
<span class="fc" id="L121">        emailService.enviarEmailBienvenida(email, nombre);</span>

        
<span class="fc" id="L124">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L125">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L126">    }</span>

    @Test
    @DisplayName(&quot;enviarCodigoRecuperacion - debe enviar código de recuperación de contraseña&quot;)
    void enviarCodigoRecuperacion_debeEnviarCorrectamente() {
        
<span class="fc" id="L132">        String codigoRecuperacion = &quot;123456&quot;;</span>

        
<span class="fc" id="L135">        emailService.enviarCodigoRecuperacion(TEST_EMAIL, TEST_NOMBRE, codigoRecuperacion);</span>

        
<span class="fc" id="L138">        verify(mailSender, times(1)).createMimeMessage();</span>
<span class="fc" id="L139">        verify(mailSender, times(1)).send(mimeMessage);</span>
<span class="fc" id="L140">    }</span>

    @Test
    @DisplayName(&quot;enviarCodigoRecuperacion - debe incluir código de 6 dígitos&quot;)
    void enviarCodigoRecuperacion_debeIncluirCodigo() {
        
<span class="fc" id="L146">        String codigo = &quot;987654&quot;;</span>
<span class="fc" id="L147">        String email = &quot;recuperar@example.com&quot;;</span>
<span class="fc" id="L148">        String nombre = &quot;Usuario Recuperar&quot;;</span>

        
<span class="fc" id="L151">        emailService.enviarCodigoRecuperacion(email, nombre, codigo);</span>

        
<span class="fc" id="L154">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L155">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L156">    }</span>

    @Test
    @DisplayName(&quot;enviarCodigoRecuperacion - debe advertir sobre validez de 10 minutos&quot;)
    void enviarCodigoRecuperacion_debeIncluirAdvertenciaValidez() {
        
<span class="fc" id="L162">        String codigo = &quot;555555&quot;;</span>

        
<span class="fc" id="L165">        emailService.enviarCodigoRecuperacion(TEST_EMAIL, TEST_NOMBRE, codigo);</span>

        
<span class="fc" id="L168">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L169">    }</span>

    @Test
    @DisplayName(&quot;enviar2FAActivado - debe enviar notificación de activación de 2FA&quot;)
    void enviar2FAActivado_debeEnviarCorrectamente() {
        
<span class="fc" id="L175">        emailService.enviar2FAActivado(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L178">        verify(mailSender, times(1)).createMimeMessage();</span>
<span class="fc" id="L179">        verify(mailSender, times(1)).send(mimeMessage);</span>
<span class="fc" id="L180">    }</span>

    @Test
    @DisplayName(&quot;enviar2FAActivado - debe informar sobre protección adicional&quot;)
    void enviar2FAActivado_debeInformarProteccion() {
        
<span class="fc" id="L186">        String email = &quot;2fa@example.com&quot;;</span>
<span class="fc" id="L187">        String nombre = &quot;Usuario Seguro&quot;;</span>

        
<span class="fc" id="L190">        emailService.enviar2FAActivado(email, nombre);</span>

        
<span class="fc" id="L193">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L194">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L195">    }</span>

    @Test
    @DisplayName(&quot;enviarNuevoDispositivo - debe enviar notificación de nuevo dispositivo de confianza&quot;)
    void enviarNuevoDispositivo_debeEnviarCorrectamente() {
        
<span class="fc" id="L201">        String nombreDispositivo = &quot;Chrome en Windows 11&quot;;</span>
<span class="fc" id="L202">        String ipAddress = &quot;192.168.1.100&quot;;</span>

        
<span class="fc" id="L205">        emailService.enviarNuevoDispositivo(TEST_EMAIL, TEST_NOMBRE, nombreDispositivo, ipAddress);</span>

        
<span class="fc" id="L208">        verify(mailSender, times(1)).createMimeMessage();</span>
<span class="fc" id="L209">        verify(mailSender, times(1)).send(mimeMessage);</span>
<span class="fc" id="L210">    }</span>

    @Test
    @DisplayName(&quot;enviarNuevoDispositivo - debe incluir información del dispositivo e IP&quot;)
    void enviarNuevoDispositivo_debeIncluirDetallesDispositivo() {
        
<span class="fc" id="L216">        String dispositivo = &quot;Firefox en Ubuntu 22.04&quot;;</span>
<span class="fc" id="L217">        String ip = &quot;10.0.0.50&quot;;</span>
<span class="fc" id="L218">        String email = &quot;dispositivo@example.com&quot;;</span>
<span class="fc" id="L219">        String nombre = &quot;Usuario Multi-Dispositivo&quot;;</span>

        
<span class="fc" id="L222">        emailService.enviarNuevoDispositivo(email, nombre, dispositivo, ip);</span>

        
<span class="fc" id="L225">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L226">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L227">    }</span>

    @Test
    @DisplayName(&quot;enviarNuevoDispositivo - debe advertir sobre validez de 30 días&quot;)
    void enviarNuevoDispositivo_debeAdvertirValidez30Dias() {
        
<span class="fc" id="L233">        String dispositivo = &quot;Safari en MacOS&quot;;</span>
<span class="fc" id="L234">        String ip = &quot;172.16.0.1&quot;;</span>

        
<span class="fc" id="L237">        emailService.enviarNuevoDispositivo(TEST_EMAIL, TEST_NOMBRE, dispositivo, ip);</span>

        
<span class="fc" id="L240">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L241">    }</span>

    @Test
    @DisplayName(&quot;enviarEmail - debe manejar error cuando falla el envío&quot;)
    void enviarEmail_debeCapturarErrorEnvio() {
        
<span class="fc" id="L247">        doThrow(new RuntimeException(&quot;Error de envío&quot;)).when(mailSender).send(any(MimeMessage.class));</span>

        
<span class="fc" id="L250">        emailService.enviarEmailBienvenida(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L253">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L254">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L255">    }</span>

    @Test
    @DisplayName(&quot;enviarEmail - debe manejar error genérico sin lanzar excepción&quot;)
    void enviarEmail_debeCapturarExcepcionGenerica() {
        
<span class="fc" id="L261">        when(mailSender.createMimeMessage()).thenThrow(new RuntimeException(&quot;Error inesperado&quot;));</span>

        
<span class="fc" id="L264">        emailService.enviarCodigoRecuperacion(TEST_EMAIL, TEST_NOMBRE, &quot;123456&quot;);</span>

        
<span class="fc" id="L267">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L268">        verify(mailSender, never()).send(any(MimeMessage.class));</span>
<span class="fc" id="L269">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailNuevoRegistro - debe usar plantilla HTML con colores INIA&quot;)
    void enviarEmailNuevoRegistro_debeUsarPlantillaHTML() {
        
<span class="fc" id="L275">        emailService.enviarEmailNuevoRegistro(ANALISTA_EMAIL, ANALISTA_NOMBRE, &quot;Usuario&quot;, &quot;user@test.com&quot;);</span>

        
<span class="fc" id="L278">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L279">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L280">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailConfirmacionRegistro - debe tener asunto correcto&quot;)
    void enviarEmailConfirmacionRegistro_debeTenerAsuntoCorrecto() {
        
<span class="fc" id="L286">        emailService.enviarEmailConfirmacionRegistro(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L289">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L290">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailBienvenida - debe tener asunto de bienvenida&quot;)
    void enviarEmailBienvenida_debeTenerAsuntoBienvenida() {
        
<span class="fc" id="L296">        emailService.enviarEmailBienvenida(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L299">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L300">    }</span>

    @Test
    @DisplayName(&quot;enviarCodigoRecuperacion - debe tener asunto de recuperación&quot;)
    void enviarCodigoRecuperacion_debeTenerAsuntoRecuperacion() {
        
<span class="fc" id="L306">        emailService.enviarCodigoRecuperacion(TEST_EMAIL, TEST_NOMBRE, &quot;999999&quot;);</span>

        
<span class="fc" id="L309">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L310">    }</span>

    @Test
    @DisplayName(&quot;enviar2FAActivado - debe tener asunto de 2FA activado&quot;)
    void enviar2FAActivado_debeTenerAsunto2FA() {
        
<span class="fc" id="L316">        emailService.enviar2FAActivado(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L319">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L320">    }</span>

    @Test
    @DisplayName(&quot;enviarNuevoDispositivo - debe tener asunto de nuevo dispositivo&quot;)
    void enviarNuevoDispositivo_debeTenerAsuntoDispositivo() {
        
<span class="fc" id="L326">        emailService.enviarNuevoDispositivo(TEST_EMAIL, TEST_NOMBRE, &quot;Device&quot;, &quot;127.0.0.1&quot;);</span>

        
<span class="fc" id="L329">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L330">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailNuevoRegistro - debe funcionar con múltiples usuarios&quot;)
    void enviarEmailNuevoRegistro_debeFuncionarConMultiplesUsuarios() {
        
<span class="fc" id="L336">        String[] usuarios = {&quot;user1@test.com&quot;, &quot;user2@test.com&quot;, &quot;user3@test.com&quot;};</span>
<span class="fc" id="L337">        String[] nombres = {&quot;Usuario 1&quot;, &quot;Usuario 2&quot;, &quot;Usuario 3&quot;};</span>

        
<span class="fc bfc" id="L340" title="All 2 branches covered.">        for (int i = 0; i &lt; usuarios.length; i++) {</span>
<span class="fc" id="L341">            emailService.enviarEmailNuevoRegistro(ANALISTA_EMAIL, ANALISTA_NOMBRE, nombres[i], usuarios[i]);</span>
        }

        
<span class="fc" id="L345">        verify(mailSender, times(3)).send(mimeMessage);</span>
<span class="fc" id="L346">    }</span>

    @Test
    @DisplayName(&quot;enviarEmailBienvenida - debe funcionar con diferentes nombres de usuario&quot;)
    void enviarEmailBienvenida_debeFuncionarConDiferentesNombres() {
        
<span class="fc" id="L352">        String[] nombres = {&quot;María García&quot;, &quot;José López&quot;, &quot;Ana Martínez&quot;};</span>

        
<span class="fc bfc" id="L355" title="All 2 branches covered.">        for (String nombre : nombres) {</span>
<span class="fc" id="L356">            emailService.enviarEmailBienvenida(TEST_EMAIL, nombre);</span>
        }

        
<span class="fc" id="L360">        verify(mailSender, times(3)).send(mimeMessage);</span>
<span class="fc" id="L361">    }</span>

    @Test
    @DisplayName(&quot;enviarCodigoRecuperacion - debe funcionar con diferentes códigos&quot;)
    void enviarCodigoRecuperacion_debeFuncionarConDiferentesCodigos() {
        
<span class="fc" id="L367">        String[] codigos = {&quot;111111&quot;, &quot;222222&quot;, &quot;333333&quot;, &quot;444444&quot;};</span>

        
<span class="fc bfc" id="L370" title="All 2 branches covered.">        for (String codigo : codigos) {</span>
<span class="fc" id="L371">            emailService.enviarCodigoRecuperacion(TEST_EMAIL, TEST_NOMBRE, codigo);</span>
        }

        
<span class="fc" id="L375">        verify(mailSender, times(4)).send(mimeMessage);</span>
<span class="fc" id="L376">    }</span>

    @Test
    @DisplayName(&quot;enviarNuevoDispositivo - debe funcionar con diferentes dispositivos e IPs&quot;)
    void enviarNuevoDispositivo_debeFuncionarConDiferentesDispositivos() {
        
<span class="fc" id="L382">        String[] dispositivos = {&quot;Chrome/Windows&quot;, &quot;Firefox/Linux&quot;, &quot;Safari/MacOS&quot;};</span>
<span class="fc" id="L383">        String[] ips = {&quot;192.168.1.1&quot;, &quot;10.0.0.1&quot;, &quot;172.16.0.1&quot;};</span>

        
<span class="fc bfc" id="L386" title="All 2 branches covered.">        for (int i = 0; i &lt; dispositivos.length; i++) {</span>
<span class="fc" id="L387">            emailService.enviarNuevoDispositivo(TEST_EMAIL, TEST_NOMBRE, dispositivos[i], ips[i]);</span>
        }

        
<span class="fc" id="L391">        verify(mailSender, times(3)).send(mimeMessage);</span>
<span class="fc" id="L392">    }</span>

    @Test
    @DisplayName(&quot;todos los métodos de envío - deben crear MimeMessage antes de enviar&quot;)
    void todosLosMetodos_debenCrearMimeMessageAntesDeEnviar() {
        
<span class="fc" id="L398">        emailService.enviarEmailNuevoRegistro(ANALISTA_EMAIL, ANALISTA_NOMBRE, &quot;User&quot;, &quot;user@test.com&quot;);</span>
<span class="fc" id="L399">        emailService.enviarEmailConfirmacionRegistro(TEST_EMAIL, TEST_NOMBRE);</span>
<span class="fc" id="L400">        emailService.enviarEmailBienvenida(TEST_EMAIL, TEST_NOMBRE);</span>
<span class="fc" id="L401">        emailService.enviarCodigoRecuperacion(TEST_EMAIL, TEST_NOMBRE, &quot;123456&quot;);</span>
<span class="fc" id="L402">        emailService.enviar2FAActivado(TEST_EMAIL, TEST_NOMBRE);</span>
<span class="fc" id="L403">        emailService.enviarNuevoDispositivo(TEST_EMAIL, TEST_NOMBRE, &quot;Device&quot;, &quot;127.0.0.1&quot;);</span>

        
<span class="fc" id="L406">        verify(mailSender, times(6)).createMimeMessage();</span>
<span class="fc" id="L407">        verify(mailSender, times(6)).send(mimeMessage);</span>
<span class="fc" id="L408">    }</span>

    @Test
    @DisplayName(&quot;enviarEmail - debe imprimir mensaje de éxito en consola&quot;)
    void enviarEmail_debeImprimirMensajeExito() {
        
<span class="fc" id="L414">        emailService.enviarEmailBienvenida(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L417">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L418">    }</span>

    @Test
    @DisplayName(&quot;enviarEmail - debe imprimir error cuando falla el envío&quot;)
    void enviarEmail_debeImprimirErrorEnvio() {
        
<span class="fc" id="L424">        doThrow(new RuntimeException(&quot;SMTP error&quot;)).when(mailSender).send(any(MimeMessage.class));</span>

        
<span class="fc" id="L427">        emailService.enviar2FAActivado(TEST_EMAIL, TEST_NOMBRE);</span>

        
<span class="fc" id="L430">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L431">        verify(mailSender).send(mimeMessage);</span>
<span class="fc" id="L432">    }</span>

    @Test
    @DisplayName(&quot;enviarEmail - debe imprimir error cuando falla con excepción genérica&quot;)
    void enviarEmail_debeImprimirErrorExcepcionGenerica() {
        
<span class="fc" id="L438">        when(mailSender.createMimeMessage()).thenThrow(new NullPointerException(&quot;Null pointer&quot;));</span>

        
<span class="fc" id="L441">        emailService.enviarNuevoDispositivo(TEST_EMAIL, TEST_NOMBRE, &quot;Device&quot;, &quot;127.0.0.1&quot;);</span>

        
<span class="fc" id="L444">        verify(mailSender).createMimeMessage();</span>
<span class="fc" id="L445">        verify(mailSender, never()).send(any(MimeMessage.class));</span>
<span class="fc" id="L446">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>