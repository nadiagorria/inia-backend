<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImportacionLegadoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">ImportacionLegadoService.java</span></div><h1>ImportacionLegadoService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.*;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.*;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.ImportacionLegadoResponseDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.ImportacionLegadoResponseDTO.ErrorImportacionDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoCatalogo;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoContacto;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


@Service
<span class="fc" id="L26">@Slf4j</span>
@RequiredArgsConstructor
public class ImportacionLegadoService {

    private final LegadoRepository legadoRepository;
    private final LoteRepository loteRepository;
    private final EspecieRepository especieRepository;
    private final CultivarRepository cultivarRepository;
    private final CatalogoCrudRepository catalogoRepository;
    private final ContactoRepository contactoRepository;

    // Mapeo de columnas del Excel (índice basado en 0)
    private static final int COL_EMPRESA = 0;           // A
    private static final int COL_COD_DOC = 1;           // B
    private static final int COL_NOM_DOC = 2;           // C
    private static final int COL_NRO_DOC = 3;           // D
    private static final int COL_DEPOSITO = 4;          // E
    private static final int COL_FAMILIA = 5;           // F
    private static final int COL_ESPECIE = 6;           // G
    private static final int COL_VARIEDAD = 7;          // H
    private static final int COL_LOTE = 8;              // I
    private static final int COL_TIPO_SEMILLA = 9;     // J
    private static final int COL_CANTIDAD = 10;         // K
    private static final int COL_PRECIO_UNIT = 11;      // L
    private static final int COL_ORIGEN = 12;           // M
    private static final int COL_UNIDAD = 13;           // N
    private static final int COL_NRO_FICHA = 14;        // O
    private static final int COL_FECHA_R = 15;          // P
    private static final int COL_GERM_C = 16;           // Q
    private static final int COL_GERM_SC = 17;          // R
    private static final int COL_PESO_1000 = 18;        // S
    private static final int COL_PURA = 19;             // T
    private static final int COL_OC = 20;               // U
    private static final int COL_PORC_OC = 21;          // V
    private static final int COL_MALEZA = 22;           // W
    private static final int COL_MALEZA_TOL = 23;       // X
    private static final int COL_MAT_INERTE = 24;       // Y
    private static final int COL_PURA_I = 25;           // Z
    private static final int COL_OC_I = 26;             // AA
    private static final int COL_MALEZA_I = 27;         // AB
    private static final int COL_MALEZA_TOL_I = 28;     // AC
    private static final int COL_MAT_INERTE_I = 29;     // AD
    private static final int COL_PESO_HEC = 30;         // AE
    private static final int COL_TRATADA = 31;          // AF
    private static final int COL_NRO_TRANS = 32;        // AG
    private static final int COL_FEC_DOC = 33;          // AH
    private static final int COL_CTA_MOV = 34;          // AI
    private static final int COL_CA_CC = 35;            // AJ
    private static final int COL_FF = 36;               // AK
    private static final int COL_TITULAR = 37;          // AL
    private static final int COL_CTA_ART = 38;          // AM
    private static final int COL_PROVEEDOR = 39;        // AN
    private static final int COL_DOC_AFECT = 40;        // AO
    private static final int COL_NRO_AFECT = 41;        // AP
    private static final int COL_MONEDA = 42;           // AQ
    private static final int COL_IMPORTE_MN = 43;       // AR
    private static final int COL_IMPORTE_MO = 44;       // AS
    private static final int COL_OBS_LOTE = 45;         // AT
    private static final int COL_STK = 46;              // AU
    private static final int COL_REFERENCIA = 47;       // AV
    private static final int COL_TIPO_TRAT_GERM = 48;   // AW
    private static final int COL_FECHA_SC_I = 49;       // AX
    private static final int COL_FECHA_C_I = 50;        // AY
    private static final int COL_GERM_TOTAL_SC_I = 51;  // AZ
    private static final int COL_GERM_TOTAL_C_I = 52;   // BA
    private static final int COL_OBS_TRANS = 53;        // BB
    private static final int COL_OTRAS_SEMILLAS_OBSER = 54; // BC
    private static final int COL_SEMILLA_PURA = 55;     // BD
    private static final int COL_SEMILLA_OTROS_CULTIVOS = 56; // BE
    private static final int COL_SEMILLA_MALEZAS = 57;  // BF
    private static final int COL_SEMILLA_MALEZAS_TOL = 58; // BG
    private static final int COL_MATERIA_INERTE = 59;   // BH

    
    @Transactional
    public ImportacionLegadoResponseDTO importarDesdeExcel(MultipartFile archivo, boolean soloValidar) {
<span class="fc" id="L102">        ImportacionLegadoResponseDTO response = new ImportacionLegadoResponseDTO();</span>
<span class="fc" id="L103">        response.setExitoso(false);</span>
<span class="fc" id="L104">        response.setTotalFilas(0);</span>
<span class="fc" id="L105">        response.setFilasImportadas(0);</span>
<span class="fc" id="L106">        response.setFilasConErrores(0);</span>
        
<span class="fc" id="L108">        try (Workbook workbook = new XSSFWorkbook(archivo.getInputStream())) {</span>
<span class="fc" id="L109">            Sheet sheet = workbook.getSheetAt(0);</span>
            
<span class="fc" id="L111">            int totalFilas = 0;</span>
<span class="fc" id="L112">            int filasImportadas = 0;</span>
<span class="fc" id="L113">            int filasConErrores = 0;</span>
            
            // Empezar desde la fila 1 (asumiendo que la fila 0 son encabezados)
<span class="fc bfc" id="L116" title="All 2 branches covered.">            for (int i = 1; i &lt;= sheet.getLastRowNum(); i++) {</span>
<span class="fc" id="L117">                Row row = sheet.getRow(i);</span>
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">                if (row == null || esFilaVacia(row)) {</span>
<span class="fc" id="L119">                    continue;</span>
                }
                
<span class="fc" id="L122">                totalFilas++;</span>
                
                try {
<span class="fc bfc" id="L125" title="All 2 branches covered.">                    if (!soloValidar) {</span>
<span class="fc" id="L126">                        procesarFila(row, i, archivo.getOriginalFilename());</span>
                    }
<span class="fc" id="L128">                    filasImportadas++;</span>
<span class="fc" id="L129">                } catch (Exception e) {</span>
<span class="fc" id="L130">                    filasConErrores++;</span>
<span class="fc" id="L131">                    response.getErrores().add(new ErrorImportacionDTO(</span>
<span class="fc" id="L132">                        i + 1, // +1 para mostrar número de fila en Excel (1-based)</span>
                        &quot;General&quot;,
<span class="fc" id="L134">                        e.getMessage(),</span>
                        &quot;&quot;
                    ));
<span class="fc" id="L137">                    log.error(&quot;Error procesando fila {}: {}&quot;, i, e.getMessage(), e);</span>
<span class="fc" id="L138">                }</span>
            }
            
<span class="fc" id="L141">            response.setTotalFilas(totalFilas);</span>
<span class="fc" id="L142">            response.setFilasImportadas(filasImportadas);</span>
<span class="fc" id="L143">            response.setFilasConErrores(filasConErrores);</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">            response.setExitoso(filasConErrores == 0);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">            response.setMensaje(soloValidar ? </span>
<span class="fc" id="L146">                &quot;Validación completada: &quot; + totalFilas + &quot; filas validadas&quot; :</span>
<span class="fc" id="L147">                &quot;Importación completada: &quot; + filasImportadas + &quot; filas importadas, &quot; + filasConErrores + &quot; con errores&quot;</span>
            );
            
<span class="fc" id="L150">        } catch (IOException e) {</span>
<span class="fc" id="L151">            response.setMensaje(&quot;Error al leer el archivo Excel: &quot; + e.getMessage());</span>
<span class="fc" id="L152">            log.error(&quot;Error al leer archivo Excel&quot;, e);</span>
<span class="fc" id="L153">        }</span>
        
<span class="fc" id="L155">        return response;</span>
    }

    
    private void procesarFila(Row row, int numeroFila, String nombreArchivo) {
        // 1. Extraer y/o crear entidades relacionadas
<span class="fc" id="L161">        Contacto empresa = obtenerOCrearEmpresa(getCellValueAsString(row, COL_EMPRESA));</span>
<span class="fc" id="L162">        Catalogo deposito = obtenerOCrearCatalogo(TipoCatalogo.DEPOSITO, getCellValueAsString(row, COL_DEPOSITO));</span>
<span class="fc" id="L163">        Especie especie = obtenerOCrearEspecie(getCellValueAsString(row, COL_ESPECIE));</span>
<span class="fc" id="L164">        Cultivar cultivar = obtenerOCrearCultivar(getCellValueAsString(row, COL_VARIEDAD), especie);</span>
<span class="fc" id="L165">        Catalogo origen = obtenerOCrearCatalogo(TipoCatalogo.ORIGEN, getCellValueAsString(row, COL_ORIGEN));</span>

        // 2. Crear o actualizar Lote
<span class="fc" id="L168">        Lote lote = crearLote(row, empresa, cultivar, deposito, origen);</span>
<span class="fc" id="L169">        lote = loteRepository.save(lote);</span>

        // 3. Crear registro Legado con el resto de la información
<span class="fc" id="L172">        Legado legado = crearLegado(row, lote, numeroFila, nombreArchivo);</span>
<span class="fc" id="L173">        legadoRepository.save(legado);</span>
<span class="fc" id="L174">    }</span>

    
    private Contacto obtenerOCrearEmpresa(String nombreEmpresa) {
<span class="pc bpc" id="L178" title="1 of 4 branches missed.">        if (nombreEmpresa == null || nombreEmpresa.trim().isEmpty()) {</span>
<span class="fc" id="L179">            return null;</span>
        }
        
        // Buscar si ya existe
<span class="fc" id="L183">        Optional&lt;Contacto&gt; existente = contactoRepository.findByNombreAndTipoAndActivoTrue(</span>
<span class="fc" id="L184">            nombreEmpresa.trim(), TipoContacto.EMPRESA</span>
        );
        
<span class="fc bfc" id="L187" title="All 2 branches covered.">        if (existente.isPresent()) {</span>
<span class="fc" id="L188">            return existente.get();</span>
        }
        
        // Crear nueva empresa
<span class="fc" id="L192">        Contacto empresa = new Contacto();</span>
<span class="fc" id="L193">        empresa.setNombre(nombreEmpresa.trim());</span>
<span class="fc" id="L194">        empresa.setContacto(&quot;Importado desde legado&quot;); // Contacto por defecto</span>
<span class="fc" id="L195">        empresa.setTipo(TipoContacto.EMPRESA);</span>
<span class="fc" id="L196">        empresa.setActivo(true);</span>
        
<span class="fc" id="L198">        return contactoRepository.save(empresa);</span>
    }

    
    private Catalogo obtenerOCrearCatalogo(TipoCatalogo tipo, String valorCompleto) {
<span class="pc bpc" id="L203" title="1 of 4 branches missed.">        if (valorCompleto == null || valorCompleto.trim().isEmpty()) {</span>
<span class="fc" id="L204">            return null;</span>
        }
        
        
<span class="fc" id="L208">        String valor = parsearValorCatalogo(valorCompleto);</span>
        
        // Buscar si ya existe
<span class="fc" id="L211">        Optional&lt;Catalogo&gt; existente = catalogoRepository.findByTipoAndValorAndActivoTrue(tipo, valor);</span>
        
<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (existente.isPresent()) {</span>
<span class="fc" id="L214">            return existente.get();</span>
        }
        
        // Crear nuevo catálogo
<span class="fc" id="L218">        Catalogo catalogo = new Catalogo();</span>
<span class="fc" id="L219">        catalogo.setTipo(tipo);</span>
<span class="fc" id="L220">        catalogo.setValor(valor);</span>
<span class="fc" id="L221">        catalogo.setActivo(true);</span>
        
<span class="fc" id="L223">        return catalogoRepository.save(catalogo);</span>
    }

    
    private Especie obtenerOCrearEspecie(String nombreCompletoEspecie) {
<span class="pc bpc" id="L228" title="2 of 4 branches missed.">        if (nombreCompletoEspecie == null || nombreCompletoEspecie.trim().isEmpty()) {</span>
<span class="nc" id="L229">            return null;</span>
        }
        
        
<span class="fc" id="L233">        String nombreComun = parsearValorCatalogo(nombreCompletoEspecie);</span>
        
        // Normalizar el nombre (trim y quitar espacios múltiples)
<span class="fc" id="L236">        nombreComun = nombreComun.trim().replaceAll(&quot;\\s+&quot;, &quot; &quot;);</span>
        
        // 1. Intentar búsqueda exacta (case-insensitive)
<span class="fc" id="L239">        Optional&lt;Especie&gt; existente = especieRepository.findByNombreComunIgnoreCase(nombreComun);</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (existente.isPresent()) {</span>
<span class="fc" id="L241">            log.debug(&quot;Especie encontrada (búsqueda exacta): {}&quot;, nombreComun);</span>
<span class="fc" id="L242">            return existente.get();</span>
        }
        
        // 2. Búsqueda flexible: el nombre de la BD puede contener el nombre buscado
<span class="fc" id="L246">        List&lt;Especie&gt; coincidencias = especieRepository.buscarPorNombreComunInicio(nombreComun);</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">        if (!coincidencias.isEmpty()) {</span>
<span class="fc" id="L248">            log.debug(&quot;Especie encontrada (búsqueda por inicio): {} -&gt; {}&quot;, nombreComun, coincidencias.get(0).getNombreComun());</span>
<span class="fc" id="L249">            return coincidencias.get(0);</span>
        }
        
        // 3. Búsqueda aún más flexible: buscar por palabras clave
        
<span class="fc" id="L254">        String nombreSinAcentos = removerAcentos(nombreComun);</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">        for (Especie especie : especieRepository.findByActivoTrue()) {</span>
<span class="fc" id="L256">            String nombreBD = removerAcentos(especie.getNombreComun());</span>
            
            // Verificar si el nombre buscado está contenido en el nombre de la BD
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">            if (nombreBD.toLowerCase().contains(nombreSinAcentos.toLowerCase())) {</span>
<span class="fc" id="L260">                log.debug(&quot;Especie encontrada (búsqueda flexible): {} -&gt; {}&quot;, nombreComun, especie.getNombreComun());</span>
<span class="fc" id="L261">                return especie;</span>
            }
            
            // Verificar si el nombre de la BD está contenido en el nombre buscado
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (nombreSinAcentos.toLowerCase().contains(nombreBD.toLowerCase())) {</span>
<span class="nc" id="L266">                log.debug(&quot;Especie encontrada (búsqueda inversa): {} -&gt; {}&quot;, nombreComun, especie.getNombreComun());</span>
<span class="nc" id="L267">                return especie;</span>
            }
<span class="nc" id="L269">        }</span>
        
        // 4. Si no existe, crear nueva especie
<span class="fc" id="L272">        log.info(&quot;Creando nueva especie: {}&quot;, nombreComun);</span>
<span class="fc" id="L273">        Especie especie = new Especie();</span>
<span class="fc" id="L274">        especie.setNombreComun(nombreComun);</span>
<span class="fc" id="L275">        especie.setNombreCientifico(&quot;&quot;); // Vacío por ahora</span>
<span class="fc" id="L276">        especie.setActivo(true);</span>
        
<span class="fc" id="L278">        return especieRepository.save(especie);</span>
    }
    
    
    private String removerAcentos(String texto) {
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">        if (texto == null) return &quot;&quot;;</span>
        
<span class="fc" id="L285">        String normalized = java.text.Normalizer.normalize(texto, java.text.Normalizer.Form.NFD);</span>
<span class="fc" id="L286">        return normalized.replaceAll(&quot;\\p{InCombiningDiacriticalMarks}+&quot;, &quot;&quot;);</span>
    }

    
    private Cultivar obtenerOCrearCultivar(String nombreCompletoCultivar, Especie especie) {
<span class="pc bpc" id="L291" title="2 of 6 branches missed.">        if (nombreCompletoCultivar == null || nombreCompletoCultivar.trim().isEmpty() || especie == null) {</span>
<span class="fc" id="L292">            return null;</span>
        }
        
        // Parsear el nombre (quitar código)
<span class="fc" id="L296">        String nombre = parsearValorCatalogo(nombreCompletoCultivar);</span>
        
        // Buscar si ya existe para esta especie
<span class="fc" id="L299">        Optional&lt;Cultivar&gt; existente = cultivarRepository.findByNombreAndEspecie_EspecieID(nombre, especie.getEspecieID());</span>
        
<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (existente.isPresent()) {</span>
<span class="fc" id="L302">            return existente.get();</span>
        }
        
        // Crear nuevo cultivar
<span class="fc" id="L306">        Cultivar cultivar = new Cultivar();</span>
<span class="fc" id="L307">        cultivar.setNombre(nombre);</span>
<span class="fc" id="L308">        cultivar.setEspecie(especie);</span>
<span class="fc" id="L309">        cultivar.setActivo(true);</span>
        
<span class="fc" id="L311">        return cultivarRepository.save(cultivar);</span>
    }

    
    private Lote crearLote(Row row, Contacto empresa, Cultivar cultivar, 
                           Catalogo deposito, Catalogo origen) {
        
<span class="fc" id="L318">        String ficha = getCellValueAsString(row, COL_NRO_FICHA);</span>
        
        // Verificar si ya existe un lote con esta ficha
<span class="fc" id="L321">        Optional&lt;Lote&gt; existente = loteRepository.findByFicha(ficha);</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">        if (existente.isPresent()) {</span>
<span class="fc" id="L323">            return existente.get(); // Reutilizar lote existente</span>
        }
        
<span class="fc" id="L326">        Lote lote = new Lote();</span>
<span class="fc" id="L327">        lote.setFicha(ficha);</span>
<span class="fc" id="L328">        lote.setCultivar(cultivar);</span>
<span class="fc" id="L329">        lote.setEmpresa(empresa);</span>
<span class="fc" id="L330">        lote.setDeposito(deposito);</span>
<span class="fc" id="L331">        lote.setOrigen(origen);</span>
        
        // Kilos limpios
<span class="fc" id="L334">        BigDecimal cantidad = getCellValueAsBigDecimal(row, COL_CANTIDAD);</span>
<span class="fc" id="L335">        lote.setKilosLimpios(cantidad);</span>
        
        // Observaciones
<span class="fc" id="L338">        lote.setObservaciones(getCellValueAsString(row, COL_OBS_LOTE));</span>
        
        // Fecha de registro (Fecha R.)
<span class="fc" id="L341">        LocalDate fechaRegistro = getCellValueAsDate(row, COL_FECHA_R);</span>
<span class="fc" id="L342">        lote.setFechaRecibo(fechaRegistro);</span>
        
<span class="fc" id="L344">        lote.setActivo(true);</span>
        
<span class="fc" id="L346">        return lote;</span>
    }

    
    private Legado crearLegado(Row row, Lote lote, int numeroFila, String nombreArchivo) {
<span class="fc" id="L351">        Legado legado = new Legado();</span>
        
<span class="fc" id="L353">        legado.setLote(lote);</span>
        
        // Datos del documento
<span class="fc" id="L356">        legado.setCodDoc(getCellValueAsString(row, COL_COD_DOC));</span>
<span class="fc" id="L357">        legado.setNomDoc(getCellValueAsString(row, COL_NOM_DOC));</span>
<span class="fc" id="L358">        legado.setNroDoc(getCellValueAsString(row, COL_NRO_DOC));</span>
<span class="fc" id="L359">        legado.setFechaDoc(getCellValueAsDate(row, COL_FEC_DOC));</span>
<span class="fc" id="L360">        legado.setFamilia(getCellValueAsString(row, COL_FAMILIA));</span>
        
        // Tipo de semilla y tratamiento
<span class="fc" id="L363">        legado.setTipoSemilla(getCellValueAsString(row, COL_TIPO_SEMILLA));</span>
<span class="fc" id="L364">        legado.setTipoTratGerm(getCellValueAsString(row, COL_TIPO_TRAT_GERM));</span>
        

        // Datos de germinación
<span class="fc" id="L368">        legado.setGermC(getCellValueAsInteger(row, COL_GERM_C));</span>
<span class="fc" id="L369">        legado.setGermSC(getCellValueAsInteger(row, COL_GERM_SC));</span>
<span class="fc" id="L370">        legado.setPeso1000(getCellValueAsBigDecimal(row, COL_PESO_1000));</span>
        
        // Datos de pureza
<span class="fc" id="L373">        legado.setPura(getCellValueAsBigDecimal(row, COL_PURA));</span>
<span class="fc" id="L374">        legado.setOc(getCellValueAsBigDecimal(row, COL_OC));</span>
<span class="fc" id="L375">        legado.setPorcOC(getCellValueAsBigDecimal(row, COL_PORC_OC));</span>
<span class="fc" id="L376">        legado.setMaleza(getCellValueAsBigDecimal(row, COL_MALEZA));</span>
<span class="fc" id="L377">        legado.setMalezaTol(getCellValueAsBigDecimal(row, COL_MALEZA_TOL));</span>
<span class="fc" id="L378">        legado.setMatInerte(getCellValueAsBigDecimal(row, COL_MAT_INERTE));</span>
        
        // Datos de pureza I
<span class="fc" id="L381">        legado.setPuraI(getCellValueAsBigDecimal(row, COL_PURA_I));</span>
<span class="fc" id="L382">        legado.setOcI(getCellValueAsBigDecimal(row, COL_OC_I));</span>
<span class="fc" id="L383">        legado.setMalezaI(getCellValueAsBigDecimal(row, COL_MALEZA_I));</span>
<span class="fc" id="L384">        legado.setMalezaTolI(getCellValueAsBigDecimal(row, COL_MALEZA_TOL_I));</span>
<span class="fc" id="L385">        legado.setMatInerteI(getCellValueAsBigDecimal(row, COL_MAT_INERTE_I));</span>
        
        // Peso HEC
<span class="fc" id="L388">        legado.setPesoHEC(getCellValueAsBigDecimal(row, COL_PESO_HEC));</span>
        
        // Datos de transacción
<span class="fc" id="L391">        legado.setNroTrans(getCellValueAsString(row, COL_NRO_TRANS));</span>
<span class="fc" id="L392">        legado.setCtaMov(getCellValueAsString(row, COL_CTA_MOV));</span>
        
        // Stock
<span class="fc" id="L395">        legado.setStk(getCellValueAsBigDecimal(row, COL_STK));</span>
        
        // Fechas adicionales
<span class="fc" id="L398">        legado.setFechaSC_I(getCellValueAsDate(row, COL_FECHA_SC_I));</span>
<span class="fc" id="L399">        legado.setFechaC_I(getCellValueAsDate(row, COL_FECHA_C_I));</span>
        
        // Germinación total
<span class="fc" id="L402">        legado.setGermTotalSC_I(getCellValueAsInteger(row, COL_GERM_TOTAL_SC_I));</span>
<span class="fc" id="L403">        legado.setGermTotalC_I(getCellValueAsInteger(row, COL_GERM_TOTAL_C_I));</span>
        
        // Observaciones
<span class="fc" id="L406">        legado.setOtrasSemillasObser(getCellValueAsString(row, COL_OTRAS_SEMILLAS_OBSER));</span>
        
        // Análisis de semillas
<span class="fc" id="L409">        legado.setSemillaPura(getCellValueAsString(row, COL_SEMILLA_PURA));</span>
<span class="fc" id="L410">        legado.setSemillaOtrosCultivos(getCellValueAsString(row, COL_SEMILLA_OTROS_CULTIVOS));</span>
<span class="fc" id="L411">        legado.setSemillaMalezas(getCellValueAsString(row, COL_SEMILLA_MALEZAS));</span>
<span class="fc" id="L412">        legado.setSemillaMalezasToleradas(getCellValueAsString(row, COL_SEMILLA_MALEZAS_TOL));</span>
<span class="fc" id="L413">        legado.setMateriaInerte(getCellValueAsString(row, COL_MATERIA_INERTE));</span>
        
        // Metadatos
<span class="fc" id="L416">        legado.setFechaImportacion(LocalDate.now());</span>
<span class="fc" id="L417">        legado.setArchivoOrigen(nombreArchivo);</span>
<span class="fc" id="L418">        legado.setFilaExcel(numeroFila);</span>
<span class="fc" id="L419">        legado.setActivo(true);</span>
        
<span class="fc" id="L421">        return legado;</span>
    }

    // MÉTODOS AUXILIARES

    
    private String parsearValorCatalogo(String valorCompleto) {
<span class="pc bpc" id="L428" title="2 of 4 branches missed.">        if (valorCompleto == null || valorCompleto.trim().isEmpty()) {</span>
<span class="nc" id="L429">            return &quot;&quot;;</span>
        }
        
        // Buscar patrón: número - texto
<span class="fc" id="L433">        Pattern pattern = Pattern.compile(&quot;^\\d+\\s*-\\s*(.+)$&quot;);</span>
<span class="fc" id="L434">        Matcher matcher = pattern.matcher(valorCompleto.trim());</span>
        
<span class="fc bfc" id="L436" title="All 2 branches covered.">        if (matcher.find()) {</span>
<span class="fc" id="L437">            return matcher.group(1).trim();</span>
        }
        
<span class="fc" id="L440">        return valorCompleto.trim();</span>
    }

    
    private String parsearCodigo(String valorCompleto) {
<span class="nc bnc" id="L445" title="All 4 branches missed.">        if (valorCompleto == null || valorCompleto.trim().isEmpty()) {</span>
<span class="nc" id="L446">            return null;</span>
        }
        
<span class="nc" id="L449">        Pattern pattern = Pattern.compile(&quot;^(\\d+)\\s*-&quot;);</span>
<span class="nc" id="L450">        Matcher matcher = pattern.matcher(valorCompleto.trim());</span>
        
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (matcher.find()) {</span>
<span class="nc" id="L453">            return matcher.group(1).trim();</span>
        }
        
        // Si no hay guión, intentar devolver solo números al inicio
<span class="nc" id="L457">        pattern = Pattern.compile(&quot;^(\\d+)&quot;);</span>
<span class="nc" id="L458">        matcher = pattern.matcher(valorCompleto.trim());</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (matcher.find()) {</span>
<span class="nc" id="L460">            return matcher.group(1).trim();</span>
        }
        
<span class="nc" id="L463">        return valorCompleto.trim();</span>
    }

    
    private boolean esFilaVacia(Row row) {
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">        if (row == null) {</span>
<span class="nc" id="L469">            return true;</span>
        }
        
<span class="fc bfc" id="L472" title="All 2 branches covered.">        for (int i = 0; i &lt; row.getLastCellNum(); i++) {</span>
<span class="fc" id="L473">            Cell cell = row.getCell(i);</span>
<span class="pc bpc" id="L474" title="1 of 4 branches missed.">            if (cell != null &amp;&amp; cell.getCellType() != CellType.BLANK) {</span>
<span class="fc" id="L475">                String value = getCellValueAsString(row, i);</span>
<span class="pc bpc" id="L476" title="2 of 4 branches missed.">                if (value != null &amp;&amp; !value.trim().isEmpty()) {</span>
<span class="fc" id="L477">                    return false;</span>
                }
            }
        }
<span class="fc" id="L481">        return true;</span>
    }

    
    private String getCellValueAsString(Row row, int columnIndex) {
<span class="fc" id="L486">        Cell cell = row.getCell(columnIndex);</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">        if (cell == null) {</span>
<span class="fc" id="L488">            return null;</span>
        }
        
<span class="pc bpc" id="L491" title="2 of 5 branches missed.">        switch (cell.getCellType()) {</span>
            case STRING:
<span class="fc" id="L493">                return cell.getStringCellValue();</span>
            case NUMERIC:
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">                if (DateUtil.isCellDateFormatted(cell)) {</span>
<span class="nc" id="L496">                    return cell.getLocalDateTimeCellValue().toString();</span>
                }
                // Formatear número como string sin notación científica
<span class="fc" id="L499">                return String.valueOf(cell.getNumericCellValue());</span>
            case BOOLEAN:
<span class="fc" id="L501">                return String.valueOf(cell.getBooleanCellValue());</span>
            case FORMULA:
<span class="nc" id="L503">                return cell.getCellFormula();</span>
            default:
<span class="nc" id="L505">                return null;</span>
        }
    }

    
    private BigDecimal getCellValueAsBigDecimal(Row row, int columnIndex) {
<span class="fc" id="L511">        Cell cell = row.getCell(columnIndex);</span>
<span class="pc bpc" id="L512" title="1 of 4 branches missed.">        if (cell == null || cell.getCellType() == CellType.BLANK) {</span>
<span class="fc" id="L513">            return null;</span>
        }
        
        try {
<span class="fc bfc" id="L517" title="All 2 branches covered.">            if (cell.getCellType() == CellType.NUMERIC) {</span>
<span class="fc" id="L518">                return BigDecimal.valueOf(cell.getNumericCellValue());</span>
<span class="fc bfc" id="L519" title="All 2 branches covered.">            } else if (cell.getCellType() == CellType.STRING) {</span>
<span class="fc" id="L520">                String value = cell.getStringCellValue().trim();</span>
<span class="fc bfc" id="L521" title="All 2 branches covered.">                if (value.isEmpty()) {</span>
<span class="fc" id="L522">                    return null;</span>
                }
                // Reemplazar coma por punto para decimales
<span class="fc" id="L525">                value = value.replace(&quot;,&quot;, &quot;.&quot;);</span>
<span class="fc" id="L526">                return new BigDecimal(value);</span>
            }
<span class="nc" id="L528">        } catch (Exception e) {</span>
<span class="nc" id="L529">            log.warn(&quot;Error convirtiendo celda a BigDecimal en columna {}: {}&quot;, columnIndex, e.getMessage());</span>
<span class="fc" id="L530">        }</span>
        
<span class="fc" id="L532">        return null;</span>
    }

    
    private Integer getCellValueAsInteger(Row row, int columnIndex) {
<span class="fc" id="L537">        BigDecimal value = getCellValueAsBigDecimal(row, columnIndex);</span>
<span class="fc bfc" id="L538" title="All 2 branches covered.">        return value != null ? value.intValue() : null;</span>
    }

    
    private LocalDate getCellValueAsDate(Row row, int columnIndex) {
<span class="fc" id="L543">        Cell cell = row.getCell(columnIndex);</span>
<span class="pc bpc" id="L544" title="1 of 4 branches missed.">        if (cell == null || cell.getCellType() == CellType.BLANK) {</span>
<span class="fc" id="L545">            return null;</span>
        }
        
        try {
<span class="pc bpc" id="L549" title="1 of 4 branches missed.">            if (cell.getCellType() == CellType.NUMERIC &amp;&amp; DateUtil.isCellDateFormatted(cell)) {</span>
<span class="fc" id="L550">                return cell.getLocalDateTimeCellValue().toLocalDate();</span>
<span class="pc bpc" id="L551" title="1 of 2 branches missed.">            } else if (cell.getCellType() == CellType.STRING) {</span>
                // Intentar parsear string como fecha
<span class="fc" id="L553">                String dateStr = cell.getStringCellValue().trim();</span>
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">                if (dateStr.isEmpty()) {</span>
<span class="nc" id="L555">                    return null;</span>
                }
                // Formato esperado: d/M/yyyy
<span class="fc" id="L558">                String[] parts = dateStr.split(&quot;/&quot;);</span>
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">                if (parts.length == 3) {</span>
<span class="fc" id="L560">                    int day = Integer.parseInt(parts[0]);</span>
<span class="fc" id="L561">                    int month = Integer.parseInt(parts[1]);</span>
<span class="fc" id="L562">                    int year = Integer.parseInt(parts[2]);</span>
<span class="fc" id="L563">                    return LocalDate.of(year, month, day);</span>
                }
            }
<span class="nc" id="L566">        } catch (Exception e) {</span>
<span class="nc" id="L567">            log.warn(&quot;Error convirtiendo celda a LocalDate en columna {}: {}&quot;, columnIndex, e.getMessage());</span>
<span class="nc" id="L568">        }</span>
        
<span class="nc" id="L570">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>