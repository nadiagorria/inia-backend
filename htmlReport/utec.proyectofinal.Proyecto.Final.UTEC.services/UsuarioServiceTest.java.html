<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">UsuarioServiceTest.java</span></div><h1>UsuarioServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockedStatic;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Usuario;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.UsuarioRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ActualizarPerfilRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.AprobarUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.GestionarUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.RegistroUsuarioRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.UsuarioDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.EstadoUsuario;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Rol;

import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@org.mockito.junit.jupiter.MockitoSettings(strictness = org.mockito.quality.Strictness.LENIENT)
@DisplayName(&quot;Tests de UsuarioService&quot;)
<span class="fc" id="L43">class UsuarioServiceTest {</span>

    @Mock
    private UsuarioRepository usuarioRepository;

    @Mock
    private PasswordEncoder passwordEncoder;

    @Mock
    private NotificacionService notificacionService;

    @Mock
    private EmailService emailService;

    @Mock
    private TotpService totpService;

    @Mock
    private BackupCodeService backupCodeService;

    @InjectMocks
    private UsuarioService usuarioService;

    private RegistroUsuarioRequestDTO registroRequestDTO;
    private Usuario usuario;
    private Usuario analista;

    @BeforeEach
    void setUp() {
        
<span class="fc" id="L73">        registroRequestDTO = new RegistroUsuarioRequestDTO();</span>
<span class="fc" id="L74">        registroRequestDTO.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L75">        registroRequestDTO.setNombres(&quot;Juan&quot;);</span>
<span class="fc" id="L76">        registroRequestDTO.setApellidos(&quot;Pérez&quot;);</span>
<span class="fc" id="L77">        registroRequestDTO.setEmail(&quot;jperez@example.com&quot;);</span>
<span class="fc" id="L78">        registroRequestDTO.setContrasenia(&quot;Password123!&quot;);</span>

<span class="fc" id="L80">        usuario = new Usuario();</span>
<span class="fc" id="L81">        usuario.setUsuarioID(1);</span>
<span class="fc" id="L82">        usuario.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L83">        usuario.setNombres(&quot;Juan&quot;);</span>
<span class="fc" id="L84">        usuario.setApellidos(&quot;Pérez&quot;);</span>
<span class="fc" id="L85">        usuario.setEmail(&quot;jperez@example.com&quot;);</span>
<span class="fc" id="L86">        usuario.setEstado(EstadoUsuario.PENDIENTE);</span>
<span class="fc" id="L87">        usuario.setActivo(false);</span>

<span class="fc" id="L89">        analista = new Usuario();</span>
<span class="fc" id="L90">        analista.setUsuarioID(2);</span>
<span class="fc" id="L91">        analista.setNombre(&quot;analista1&quot;);</span>
<span class="fc" id="L92">        analista.setNombres(&quot;Ana&quot;);</span>
<span class="fc" id="L93">        analista.setApellidos(&quot;Listas&quot;);</span>
<span class="fc" id="L94">        analista.setEmail(&quot;analista@inia.com&quot;);</span>
<span class="fc" id="L95">        analista.setRol(Rol.ANALISTA);</span>
<span class="fc" id="L96">        analista.setActivo(true);</span>
<span class="fc" id="L97">        analista.setEstado(EstadoUsuario.ACTIVO);</span>
<span class="fc" id="L98">    }</span>

    @Test
    @DisplayName(&quot;Registrar usuario - debe crear usuario en estado PENDIENTE&quot;)
    void registrarSolicitud_debeCrearUsuarioPendiente() {
        
<span class="fc" id="L104">        when(usuarioRepository.findByNombre(anyString())).thenReturn(Optional.empty());</span>
<span class="fc" id="L105">        when(usuarioRepository.findByEmail(anyString())).thenReturn(Optional.empty());</span>
<span class="fc" id="L106">        when(passwordEncoder.encode(anyString())).thenReturn(&quot;encodedPassword&quot;);</span>
<span class="fc" id="L107">        when(usuarioRepository.save(any(Usuario.class))).thenReturn(usuario);</span>
<span class="fc" id="L108">        when(usuarioRepository.findAllByRol(Rol.ANALISTA)).thenReturn(Arrays.asList(analista));</span>
<span class="fc" id="L109">        doNothing().when(notificacionService).notificarNuevoUsuario(anyLong());</span>
<span class="fc" id="L110">        doNothing().when(emailService).enviarEmailConfirmacionRegistro(anyString(), anyString());</span>
<span class="fc" id="L111">        doNothing().when(emailService).enviarEmailNuevoRegistro(anyString(), anyString(), anyString(), anyString());</span>

        
<span class="fc" id="L114">        UsuarioDTO resultado = usuarioService.registrarSolicitud(registroRequestDTO);</span>

        
<span class="fc" id="L117">        assertNotNull(resultado, &quot;El usuario registrado no debe ser nulo&quot;);</span>
<span class="fc" id="L118">        assertEquals(&quot;jperez&quot;, resultado.getNombre());</span>
<span class="fc" id="L119">        assertEquals(&quot;Juan&quot;, resultado.getNombres());</span>
<span class="fc" id="L120">        assertEquals(&quot;Pérez&quot;, resultado.getApellidos());</span>
<span class="fc" id="L121">        assertEquals(&quot;jperez@example.com&quot;, resultado.getEmail());</span>
        
<span class="fc" id="L123">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L124">        verify(passwordEncoder, times(1)).encode(&quot;Password123!&quot;);</span>
<span class="fc" id="L125">        verify(notificacionService, times(1)).notificarNuevoUsuario(anyLong());</span>
<span class="fc" id="L126">    }</span>

    @Test
    @DisplayName(&quot;Registrar usuario con nombre duplicado - debe lanzar excepción&quot;)
    void registrarSolicitud_conNombreDuplicado_debeLanzarExcepcion() {
        
<span class="fc" id="L132">        when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuario));</span>

        
<span class="fc" id="L135">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L136">            usuarioService.registrarSolicitud(registroRequestDTO);</span>
<span class="nc" id="L137">        });</span>
        
<span class="fc" id="L139">        assertEquals(&quot;El nombre de usuario ya existe&quot;, exception.getMessage());</span>
<span class="fc" id="L140">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L141">    }</span>

    @Test
    @DisplayName(&quot;Registrar usuario con email duplicado - debe lanzar excepción&quot;)
    void registrarSolicitud_conEmailDuplicado_debeLanzarExcepcion() {
        
<span class="fc" id="L147">        when(usuarioRepository.findByNombre(anyString())).thenReturn(Optional.empty());</span>
<span class="fc" id="L148">        when(usuarioRepository.findByEmail(&quot;jperez@example.com&quot;)).thenReturn(Optional.of(usuario));</span>

        
<span class="fc" id="L151">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L152">            usuarioService.registrarSolicitud(registroRequestDTO);</span>
<span class="nc" id="L153">        });</span>
        
<span class="fc" id="L155">        assertEquals(&quot;El email ya está registrado&quot;, exception.getMessage());</span>
<span class="fc" id="L156">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L157">    }</span>

    @Test
    @DisplayName(&quot;Listar solicitudes pendientes - debe retornar solo usuarios PENDIENTES&quot;)
    void listarSolicitudesPendientes_debeRetornarSoloPendientes() {
        
<span class="fc" id="L163">        Usuario usuario2 = new Usuario();</span>
<span class="fc" id="L164">        usuario2.setUsuarioID(3);</span>
<span class="fc" id="L165">        usuario2.setNombre(&quot;mgarcia&quot;);</span>
<span class="fc" id="L166">        usuario2.setEstado(EstadoUsuario.PENDIENTE);</span>
        
<span class="fc" id="L168">        when(usuarioRepository.findByEstado(EstadoUsuario.PENDIENTE))</span>
<span class="fc" id="L169">            .thenReturn(Arrays.asList(usuario, usuario2));</span>

        
<span class="fc" id="L172">        List&lt;UsuarioDTO&gt; resultado = usuarioService.listarSolicitudesPendientes();</span>

        
<span class="fc" id="L175">        assertNotNull(resultado);</span>
<span class="fc" id="L176">        assertEquals(2, resultado.size());</span>
<span class="fc" id="L177">        verify(usuarioRepository, times(1)).findByEstado(EstadoUsuario.PENDIENTE);</span>
<span class="fc" id="L178">    }</span>

    @Test
    @DisplayName(&quot;Listar solicitudes pendientes paginadas - debe retornar página correcta&quot;)
    void listarSolicitudesPendientesPaginadas_debeRetornarPaginaCorrecta() {
        
<span class="fc" id="L184">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(usuario));</span>
        
<span class="fc" id="L186">        when(usuarioRepository.findByEstado(eq(EstadoUsuario.PENDIENTE), any(Pageable.class)))</span>
<span class="fc" id="L187">            .thenReturn(usuariosPage);</span>

        
<span class="fc" id="L190">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarSolicitudesPendientesPaginadas(0, 10, null);</span>

        
<span class="fc" id="L193">        assertNotNull(resultado);</span>
<span class="fc" id="L194">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L195">        assertEquals(1, resultado.getContent().size());</span>
<span class="fc" id="L196">    }</span>

    @Test
    @DisplayName(&quot;Listar solicitudes con búsqueda - debe filtrar resultados&quot;)
    void listarSolicitudesPendientesPaginadas_conBusqueda_debeFiltrar() {
        
<span class="fc" id="L202">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(usuario));</span>
        
<span class="fc" id="L204">        when(usuarioRepository.findByEstadoAndSearchTerm(</span>
<span class="fc" id="L205">            eq(EstadoUsuario.PENDIENTE), eq(&quot;juan&quot;), any(Pageable.class)))</span>
<span class="fc" id="L206">            .thenReturn(usuariosPage);</span>

        
<span class="fc" id="L209">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarSolicitudesPendientesPaginadas(0, 10, &quot;juan&quot;);</span>

        
<span class="fc" id="L212">        assertNotNull(resultado);</span>
<span class="fc" id="L213">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L214">        verify(usuarioRepository, times(1))</span>
<span class="fc" id="L215">            .findByEstadoAndSearchTerm(eq(EstadoUsuario.PENDIENTE), eq(&quot;juan&quot;), any(Pageable.class));</span>
<span class="fc" id="L216">    }</span>

    @Test
    @DisplayName(&quot;Aprobar usuario - debe cambiar estado a APROBADO y asignar rol&quot;)
    void aprobarUsuario_debeCambiarEstadoYAsignarRol() {
        
<span class="fc" id="L222">        AprobarUsuarioRequestDTO aprobarRequest = new AprobarUsuarioRequestDTO();</span>
<span class="fc" id="L223">        aprobarRequest.setRol(Rol.ANALISTA);</span>
        
<span class="fc" id="L225">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L226">        when(usuarioRepository.save(any(Usuario.class))).thenReturn(usuario);</span>
<span class="fc" id="L227">        doNothing().when(emailService).enviarEmailBienvenida(anyString(), anyString());</span>

        
<span class="fc" id="L230">        UsuarioDTO resultado = usuarioService.aprobarUsuario(1, aprobarRequest);</span>

        
<span class="fc" id="L233">        assertNotNull(resultado);</span>
<span class="fc" id="L234">        verify(usuarioRepository, times(1)).findById(1);</span>
<span class="fc" id="L235">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L236">    }</span>

    @Test
    @DisplayName(&quot;Aprobar usuario inexistente - debe lanzar excepción&quot;)
    void aprobarUsuario_usuarioInexistente_debeLanzarExcepcion() {
        
<span class="fc" id="L242">        AprobarUsuarioRequestDTO aprobarRequest = new AprobarUsuarioRequestDTO();</span>
<span class="fc" id="L243">        aprobarRequest.setRol(Rol.ANALISTA);</span>
        
<span class="fc" id="L245">        when(usuarioRepository.findById(999)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L248">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L249">            usuarioService.aprobarUsuario(999, aprobarRequest);</span>
<span class="nc" id="L250">        });</span>
        
<span class="fc" id="L252">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L253">    }</span>

    @Test
    @DisplayName(&quot;Buscar usuario por ID - debe retornar usuario si existe&quot;)
    void buscarPorId_cuandoExiste_debeRetornarUsuario() {
        
<span class="fc" id="L259">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>

        
<span class="fc" id="L262">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorId(1);</span>

        
<span class="fc" id="L265">        assertTrue(resultado.isPresent());</span>
<span class="fc" id="L266">        assertEquals(1, resultado.get().getUsuarioID());</span>
<span class="fc" id="L267">        assertEquals(&quot;jperez&quot;, resultado.get().getNombre());</span>
<span class="fc" id="L268">    }</span>

    @Test
    @DisplayName(&quot;Buscar usuario por ID inexistente - debe retornar Optional vacío&quot;)
    void buscarPorId_cuandoNoExiste_debeRetornarOptionalVacio() {
        
<span class="fc" id="L274">        when(usuarioRepository.findById(999)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L277">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorId(999);</span>

        
<span class="fc" id="L280">        assertFalse(resultado.isPresent());</span>
<span class="fc" id="L281">    }</span>

    @Test
    @DisplayName(&quot;Gestionar usuario - debe cambiar rol y estado de usuario&quot;)
    void gestionarUsuario_debeCambiarRolYEstado() {
        
<span class="fc" id="L287">        GestionarUsuarioRequestDTO gestionRequest = new GestionarUsuarioRequestDTO();</span>
<span class="fc" id="L288">        gestionRequest.setRol(Rol.ADMIN);</span>
<span class="fc" id="L289">        gestionRequest.setActivo(true);</span>
        
<span class="fc" id="L291">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L292">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L293">            Usuario u = invocation.getArgument(0);</span>
<span class="fc" id="L294">            return u;</span>
        });

        
<span class="fc" id="L298">        UsuarioDTO resultado = usuarioService.gestionarUsuario(1, gestionRequest);</span>

        
<span class="fc" id="L301">        assertNotNull(resultado);</span>
<span class="fc" id="L302">        verify(usuarioRepository, times(1)).findById(1);</span>
<span class="fc" id="L303">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L304">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - actualiza nombres y apellidos correctamente&quot;)
    void actualizarPerfil_actualizaNombresYApellidos() {
        
<span class="fc" id="L310">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L311">        request.setNombres(&quot;Juan Carlos&quot;);</span>
<span class="fc" id="L312">        request.setApellidos(&quot;Pérez García&quot;);</span>
        
<span class="fc" id="L314">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L315">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L316">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L317">        usuarioActual.setNombres(&quot;Juan&quot;);</span>
<span class="fc" id="L318">        usuarioActual.setApellidos(&quot;Pérez&quot;);</span>
<span class="fc" id="L319">        usuarioActual.setEmail(&quot;jperez@example.com&quot;);</span>
<span class="fc" id="L320">        usuarioActual.setContrasenia(&quot;encodedPassword&quot;);</span>
        
<span class="fc" id="L322">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L323">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L324">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L326">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L327">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L328">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L329">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L330">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            
<span class="fc" id="L333">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            
<span class="fc" id="L336">            assertNotNull(resultado);</span>
<span class="fc" id="L337">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L339">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - cambia contraseña con contraseña actual correcta&quot;)
    void actualizarPerfil_cambiaContraseniaCorrectamente() {
        
<span class="fc" id="L345">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L346">        request.setContraseniaActual(&quot;oldPassword&quot;);</span>
<span class="fc" id="L347">        request.setContraseniaNueva(&quot;NewPassword123!&quot;);</span>
        
<span class="fc" id="L349">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L350">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L351">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L352">        usuarioActual.setContrasenia(&quot;encodedOldPassword&quot;);</span>
        
<span class="fc" id="L354">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L355">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L356">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L358">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L359">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L360">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L361">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L362">            when(passwordEncoder.matches(&quot;oldPassword&quot;, &quot;encodedOldPassword&quot;)).thenReturn(true);</span>
<span class="fc" id="L363">            when(passwordEncoder.encode(&quot;NewPassword123!&quot;)).thenReturn(&quot;encodedNewPassword&quot;);</span>
<span class="fc" id="L364">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            
<span class="fc" id="L367">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            
<span class="fc" id="L370">            assertNotNull(resultado);</span>
<span class="fc" id="L371">            verify(passwordEncoder, times(1)).encode(&quot;NewPassword123!&quot;);</span>
<span class="fc" id="L372">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L374">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - lanza excepción si contraseña actual es incorrecta&quot;)
    void actualizarPerfil_contraseniaActualIncorrecta_lanzaExcepcion() {
        
<span class="fc" id="L380">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L381">        request.setContraseniaActual(&quot;wrongPassword&quot;);</span>
<span class="fc" id="L382">        request.setContraseniaNueva(&quot;NewPassword123!&quot;);</span>
        
<span class="fc" id="L384">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L385">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L386">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L387">        usuarioActual.setContrasenia(&quot;encodedOldPassword&quot;);</span>
        
<span class="fc" id="L389">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L390">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L391">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L393">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L394">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L395">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L396">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L397">            when(passwordEncoder.matches(&quot;wrongPassword&quot;, &quot;encodedOldPassword&quot;)).thenReturn(false);</span>
            
            
<span class="fc" id="L400">            RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L401">                usuarioService.actualizarPerfil(request);</span>
<span class="nc" id="L402">            });</span>
            
<span class="fc" id="L404">            assertTrue(exception.getMessage().contains(&quot;Contraseña actual incorrecta&quot;));</span>
<span class="fc" id="L405">            verify(usuarioRepository, never()).save(any(Usuario.class));</span>
        }
<span class="fc" id="L407">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - sin filtros retorna todos paginados&quot;)
    void listarTodosUsuariosPaginados_sinFiltros() {
        
<span class="fc" id="L413">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(usuario, analista));</span>
        
<span class="fc" id="L415">        when(usuarioRepository.findAll(any(Pageable.class))).thenReturn(usuariosPage);</span>
        
        
<span class="fc" id="L418">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, null, null, null);</span>
        
        
<span class="fc" id="L421">        assertNotNull(resultado);</span>
<span class="fc" id="L422">        assertEquals(2, resultado.getTotalElements());</span>
<span class="fc" id="L423">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - con rol ANALISTA&quot;)
    void listarTodosUsuariosPaginados_conRolAnalista() {
        
<span class="fc" id="L429">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(analista));</span>
        
<span class="fc" id="L431">        when(usuarioRepository.findByRol(eq(Rol.ANALISTA), any(Pageable.class)))</span>
<span class="fc" id="L432">            .thenReturn(usuariosPage);</span>
        
        
<span class="fc" id="L435">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, null, Rol.ANALISTA, null);</span>
        
        
<span class="fc" id="L438">        assertNotNull(resultado);</span>
<span class="fc" id="L439">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L440">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - con activo=true&quot;)
    void listarTodosUsuariosPaginados_conActivoTrue() {
        
<span class="fc" id="L446">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(analista));</span>
        
<span class="fc" id="L448">        when(usuarioRepository.findByActivo(eq(true), any(Pageable.class)))</span>
<span class="fc" id="L449">            .thenReturn(usuariosPage);</span>
        
        
<span class="fc" id="L452">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, null, null, true);</span>
        
        
<span class="fc" id="L455">        assertNotNull(resultado);</span>
<span class="fc" id="L456">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L457">    }</span>

    @Test
    @DisplayName(&quot;listarTodosUsuariosPaginados - con búsqueda&quot;)
    void listarTodosUsuariosPaginados_conBusqueda() {
        
<span class="fc" id="L463">        Page&lt;Usuario&gt; usuariosPage = new PageImpl&lt;&gt;(Arrays.asList(analista));</span>
        
<span class="fc" id="L465">        when(usuarioRepository.findBySearchTerm(eq(&quot;ana&quot;), any(Pageable.class)))</span>
<span class="fc" id="L466">            .thenReturn(usuariosPage);</span>
        
        
<span class="fc" id="L469">        Page&lt;UsuarioDTO&gt; resultado = usuarioService.listarTodosUsuariosPaginados(0, 10, &quot;ana&quot;, null, null);</span>
        
        
<span class="fc" id="L472">        assertNotNull(resultado);</span>
<span class="fc" id="L473">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L474">    }</span>

    @Test
    @DisplayName(&quot;cambiarContrasenia - cambia contraseña correctamente&quot;)
    void cambiarContrasenia_cambiaCorrectamente() {
        
<span class="fc" id="L480">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L481">        when(passwordEncoder.encode(&quot;NewPassword123!&quot;)).thenReturn(&quot;encodedNewPassword&quot;);</span>
<span class="fc" id="L482">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
        
        
<span class="fc" id="L485">        usuarioService.cambiarContrasenia(1, &quot;NewPassword123!&quot;);</span>
        
        
<span class="fc" id="L488">        verify(passwordEncoder, times(1)).encode(&quot;NewPassword123!&quot;);</span>
<span class="fc" id="L489">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L490">    }</span>

    @Test
    @DisplayName(&quot;cambiarContrasenia - lanza excepción si contraseña vacía&quot;)
    void cambiarContrasenia_contraseniaVacia_lanzaExcepcion() {
        
<span class="fc" id="L496">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
        
        
<span class="fc" id="L499">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L500">            usuarioService.cambiarContrasenia(1, &quot;&quot;);</span>
<span class="nc" id="L501">        });</span>
        
<span class="fc" id="L503">        assertTrue(exception.getMessage().contains(&quot;no puede estar vacía&quot;));</span>
<span class="fc" id="L504">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L505">    }</span>

    @Test
    @DisplayName(&quot;cambiarContrasenia - lanza excepción si contraseña muy corta&quot;)
    void cambiarContrasenia_contraseniaMuyCorta_lanzaExcepcion() {
        
<span class="fc" id="L511">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
        
        
<span class="fc" id="L514">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L515">            usuarioService.cambiarContrasenia(1, &quot;short&quot;);</span>
<span class="nc" id="L516">        });</span>
        
<span class="fc" id="L518">        assertTrue(exception.getMessage().contains(&quot;al menos 8 caracteres&quot;));</span>
<span class="fc" id="L519">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L520">    }</span>

    @Test
    @DisplayName(&quot;rechazarSolicitud - elimina usuario pendiente&quot;)
    void rechazarSolicitud_eliminaUsuarioPendiente() {
        
<span class="fc" id="L526">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L527">        doNothing().when(notificacionService).notificarUsuarioRechazado(anyLong());</span>
<span class="fc" id="L528">        doNothing().when(usuarioRepository).delete(any(Usuario.class));</span>
        
        
<span class="fc" id="L531">        usuarioService.rechazarSolicitud(1);</span>
        
        
<span class="fc" id="L534">        verify(usuarioRepository, times(1)).delete(any(Usuario.class));</span>
<span class="fc" id="L535">        verify(notificacionService, times(1)).notificarUsuarioRechazado(1L);</span>
<span class="fc" id="L536">    }</span>

    @Test
    @DisplayName(&quot;rechazarSolicitud - lanza excepción si usuario no está pendiente&quot;)
    void rechazarSolicitud_usuarioNoEsPendiente_lanzaExcepcion() {
        
<span class="fc" id="L542">        analista.setEstado(EstadoUsuario.ACTIVO);</span>
<span class="fc" id="L543">        when(usuarioRepository.findById(2)).thenReturn(Optional.of(analista));</span>
        
        
<span class="fc" id="L546">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L547">            usuarioService.rechazarSolicitud(2);</span>
<span class="nc" id="L548">        });</span>
        
<span class="fc" id="L550">        assertTrue(exception.getMessage().contains(&quot;PENDIENTE&quot;));</span>
<span class="fc" id="L551">        verify(usuarioRepository, never()).delete(any(Usuario.class));</span>
<span class="fc" id="L552">    }</span>

    @Test
    @DisplayName(&quot;obtenerUsuarioActual - retorna usuario autenticado&quot;)
    void obtenerUsuarioActual_retornaUsuarioAutenticado() {
        
<span class="fc" id="L558">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L559">        request.setNombres(&quot;Nuevo Nombre&quot;);</span>
        
<span class="fc" id="L561">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L562">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L563">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L565">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L566">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L567">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L568">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuario));</span>
<span class="fc" id="L569">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            
<span class="fc" id="L572">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            
<span class="fc" id="L575">            assertNotNull(resultado);</span>
<span class="fc" id="L576">            verify(usuarioRepository, times(1)).findByNombre(&quot;jperez&quot;);</span>
        }
<span class="fc" id="L578">    }</span>

    @Test
    @DisplayName(&quot;crearAdminPredeterminado - crea admin con 2FA&quot;)
    void crearAdminPredeterminado_creaAdminConExito() {
        
<span class="fc" id="L584">        when(usuarioRepository.existsByRol(Rol.ADMIN)).thenReturn(false);</span>
<span class="fc" id="L585">        when(totpService.generateSecret()).thenReturn(&quot;SECRET123&quot;);</span>
<span class="fc" id="L586">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L587">            Usuario u = invocation.getArgument(0);</span>
<span class="fc" id="L588">            u.setUsuarioID(1);</span>
<span class="fc" id="L589">            return u;</span>
        });
        
        
<span class="fc" id="L593">        UsuarioDTO resultado = usuarioService.crearAdminPredeterminado();</span>
        
        
<span class="fc" id="L596">        assertNotNull(resultado);</span>
<span class="fc" id="L597">        verify(usuarioRepository, times(1)).existsByRol(Rol.ADMIN);</span>
<span class="fc" id="L598">        verify(totpService, times(1)).generateSecret();</span>
<span class="fc" id="L599">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L600">    }</span>

    @Test
    @DisplayName(&quot;crearAdminPredeterminado - lanza excepción si ya existe admin&quot;)
    void crearAdminPredeterminado_yaExisteAdmin_lanzaExcepcion() {
        
<span class="fc" id="L606">        when(usuarioRepository.existsByRol(Rol.ADMIN)).thenReturn(true);</span>
        
        
<span class="fc" id="L609">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L610">            usuarioService.crearAdminPredeterminado();</span>
<span class="nc" id="L611">        });</span>
        
<span class="fc" id="L613">        assertTrue(exception.getMessage().contains(&quot;Ya existe un administrador&quot;));</span>
<span class="fc" id="L614">        verify(usuarioRepository, never()).save(any(Usuario.class));</span>
<span class="fc" id="L615">    }</span>

    @Test
    @DisplayName(&quot;guardar - guarda usuario correctamente&quot;)
    void guardar_guardaUsuarioCorrectamente() {
        
<span class="fc" id="L621">        Usuario usuarioAGuardar = new Usuario();</span>
<span class="fc" id="L622">        usuarioAGuardar.setNombre(&quot;newuser&quot;);</span>
<span class="fc" id="L623">        usuarioAGuardar.setEmail(&quot;newuser@example.com&quot;);</span>
        
<span class="fc" id="L625">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L626">            Usuario u = invocation.getArgument(0);</span>
<span class="fc" id="L627">            u.setUsuarioID(10);</span>
<span class="fc" id="L628">            return u;</span>
        });
        
        
<span class="fc" id="L632">        Usuario resultado = usuarioService.guardar(usuarioAGuardar);</span>
        
        
<span class="fc" id="L635">        assertNotNull(resultado);</span>
<span class="fc" id="L636">        assertEquals(10, resultado.getUsuarioID());</span>
<span class="fc" id="L637">        verify(usuarioRepository, times(1)).save(usuarioAGuardar);</span>
<span class="fc" id="L638">    }</span>

    @Test
    @DisplayName(&quot;buscarPorEmail - encuentra usuario por email&quot;)
    void buscarPorEmail_encuentraUsuario() {
        
<span class="fc" id="L644">        String email = &quot;jperez@example.com&quot;;</span>
<span class="fc" id="L645">        usuario.setEmail(email);</span>
<span class="fc" id="L646">        when(usuarioRepository.findByEmail(email)).thenReturn(Optional.of(usuario));</span>
        
        
<span class="fc" id="L649">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorEmail(email);</span>
        
        
<span class="fc" id="L652">        assertTrue(resultado.isPresent());</span>
<span class="fc" id="L653">        assertEquals(email, resultado.get().getEmail());</span>
<span class="fc" id="L654">        verify(usuarioRepository, times(1)).findByEmail(email);</span>
<span class="fc" id="L655">    }</span>

    @Test
    @DisplayName(&quot;buscarPorEmail - retorna empty si no encuentra usuario&quot;)
    void buscarPorEmail_noEncuentraUsuario() {
        
<span class="fc" id="L661">        String email = &quot;noexiste@example.com&quot;;</span>
<span class="fc" id="L662">        when(usuarioRepository.findByEmail(email)).thenReturn(Optional.empty());</span>
        
        
<span class="fc" id="L665">        Optional&lt;Usuario&gt; resultado = usuarioService.buscarPorEmail(email);</span>
        
        
<span class="fc" id="L668">        assertFalse(resultado.isPresent());</span>
<span class="fc" id="L669">        verify(usuarioRepository, times(1)).findByEmail(email);</span>
<span class="fc" id="L670">    }</span>

    @Test
    @DisplayName(&quot;obtenerPerfil - retorna perfil del usuario autenticado&quot;)
    void obtenerPerfil_retornaPerfilUsuarioActual() {
        
<span class="fc" id="L676">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L677">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L678">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L680">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L681">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L682">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L683">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuario));</span>
            
            
<span class="fc" id="L686">            UsuarioDTO resultado = usuarioService.obtenerPerfil();</span>
            
            
<span class="fc" id="L689">            assertNotNull(resultado);</span>
<span class="fc" id="L690">            verify(usuarioRepository, times(1)).findByNombre(&quot;jperez&quot;);</span>
        }
<span class="fc" id="L692">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - actualiza email correctamente&quot;)
    void actualizarPerfil_actualizaEmailCorrectamente() {
        
<span class="fc" id="L698">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L699">        request.setEmail(&quot;nuevo.email@example.com&quot;);</span>
        
<span class="fc" id="L701">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L702">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L703">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L704">        usuarioActual.setEmail(&quot;viejo@example.com&quot;);</span>
        
<span class="fc" id="L706">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L707">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L708">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L710">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L711">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L712">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L713">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L714">            when(usuarioRepository.findByEmailIgnoreCase(&quot;nuevo.email@example.com&quot;)).thenReturn(Optional.empty());</span>
<span class="fc" id="L715">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            
<span class="fc" id="L718">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            
<span class="fc" id="L721">            assertNotNull(resultado);</span>
<span class="fc" id="L722">            verify(usuarioRepository, times(1)).findByEmailIgnoreCase(&quot;nuevo.email@example.com&quot;);</span>
<span class="fc" id="L723">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L725">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - lanza excepción si email ya existe&quot;)
    void actualizarPerfil_emailYaExiste_lanzaExcepcion() {
        
<span class="fc" id="L731">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L732">        request.setEmail(&quot;existente@example.com&quot;);</span>
        
<span class="fc" id="L734">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L735">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L736">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
<span class="fc" id="L737">        usuarioActual.setEmail(&quot;viejo@example.com&quot;);</span>
        
<span class="fc" id="L739">        Usuario otroUsuario = new Usuario();</span>
<span class="fc" id="L740">        otroUsuario.setUsuarioID(2);</span>
<span class="fc" id="L741">        otroUsuario.setEmail(&quot;existente@example.com&quot;);</span>
        
<span class="fc" id="L743">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L744">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L745">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L747">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L748">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L749">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L750">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L751">            when(usuarioRepository.findByEmailIgnoreCase(&quot;existente@example.com&quot;)).thenReturn(Optional.of(otroUsuario));</span>
            
            
<span class="fc" id="L754">            RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L755">                usuarioService.actualizarPerfil(request);</span>
<span class="nc" id="L756">            });</span>
            
<span class="fc" id="L758">            assertTrue(exception.getMessage().contains(&quot;email ya está en uso&quot;));</span>
<span class="fc" id="L759">            verify(usuarioRepository, never()).save(any(Usuario.class));</span>
        }
<span class="fc" id="L761">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - actualiza nombre de usuario correctamente&quot;)
    void actualizarPerfil_actualizaNombreUsuarioCorrectamente() {
        
<span class="fc" id="L767">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L768">        request.setNombre(&quot;nuevousuario&quot;);</span>
        
<span class="fc" id="L770">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L771">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L772">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
        
<span class="fc" id="L774">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L775">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L776">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L778">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L779">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L780">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L781">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L782">            when(usuarioRepository.findByNombreIgnoreCase(&quot;nuevousuario&quot;)).thenReturn(Optional.empty());</span>
<span class="fc" id="L783">            when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
            
            
<span class="fc" id="L786">            UsuarioDTO resultado = usuarioService.actualizarPerfil(request);</span>
            
            
<span class="fc" id="L789">            assertNotNull(resultado);</span>
<span class="fc" id="L790">            verify(usuarioRepository, times(1)).findByNombreIgnoreCase(&quot;nuevousuario&quot;);</span>
<span class="fc" id="L791">            verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
        }
<span class="fc" id="L793">    }</span>

    @Test
    @DisplayName(&quot;actualizarPerfil - lanza excepción si nombre de usuario ya existe&quot;)
    void actualizarPerfil_nombreUsuarioYaExiste_lanzaExcepcion() {
        
<span class="fc" id="L799">        ActualizarPerfilRequestDTO request = new ActualizarPerfilRequestDTO();</span>
<span class="fc" id="L800">        request.setNombre(&quot;usuarioexistente&quot;);</span>
        
<span class="fc" id="L802">        Usuario usuarioActual = new Usuario();</span>
<span class="fc" id="L803">        usuarioActual.setUsuarioID(1);</span>
<span class="fc" id="L804">        usuarioActual.setNombre(&quot;jperez&quot;);</span>
        
<span class="fc" id="L806">        Usuario otroUsuario = new Usuario();</span>
<span class="fc" id="L807">        otroUsuario.setUsuarioID(2);</span>
<span class="fc" id="L808">        otroUsuario.setNombre(&quot;usuarioexistente&quot;);</span>
        
<span class="fc" id="L810">        try (MockedStatic&lt;SecurityContextHolder&gt; mockedSecurityContext = mockStatic(SecurityContextHolder.class)) {</span>
<span class="fc" id="L811">            SecurityContext securityContext = mock(SecurityContext.class);</span>
<span class="fc" id="L812">            Authentication authentication = mock(Authentication.class);</span>
            
<span class="fc" id="L814">            mockedSecurityContext.when(SecurityContextHolder::getContext).thenReturn(securityContext);</span>
<span class="fc" id="L815">            when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L816">            when(authentication.getName()).thenReturn(&quot;jperez&quot;);</span>
<span class="fc" id="L817">            when(usuarioRepository.findByNombre(&quot;jperez&quot;)).thenReturn(Optional.of(usuarioActual));</span>
<span class="fc" id="L818">            when(usuarioRepository.findByNombreIgnoreCase(&quot;usuarioexistente&quot;)).thenReturn(Optional.of(otroUsuario));</span>
            
            
<span class="fc" id="L821">            RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L822">                usuarioService.actualizarPerfil(request);</span>
<span class="nc" id="L823">            });</span>
            
<span class="fc" id="L825">            assertTrue(exception.getMessage().contains(&quot;nombre de usuario ya está en uso&quot;));</span>
<span class="fc" id="L826">            verify(usuarioRepository, never()).save(any(Usuario.class));</span>
        }
<span class="fc" id="L828">    }</span>

    @Test
    @DisplayName(&quot;gestionarUsuario - actualiza estado activo/inactivo&quot;)
    void gestionarUsuario_actualizaEstadoActivo() {
        
<span class="fc" id="L834">        GestionarUsuarioRequestDTO gestionRequest = new GestionarUsuarioRequestDTO();</span>
<span class="fc" id="L835">        gestionRequest.setRol(Rol.ANALISTA);</span>
<span class="fc" id="L836">        gestionRequest.setActivo(false); </span>
        
<span class="fc" id="L838">        analista.setActivo(true); </span>
<span class="fc" id="L839">        when(usuarioRepository.findById(2)).thenReturn(Optional.of(analista));</span>
<span class="fc" id="L840">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        
<span class="fc" id="L843">        UsuarioDTO resultado = usuarioService.gestionarUsuario(2, gestionRequest);</span>

        
<span class="fc" id="L846">        assertNotNull(resultado);</span>
<span class="fc" id="L847">        verify(usuarioRepository, times(1)).findById(2);</span>
<span class="fc" id="L848">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L849">    }</span>

    @Test
    @DisplayName(&quot;gestionarUsuario - cambia rol del usuario&quot;)
    void gestionarUsuario_cambiaRol() {
        
<span class="fc" id="L855">        GestionarUsuarioRequestDTO gestionRequest = new GestionarUsuarioRequestDTO();</span>
<span class="fc" id="L856">        gestionRequest.setRol(Rol.ADMIN); </span>
<span class="fc" id="L857">        gestionRequest.setActivo(true);</span>
        
<span class="fc" id="L859">        analista.setRol(Rol.ANALISTA); </span>
<span class="fc" id="L860">        when(usuarioRepository.findById(2)).thenReturn(Optional.of(analista));</span>
<span class="fc" id="L861">        when(usuarioRepository.save(any(Usuario.class))).thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        
<span class="fc" id="L864">        UsuarioDTO resultado = usuarioService.gestionarUsuario(2, gestionRequest);</span>

        
<span class="fc" id="L867">        assertNotNull(resultado);</span>
<span class="fc" id="L868">        verify(usuarioRepository, times(1)).save(any(Usuario.class));</span>
<span class="fc" id="L869">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>