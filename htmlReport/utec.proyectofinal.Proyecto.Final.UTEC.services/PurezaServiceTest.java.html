<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PurezaServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">PurezaServiceTest.java</span></div><h1>PurezaServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pureza;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Listado;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Especie;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Cultivar;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PurezaRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.MalezasCatalogoRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ListadoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PurezaRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.MalezasCatalogoDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PurezaDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PurezaListadoDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;
import utec.proyectofinal.Proyecto.Final.UTEC.responses.ResponseListadoPureza;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de PurezaService&quot;)
<span class="fc" id="L42">class PurezaServiceTest {</span>

    @Mock
    private PurezaRepository purezaRepository;

    @Mock
    private LoteRepository loteRepository;

    @Mock
    private MalezasCatalogoRepository malezasCatalogoRepository;

    @Mock
    private AnalisisHistorialService analisisHistorialService;

    @Mock
    private AnalisisService analisisService;

    @InjectMocks
    private PurezaService purezaService;

    private PurezaRequestDTO purezaRequestDTO;
    private Lote lote;
    private Pureza pureza;

    @BeforeEach
    void setUp() {
        
<span class="fc" id="L69">        lote = new Lote();</span>
<span class="fc" id="L70">        lote.setLoteID(1L);</span>
<span class="fc" id="L71">        lote.setNomLote(&quot;LOTE-TEST-001&quot;);</span>
<span class="fc" id="L72">        lote.setActivo(true);</span>

<span class="fc" id="L74">        purezaRequestDTO = new PurezaRequestDTO();</span>
<span class="fc" id="L75">        purezaRequestDTO.setIdLote(1L);</span>
<span class="fc" id="L76">        purezaRequestDTO.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L77">        purezaRequestDTO.setPesoTotal_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L78">        purezaRequestDTO.setSemillaPura_g(BigDecimal.valueOf(95.0));</span>
<span class="fc" id="L79">        purezaRequestDTO.setMateriaInerte_g(BigDecimal.valueOf(3.0));</span>
<span class="fc" id="L80">        purezaRequestDTO.setMalezas_g(BigDecimal.valueOf(2.0));</span>

<span class="fc" id="L82">        pureza = new Pureza();</span>
<span class="fc" id="L83">        pureza.setAnalisisID(1L);</span>
<span class="fc" id="L84">        pureza.setLote(lote);</span>
<span class="fc" id="L85">        pureza.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L86">        pureza.setActivo(true);</span>
<span class="fc" id="L87">    }</span>

    @Test
    @DisplayName(&quot;Crear pureza - debe asignar estado EN_PROCESO&quot;)
    void crearPureza_debeAsignarEstadoEnProceso() {
        
<span class="fc" id="L93">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L94">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>

        
<span class="fc" id="L97">        PurezaDTO resultado = purezaService.crearPureza(purezaRequestDTO);</span>

        
<span class="fc" id="L100">        assertNotNull(resultado, &quot;El resultado no debe ser nulo&quot;);</span>
<span class="fc" id="L101">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L102">        verify(analisisHistorialService, times(1)).registrarCreacion(any(Pureza.class));</span>
<span class="fc" id="L103">    }</span>

    @Test
    @DisplayName(&quot;Crear pureza con lote inexistente - debe lanzar excepción&quot;)
    void crearPureza_conLoteInexistente_debeLanzarExcepcion() {
        
<span class="fc" id="L109">        when(loteRepository.findById(999L)).thenReturn(Optional.empty());</span>
<span class="fc" id="L110">        purezaRequestDTO.setIdLote(999L);</span>

        
<span class="fc" id="L113">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L114">            purezaService.crearPureza(purezaRequestDTO);</span>
<span class="nc" id="L115">        }, &quot;Debe lanzar excepción cuando el lote no existe&quot;);</span>
<span class="fc" id="L116">    }</span>

    @Test
    @DisplayName(&quot;Validar pesos - pesoTotal debe ser mayor o igual a pesoInicial&quot;)
    void validarPesos_pesoTotalMenorQuePesoInicial_debeLanzarExcepcion() {
        
<span class="fc" id="L122">        purezaRequestDTO.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L123">        purezaRequestDTO.setPesoTotal_g(BigDecimal.valueOf(95.0)); </span>

        
<span class="fc" id="L126">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L127">            purezaService.crearPureza(purezaRequestDTO);</span>
<span class="nc" id="L128">        }, &quot;Debe lanzar excepción cuando pesoTotal &lt; pesoInicial&quot;);</span>
<span class="fc" id="L129">    }</span>

    @Test
    @DisplayName(&quot;Obtener pureza por ID - debe retornar la pureza si existe&quot;)
    void obtenerPurezaPorId_cuandoExiste_debeRetornarPureza() {
        
<span class="fc" id="L135">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>

        
<span class="fc" id="L138">        PurezaDTO resultado = purezaService.obtenerPurezaPorId(1L);</span>

        
<span class="fc" id="L141">        assertNotNull(resultado);</span>
<span class="fc" id="L142">        assertEquals(1L, resultado.getAnalisisID());</span>
<span class="fc" id="L143">        verify(purezaRepository, times(1)).findById(1L);</span>
<span class="fc" id="L144">    }</span>

    @Test
    @DisplayName(&quot;Desactivar pureza - debe cambiar activo a false&quot;)
    void desactivarPureza_debeCambiarActivoAFalse() {
        
<span class="fc" id="L150">        doNothing().when(analisisService).desactivarAnalisis(anyLong(), any());</span>

        
<span class="fc" id="L153">        purezaService.desactivarPureza(1L);</span>

        
<span class="fc" id="L156">        verify(analisisService, times(1)).desactivarAnalisis(eq(1L), any());</span>
<span class="fc" id="L157">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - debe actualizar correctamente&quot;)
    void actualizarPureza_debeActualizarCorrectamente() {
        
<span class="fc" id="L163">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L164">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L165">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L167">        purezaRequestDTO.setSemillaPura_g(BigDecimal.valueOf(90.0));</span>
        
        
<span class="fc" id="L170">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L173">        assertNotNull(resultado);</span>
<span class="fc" id="L174">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L175">        verify(analisisHistorialService, times(1)).registrarModificacion(any(Pureza.class));</span>
<span class="fc" id="L176">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza inexistente - debe lanzar excepción&quot;)
    void actualizarPureza_conIdInexistente_debeLanzarExcepcion() {
        
<span class="fc" id="L182">        when(purezaRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L185">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L186">            purezaService.actualizarPureza(999L, purezaRequestDTO);</span>
<span class="nc" id="L187">        });</span>
<span class="fc" id="L188">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza con pesos inválidos - debe lanzar excepción&quot;)
    void actualizarPureza_conPesosInvalidos_debeLanzarExcepcion() {
        
<span class="fc" id="L194">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L195">        purezaRequestDTO.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L196">        purezaRequestDTO.setPesoTotal_g(BigDecimal.valueOf(105.0));</span>

        
<span class="fc" id="L199">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L200">            purezaService.actualizarPureza(1L, purezaRequestDTO);</span>
<span class="nc" id="L201">        });</span>
<span class="fc" id="L202">    }</span>




    @Test
    @DisplayName(&quot;Reactivar pureza - debe llamar al servicio de análisis&quot;)
    void reactivarPureza_debeLlamarServicioAnalisis() {
        
<span class="fc" id="L211">        when(analisisService.reactivarAnalisis(eq(1L), eq(purezaRepository), any())).thenReturn(new PurezaDTO());</span>

        
<span class="fc" id="L214">        PurezaDTO resultado = purezaService.reactivarPureza(1L);</span>

        
<span class="fc" id="L217">        assertNotNull(resultado);</span>
<span class="fc" id="L218">        verify(analisisService, times(1)).reactivarAnalisis(eq(1L), eq(purezaRepository), any());</span>
<span class="fc" id="L219">    }</span>



    @Test
    @DisplayName(&quot;Obtener purezas por lote - debe retornar lista filtrada&quot;)
    void obtenerPurezasPorIdLote_debeRetornarListaFiltrada() {
        
<span class="fc" id="L227">        List&lt;Pureza&gt; purezas = List.of(pureza);</span>
<span class="fc" id="L228">        when(purezaRepository.findByIdLote(1L)).thenReturn(purezas);</span>

        
<span class="fc" id="L231">        List&lt;PurezaDTO&gt; resultado = purezaService.obtenerPurezasPorIdLote(1L);</span>

        
<span class="fc" id="L234">        assertNotNull(resultado);</span>
<span class="fc" id="L235">        assertEquals(1, resultado.size());</span>
<span class="fc" id="L236">        verify(purezaRepository, times(1)).findByIdLote(1L);</span>
<span class="fc" id="L237">    }</span>

    @Test
    @DisplayName(&quot;Obtener pureza por ID inexistente - debe lanzar excepción&quot;)
    void obtenerPurezaPorId_conIdInexistente_debeLanzarExcepcion() {
        
<span class="fc" id="L243">        when(purezaRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L246">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L247">            purezaService.obtenerPurezaPorId(999L);</span>
<span class="nc" id="L248">        });</span>
<span class="fc" id="L249">    }</span>

    @Test
    @DisplayName(&quot;Validar peso inicial cero - debe lanzar excepción&quot;)
    void crearPureza_conPesoInicialCero_debeLanzarExcepcion() {
        
<span class="fc" id="L255">        purezaRequestDTO.setPesoInicial_g(BigDecimal.ZERO);</span>

        
<span class="fc" id="L258">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L259">            purezaService.crearPureza(purezaRequestDTO);</span>
<span class="nc" id="L260">        });</span>
<span class="fc" id="L261">    }</span>

    @Test
    @DisplayName(&quot;Validar peso inicial negativo - debe lanzar excepción&quot;)
    void crearPureza_conPesoInicialNegativo_debeLanzarExcepcion() {
        
<span class="fc" id="L267">        purezaRequestDTO.setPesoInicial_g(BigDecimal.valueOf(-10.0));</span>

        
<span class="fc" id="L270">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L271">            purezaService.crearPureza(purezaRequestDTO);</span>
<span class="nc" id="L272">        });</span>
<span class="fc" id="L273">    }</span>

    @Test
    @DisplayName(&quot;Finalizar análisis - debe llamar al servicio genérico&quot;)
    void finalizarAnalisis_debeLlamarServicioGenerico() {
        
<span class="fc" id="L279">        when(analisisService.finalizarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any()))</span>
<span class="fc" id="L280">            .thenReturn(new PurezaDTO());</span>

        
<span class="fc" id="L283">        PurezaDTO resultado = purezaService.finalizarAnalisis(1L);</span>

        
<span class="fc" id="L286">        assertNotNull(resultado);</span>
<span class="fc" id="L287">        verify(analisisService, times(1)).finalizarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any());</span>
<span class="fc" id="L288">    }</span>

    @Test
    @DisplayName(&quot;Aprobar análisis - debe llamar al servicio genérico&quot;)
    void aprobarAnalisis_debeLlamarServicioGenerico() {
        
<span class="fc" id="L294">        when(analisisService.aprobarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any(), any()))</span>
<span class="fc" id="L295">            .thenReturn(new PurezaDTO());</span>

        
<span class="fc" id="L298">        PurezaDTO resultado = purezaService.aprobarAnalisis(1L);</span>

        
<span class="fc" id="L301">        assertNotNull(resultado);</span>
<span class="fc" id="L302">        verify(analisisService, times(1)).aprobarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any(), any());</span>
<span class="fc" id="L303">    }</span>

    @Test
    @DisplayName(&quot;Marcar para repetir - debe llamar al servicio genérico&quot;)
    void marcarParaRepetir_debeLlamarServicioGenerico() {
        
<span class="fc" id="L309">        when(analisisService.marcarParaRepetirGenerico(eq(1L), eq(purezaRepository), any(), any()))</span>
<span class="fc" id="L310">            .thenReturn(new PurezaDTO());</span>

        
<span class="fc" id="L313">        PurezaDTO resultado = purezaService.marcarParaRepetir(1L);</span>

        
<span class="fc" id="L316">        assertNotNull(resultado);</span>
<span class="fc" id="L317">        verify(analisisService, times(1)).marcarParaRepetirGenerico(eq(1L), eq(purezaRepository), any(), any());</span>
<span class="fc" id="L318">    }</span>



    @Test
    @DisplayName(&quot;Crear pureza con lote inactivo - debe lanzar excepción&quot;)
    void crearPureza_conLoteInactivo_debeLanzarExcepcion() {
        
<span class="fc" id="L326">        lote.setActivo(false);</span>
<span class="fc" id="L327">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>

        
<span class="fc" id="L330">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L331">            purezaService.crearPureza(purezaRequestDTO);</span>
<span class="nc" id="L332">        }, &quot;Debe lanzar excepción cuando el lote está inactivo&quot;);</span>
<span class="fc" id="L333">    }</span>

    @Test
    @DisplayName(&quot;Crear pureza con otras semillas - debe guardar listados&quot;)
    void crearPureza_conOtrasSemillas_debeGuardarListados() {
        
<span class="fc" id="L339">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L340">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L342">        List&lt;ListadoRequestDTO&gt; otrasSemillas = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L343">        ListadoRequestDTO listado = new ListadoRequestDTO();</span>
<span class="fc" id="L344">        otrasSemillas.add(listado);</span>
<span class="fc" id="L345">        purezaRequestDTO.setOtrasSemillas(otrasSemillas);</span>

        
<span class="fc" id="L348">        PurezaDTO resultado = purezaService.crearPureza(purezaRequestDTO);</span>

        
<span class="fc" id="L351">        assertNotNull(resultado);</span>
<span class="fc" id="L352">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L353">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza desde solicitud - debe actualizar campos específicos&quot;)
    void actualizarPurezaDesdeSolicitud_debeActualizarCamposEspecificos() {
        
<span class="fc" id="L359">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L360">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L361">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
        
<span class="fc" id="L364">        PurezaRequestDTO solicitudParcial = new PurezaRequestDTO();</span>
<span class="fc" id="L365">        solicitudParcial.setIdLote(1L);</span>
<span class="fc" id="L366">        solicitudParcial.setCumpleEstandar(true);</span>
<span class="fc" id="L367">        solicitudParcial.setComentarios(&quot;Comentario actualizado&quot;);</span>
<span class="fc" id="L368">        solicitudParcial.setPesoInicial_g(BigDecimal.valueOf(150.0));</span>
<span class="fc" id="L369">        solicitudParcial.setPesoTotal_g(BigDecimal.valueOf(150.0));</span>

        
<span class="fc" id="L372">        PurezaDTO resultado = purezaService.actualizarPureza(1L, solicitudParcial);</span>

        
<span class="fc" id="L375">        assertNotNull(resultado);</span>
<span class="fc" id="L376">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L377">    }</span>

    @Test
    @DisplayName(&quot;Obtener purezas paginadas con filtros dinámicos&quot;)
    void obtenerPurezaPaginadasConFiltros_debeFiltrarCorrectamente() {
        
<span class="fc" id="L383">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L384">            .thenReturn(Page.empty());</span>

        
<span class="fc" id="L387">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(</span>
<span class="fc" id="L388">            Pageable.unpaged(),</span>
            &quot;LOTE-TEST&quot;,
<span class="fc" id="L390">            true,</span>
            &quot;EN_PROCESO&quot;,
<span class="fc" id="L392">            1L</span>
        );

        
<span class="fc" id="L396">        assertNotNull(resultado);</span>
<span class="fc" id="L397">        verify(purezaRepository, times(1)).findAll(any(Specification.class), any(Pageable.class));</span>
<span class="fc" id="L398">    }</span>


    @Test
    @DisplayName(&quot;Validar pesos - con pérdida mayor al 5% debe solo informar&quot;)
    void validarPesos_conPerdidaMayorAl5Porciento_debeSoloInformar() {
        
<span class="fc" id="L405">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L406">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
        
<span class="fc" id="L409">        purezaRequestDTO.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L410">        purezaRequestDTO.setPesoTotal_g(BigDecimal.valueOf(94.0)); </span>

        
<span class="fc" id="L413">        PurezaDTO resultado = purezaService.crearPureza(purezaRequestDTO);</span>

        
<span class="fc" id="L416">        assertNotNull(resultado);</span>
<span class="fc" id="L417">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L418">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a listado DTO - con lote y especie completos&quot;)
    void mapearEntidadAListadoDTO_conLoteYEspecieCompletos() {
        
<span class="fc" id="L424">        Especie especie = new Especie();</span>
<span class="fc" id="L425">        especie.setEspecieID(1L);</span>
<span class="fc" id="L426">        especie.setNombreComun(&quot;Especie Test&quot;);</span>
<span class="fc" id="L427">        especie.setNombreCientifico(&quot;Especie Cientifica Test&quot;);</span>
        
<span class="fc" id="L429">        Cultivar cultivar = new Cultivar();</span>
<span class="fc" id="L430">        cultivar.setCultivarID(1L);</span>
<span class="fc" id="L431">        cultivar.setNombre(&quot;Cultivar Test&quot;);</span>
<span class="fc" id="L432">        cultivar.setEspecie(especie);</span>
        
<span class="fc" id="L434">        lote.setNomLote(&quot;LOTE-001&quot;);</span>
<span class="fc" id="L435">        lote.setCultivar(cultivar);</span>
        
<span class="fc" id="L437">        List&lt;Pureza&gt; listaPureza = List.of(pureza);</span>
<span class="fc" id="L438">        Page&lt;Pureza&gt; page = new org.springframework.data.domain.PageImpl&lt;&gt;(listaPureza);</span>
<span class="fc" id="L439">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L440">            .thenReturn(page);</span>
<span class="fc" id="L441">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L442">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L445">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L448">        assertNotNull(resultado);</span>
<span class="fc" id="L449">        assertFalse(resultado.isEmpty());</span>
<span class="fc" id="L450">        PurezaListadoDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L451">        assertEquals(1L, dto.getAnalisisID());</span>
<span class="fc" id="L452">        assertEquals(&quot;LOTE-001&quot;, dto.getLote());</span>
<span class="fc" id="L453">        assertEquals(&quot;Especie Test&quot;, dto.getEspecie());</span>
<span class="fc" id="L454">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a listado DTO - con nombre común vacío usa nombre científico&quot;)
    void mapearEntidadAListadoDTO_nombreComunVacio_usaNombreCientifico() {
        
<span class="fc" id="L460">        Especie especie = new Especie();</span>
<span class="fc" id="L461">        especie.setEspecieID(1L);</span>
<span class="fc" id="L462">        especie.setNombreComun(null);</span>
<span class="fc" id="L463">        especie.setNombreCientifico(&quot;Nombre Científico Test&quot;);</span>
        
<span class="fc" id="L465">        Cultivar cultivar = new Cultivar();</span>
<span class="fc" id="L466">        cultivar.setCultivarID(1L);</span>
<span class="fc" id="L467">        cultivar.setNombre(&quot;Cultivar Test&quot;);</span>
<span class="fc" id="L468">        cultivar.setEspecie(especie);</span>
        
<span class="fc" id="L470">        lote.setCultivar(cultivar);</span>
        
<span class="fc" id="L472">        List&lt;Pureza&gt; listaPureza = List.of(pureza);</span>
<span class="fc" id="L473">        Page&lt;Pureza&gt; page = new org.springframework.data.domain.PageImpl&lt;&gt;(listaPureza);</span>
<span class="fc" id="L474">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L475">            .thenReturn(page);</span>
<span class="fc" id="L476">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L477">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L480">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L483">        assertNotNull(resultado);</span>
<span class="fc" id="L484">        assertFalse(resultado.isEmpty());</span>
<span class="fc" id="L485">        PurezaListadoDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L486">        assertEquals(&quot;Nombre Científico Test&quot;, dto.getEspecie());</span>
<span class="fc" id="L487">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a listado DTO - sin cultivar no debe fallar&quot;)
    void mapearEntidadAListadoDTO_sinCultivar_noDebeFallar() {
        
<span class="fc" id="L493">        lote.setCultivar(null);</span>
        
<span class="fc" id="L495">        List&lt;Pureza&gt; listaPureza = List.of(pureza);</span>
<span class="fc" id="L496">        Page&lt;Pureza&gt; page = new org.springframework.data.domain.PageImpl&lt;&gt;(listaPureza);</span>
<span class="fc" id="L497">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L498">            .thenReturn(page);</span>
<span class="fc" id="L499">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L500">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L503">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L506">        assertNotNull(resultado);</span>
<span class="fc" id="L507">        assertFalse(resultado.isEmpty());</span>
<span class="fc" id="L508">        PurezaListadoDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L509">        assertNull(dto.getEspecie());</span>
<span class="fc" id="L510">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a listado DTO - sin lote no debe fallar&quot;)
    void mapearEntidadAListadoDTO_sinLote_noDebeFallar() {
        
<span class="fc" id="L516">        pureza.setLote(null);</span>
        
<span class="fc" id="L518">        List&lt;Pureza&gt; listaPureza = List.of(pureza);</span>
<span class="fc" id="L519">        Page&lt;Pureza&gt; page = new org.springframework.data.domain.PageImpl&lt;&gt;(listaPureza);</span>
<span class="fc" id="L520">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L521">            .thenReturn(page);</span>
<span class="fc" id="L522">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L523">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L526">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L529">        assertNotNull(resultado);</span>
<span class="fc" id="L530">        assertFalse(resultado.isEmpty());</span>
<span class="fc" id="L531">        PurezaListadoDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L532">        assertNull(dto.getIdLote());</span>
<span class="fc" id="L533">        assertNull(dto.getLote());</span>
<span class="fc" id="L534">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a listado DTO - con historial de usuario&quot;)
    void mapearEntidadAListadoDTO_conHistorial_debeMostrarUsuario() {
        
<span class="fc" id="L540">        var historial = new ArrayList&lt;utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.AnalisisHistorialDTO&gt;();</span>
<span class="fc" id="L541">        var registro = new utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.AnalisisHistorialDTO();</span>
<span class="fc" id="L542">        registro.setUsuario(&quot;usuario_test@test.com&quot;);</span>
<span class="fc" id="L543">        historial.add(registro);</span>
        
<span class="fc" id="L545">        List&lt;Pureza&gt; listaPureza = List.of(pureza);</span>
<span class="fc" id="L546">        Page&lt;Pureza&gt; page = new org.springframework.data.domain.PageImpl&lt;&gt;(listaPureza);</span>
<span class="fc" id="L547">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L548">            .thenReturn(page);</span>
<span class="fc" id="L549">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L550">            .thenReturn(historial);</span>

        
<span class="fc" id="L553">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L556">        assertNotNull(resultado);</span>
<span class="fc" id="L557">        assertFalse(resultado.isEmpty());</span>
<span class="fc" id="L558">        PurezaListadoDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L559">        assertEquals(&quot;usuario_test@test.com&quot;, dto.getUsuarioCreador());</span>
<span class="fc" id="L560">    }</span>

    @Test
    @DisplayName(&quot;Validar antes de finalizar - sin datos debe lanzar excepción&quot;)
    void validarAntesDeFinalizar_sinDatos_debeLanzarExcepcion() {
        
<span class="fc" id="L566">        Pureza purezaVacia = new Pureza();</span>
<span class="fc" id="L567">        purezaVacia.setAnalisisID(1L);</span>
<span class="fc" id="L568">        purezaVacia.setLote(lote);</span>
<span class="fc" id="L569">        purezaVacia.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L570">        purezaVacia.setActivo(true);</span>
        
<span class="fc" id="L572">        when(analisisService.finalizarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any()))</span>
<span class="fc" id="L573">            .thenThrow(new RuntimeException(&quot;No se puede finalizar: el análisis de Pureza carece de evidencia&quot;));</span>

        
<span class="fc" id="L576">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L577">            purezaService.finalizarAnalisis(1L);</span>
<span class="nc" id="L578">        });</span>
<span class="fc" id="L579">    }</span>

    @Test
    @DisplayName(&quot;Validar antes de finalizar - con datos INASE debe pasar&quot;)
    void validarAntesDeFinalizar_conDatosINASE_debeValidar() {
        
<span class="fc" id="L585">        pureza.setInaseFecha(java.time.LocalDate.now());</span>
<span class="fc" id="L586">        pureza.setInasePura(BigDecimal.valueOf(95.0));</span>
<span class="fc" id="L587">        pureza.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L588">        pureza.setPesoTotal_g(BigDecimal.valueOf(100.0));</span>
        
<span class="fc" id="L590">        when(analisisService.finalizarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any()))</span>
<span class="fc" id="L591">            .thenReturn(mapearEntidadADTO(pureza));</span>

        
<span class="fc" id="L594">        PurezaDTO resultado = purezaService.finalizarAnalisis(1L);</span>

        
<span class="fc" id="L597">        assertNotNull(resultado);</span>
<span class="fc" id="L598">    }</span>

    @Test
    @DisplayName(&quot;Validar antes de finalizar - con listados debe pasar&quot;)
    void validarAntesDeFinalizar_conListados_debeValidar() {
        
<span class="fc" id="L604">        pureza.setListados(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L605">        pureza.getListados().add(new Listado());</span>
<span class="fc" id="L606">        pureza.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L607">        pureza.setPesoTotal_g(BigDecimal.valueOf(100.0));</span>
        
<span class="fc" id="L609">        when(analisisService.finalizarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any()))</span>
<span class="fc" id="L610">            .thenReturn(mapearEntidadADTO(pureza));</span>

        
<span class="fc" id="L613">        PurezaDTO resultado = purezaService.finalizarAnalisis(1L);</span>

        
<span class="fc" id="L616">        assertNotNull(resultado);</span>
<span class="fc" id="L617">    }</span>

    @Test
    @DisplayName(&quot;Obtener purezas paginadas - debe retornar página vacía cuando no hay datos&quot;)
    void obtenerPurezasPaginadas_sinDatos_debeRetornarPaginaVacia() {
        
<span class="fc" id="L623">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L624">            .thenReturn(Page.empty());</span>

        
<span class="fc" id="L627">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L630">        assertNotNull(resultado);</span>
<span class="fc" id="L631">        assertTrue(resultado.isEmpty());</span>
<span class="fc" id="L632">    }</span>

    @Test
    @DisplayName(&quot;Obtener purezas con filtros - todos los parámetros&quot;)
    void obtenerPurezasConFiltros_todosParametros_debeFiltrar() {
        
<span class="fc" id="L638">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L639">            .thenReturn(Page.empty());</span>

        
<span class="fc" id="L642">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(</span>
<span class="fc" id="L643">            Pageable.unpaged(),</span>
            null,
            null,
            null,
            null
        );

        
<span class="fc" id="L651">        assertNotNull(resultado);</span>
<span class="fc" id="L652">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a DTO - con todos los campos completos&quot;)
    void mapearEntidadADTO_conTodosLosCampos_debeMapearCorrectamente() {
        
<span class="fc" id="L658">        pureza.setCumpleEstandar(true);</span>
<span class="fc" id="L659">        pureza.setComentarios(&quot;Test comentario&quot;);</span>
<span class="fc" id="L660">        pureza.setListados(new ArrayList&lt;&gt;());</span>
        
<span class="fc" id="L662">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L663">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L664">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L667">        PurezaDTO resultado = purezaService.obtenerPurezaPorId(1L);</span>

        
<span class="fc" id="L670">        assertNotNull(resultado);</span>
<span class="fc" id="L671">        assertEquals(1L, resultado.getAnalisisID());</span>
<span class="fc" id="L672">    }</span>

    
    private PurezaDTO mapearEntidadADTO(Pureza pureza) {
<span class="fc" id="L676">        PurezaDTO dto = new PurezaDTO();</span>
<span class="fc" id="L677">        dto.setAnalisisID(pureza.getAnalisisID());</span>
<span class="fc" id="L678">        dto.setEstado(pureza.getEstado());</span>
<span class="fc" id="L679">        dto.setFechaInicio(pureza.getFechaInicio());</span>
<span class="fc" id="L680">        dto.setFechaFin(pureza.getFechaFin());</span>
<span class="fc" id="L681">        return dto;</span>
    }

    @Test
    @DisplayName(&quot;Actualizar pureza - cambio de estado de APROBADO a PENDIENTE_APROBACION cuando es analista&quot;)
    void actualizarPureza_estadoAprobadoComoAnalista_debeCambiarAPendienteAprobacion() {
        
<span class="fc" id="L688">        pureza.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L689">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L690">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L691">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
<span class="fc" id="L692">        when(analisisService.esAnalista()).thenReturn(true);</span>
        
        
<span class="fc" id="L695">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L698">        assertNotNull(resultado);</span>
<span class="fc" id="L699">        verify(analisisService, times(1)).esAnalista();</span>
<span class="fc" id="L700">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L701">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - estado APROBADO como admin mantiene estado&quot;)
    void actualizarPureza_estadoAprobadoComoAdmin_mantienEstado() {
        
<span class="fc" id="L707">        pureza.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L708">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L709">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L710">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
<span class="fc" id="L711">        when(analisisService.esAnalista()).thenReturn(false);</span>
        
        
<span class="fc" id="L714">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L717">        assertNotNull(resultado);</span>
<span class="fc" id="L718">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L719">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - con lote inexistente debe lanzar excepción&quot;)
    void actualizarPureza_conLoteInexistente_debeLanzarExcepcion() {
        
<span class="fc" id="L725">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L726">        when(loteRepository.findById(999L)).thenReturn(Optional.empty());</span>
<span class="fc" id="L727">        purezaRequestDTO.setIdLote(999L);</span>

        
<span class="fc" id="L730">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L731">            purezaService.actualizarPureza(1L, purezaRequestDTO);</span>
<span class="nc" id="L732">        });</span>
<span class="fc" id="L733">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - con todas las actualizaciones de campos INASE&quot;)
    void actualizarPureza_actualizarCamposINASE_debeActualizarCorrectamente() {
        
<span class="fc" id="L739">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L740">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L741">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L743">        purezaRequestDTO.setInasePura(BigDecimal.valueOf(96.0));</span>
<span class="fc" id="L744">        purezaRequestDTO.setInaseMateriaInerte(BigDecimal.valueOf(2.5));</span>
<span class="fc" id="L745">        purezaRequestDTO.setInaseOtrosCultivos(BigDecimal.valueOf(1.0));</span>
<span class="fc" id="L746">        purezaRequestDTO.setInaseMalezas(BigDecimal.valueOf(0.5));</span>
<span class="fc" id="L747">        purezaRequestDTO.setInaseMalezasToleradas(BigDecimal.valueOf(0.0));</span>
<span class="fc" id="L748">        purezaRequestDTO.setInaseMalezasTolCero(BigDecimal.valueOf(0.0));</span>
<span class="fc" id="L749">        purezaRequestDTO.setInaseFecha(java.time.LocalDate.now());</span>
        
        
<span class="fc" id="L752">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L755">        assertNotNull(resultado);</span>
<span class="fc" id="L756">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L757">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - con todas las actualizaciones de campos Redon&quot;)
    void actualizarPureza_actualizarCamposRedon_debeActualizarCorrectamente() {
        
<span class="fc" id="L763">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L764">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L765">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L767">        purezaRequestDTO.setRedonSemillaPura(BigDecimal.valueOf(95.5));</span>
<span class="fc" id="L768">        purezaRequestDTO.setRedonMateriaInerte(BigDecimal.valueOf(2.0));</span>
<span class="fc" id="L769">        purezaRequestDTO.setRedonOtrosCultivos(BigDecimal.valueOf(1.5));</span>
<span class="fc" id="L770">        purezaRequestDTO.setRedonMalezas(BigDecimal.valueOf(0.5));</span>
<span class="fc" id="L771">        purezaRequestDTO.setRedonMalezasToleradas(BigDecimal.valueOf(0.5));</span>
<span class="fc" id="L772">        purezaRequestDTO.setRedonMalezasTolCero(BigDecimal.valueOf(0.0));</span>
<span class="fc" id="L773">        purezaRequestDTO.setRedonPesoTotal(BigDecimal.valueOf(100.0));</span>
        
        
<span class="fc" id="L776">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L779">        assertNotNull(resultado);</span>
<span class="fc" id="L780">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L781">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - agregar listados vacíos debe limpiar lista&quot;)
    void actualizarPureza_conListadosVacios_debeLimpiarLista() {
        
<span class="fc" id="L787">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L788">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L789">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L791">        pureza.setListados(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L792">        pureza.getListados().add(new Listado());</span>
        
<span class="fc" id="L794">        purezaRequestDTO.setOtrasSemillas(new ArrayList&lt;&gt;()); </span>
        
        
<span class="fc" id="L797">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L800">        assertNotNull(resultado);</span>
<span class="fc" id="L801">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L802">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - inicializar lista de listados si es null&quot;)
    void actualizarPureza_inicializarListadosSiEsNull_debeCrearLista() {
        
<span class="fc" id="L808">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L809">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L810">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L812">        pureza.setListados(null);</span>
        
<span class="fc" id="L814">        List&lt;ListadoRequestDTO&gt; nuevosListados = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L815">        ListadoRequestDTO listado = new ListadoRequestDTO();</span>
<span class="fc" id="L816">        nuevosListados.add(listado);</span>
<span class="fc" id="L817">        purezaRequestDTO.setOtrasSemillas(nuevosListados);</span>
        
        
<span class="fc" id="L820">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L823">        assertNotNull(resultado);</span>
<span class="fc" id="L824">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L825">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - actualizar todos los campos de fecha y comentarios&quot;)
    void actualizarPureza_actualizarFechaYComentarios_debeActualizarCorrectamente() {
        
<span class="fc" id="L831">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L832">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L833">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L835">        purezaRequestDTO.setFecha(java.time.LocalDate.now());</span>
<span class="fc" id="L836">        purezaRequestDTO.setComentarios(&quot;Comentario actualizado&quot;);</span>
<span class="fc" id="L837">        purezaRequestDTO.setCumpleEstandar(false);</span>
        
        
<span class="fc" id="L840">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L843">        assertNotNull(resultado);</span>
<span class="fc" id="L844">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L845">    }</span>

    @Test
    @DisplayName(&quot;Actualizar pureza - actualizar todos los campos de pesos en gramos&quot;)
    void actualizarPureza_actualizarPesosGramos_debeActualizarCorrectamente() {
        
<span class="fc" id="L851">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L852">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L853">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L855">        purezaRequestDTO.setSemillaPura_g(BigDecimal.valueOf(92.0));</span>
<span class="fc" id="L856">        purezaRequestDTO.setMateriaInerte_g(BigDecimal.valueOf(4.0));</span>
<span class="fc" id="L857">        purezaRequestDTO.setOtrosCultivos_g(BigDecimal.valueOf(2.0));</span>
<span class="fc" id="L858">        purezaRequestDTO.setMalezas_g(BigDecimal.valueOf(1.0));</span>
<span class="fc" id="L859">        purezaRequestDTO.setMalezasToleradas_g(BigDecimal.valueOf(0.5));</span>
<span class="fc" id="L860">        purezaRequestDTO.setMalezasTolCero_g(BigDecimal.valueOf(0.5));</span>
        
        
<span class="fc" id="L863">        PurezaDTO resultado = purezaService.actualizarPureza(1L, purezaRequestDTO);</span>

        
<span class="fc" id="L866">        assertNotNull(resultado);</span>
<span class="fc" id="L867">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L868">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a DTO - con lote y cultivar completos&quot;)
    void mapearEntidadADTO_conLoteYCultivarCompletos_debeIncluirTodosDatos() {
        
<span class="fc" id="L874">        Especie especie = new Especie();</span>
<span class="fc" id="L875">        especie.setEspecieID(1L);</span>
<span class="fc" id="L876">        especie.setNombreComun(&quot;Trigo&quot;);</span>
        
<span class="fc" id="L878">        Cultivar cultivar = new Cultivar();</span>
<span class="fc" id="L879">        cultivar.setCultivarID(1L);</span>
<span class="fc" id="L880">        cultivar.setNombre(&quot;Cultivar Premium&quot;);</span>
<span class="fc" id="L881">        cultivar.setEspecie(especie);</span>
        
<span class="fc" id="L883">        lote.setCultivar(cultivar);</span>
<span class="fc" id="L884">        lote.setFicha(&quot;FICHA-001&quot;);</span>
        
<span class="fc" id="L886">        pureza.setRedonSemillaPura(BigDecimal.valueOf(95.5));</span>
        
<span class="fc" id="L888">        when(purezaRepository.findById(1L)).thenReturn(Optional.of(pureza));</span>
<span class="fc" id="L889">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L890">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L893">        PurezaDTO resultado = purezaService.obtenerPurezaPorId(1L);</span>

        
<span class="fc" id="L896">        assertNotNull(resultado);</span>
<span class="fc" id="L897">        assertEquals(1L, resultado.getAnalisisID());</span>
<span class="fc" id="L898">    }</span>

    @Test
    @DisplayName(&quot;Validar antes de finalizar - con datos Redon debe pasar&quot;)
    void validarAntesDeFinalizar_conDatosRedon_debeValidar() {
        
<span class="fc" id="L904">        pureza.setRedonSemillaPura(BigDecimal.valueOf(95.0));</span>
<span class="fc" id="L905">        pureza.setPesoInicial_g(BigDecimal.valueOf(100.0));</span>
<span class="fc" id="L906">        pureza.setPesoTotal_g(BigDecimal.valueOf(100.0));</span>
        
<span class="fc" id="L908">        when(analisisService.finalizarAnalisisGenerico(eq(1L), eq(purezaRepository), any(), any()))</span>
<span class="fc" id="L909">            .thenReturn(mapearEntidadADTO(pureza));</span>

        
<span class="fc" id="L912">        PurezaDTO resultado = purezaService.finalizarAnalisis(1L);</span>

        
<span class="fc" id="L915">        assertNotNull(resultado);</span>
<span class="fc" id="L916">    }</span>

    @Test
    @DisplayName(&quot;Validar pesos - con pesos null no debe validar&quot;)
    void validarPesos_pesosNull_noDebeValidar() {
        
<span class="fc" id="L922">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L923">        when(purezaRepository.save(any(Pureza.class))).thenReturn(pureza);</span>
        
<span class="fc" id="L925">        purezaRequestDTO.setPesoInicial_g(null);</span>
<span class="fc" id="L926">        purezaRequestDTO.setPesoTotal_g(null);</span>

        
<span class="fc" id="L929">        PurezaDTO resultado = purezaService.crearPureza(purezaRequestDTO);</span>

        
<span class="fc" id="L932">        assertNotNull(resultado);</span>
<span class="fc" id="L933">        verify(purezaRepository, times(1)).save(any(Pureza.class));</span>
<span class="fc" id="L934">    }</span>

    @Test
    @DisplayName(&quot;Mapear entidad a listado DTO - con nombre común con espacios usa nombre científico&quot;)
    void mapearEntidadAListadoDTO_nombreComunConEspacios_usaNombreCientifico() {
        
<span class="fc" id="L940">        Especie especie = new Especie();</span>
<span class="fc" id="L941">        especie.setEspecieID(1L);</span>
<span class="fc" id="L942">        especie.setNombreComun(&quot;   &quot;);</span>
<span class="fc" id="L943">        especie.setNombreCientifico(&quot;Nombre Científico&quot;);</span>
        
<span class="fc" id="L945">        Cultivar cultivar = new Cultivar();</span>
<span class="fc" id="L946">        cultivar.setCultivarID(1L);</span>
<span class="fc" id="L947">        cultivar.setEspecie(especie);</span>
        
<span class="fc" id="L949">        lote.setCultivar(cultivar);</span>
        
<span class="fc" id="L951">        List&lt;Pureza&gt; listaPureza = List.of(pureza);</span>
<span class="fc" id="L952">        Page&lt;Pureza&gt; page = new org.springframework.data.domain.PageImpl&lt;&gt;(listaPureza);</span>
<span class="fc" id="L953">        when(purezaRepository.findAll(any(Specification.class), any(Pageable.class)))</span>
<span class="fc" id="L954">            .thenReturn(page);</span>
<span class="fc" id="L955">        when(analisisHistorialService.obtenerHistorialAnalisis(anyLong()))</span>
<span class="fc" id="L956">            .thenReturn(new ArrayList&lt;&gt;());</span>

        
<span class="fc" id="L959">        Page&lt;PurezaListadoDTO&gt; resultado = purezaService.obtenerPurezaPaginadasConFiltros(Pageable.unpaged(), null, null, null, null);</span>

        
<span class="fc" id="L962">        assertNotNull(resultado);</span>
<span class="fc" id="L963">        assertFalse(resultado.isEmpty());</span>
<span class="fc" id="L964">        PurezaListadoDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L965">        assertEquals(&quot;Nombre Científico&quot;, dto.getEspecie());</span>
<span class="fc" id="L966">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>