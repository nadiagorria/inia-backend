<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PmsService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">PmsService.java</span></div><h1>PmsService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;
import java.math.BigDecimal;
import java.math.MathContext;
import java.math.RoundingMode;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pms;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.RepPms;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.RepPmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.specifications.PmsSpecification;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PmsRedondeoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PmsRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.EstadisticasTandaDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PmsDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PmsListadoDTO;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;

@Service
<span class="fc" id="L32">public class PmsService {</span>

    @Autowired
    private PmsRepository pmsRepository;

    @Autowired
    private RepPmsRepository repPmsRepository;

    @Autowired
    private LoteRepository loteRepository;

    @Autowired
    private AnalisisHistorialService analisisHistorialService;
    
    @Autowired
    private AnalisisService analisisService;

        @Transactional
    
    public PmsDTO crearPms(PmsRequestDTO solicitud) {
        
<span class="fc bfc" id="L53" title="All 4 branches covered.">        if (solicitud.getNumRepeticionesEsperadas() == null || solicitud.getNumRepeticionesEsperadas() &lt;= 0) {</span>
<span class="fc" id="L54">            throw new RuntimeException(&quot;Debe especificar un número válido de repeticiones esperadas (mayor a 0).&quot;);</span>
        }
        
        
        
<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (solicitud.getNumRepeticionesEsperadas() &gt; 16) {</span>
<span class="fc" id="L60">            throw new RuntimeException(&quot;El número de repeticiones por tanda no puede superar 16.&quot;);</span>
        }
        
<span class="fc" id="L63">        Pms pms = mapearSolicitudAEntidad(solicitud);</span>
<span class="fc" id="L64">        pms.setEstado(Estado.REGISTRADO);</span>

<span class="fc" id="L66">        Pms guardado = pmsRepository.save(pms);</span>
        
        
<span class="fc" id="L69">        analisisHistorialService.registrarCreacion(guardado);</span>
        
<span class="fc" id="L71">        return mapearEntidadADTO(guardado);</span>
    }

    
    @Transactional
    public PmsDTO actualizarPms(Long id, PmsRequestDTO solicitud) {
<span class="fc" id="L77">        Optional&lt;Pms&gt; existente = pmsRepository.findById(id);</span>

<span class="fc bfc" id="L79" title="All 2 branches covered.">        if (existente.isPresent()) {</span>
<span class="fc" id="L80">            Pms pms = existente.get();</span>
            
            
<span class="fc" id="L83">            analisisService.manejarEdicionAnalisisFinalizado(pms);</span>
            
<span class="fc" id="L85">            actualizarEntidadDesdeSolicitud(pms, solicitud);</span>
<span class="fc" id="L86">            Pms actualizado = pmsRepository.save(pms);</span>
            
            
<span class="fc" id="L89">            analisisHistorialService.registrarModificacion(actualizado);</span>
            
<span class="fc" id="L91">            return mapearEntidadADTO(actualizado);</span>
        } else {
<span class="fc" id="L93">            throw new RuntimeException(&quot;Pms no encontrado con ID: &quot; + id);</span>
        }
    }

    
    public void eliminarPms(Long id) {
<span class="fc" id="L99">        Optional&lt;Pms&gt; existente = pmsRepository.findById(id);</span>

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (existente.isPresent()) {</span>
<span class="fc" id="L102">            Pms pms = existente.get();</span>
<span class="fc" id="L103">            pms.setActivo(false);</span>
<span class="fc" id="L104">            pmsRepository.save(pms);</span>
<span class="fc" id="L105">        } else {</span>
<span class="nc" id="L106">            throw new RuntimeException(&quot;Pms no encontrado con ID: &quot; + id);</span>
        }
<span class="fc" id="L108">    }</span>

    
    public void desactivarPms(Long id) {
<span class="fc" id="L112">        analisisService.desactivarAnalisis(id, pmsRepository);</span>
<span class="fc" id="L113">    }</span>

    
    public PmsDTO reactivarPms(Long id) {
<span class="fc" id="L117">        return analisisService.reactivarAnalisis(id, pmsRepository, this::mapearEntidadADTO);</span>
    }

    
    public List&lt;PmsDTO&gt; obtenerTodos() {
<span class="fc" id="L122">        List&lt;Pms&gt; activos = pmsRepository.findByActivoTrue();</span>

<span class="fc" id="L124">        return activos.stream()</span>
<span class="fc" id="L125">                .map(this::mapearEntidadADTO)</span>
<span class="fc" id="L126">                .collect(Collectors.toList());</span>
    }

    
    public PmsDTO obtenerPorId(Long id) {
<span class="fc" id="L131">        Optional&lt;Pms&gt; pms = pmsRepository.findById(id);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (pms.isPresent()) {</span>
<span class="fc" id="L133">            return mapearEntidadADTO(pms.get());</span>
        } else {
<span class="fc" id="L135">            throw new RuntimeException(&quot;Pms no encontrado con ID: &quot; + id);</span>
        }
    }

    public List&lt;PmsDTO&gt; obtenerPmsPorIdLote(Long idLote) {
<span class="fc" id="L140">        List&lt;Pms&gt; lista = pmsRepository.findByIdLote(idLote.intValue());</span>

<span class="fc" id="L142">        return lista.stream()</span>
<span class="fc" id="L143">                .map(this::mapearEntidadADTO)</span>
<span class="fc" id="L144">                .collect(Collectors.toList());</span>
    }

    
    public Page&lt;PmsListadoDTO&gt; obtenerPmsPaginadas(Pageable pageable) {
<span class="fc" id="L149">        Page&lt;Pms&gt; pmsPage = pmsRepository.findByActivoTrueOrderByFechaInicioDesc(pageable);</span>
<span class="fc" id="L150">        return pmsPage.map(this::mapearEntidadAListadoDTO);</span>
    }

    
    public Page&lt;PmsListadoDTO&gt; obtenerPmsPaginadasConFiltro(Pageable pageable, String filtroActivo) {
        Page&lt;Pms&gt; pmsPage;
        
<span class="fc bfc" id="L157" title="All 3 branches covered.">        switch (filtroActivo.toLowerCase()) {</span>
            case &quot;activos&quot;:
<span class="fc" id="L159">                pmsPage = pmsRepository.findByActivoTrueOrderByFechaInicioDesc(pageable);</span>
<span class="fc" id="L160">                break;</span>
            case &quot;inactivos&quot;:
<span class="fc" id="L162">                pmsPage = pmsRepository.findByActivoFalseOrderByFechaInicioDesc(pageable);</span>
<span class="fc" id="L163">                break;</span>
            default: 
<span class="fc" id="L165">                pmsPage = pmsRepository.findAllByOrderByFechaInicioDesc(pageable);</span>
                break;
        }
        
<span class="fc" id="L169">        return pmsPage.map(this::mapearEntidadAListadoDTO);</span>
    }

    
    public Page&lt;PmsListadoDTO&gt; obtenerPmsPaginadasConFiltros(
            Pageable pageable,
            String searchTerm,
            Boolean activo,
            String estado,
            Long loteId) {
        
<span class="fc" id="L180">        Specification&lt;Pms&gt; spec = PmsSpecification.conFiltros(searchTerm, activo, estado, loteId);</span>
<span class="fc" id="L181">        Page&lt;Pms&gt; pmsPage = pmsRepository.findAll(spec, pageable);</span>
<span class="fc" id="L182">        return pmsPage.map(this::mapearEntidadAListadoDTO);</span>
    }

    private PmsListadoDTO mapearEntidadAListadoDTO(Pms pms) {
<span class="fc" id="L186">        PmsListadoDTO dto = new PmsListadoDTO();</span>
<span class="fc" id="L187">        dto.setAnalisisID(pms.getAnalisisID());</span>
<span class="fc" id="L188">        dto.setEstado(pms.getEstado());</span>
<span class="fc" id="L189">        dto.setFechaInicio(pms.getFechaInicio());</span>
<span class="fc" id="L190">        dto.setFechaFin(pms.getFechaFin());</span>
<span class="fc" id="L191">        dto.setActivo(pms.getActivo());</span>
        
        
<span class="fc" id="L194">        dto.setPms_g(pms.getPmsconRedon());</span>
<span class="fc" id="L195">        dto.setCoeficienteVariacion(pms.getCoefVariacion());</span>
        
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (pms.getLote() != null) {</span>
<span class="fc" id="L198">            dto.setIdLote(pms.getLote().getLoteID());</span>
<span class="fc" id="L199">            dto.setLote(pms.getLote().getNomLote()); </span>
            
            
<span class="pc bpc" id="L202" title="3 of 4 branches missed.">            if (pms.getLote().getCultivar() != null &amp;&amp; pms.getLote().getCultivar().getEspecie() != null) {</span>
<span class="nc" id="L203">                String nombreEspecie = pms.getLote().getCultivar().getEspecie().getNombreComun();</span>
                
<span class="nc bnc" id="L205" title="All 4 branches missed.">                if (nombreEspecie == null || nombreEspecie.trim().isEmpty()) {</span>
<span class="nc" id="L206">                    nombreEspecie = pms.getLote().getCultivar().getEspecie().getNombreCientifico();</span>
                }
<span class="nc" id="L208">                dto.setEspecie(nombreEspecie);</span>
            }
        }
        
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        if (pms.getAnalisisID() != null) {</span>
<span class="fc" id="L213">            var historial = analisisHistorialService.obtenerHistorialAnalisis(pms.getAnalisisID());</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">            if (!historial.isEmpty()) {</span>
<span class="nc" id="L215">                var primerRegistro = historial.get(historial.size() - 1);</span>
<span class="nc" id="L216">                dto.setUsuarioCreador(primerRegistro.getUsuario());</span>
<span class="nc" id="L217">                var ultimoRegistro = historial.get(0);</span>
<span class="nc" id="L218">                dto.setUsuarioModificador(ultimoRegistro.getUsuario());</span>
            }
        }
<span class="fc" id="L221">        return dto;</span>
    }

    
    @Transactional
    public PmsDTO actualizarPmsConRedondeo(Long id, PmsRedondeoRequestDTO solicitud) {
<span class="fc" id="L227">        Optional&lt;Pms&gt; pmsExistente = pmsRepository.findById(id);</span>
        
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        if (pmsExistente.isPresent()) {</span>
<span class="fc" id="L230">            Pms pms = pmsExistente.get();</span>
            
<span class="fc" id="L232">            System.out.println(&quot;=== DEBUG actualizarPmsConRedondeo ===&quot;);</span>
<span class="fc" id="L233">            System.out.println(&quot;PMS ID: &quot; + id);</span>
<span class="fc" id="L234">            System.out.println(&quot;Estado actual: &quot; + pms.getEstado());</span>
<span class="fc" id="L235">            System.out.println(&quot;Número de tandas: &quot; + pms.getNumTandas());</span>
<span class="fc" id="L236">            System.out.println(&quot;Repeticiones esperadas: &quot; + pms.getNumRepeticionesEsperadas());</span>
            
            
<span class="fc bfc" id="L239" title="All 2 branches covered.">            if (pms.getEstado() != Estado.EN_PROCESO &amp;&amp; </span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">                pms.getEstado() != Estado.PENDIENTE_APROBACION &amp;&amp; </span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">                pms.getEstado() != Estado.APROBADO) {</span>
<span class="fc" id="L242">                System.out.println(&quot;ERROR: Estado no válido: &quot; + pms.getEstado());</span>
<span class="fc" id="L243">                throw new RuntimeException(&quot;Solo se pueden actualizar valores finales de PMS en estado EN_PROCESO, PENDIENTE_APROBACION o APROBADO. Estado actual: &quot; + pms.getEstado());</span>
            }
            
            
<span class="fc" id="L247">            boolean repeticionesCompletas = todasLasRepeticionesCompletas(pms);</span>
<span class="fc" id="L248">            System.out.println(&quot;Repeticiones completas: &quot; + repeticionesCompletas);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">            if (!repeticionesCompletas) {</span>
<span class="fc" id="L250">                System.out.println(&quot;ERROR: No todas las repeticiones están completas&quot;);</span>
<span class="fc" id="L251">                throw new RuntimeException(&quot;No se pueden actualizar los valores finales hasta completar todas las repeticiones válidas&quot;);</span>
            }
            
            
<span class="fc" id="L255">            pms.setPmsconRedon(solicitud.getPmsconRedon());</span>
            
<span class="fc" id="L257">            Pms pmsActualizado = pmsRepository.save(pms);</span>
<span class="fc" id="L258">            System.out.println(&quot;PMS con redondeo actualizado exitosamente para PMS ID: &quot; + id);</span>
<span class="fc" id="L259">            return mapearEntidadADTO(pmsActualizado);</span>
        } else {
<span class="nc" id="L261">            throw new RuntimeException(&quot;Análisis de PMS no encontrado con ID: &quot; + id);</span>
        }
    }

    
    public void procesarCalculosTanda(Long pmsId, Integer numTanda) {
<span class="fc" id="L267">        Pms pms = pmsRepository.findById(pmsId)</span>
<span class="pc" id="L268">            .orElseThrow(() -&gt; new RuntimeException(&quot;PMS no encontrado con ID: &quot; + pmsId));</span>
        
<span class="fc" id="L270">        List&lt;RepPms&gt; repeticionesTanda = repPmsRepository.findByPmsId(pmsId).stream()</span>
<span class="fc" id="L271">            .filter(rep -&gt; rep.getNumTanda().equals(numTanda))</span>
<span class="fc" id="L272">            .collect(Collectors.toList());</span>
        
<span class="fc bfc" id="L274" title="All 2 branches covered.">        if (repeticionesTanda.size() &lt; pms.getNumRepeticionesEsperadas()) {</span>
            
<span class="fc" id="L276">            actualizarEstadisticasGenerales(pms);</span>
<span class="fc" id="L277">            pmsRepository.save(pms);</span>
<span class="fc" id="L278">            return;</span>
        }
        
        
<span class="fc" id="L282">        List&lt;RepPms&gt; todasLasRepeticiones = repPmsRepository.findByPmsId(pmsId);</span>
        
        
<span class="fc" id="L285">        EstadisticasTandaDTO estadisticasGlobales = calcularEstadisticasTanda(todasLasRepeticiones);</span>
        
        
<span class="fc" id="L288">        BigDecimal media = estadisticasGlobales.getPromedio();</span>
<span class="fc" id="L289">        BigDecimal desviacion = estadisticasGlobales.getDesviacion();</span>
<span class="fc" id="L290">        BigDecimal umbralInferior = media.subtract(desviacion.multiply(new BigDecimal(&quot;2&quot;)));</span>
<span class="fc" id="L291">        BigDecimal umbralSuperior = media.add(desviacion.multiply(new BigDecimal(&quot;2&quot;)));</span>
        
<span class="fc" id="L293">        System.out.println(&quot; ESTADÍSTICAS GLOBALES DEL PMS (todas las repeticiones):&quot;);</span>
<span class="fc" id="L294">        System.out.println(&quot;  Total repeticiones: &quot; + todasLasRepeticiones.size());</span>
<span class="fc" id="L295">        System.out.println(&quot;  Media (μ): &quot; + media);</span>
<span class="fc" id="L296">        System.out.println(&quot;  Desviación (σ): &quot; + desviacion);</span>
<span class="fc" id="L297">        System.out.println(&quot;  Umbral inferior (μ - 2σ): &quot; + umbralInferior);</span>
<span class="fc" id="L298">        System.out.println(&quot;  Umbral superior (μ + 2σ): &quot; + umbralSuperior);</span>
<span class="fc" id="L299">        System.out.println(&quot; VALIDACIÓN DE TANDA &quot; + numTanda + &quot;:&quot;);</span>
        
        
<span class="fc bfc" id="L302" title="All 2 branches covered.">        for (RepPms rep : repeticionesTanda) {</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">            boolean esValida = rep.getPeso().compareTo(umbralInferior) &gt;= 0 &amp;&amp; </span>
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">                              rep.getPeso().compareTo(umbralSuperior) &lt;= 0;</span>
<span class="fc" id="L305">            rep.setValido(esValida);</span>
<span class="fc" id="L306">            System.out.println(&quot;    Rep #&quot; + rep.getNumRep() + &quot; (Tanda &quot; + numTanda + &quot;): &quot; + rep.getPeso() + &quot;g -&gt; &quot; + </span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">                (esValida ? &quot; VÁLIDA&quot; : &quot; INVÁLIDA&quot;) +</span>
<span class="fc" id="L308">                &quot; (comparación: &quot; + rep.getPeso() + &quot; vs [&quot; + umbralInferior + &quot;, &quot; + umbralSuperior + &quot;])&quot;);</span>
<span class="fc" id="L309">        }</span>
<span class="fc" id="L310">        repPmsRepository.saveAll(repeticionesTanda);</span>
<span class="fc" id="L311">        System.out.println(&quot;   Validaciones guardadas en BD&quot;);</span>
        
        
<span class="fc" id="L314">        List&lt;RepPms&gt; repeticionesValidas = repeticionesTanda.stream()</span>
<span class="fc" id="L315">            .filter(rep -&gt; Boolean.TRUE.equals(rep.getValido()))</span>
<span class="fc" id="L316">            .collect(Collectors.toList());</span>
        
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">        if (repeticionesValidas.isEmpty()) {</span>
            
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (puedeIncrementarTandas(pms)) {</span>
<span class="nc" id="L321">                pms.setNumTandas(pms.getNumTandas() + 1);</span>
<span class="nc" id="L322">                System.out.println(&quot;No hay repeticiones válidas en tanda &quot; + numTanda + &quot;. Se incrementa el número de tandas a: &quot; + pms.getNumTandas());</span>
            }
<span class="nc" id="L324">            actualizarEstadisticasGenerales(pms);</span>
<span class="nc" id="L325">            pmsRepository.save(pms);</span>
<span class="nc" id="L326">            return;</span>
        }
        
        
<span class="fc" id="L330">        EstadisticasTandaDTO estadisticasTanda = calcularEstadisticasTanda(repeticionesValidas);</span>
        
        
<span class="fc bfc" id="L333" title="All 2 branches covered.">        BigDecimal umbralCV = pms.getEsSemillaBrozosa() ? </span>
<span class="fc" id="L334">            new BigDecimal(&quot;6.0&quot;) : new BigDecimal(&quot;4.0&quot;);</span>
        
<span class="fc" id="L336">        System.out.println(&quot;  CV de la tanda &quot; + numTanda + &quot;: &quot; + estadisticasTanda.getCoeficienteVariacion() + &quot; (umbral: &quot; + umbralCV + &quot;)&quot;);</span>
        
<span class="fc bfc" id="L338" title="All 2 branches covered.">        if (estadisticasTanda.getCoeficienteVariacion().compareTo(umbralCV) &gt; 0) {</span>
            
<span class="fc bfc" id="L340" title="All 2 branches covered.">            if (puedeIncrementarTandas(pms)) {</span>
<span class="fc" id="L341">                pms.setNumTandas(pms.getNumTandas() + 1);</span>
<span class="fc" id="L342">                System.out.println(&quot;   CV no aceptable. Se incrementa el número de tandas a: &quot; + pms.getNumTandas());</span>
            } else {
<span class="fc" id="L344">                System.out.println(&quot;   CV no aceptable pero se alcanzó el límite máximo de 16 repeticiones.&quot;);</span>
            }
        } else {
<span class="fc" id="L347">            System.out.println(&quot;   CV aceptable para la tanda &quot; + numTanda);</span>
        }
        
        
<span class="fc" id="L351">        actualizarEstadisticasGenerales(pms);</span>
        
<span class="fc" id="L353">        pmsRepository.save(pms);</span>
<span class="fc" id="L354">    }</span>
    
    
    @Transactional
    public void validarTodasLasRepeticiones(Long pmsId) {
<span class="fc" id="L359">        System.out.println(&quot; VALIDANDO TODAS LAS REPETICIONES del PMS ID: &quot; + pmsId);</span>
        
<span class="fc" id="L361">        Pms pms = pmsRepository.findById(pmsId)</span>
<span class="pc" id="L362">            .orElseThrow(() -&gt; new RuntimeException(&quot;PMS no encontrado con ID: &quot; + pmsId));</span>
        
        
<span class="fc" id="L365">        List&lt;RepPms&gt; todasLasRepeticiones = repPmsRepository.findByPmsId(pmsId);</span>
        
<span class="fc bfc" id="L367" title="All 2 branches covered.">        if (todasLasRepeticiones.isEmpty()) {</span>
<span class="fc" id="L368">            System.out.println(&quot;  No hay repeticiones para validar&quot;);</span>
<span class="fc" id="L369">            return;</span>
        }
        
        
<span class="fc bfc" id="L373" title="All 2 branches covered.">        if (todasLasRepeticiones.size() &lt; pms.getNumRepeticionesEsperadas()) {</span>
<span class="fc" id="L374">            System.out.println(&quot;  Repeticiones insuficientes (&quot; + todasLasRepeticiones.size() + &quot; &lt; &quot; + pms.getNumRepeticionesEsperadas() + &quot;), marcando todas como indeterminadas&quot;);</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">            for (RepPms rep : todasLasRepeticiones) {</span>
<span class="fc" id="L376">                rep.setValido(null);</span>
<span class="fc" id="L377">            }</span>
<span class="fc" id="L378">            repPmsRepository.saveAll(todasLasRepeticiones);</span>
<span class="fc" id="L379">            actualizarEstadisticasGenerales(pms);</span>
<span class="fc" id="L380">            pmsRepository.save(pms);</span>
<span class="fc" id="L381">            return;</span>
        }
        
        
<span class="fc" id="L385">        EstadisticasTandaDTO estadisticasGlobales = calcularEstadisticasTanda(todasLasRepeticiones);</span>
<span class="fc" id="L386">        BigDecimal media = estadisticasGlobales.getPromedio();</span>
<span class="fc" id="L387">        BigDecimal desviacion = estadisticasGlobales.getDesviacion();</span>
<span class="fc" id="L388">        BigDecimal umbralInferior = media.subtract(desviacion.multiply(new BigDecimal(&quot;2&quot;)));</span>
<span class="fc" id="L389">        BigDecimal umbralSuperior = media.add(desviacion.multiply(new BigDecimal(&quot;2&quot;)));</span>
        
<span class="fc" id="L391">        System.out.println(&quot; ESTADÍSTICAS GLOBALES:&quot;);</span>
<span class="fc" id="L392">        System.out.println(&quot;  Total repeticiones: &quot; + todasLasRepeticiones.size());</span>
<span class="fc" id="L393">        System.out.println(&quot;  Media (μ): &quot; + media);</span>
<span class="fc" id="L394">        System.out.println(&quot;  Desviación (σ): &quot; + desviacion);</span>
<span class="fc" id="L395">        System.out.println(&quot;  Umbral inferior (μ - 2σ): &quot; + umbralInferior);</span>
<span class="fc" id="L396">        System.out.println(&quot;  Umbral superior (μ + 2σ): &quot; + umbralSuperior);</span>
<span class="fc" id="L397">        System.out.println(&quot;  Validación:&quot;);</span>
        
        
<span class="fc bfc" id="L400" title="All 2 branches covered.">        for (RepPms rep : todasLasRepeticiones) {</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">            boolean esValida = rep.getPeso().compareTo(umbralInferior) &gt;= 0 &amp;&amp; </span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">                              rep.getPeso().compareTo(umbralSuperior) &lt;= 0;</span>
<span class="fc" id="L403">            rep.setValido(esValida);</span>
<span class="fc" id="L404">            System.out.println(&quot;    Rep #&quot; + rep.getNumRep() + &quot; (Tanda &quot; + rep.getNumTanda() + &quot;): &quot; + </span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">                rep.getPeso() + &quot;g -&gt; &quot; + (esValida ? &quot; VÁLIDA&quot; : &quot; INVÁLIDA&quot;));</span>
<span class="fc" id="L406">        }</span>
        
        
<span class="fc" id="L409">        repPmsRepository.saveAll(todasLasRepeticiones);</span>
<span class="fc" id="L410">        System.out.println(&quot;   Validaciones guardadas&quot;);</span>
        
        
<span class="fc" id="L413">        List&lt;RepPms&gt; repeticionesValidas = todasLasRepeticiones.stream()</span>
<span class="fc" id="L414">            .filter(rep -&gt; Boolean.TRUE.equals(rep.getValido()))</span>
<span class="fc" id="L415">            .collect(Collectors.toList());</span>
        
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">        if (repeticionesValidas.size() &gt;= pms.getNumRepeticionesEsperadas()) {</span>
<span class="fc" id="L418">            EstadisticasTandaDTO estadisticasValidas = calcularEstadisticasTanda(repeticionesValidas);</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">            BigDecimal umbralCV = pms.getEsSemillaBrozosa() ? new BigDecimal(&quot;6.0&quot;) : new BigDecimal(&quot;4.0&quot;);</span>
            
<span class="fc" id="L421">            System.out.println(&quot;  CV con repeticiones válidas: &quot; + estadisticasValidas.getCoeficienteVariacion() + &quot; (umbral: &quot; + umbralCV + &quot;)&quot;);</span>
            
<span class="pc bpc" id="L423" title="1 of 4 branches missed.">            if (estadisticasValidas.getCoeficienteVariacion().compareTo(umbralCV) &gt; 0 &amp;&amp; puedeIncrementarTandas(pms)) {</span>
<span class="fc" id="L424">                pms.setNumTandas(pms.getNumTandas() + 1);</span>
<span class="fc" id="L425">                System.out.println(&quot;   CV no aceptable. Se incrementa número de tandas a: &quot; + pms.getNumTandas());</span>
            }
        }
        
        
<span class="fc" id="L430">        actualizarEstadisticasGenerales(pms);</span>
<span class="fc" id="L431">        pmsRepository.save(pms);</span>
        
<span class="fc" id="L433">        System.out.println(&quot; Validación completada&quot;);</span>
<span class="fc" id="L434">    }</span>
    
    
    public void actualizarEstadisticasPms(Long pmsId) {
<span class="fc" id="L438">        Pms pms = pmsRepository.findById(pmsId)</span>
<span class="pc" id="L439">            .orElseThrow(() -&gt; new RuntimeException(&quot;PMS no encontrado con ID: &quot; + pmsId));</span>
        
<span class="fc" id="L441">        actualizarEstadisticasGenerales(pms);</span>
<span class="fc" id="L442">        pmsRepository.save(pms);</span>
<span class="fc" id="L443">    }</span>



    
    
    

    private Pms mapearSolicitudAEntidad(PmsRequestDTO solicitud) {
<span class="fc" id="L452">        Pms pms = new Pms();</span>

<span class="fc" id="L454">        pms.setComentarios(solicitud.getComentarios());</span>

<span class="pc bpc" id="L456" title="1 of 2 branches missed.">        if (solicitud.getIdLote() != null) {</span>
<span class="fc" id="L457">            Optional&lt;Lote&gt; loteOpt = loteRepository.findById(solicitud.getIdLote());</span>
<span class="fc bfc" id="L458" title="All 2 branches covered.">            if (loteOpt.isPresent()) {</span>
<span class="fc" id="L459">                Lote lote = loteOpt.get();</span>
                
                
<span class="fc bfc" id="L462" title="All 2 branches covered.">                if (!lote.getActivo()) {</span>
<span class="fc" id="L463">                    throw new RuntimeException(&quot;No se puede crear un análisis para un lote inactivo&quot;);</span>
                }
                
<span class="fc" id="L466">                pms.setLote(lote);</span>
<span class="fc" id="L467">            } else {</span>
<span class="fc" id="L468">                throw new RuntimeException(&quot;Lote no encontrado con ID: &quot; + solicitud.getIdLote());</span>
            }
        }

        
<span class="fc" id="L473">        pms.setNumRepeticionesEsperadas(solicitud.getNumRepeticionesEsperadas());</span>
<span class="fc" id="L474">        pms.setNumTandas(1); </span>
<span class="fc" id="L475">        pms.setEsSemillaBrozosa(solicitud.getEsSemillaBrozosa());</span>

<span class="fc" id="L477">        return pms;</span>
    }

    private void actualizarEntidadDesdeSolicitud(Pms pms, PmsRequestDTO solicitud) {

<span class="fc" id="L482">        pms.setComentarios(solicitud.getComentarios());</span>

<span class="pc bpc" id="L484" title="1 of 2 branches missed.">        if (solicitud.getIdLote() != null) {</span>
<span class="fc" id="L485">            Optional&lt;Lote&gt; loteOpt = loteRepository.findById(solicitud.getIdLote());</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">            if (loteOpt.isPresent()) {</span>
<span class="fc" id="L487">                pms.setLote(loteOpt.get());</span>
            } else {
<span class="nc" id="L489">                throw new RuntimeException(&quot;Lote no encontrado con ID: &quot; + solicitud.getIdLote());</span>
            }
        }

        
        
        
<span class="fc" id="L496">        pms.setEsSemillaBrozosa(solicitud.getEsSemillaBrozosa());</span>
<span class="fc" id="L497">    }</span>

    private PmsDTO mapearEntidadADTO(Pms pms) {
<span class="fc" id="L500">        PmsDTO dto = new PmsDTO();</span>

<span class="fc" id="L502">        dto.setAnalisisID(pms.getAnalisisID());</span>
<span class="fc" id="L503">        dto.setEstado(pms.getEstado());</span>
<span class="fc" id="L504">        dto.setFechaInicio(pms.getFechaInicio());</span>
<span class="fc" id="L505">        dto.setFechaFin(pms.getFechaFin());</span>
<span class="fc" id="L506">        dto.setComentarios(pms.getComentarios());</span>

        
<span class="fc bfc" id="L509" title="All 2 branches covered.">        if (pms.getLote() != null) {</span>
<span class="fc" id="L510">            dto.setIdLote(pms.getLote().getLoteID());</span>
<span class="fc" id="L511">            dto.setLote(pms.getLote().getNomLote());</span>
<span class="fc" id="L512">            dto.setFicha(pms.getLote().getFicha());</span>
            
            
<span class="fc bfc" id="L515" title="All 2 branches covered.">            if (pms.getLote().getCultivar() != null) {</span>
<span class="fc" id="L516">                dto.setCultivarNombre(pms.getLote().getCultivar().getNombre());</span>
                
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">                if (pms.getLote().getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L519">                    dto.setEspecieNombre(pms.getLote().getCultivar().getEspecie().getNombreComun());</span>
                }
            }
        }

        
<span class="fc" id="L525">        dto.setNumRepeticionesEsperadas(pms.getNumRepeticionesEsperadas());</span>
<span class="fc" id="L526">        dto.setNumTandas(pms.getNumTandas());</span>
<span class="fc" id="L527">        dto.setEsSemillaBrozosa(pms.getEsSemillaBrozosa());</span>
        
        
<span class="fc" id="L530">        dto.setPromedio100g(pms.getPromedio100g());</span>
<span class="fc" id="L531">        dto.setDesvioStd(pms.getDesvioStd());</span>
<span class="fc" id="L532">        dto.setCoefVariacion(pms.getCoefVariacion());</span>
<span class="fc" id="L533">        dto.setPmssinRedon(pms.getPmssinRedon());</span>
<span class="fc" id="L534">        dto.setPmsconRedon(pms.getPmsconRedon());</span>

        
<span class="fc" id="L537">        dto.setHistorial(analisisHistorialService.obtenerHistorialAnalisis(pms.getAnalisisID()));</span>

<span class="fc" id="L539">        return dto;</span>
    }

    
    
    

    private EstadisticasTandaDTO calcularEstadisticasTanda(List&lt;RepPms&gt; repeticiones) {
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">        if (repeticiones.isEmpty()) {</span>
<span class="nc" id="L548">            throw new RuntimeException(&quot;No se pueden calcular estadísticas de una tanda vacía&quot;);</span>
        }

        
<span class="fc" id="L552">        BigDecimal suma = repeticiones.stream()</span>
<span class="fc" id="L553">            .map(RepPms::getPeso)</span>
<span class="fc" id="L554">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="fc" id="L556">        BigDecimal promedio = suma.divide(</span>
<span class="fc" id="L557">            new BigDecimal(repeticiones.size()), </span>
            4, RoundingMode.HALF_UP  
        );

        
<span class="fc" id="L562">        BigDecimal sumaCuadrados = repeticiones.stream()</span>
<span class="fc" id="L563">            .map(rep -&gt; rep.getPeso().subtract(promedio).pow(2))</span>
<span class="fc" id="L564">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>

        
<span class="fc" id="L567">        int n = repeticiones.size();</span>
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">        BigDecimal divisor = n &gt; 1 ? new BigDecimal(n - 1) : new BigDecimal(1);</span>
        
<span class="fc" id="L570">        BigDecimal varianza = sumaCuadrados.divide(</span>
            divisor, 
            MathContext.DECIMAL128
        );
        
<span class="fc" id="L575">        BigDecimal desviacion = new BigDecimal(Math.sqrt(varianza.doubleValue()))</span>
<span class="fc" id="L576">            .setScale(4, RoundingMode.HALF_UP);</span>

        
<span class="fc" id="L579">        BigDecimal coeficienteVariacion = desviacion</span>
<span class="fc" id="L580">            .divide(promedio, MathContext.DECIMAL128)</span>
<span class="fc" id="L581">            .multiply(new BigDecimal(&quot;100&quot;))</span>
<span class="fc" id="L582">            .setScale(4, RoundingMode.HALF_UP);  </span>

        
<span class="fc" id="L585">        BigDecimal pmsSinRedondeo = promedio.multiply(new BigDecimal(&quot;10&quot;))</span>
<span class="fc" id="L586">            .setScale(4, RoundingMode.HALF_UP);  </span>

<span class="fc" id="L588">        return new EstadisticasTandaDTO(promedio, desviacion, coeficienteVariacion, pmsSinRedondeo);</span>
    }

    private void actualizarEstadisticasGenerales(Pms pms) {
        
<span class="fc" id="L593">        List&lt;RepPms&gt; repeticionesValidas = repPmsRepository.findByPmsId(pms.getAnalisisID()).stream()</span>
<span class="fc" id="L594">            .filter(rep -&gt; Boolean.TRUE.equals(rep.getValido()))</span>
<span class="fc" id="L595">            .collect(Collectors.toList());</span>
        
<span class="fc bfc" id="L597" title="All 2 branches covered.">        if (!repeticionesValidas.isEmpty()) {</span>
<span class="fc" id="L598">            EstadisticasTandaDTO estadisticasGenerales = calcularEstadisticasTanda(repeticionesValidas);</span>
            
            
<span class="fc" id="L601">            pms.setPromedio100g(estadisticasGenerales.getPromedio());</span>
<span class="fc" id="L602">            pms.setDesvioStd(estadisticasGenerales.getDesviacion());</span>
<span class="fc" id="L603">            pms.setCoefVariacion(estadisticasGenerales.getCoeficienteVariacion());</span>
<span class="fc" id="L604">            pms.setPmssinRedon(estadisticasGenerales.getPmsSinRedondeo());</span>
<span class="fc" id="L605">        } else {</span>
            
<span class="fc" id="L607">            pms.setPromedio100g(null);</span>
<span class="fc" id="L608">            pms.setDesvioStd(null);</span>
<span class="fc" id="L609">            pms.setCoefVariacion(null);</span>
<span class="fc" id="L610">            pms.setPmssinRedon(null);</span>
        }
<span class="fc" id="L612">    }</span>

    private boolean todasLasTandasCompletas(Pms pms) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">        for (int tandaNum = 1; tandaNum &lt;= pms.getNumTandas(); tandaNum++) {</span>
<span class="nc" id="L616">            final int tanda = tandaNum;</span>
<span class="nc" id="L617">            List&lt;RepPms&gt; repeticionesTanda = repPmsRepository.findByPmsId(pms.getAnalisisID()).stream()</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">                .filter(rep -&gt; rep.getNumTanda().equals(tanda) &amp;&amp; Boolean.TRUE.equals(rep.getValido()))</span>
<span class="nc" id="L619">                .collect(Collectors.toList());</span>
            
<span class="nc bnc" id="L621" title="All 2 branches missed.">            if (repeticionesTanda.size() &lt; pms.getNumRepeticionesEsperadas()) {</span>
<span class="nc" id="L622">                return false;</span>
            }
        }
<span class="nc" id="L625">        return true;</span>
    }

    private boolean puedeIncrementarTandas(Pms pms) {
<span class="fc" id="L629">        long totalRepeticiones = repPmsRepository.countByPmsId(pms.getAnalisisID());</span>
        
<span class="fc bfc" id="L631" title="All 2 branches covered.">        return totalRepeticiones &lt; 16;</span>
    }

    private boolean todasLasRepeticionesCompletas(Pms pms) {
<span class="fc" id="L635">        System.out.println(&quot;=== DEBUG todasLasRepeticionesCompletas ===&quot;);</span>
        
        
<span class="fc" id="L638">        List&lt;RepPms&gt; todasLasRepeticiones = repPmsRepository.findByPmsId(pms.getAnalisisID());</span>
<span class="fc" id="L639">        long totalRepeticiones = todasLasRepeticiones.size();</span>
        
<span class="fc" id="L641">        System.out.println(&quot;Total de repeticiones: &quot; + totalRepeticiones);</span>
<span class="fc" id="L642">        System.out.println(&quot;Número de tandas: &quot; + pms.getNumTandas());</span>
<span class="fc" id="L643">        System.out.println(&quot;Repeticiones esperadas por tanda: &quot; + pms.getNumRepeticionesEsperadas());</span>
        
        
<span class="fc bfc" id="L646" title="All 2 branches covered.">        for (int tandaNum = 1; tandaNum &lt;= pms.getNumTandas(); tandaNum++) {</span>
<span class="fc" id="L647">            final int tanda = tandaNum;</span>
<span class="fc" id="L648">            List&lt;RepPms&gt; repeticionesTanda = todasLasRepeticiones.stream()</span>
<span class="fc" id="L649">                .filter(rep -&gt; rep.getNumTanda().equals(tanda))</span>
<span class="fc" id="L650">                .collect(Collectors.toList());</span>
            
<span class="fc" id="L652">            List&lt;RepPms&gt; repeticionesValidas = repeticionesTanda.stream()</span>
<span class="fc" id="L653">                .filter(rep -&gt; Boolean.TRUE.equals(rep.getValido()))</span>
<span class="fc" id="L654">                .collect(Collectors.toList());</span>
            
<span class="fc" id="L656">            System.out.println(&quot;Tanda &quot; + tanda + &quot;: &quot; + repeticionesTanda.size() + &quot; repeticiones totales, &quot; + </span>
<span class="fc" id="L657">                             repeticionesValidas.size() + &quot; válidas (necesita &quot; + pms.getNumRepeticionesEsperadas() + &quot;)&quot;);</span>
            
            
<span class="fc bfc" id="L660" title="All 2 branches covered.">            if (repeticionesValidas.size() &gt;= pms.getNumRepeticionesEsperadas()) {</span>
                
<span class="fc" id="L662">                EstadisticasTandaDTO estadisticas = calcularEstadisticasTanda(repeticionesValidas);</span>
<span class="pc bpc" id="L663" title="1 of 2 branches missed.">                BigDecimal umbralCV = pms.getEsSemillaBrozosa() ? </span>
<span class="pc" id="L664">                    new BigDecimal(&quot;6.0&quot;) : new BigDecimal(&quot;4.0&quot;);</span>
                
<span class="fc" id="L666">                System.out.println(&quot;CV de tanda &quot; + tanda + &quot;: &quot; + estadisticas.getCoeficienteVariacion() + </span>
                                 &quot; (umbral: &quot; + umbralCV + &quot;)&quot;);
                
                
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">                if (estadisticas.getCoeficienteVariacion().compareTo(umbralCV) &lt;= 0) {</span>
<span class="fc" id="L671">                    System.out.println(&quot;Tanda &quot; + tanda + &quot; tiene CV válido. Repeticiones completas.&quot;);</span>
<span class="fc" id="L672">                    return true;</span>
                }
            }
        }
        
        
<span class="pc bpc" id="L678" title="1 of 2 branches missed.">        if (totalRepeticiones &gt;= 16) {</span>
<span class="nc" id="L679">            System.out.println(&quot;Se alcanzó el límite de 16 repeticiones sin CV válido. Permitir finalización.&quot;);</span>
<span class="nc" id="L680">            return true; </span>
        }
        
<span class="fc" id="L683">        System.out.println(&quot;No hay tandas con CV válido y no se alcanzó el límite. Retornando false.&quot;);</span>
<span class="fc" id="L684">        return false;</span>
    }

    
    private void validarPmsParaOperacionCritica(Pms pms) {
        
<span class="nc bnc" id="L690" title="All 2 branches missed.">        if (!todasLasRepeticionesCompletas(pms)) {</span>
<span class="nc" id="L691">            throw new RuntimeException(&quot;No se puede completar la operación hasta completar todas las repeticiones válidas&quot;);</span>
        }
        
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (pms.getPmsconRedon() == null) {</span>
<span class="nc" id="L695">            throw new RuntimeException(&quot;Debe ingresar el promedio con redondeo (PMS con redondeo) antes de completar la operación&quot;);</span>
        }
<span class="nc" id="L697">    }</span>

    
    public PmsDTO finalizarAnalisis(Long id) {
<span class="fc" id="L701">        return analisisService.finalizarAnalisisGenerico(</span>
            id, 
            pmsRepository, 
            this::mapearEntidadADTO,
            this::validarPmsParaOperacionCritica
        );
    }

    
    public PmsDTO aprobarAnalisis(Long id) {
<span class="fc" id="L711">        return analisisService.aprobarAnalisisGenerico(</span>
            id,
            pmsRepository,
            this::mapearEntidadADTO,
            this::validarPmsParaOperacionCritica, 
<span class="nc" id="L716">            (idLote) -&gt; pmsRepository.findByIdLote(idLote.intValue()) </span>
        );
    }

    
    public PmsDTO marcarParaRepetir(Long id) {
<span class="fc" id="L722">        return analisisService.marcarParaRepetirGenerico(</span>
            id,
            pmsRepository,
            this::mapearEntidadADTO,
            this::validarPmsParaOperacionCritica 
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>