<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PmsServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">PmsServiceTest.java</span></div><h1>PmsServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Cultivar;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Especie;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pms;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.RepPms;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.RepPmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PmsRedondeoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PmsRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.AnalisisHistorialDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.PmsDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyList;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@org.mockito.junit.jupiter.MockitoSettings(strictness = org.mockito.quality.Strictness.LENIENT)
@DisplayName(&quot;Tests de PmsService&quot;)
<span class="fc" id="L47">class PmsServiceTest {</span>

    @Mock
    private PmsRepository pmsRepository;

    @Mock
    private RepPmsRepository repPmsRepository;

    @Mock
    private LoteRepository loteRepository;

    @Mock
    private AnalisisHistorialService analisisHistorialService;

    @Mock
    private AnalisisService analisisService;

    @InjectMocks
    private PmsService pmsService;

    private PmsRequestDTO pmsRequestDTO;
    private Lote lote;
    private Pms pms;

    @BeforeEach
    void setUp() {
        // ARRANGE: Preparar datos de prueba
<span class="fc" id="L74">        lote = new Lote();</span>
<span class="fc" id="L75">        lote.setLoteID(1L);</span>
<span class="fc" id="L76">        lote.setNomLote(&quot;LOTE-PMS-001&quot;);</span>
<span class="fc" id="L77">        lote.setActivo(true);</span>

<span class="fc" id="L79">        pmsRequestDTO = new PmsRequestDTO();</span>
<span class="fc" id="L80">        pmsRequestDTO.setIdLote(1L);</span>
<span class="fc" id="L81">        pmsRequestDTO.setNumRepeticionesEsperadas(8);</span>
<span class="fc" id="L82">        pmsRequestDTO.setEsSemillaBrozosa(false);</span>
<span class="fc" id="L83">        pmsRequestDTO.setComentarios(&quot;Test PMS&quot;);</span>

<span class="fc" id="L85">        pms = new Pms();</span>
<span class="fc" id="L86">        pms.setAnalisisID(1L);</span>
<span class="fc" id="L87">        pms.setLote(lote);</span>
<span class="fc" id="L88">        pms.setNumRepeticionesEsperadas(8);</span>
<span class="fc" id="L89">        pms.setEstado(Estado.REGISTRADO);</span>
<span class="fc" id="L90">        pms.setActivo(true);</span>
<span class="fc" id="L91">        pms.setNumTandas(1); // asegurar valor inicial para las validaciones internas</span>
<span class="fc" id="L92">    }</span>

    @Test
    @DisplayName(&quot;Crear PMS - debe asignar estado REGISTRADO&quot;)
    void crearPms_debeAsignarEstadoRegistrado() {
        
<span class="fc" id="L98">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L99">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
<span class="fc" id="L100">        doNothing().when(analisisHistorialService).registrarCreacion(any(Pms.class));</span>

        
<span class="fc" id="L103">        PmsDTO resultado = pmsService.crearPms(pmsRequestDTO);</span>

        
<span class="fc" id="L106">        assertNotNull(resultado, &quot;El resultado no debe ser nulo&quot;);</span>
<span class="fc" id="L107">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L108">        verify(analisisHistorialService, times(1)).registrarCreacion(any(Pms.class));</span>
<span class="fc" id="L109">    }</span>

    @Test
    @DisplayName(&quot;Crear PMS sin repeticiones esperadas - debe lanzar excepción&quot;)
    void crearPms_sinRepeticionesEsperadas_debeLanzarExcepcion() {
        
<span class="fc" id="L115">        pmsRequestDTO.setNumRepeticionesEsperadas(null);</span>

        
<span class="fc" id="L118">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L119">            pmsService.crearPms(pmsRequestDTO);</span>
<span class="nc" id="L120">        });</span>
        
<span class="fc" id="L122">        assertTrue(exception.getMessage().contains(&quot;repeticiones esperadas&quot;));</span>
<span class="fc" id="L123">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L124">    }</span>

    @Test
    @DisplayName(&quot;Crear PMS con repeticiones = 0 - debe lanzar excepción&quot;)
    void crearPms_conRepeticionesCero_debeLanzarExcepcion() {
        
<span class="fc" id="L130">        pmsRequestDTO.setNumRepeticionesEsperadas(0);</span>

        
<span class="fc" id="L133">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L134">            pmsService.crearPms(pmsRequestDTO);</span>
<span class="nc" id="L135">        });</span>
        
<span class="fc" id="L137">        assertTrue(exception.getMessage().contains(&quot;mayor a 0&quot;));</span>
<span class="fc" id="L138">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L139">    }</span>

    @Test
    @DisplayName(&quot;Crear PMS con más de 16 repeticiones - debe lanzar excepción&quot;)
    void crearPms_conMasDe16Repeticiones_debeLanzarExcepcion() {
        
<span class="fc" id="L145">        pmsRequestDTO.setNumRepeticionesEsperadas(17);</span>

        
<span class="fc" id="L148">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L149">            pmsService.crearPms(pmsRequestDTO);</span>
<span class="nc" id="L150">        });</span>
        
<span class="fc" id="L152">        assertTrue(exception.getMessage().contains(&quot;no puede superar 16&quot;));</span>
<span class="fc" id="L153">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L154">    }</span>

    @Test
    @DisplayName(&quot;Crear PMS con 8 repeticiones - debe ser válido&quot;)
    void crearPms_con8Repeticiones_debeSerValido() {
        
<span class="fc" id="L160">        pmsRequestDTO.setNumRepeticionesEsperadas(8);</span>
<span class="fc" id="L161">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L162">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
<span class="fc" id="L163">        doNothing().when(analisisHistorialService).registrarCreacion(any(Pms.class));</span>

        
<span class="fc" id="L166">        PmsDTO resultado = pmsService.crearPms(pmsRequestDTO);</span>

        
<span class="fc" id="L169">        assertNotNull(resultado);</span>
<span class="fc" id="L170">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L171">    }</span>

    @Test
    @DisplayName(&quot;Crear PMS con lote inexistente - debe lanzar excepción&quot;)
    void crearPms_conLoteInexistente_debeLanzarExcepcion() {
        
<span class="fc" id="L177">        when(loteRepository.findById(999L)).thenReturn(Optional.empty());</span>
<span class="fc" id="L178">        pmsRequestDTO.setIdLote(999L);</span>

        
<span class="fc" id="L181">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L182">            pmsService.crearPms(pmsRequestDTO);</span>
<span class="nc" id="L183">        }, &quot;Debe lanzar excepción cuando el lote no existe&quot;);</span>
<span class="fc" id="L184">    }</span>

    @Test
    @DisplayName(&quot;Obtener PMS por ID - debe retornar el análisis si existe&quot;)
    void obtenerPorId_cuandoExiste_debeRetornarPms() {
        
<span class="fc" id="L190">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>

        
<span class="fc" id="L193">        PmsDTO resultado = pmsService.obtenerPorId(1L);</span>

        
<span class="fc" id="L196">        assertNotNull(resultado);</span>
<span class="fc" id="L197">        assertEquals(1L, resultado.getAnalisisID());</span>
<span class="fc" id="L198">        assertEquals(8, resultado.getNumRepeticionesEsperadas());</span>
<span class="fc" id="L199">        verify(pmsRepository, times(1)).findById(1L);</span>
<span class="fc" id="L200">    }</span>

    @Test
    @DisplayName(&quot;Obtener PMS por ID inexistente - debe lanzar excepción&quot;)
    void obtenerPorId_cuandoNoExiste_debeLanzarExcepcion() {
        
<span class="fc" id="L206">        when(pmsRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L209">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L210">            pmsService.obtenerPorId(999L);</span>
<span class="nc" id="L211">        });</span>
        
<span class="fc" id="L213">        assertTrue(exception.getMessage().contains(&quot;no encontrado&quot;));</span>
<span class="fc" id="L214">    }</span>

    @Test
    @DisplayName(&quot;Actualizar PMS - debe actualizar correctamente&quot;)
    void actualizarPms_debeActualizarCorrectamente() {
        
<span class="fc" id="L220">        pmsRequestDTO.setComentarios(&quot;Comentarios actualizados&quot;);</span>
        
<span class="fc" id="L222">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L223">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L224">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
<span class="fc" id="L225">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any(Pms.class));</span>
<span class="fc" id="L226">        doNothing().when(analisisHistorialService).registrarModificacion(any(Pms.class));</span>

        
<span class="fc" id="L229">        PmsDTO resultado = pmsService.actualizarPms(1L, pmsRequestDTO);</span>

        
<span class="fc" id="L232">        assertNotNull(resultado);</span>
<span class="fc" id="L233">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L234">        verify(analisisHistorialService, times(1)).registrarModificacion(any(Pms.class));</span>
<span class="fc" id="L235">        verify(analisisService, times(1)).manejarEdicionAnalisisFinalizado(any(Pms.class));</span>
<span class="fc" id="L236">    }</span>

    @Test
    @DisplayName(&quot;Actualizar PMS inexistente - debe lanzar excepción&quot;)
    void actualizarPms_noExistente_debeLanzarExcepcion() {
        
<span class="fc" id="L242">        when(pmsRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L245">        assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L246">            pmsService.actualizarPms(999L, pmsRequestDTO);</span>
<span class="nc" id="L247">        });</span>
        
<span class="fc" id="L249">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L250">    }</span>

    @Test
    @DisplayName(&quot;Desactivar PMS - debe cambiar activo a false&quot;)
    void desactivarPms_debeCambiarActivoAFalse() {
        
<span class="fc" id="L256">        doNothing().when(analisisService).desactivarAnalisis(eq(1L), any());</span>

        
<span class="fc" id="L259">        pmsService.desactivarPms(1L);</span>

        
<span class="fc" id="L262">        verify(analisisService, times(1)).desactivarAnalisis(eq(1L), any());</span>
<span class="fc" id="L263">    }</span>

    @Test
    @DisplayName(&quot;Reactivar PMS - debe cambiar activo a true&quot;)
    void reactivarPms_debeCambiarActivoATrue() {
        
<span class="fc" id="L269">        pms.setActivo(false);</span>
<span class="fc" id="L270">        PmsDTO pmsDTO = new PmsDTO();</span>
<span class="fc" id="L271">        pmsDTO.setAnalisisID(1L);</span>
<span class="fc" id="L272">        pmsDTO.setActivo(true);</span>
        
<span class="fc" id="L274">        when(analisisService.reactivarAnalisis(any(Long.class), any(), any())).thenReturn(pmsDTO);</span>

        
<span class="fc" id="L277">        pmsService.reactivarPms(1L);</span>

        
<span class="fc" id="L280">        verify(analisisService, times(1)).reactivarAnalisis(any(Long.class), any(), any());</span>
<span class="fc" id="L281">    }</span>

    @Test
    @DisplayName(&quot;Eliminar PMS - debe desactivar el análisis&quot;)
    void eliminarPms_debeDesactivarAnalisis() {
        
<span class="fc" id="L287">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L288">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>

        
<span class="fc" id="L291">        pmsService.eliminarPms(1L);</span>

        
<span class="fc" id="L294">        verify(pmsRepository, times(1)).findById(1L);</span>
<span class="fc" id="L295">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L296">    }</span>

    @Test
    @DisplayName(&quot;Listar PMS activos - debe retornar solo activos&quot;)
    void obtenerTodos_debeRetornarSoloActivos() {
        
<span class="fc" id="L302">        Pms pms2 = new Pms();</span>
<span class="fc" id="L303">        pms2.setAnalisisID(2L);</span>
<span class="fc" id="L304">        pms2.setActivo(true);</span>
        
<span class="fc" id="L306">        when(pmsRepository.findByActivoTrue()).thenReturn(Arrays.asList(pms, pms2));</span>

        
<span class="fc" id="L309">        List&lt;PmsDTO&gt; resultado = pmsService.obtenerTodos();</span>

        
<span class="fc" id="L312">        assertNotNull(resultado);</span>
<span class="fc" id="L313">        assertEquals(2, resultado.size());</span>
<span class="fc" id="L314">        verify(pmsRepository, times(1)).findByActivoTrue();</span>
<span class="fc" id="L315">    }</span>

    @Test
    @DisplayName(&quot;Obtener PMS por ID de lote - debe retornar análisis del lote&quot;)
    void obtenerPmsPorIdLote_debeRetornarAnalisisDelLote() {
        
<span class="fc" id="L321">        when(pmsRepository.findByIdLote(1)).thenReturn(Arrays.asList(pms));</span>

        
<span class="fc" id="L324">        List&lt;PmsDTO&gt; resultado = pmsService.obtenerPmsPorIdLote(1L);</span>

        
<span class="fc" id="L327">        assertNotNull(resultado);</span>
<span class="fc" id="L328">        assertEquals(1, resultado.size());</span>
<span class="fc" id="L329">        verify(pmsRepository, times(1)).findByIdLote(1);</span>
<span class="fc" id="L330">    }</span>

    @Test
    @DisplayName(&quot;Listar PMS paginadas - debe retornar página correcta&quot;)
    void obtenerPmsPaginadas_debeRetornarPaginaCorrecta() {
        
<span class="fc" id="L336">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L337">        Page&lt;Pms&gt; pmsPage = new PageImpl&lt;&gt;(Arrays.asList(pms));</span>
        
<span class="fc" id="L339">        when(pmsRepository.findByActivoTrueOrderByFechaInicioDesc(any(Pageable.class)))</span>
<span class="fc" id="L340">            .thenReturn(pmsPage);</span>

        
<span class="fc" id="L343">        var resultado = pmsService.obtenerPmsPaginadas(pageable);</span>

        
<span class="fc" id="L346">        assertNotNull(resultado);</span>
<span class="fc" id="L347">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L348">    }</span>

    @Test
    @DisplayName(&quot;Validar esSemillaBrozosa - debe aceptar true o false&quot;)
    void crearPms_conSemillaBrozosaTrue_debeCrearse() {
        
<span class="fc" id="L354">        pmsRequestDTO.setEsSemillaBrozosa(true);</span>
<span class="fc" id="L355">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
<span class="fc" id="L356">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
<span class="fc" id="L357">        doNothing().when(analisisHistorialService).registrarCreacion(any(Pms.class));</span>

        
<span class="fc" id="L360">        PmsDTO resultado = pmsService.crearPms(pmsRequestDTO);</span>

        
<span class="fc" id="L363">        assertNotNull(resultado);</span>
<span class="fc" id="L364">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L365">    }</span>

    @Test
    @DisplayName(&quot;finalizarAnalisis PMS - valida y llama al método genérico sin fallar si datos ok&quot;)
    void finalizarAnalisisPms_conDatosCompletos_noFalla() {
        // Configurar para que pase las validaciones
<span class="fc" id="L371">        pms.setNumTandas(1);</span>
<span class="fc" id="L372">        pms.setPmsconRedon(new BigDecimal(&quot;10.50&quot;));</span>
<span class="fc" id="L373">        pms.setEstado(Estado.EN_PROCESO);</span>
        
        // Mock AnalisisService.finalizarAnalisisGenerico
<span class="fc" id="L376">        when(analisisService.finalizarAnalisisGenerico(</span>
<span class="fc" id="L377">            eq(1L),</span>
<span class="fc" id="L378">            eq(pmsRepository),</span>
<span class="fc" id="L379">            any(),</span>
<span class="fc" id="L380">            any()</span>
<span class="fc" id="L381">        )).thenAnswer(invocation -&gt; {</span>
            // Obtener el mapper (tercer argumento) y aplicarlo al pms
<span class="fc" id="L383">            java.util.function.Function&lt;Pms, PmsDTO&gt; mapper = invocation.getArgument(2);</span>
<span class="fc" id="L384">            return mapper.apply(pms);</span>
        });
        
        // Debería finalizar sin lanzar excepción
<span class="fc" id="L388">        PmsDTO result = pmsService.finalizarAnalisis(1L);</span>
<span class="fc" id="L389">        assertNotNull(result);</span>
<span class="fc" id="L390">    }</span>

    @Test
    @DisplayName(&quot;aprobarAnalisis PMS - con datos completos no falla&quot;)
    void aprobarAnalisisPms_conDatos_noFalla() {
<span class="fc" id="L395">        pms.setEstado(Estado.PENDIENTE_APROBACION);</span>
<span class="fc" id="L396">        pms.setPmsconRedon(new BigDecimal(&quot;10.50&quot;));</span>
<span class="fc" id="L397">        pms.setNumTandas(1);</span>
        
        // Mock AnalisisService.aprobarAnalisisGenerico
<span class="fc" id="L400">        when(analisisService.aprobarAnalisisGenerico(</span>
<span class="fc" id="L401">            eq(1L),</span>
<span class="fc" id="L402">            eq(pmsRepository),</span>
<span class="fc" id="L403">            any(),</span>
<span class="fc" id="L404">            any(),</span>
<span class="fc" id="L405">            any()</span>
<span class="fc" id="L406">        )).thenAnswer(invocation -&gt; {</span>
            // Obtener el mapper y aplicarlo al pms
<span class="fc" id="L408">            java.util.function.Function&lt;Pms, PmsDTO&gt; mapper = invocation.getArgument(2);</span>
<span class="fc" id="L409">            return mapper.apply(pms);</span>
        });
        
<span class="fc" id="L412">        PmsDTO result = pmsService.aprobarAnalisis(1L);</span>
<span class="fc" id="L413">        assertNotNull(result);</span>
<span class="fc" id="L414">    }</span>

    @Test
    @DisplayName(&quot;marcarParaRepetir PMS - con datos completos no falla&quot;)
    void marcarParaRepetirPms_conDatos_noFalla() {
<span class="fc" id="L419">        pms.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L420">        pms.setPmsconRedon(new BigDecimal(&quot;10.50&quot;));</span>
<span class="fc" id="L421">        pms.setNumTandas(1);</span>
        
        // Mock AnalisisService.marcarParaRepetirGenerico
<span class="fc" id="L424">        when(analisisService.marcarParaRepetirGenerico(</span>
<span class="fc" id="L425">            eq(1L),</span>
<span class="fc" id="L426">            eq(pmsRepository),</span>
<span class="fc" id="L427">            any(),</span>
<span class="fc" id="L428">            any()</span>
<span class="fc" id="L429">        )).thenAnswer(invocation -&gt; {</span>
            // Obtener el mapper y aplicarlo al pms
<span class="fc" id="L431">            pms.setEstado(Estado.A_REPETIR); // Simular cambio de estado</span>
<span class="fc" id="L432">            java.util.function.Function&lt;Pms, PmsDTO&gt; mapper = invocation.getArgument(2);</span>
<span class="fc" id="L433">            return mapper.apply(pms);</span>
        });
        
<span class="fc" id="L436">        PmsDTO result = pmsService.marcarParaRepetir(1L);</span>
<span class="fc" id="L437">        assertNotNull(result);</span>
<span class="fc" id="L438">        assertEquals(Estado.A_REPETIR, result.getEstado());</span>
<span class="fc" id="L439">    }</span>

    @Test
    @DisplayName(&quot;desactivarPms cambia activo a false usando servicio genérico&quot;)
    void desactivarPms_llamaServicioGenerico() {
<span class="fc" id="L444">        pms.setActivo(true);</span>
        
        // Mock AnalisisService.desactivarAnalisis - debe modificar el pms en memoria
<span class="fc" id="L447">        doAnswer(invocation -&gt; {</span>
<span class="fc" id="L448">            pms.setActivo(false); // Simular desactivación</span>
<span class="fc" id="L449">            return null;</span>
<span class="fc" id="L450">        }).when(analisisService).desactivarAnalisis(eq(1L), eq(pmsRepository));</span>
        
<span class="fc" id="L452">        pmsService.desactivarPms(1L);</span>
        
        // Verificar que el servicio de análisis fue llamado
<span class="fc" id="L455">        verify(analisisService, times(1)).desactivarAnalisis(eq(1L), eq(pmsRepository));</span>
<span class="fc" id="L456">        assertFalse(pms.getActivo());</span>
<span class="fc" id="L457">    }</span>

    @Test
    @DisplayName(&quot;reactivarPms - éxito cuando estaba inactivo y error si ya activo&quot;)
    void reactivarPms_casos() {
        // Caso 1: Reactivar PMS inactivo - debe funcionar
<span class="fc" id="L463">        Pms pmsInactivo = new Pms();</span>
<span class="fc" id="L464">        pmsInactivo.setAnalisisID(1L);</span>
<span class="fc" id="L465">        pmsInactivo.setActivo(false);</span>
<span class="fc" id="L466">        pmsInactivo.setLote(lote);</span>
<span class="fc" id="L467">        pmsInactivo.setNumRepeticionesEsperadas(8);</span>
<span class="fc" id="L468">        pmsInactivo.setNumTandas(1);</span>
        
        // Mock AnalisisService.reactivarAnalisis
<span class="fc" id="L471">        when(analisisService.reactivarAnalisis(</span>
<span class="fc" id="L472">            eq(1L),</span>
<span class="fc" id="L473">            eq(pmsRepository),</span>
<span class="fc" id="L474">            any()</span>
<span class="fc" id="L475">        )).thenAnswer(invocation -&gt; {</span>
<span class="fc" id="L476">            pmsInactivo.setActivo(true); // Simular reactivación</span>
<span class="fc" id="L477">            java.util.function.Function&lt;Pms, PmsDTO&gt; mapper = invocation.getArgument(2);</span>
<span class="fc" id="L478">            PmsDTO dto = mapper.apply(pmsInactivo);</span>
            // Asegurar que activo esté seteado
<span class="pc bpc" id="L480" title="2 of 4 branches missed.">            if (dto != null &amp;&amp; dto.getActivo() == null) {</span>
<span class="fc" id="L481">                dto.setActivo(true);</span>
            }
<span class="fc" id="L483">            return dto;</span>
        });
        
<span class="fc" id="L486">        PmsDTO dto = pmsService.reactivarPms(1L);</span>
<span class="fc" id="L487">        assertNotNull(dto);</span>
<span class="fc" id="L488">        assertTrue(dto.getActivo());</span>
        
        // Caso 2: Intentar reactivar PMS ya activo - debe lanzar excepción
<span class="fc" id="L491">        when(analisisService.reactivarAnalisis(</span>
<span class="fc" id="L492">            eq(2L),</span>
<span class="fc" id="L493">            eq(pmsRepository),</span>
<span class="fc" id="L494">            any()</span>
<span class="fc" id="L495">        )).thenThrow(new RuntimeException(&quot;El análisis ya está activo&quot;));</span>
        
<span class="pc" id="L497">        assertThrows(RuntimeException.class, () -&gt; pmsService.reactivarPms(2L));</span>
<span class="fc" id="L498">    }</span>

    @Test
    @DisplayName(&quot;procesarCalculosTanda - tanda incompleta solo actualiza estadísticas&quot;)
    void procesarCalculosTanda_tandaIncompleta_soloActualizaEstadisticas() {
        
<span class="fc" id="L504">        pms.setNumRepeticionesEsperadas(8);</span>
<span class="fc" id="L505">        pms.setNumTandas(1);</span>
<span class="fc" id="L506">        pms.setEsSemillaBrozosa(false);</span>
        
        // Crear solo 4 repeticiones (menos de las esperadas)
<span class="fc" id="L509">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L511">            RepPms rep = new RepPms();</span>
<span class="fc" id="L512">            rep.setNumRep(i);</span>
<span class="fc" id="L513">            rep.setNumTanda(1);</span>
<span class="fc" id="L514">            rep.setPeso(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L515">            rep.setValido(true);</span>
<span class="fc" id="L516">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L519">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L520">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L521">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L524">        pmsService.procesarCalculosTanda(1L, 1);</span>
        
        
<span class="fc" id="L527">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L528">        verify(repPmsRepository, never()).saveAll(anyList());</span>
<span class="fc" id="L529">    }</span>

    @Test
    @DisplayName(&quot;procesarCalculosTanda - tanda completa con CV aceptable&quot;)
    void procesarCalculosTanda_tandaCompleta_CVAceptable() {
        
<span class="fc" id="L535">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L536">        pms.setNumTandas(1);</span>
<span class="fc" id="L537">        pms.setEsSemillaBrozosa(false); // Umbral CV = 4.0</span>
        
        // Crear 4 repeticiones válidas con pesos similares
<span class="fc" id="L540">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L541" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L542">            RepPms rep = new RepPms();</span>
<span class="fc" id="L543">            rep.setNumRep(i);</span>
<span class="fc" id="L544">            rep.setNumTanda(1);</span>
<span class="fc" id="L545">            rep.setPeso(new BigDecimal(&quot;10.&quot; + i)); // 10.1, 10.2, 10.3, 10.4</span>
<span class="fc" id="L546">            rep.setValido(null);</span>
<span class="fc" id="L547">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L550">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L551">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L552">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L553">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L556">        pmsService.procesarCalculosTanda(1L, 1);</span>
        
        
<span class="fc" id="L559">        verify(repPmsRepository, times(1)).saveAll(anyList());</span>
<span class="fc" id="L560">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L561">    }</span>

    @Test
    @DisplayName(&quot;procesarCalculosTanda - tanda completa con CV no aceptable incrementa tandas&quot;)
    void procesarCalculosTanda_CVNoAceptable_incrementaTandas() {
        
<span class="fc" id="L567">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L568">        pms.setNumTandas(1);</span>
<span class="fc" id="L569">        pms.setEsSemillaBrozosa(false); // Umbral CV = 4.0</span>
        
        // Crear repeticiones con mucha variación para CV alto
<span class="fc" id="L572">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L573">        BigDecimal[] pesos = {new BigDecimal(&quot;8.0&quot;), new BigDecimal(&quot;10.0&quot;), </span>
                             new BigDecimal(&quot;12.0&quot;), new BigDecimal(&quot;14.0&quot;)};
<span class="fc bfc" id="L575" title="All 2 branches covered.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="fc" id="L576">            RepPms rep = new RepPms();</span>
<span class="fc" id="L577">            rep.setNumRep(i + 1);</span>
<span class="fc" id="L578">            rep.setNumTanda(1);</span>
<span class="fc" id="L579">            rep.setPeso(pesos[i]);</span>
<span class="fc" id="L580">            rep.setValido(null);</span>
<span class="fc" id="L581">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L584">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L585">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L586">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L587">        when(repPmsRepository.countByPmsId(1L)).thenReturn(4L);</span>
<span class="fc" id="L588">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L591">        pmsService.procesarCalculosTanda(1L, 1);</span>
        
        
<span class="fc" id="L594">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L595">    }</span>

    @Test
    @DisplayName(&quot;procesarCalculosTanda - sin repeticiones válidas incrementa tandas&quot;)
    void procesarCalculosTanda_sinRepeticionesValidas_incrementaTandas() {
        
<span class="fc" id="L601">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L602">        pms.setNumTandas(1);</span>
<span class="fc" id="L603">        pms.setEsSemillaBrozosa(false);</span>
        
        // Crear repeticiones que serán marcadas como inválidas
<span class="fc" id="L606">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L607" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L608">            RepPms rep = new RepPms();</span>
<span class="fc" id="L609">            rep.setNumRep(i);</span>
<span class="fc" id="L610">            rep.setNumTanda(1);</span>
<span class="fc" id="L611">            rep.setPeso(new BigDecimal(&quot;100.0&quot;)); // Outlier extremo</span>
<span class="fc" id="L612">            rep.setValido(false);</span>
<span class="fc" id="L613">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L616">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L617">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L618">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L619">        when(repPmsRepository.countByPmsId(1L)).thenReturn(4L);</span>
<span class="fc" id="L620">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L623">        pmsService.procesarCalculosTanda(1L, 1);</span>
        
        
<span class="fc" id="L626">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L627">    }</span>

    @Test
    @DisplayName(&quot;validarTodasLasRepeticiones - sin repeticiones no hace nada&quot;)
    void validarTodasLasRepeticiones_sinRepeticiones_noHaceNada() {
        
<span class="fc" id="L633">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L634">        when(repPmsRepository.findByPmsId(1L)).thenReturn(Collections.emptyList());</span>
        
        
<span class="fc" id="L637">        pmsService.validarTodasLasRepeticiones(1L);</span>
        
        
<span class="fc" id="L640">        verify(repPmsRepository, never()).saveAll(anyList());</span>
<span class="fc" id="L641">    }</span>

    @Test
    @DisplayName(&quot;validarTodasLasRepeticiones - repeticiones insuficientes marca como indeterminadas&quot;)
    void validarTodasLasRepeticiones_repeticionesInsuficientes_marcaIndeterminadas() {
        
<span class="fc" id="L647">        pms.setNumRepeticionesEsperadas(8);</span>
        
<span class="fc" id="L649">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) { // Menos de las esperadas</span>
<span class="fc" id="L651">            RepPms rep = new RepPms();</span>
<span class="fc" id="L652">            rep.setNumRep(i);</span>
<span class="fc" id="L653">            rep.setPeso(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L654">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L657">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L658">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L659">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L660">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L663">        pmsService.validarTodasLasRepeticiones(1L);</span>
        
        
<span class="fc" id="L666">        verify(repPmsRepository, times(1)).saveAll(anyList());</span>
<span class="fc" id="L667">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L668">    }</span>

    @Test
    @DisplayName(&quot;validarTodasLasRepeticiones - con repeticiones suficientes valida correctamente&quot;)
    void validarTodasLasRepeticiones_repeticionesSuficientes_validaCorrectamente() {
        
<span class="fc" id="L674">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L675">        pms.setNumTandas(1);</span>
<span class="fc" id="L676">        pms.setEsSemillaBrozosa(false);</span>
        
<span class="fc" id="L678">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L679" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L680">            RepPms rep = new RepPms();</span>
<span class="fc" id="L681">            rep.setNumRep(i);</span>
<span class="fc" id="L682">            rep.setNumTanda(1);</span>
<span class="fc" id="L683">            rep.setPeso(new BigDecimal(&quot;10.&quot; + i));</span>
<span class="fc" id="L684">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L687">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L688">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L689">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L690">        when(repPmsRepository.countByPmsId(1L)).thenReturn(4L);</span>
<span class="fc" id="L691">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L694">        pmsService.validarTodasLasRepeticiones(1L);</span>
        
        
<span class="fc" id="L697">        verify(repPmsRepository, times(1)).saveAll(anyList());</span>
<span class="fc" id="L698">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L699">    }</span>

    @Test
    @DisplayName(&quot;actualizarPmsConRedondeo - actualiza correctamente en estado EN_PROCESO&quot;)
    void actualizarPmsConRedondeo_estadoEnProceso_actualizaCorrectamente() {
        
<span class="fc" id="L705">        pms.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L706">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L707">        pms.setNumTandas(1);</span>
<span class="fc" id="L708">        pms.setEsSemillaBrozosa(false);</span>
        
        
<span class="fc" id="L711">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L712" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L713">            RepPms rep = new RepPms();</span>
<span class="fc" id="L714">            rep.setNumRep(i);</span>
<span class="fc" id="L715">            rep.setNumTanda(1);</span>
<span class="fc" id="L716">            rep.setPeso(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L717">            rep.setValido(true);</span>
<span class="fc" id="L718">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L721">        PmsRedondeoRequestDTO request = new PmsRedondeoRequestDTO();</span>
<span class="fc" id="L722">        request.setPmsconRedon(new BigDecimal(&quot;100.5&quot;));</span>
        
<span class="fc" id="L724">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L725">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L726">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L729">        PmsDTO resultado = pmsService.actualizarPmsConRedondeo(1L, request);</span>
        
        
<span class="fc" id="L732">        assertNotNull(resultado);</span>
<span class="fc" id="L733">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L734">    }</span>

    @Test
    @DisplayName(&quot;actualizarPmsConRedondeo - falla con estado REGISTRADO&quot;)
    void actualizarPmsConRedondeo_estadoRegistrado_lanzaExcepcion() {
        
<span class="fc" id="L740">        pms.setEstado(Estado.REGISTRADO);</span>
        
<span class="fc" id="L742">        PmsRedondeoRequestDTO request = new PmsRedondeoRequestDTO();</span>
<span class="fc" id="L743">        request.setPmsconRedon(new BigDecimal(&quot;100.5&quot;));</span>
        
<span class="fc" id="L745">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
        
        
<span class="fc" id="L748">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L749">            pmsService.actualizarPmsConRedondeo(1L, request);</span>
<span class="nc" id="L750">        });</span>
        
<span class="fc" id="L752">        assertTrue(exception.getMessage().contains(&quot;EN_PROCESO&quot;));</span>
<span class="fc" id="L753">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L754">    }</span>

    @Test
    @DisplayName(&quot;actualizarPmsConRedondeo - falla si repeticiones incompletas&quot;)
    void actualizarPmsConRedondeo_repeticionesIncompletas_lanzaExcepcion() {
        
<span class="fc" id="L760">        pms.setEstado(Estado.EN_PROCESO);</span>
<span class="fc" id="L761">        pms.setNumRepeticionesEsperadas(8);</span>
<span class="fc" id="L762">        pms.setNumTandas(1);</span>
        
        
<span class="fc" id="L765">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L766" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L767">            RepPms rep = new RepPms();</span>
<span class="fc" id="L768">            rep.setNumRep(i);</span>
<span class="fc" id="L769">            rep.setNumTanda(1);</span>
<span class="fc" id="L770">            rep.setPeso(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L771">            rep.setValido(true);</span>
<span class="fc" id="L772">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L775">        PmsRedondeoRequestDTO request = new PmsRedondeoRequestDTO();</span>
<span class="fc" id="L776">        request.setPmsconRedon(new BigDecimal(&quot;100.5&quot;));</span>
        
<span class="fc" id="L778">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L779">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
        
        
<span class="fc" id="L782">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L783">            pmsService.actualizarPmsConRedondeo(1L, request);</span>
<span class="nc" id="L784">        });</span>
        
<span class="fc" id="L786">        assertTrue(exception.getMessage().contains(&quot;repeticiones válidas&quot;));</span>
<span class="fc" id="L787">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L788">    }</span>

    @Test
    @DisplayName(&quot;actualizarEstadisticasPms - actualiza estadísticas públicamente&quot;)
    void actualizarEstadisticasPms_actualizaCorrectamente() {
        
<span class="fc" id="L794">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L795">        when(repPmsRepository.findByPmsId(1L)).thenReturn(Collections.emptyList());</span>
<span class="fc" id="L796">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L799">        pmsService.actualizarEstadisticasPms(1L);</span>
        
        
<span class="fc" id="L802">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L803">    }</span>

    @Test
    @DisplayName(&quot;obtenerPmsPaginadasConFiltro - filtro 'activos'&quot;)
    void obtenerPmsPaginadasConFiltro_activos() {
        
<span class="fc" id="L809">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L810">        Page&lt;Pms&gt; pmsPage = new PageImpl&lt;&gt;(Arrays.asList(pms));</span>
        
<span class="fc" id="L812">        when(pmsRepository.findByActivoTrueOrderByFechaInicioDesc(pageable))</span>
<span class="fc" id="L813">            .thenReturn(pmsPage);</span>
        
        
<span class="fc" id="L816">        var resultado = pmsService.obtenerPmsPaginadasConFiltro(pageable, &quot;activos&quot;);</span>
        
        
<span class="fc" id="L819">        assertNotNull(resultado);</span>
<span class="fc" id="L820">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L821">        verify(pmsRepository, times(1)).findByActivoTrueOrderByFechaInicioDesc(pageable);</span>
<span class="fc" id="L822">    }</span>

    @Test
    @DisplayName(&quot;obtenerPmsPaginadasConFiltro - filtro 'inactivos'&quot;)
    void obtenerPmsPaginadasConFiltro_inactivos() {
        
<span class="fc" id="L828">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L829">        pms.setActivo(false);</span>
<span class="fc" id="L830">        Page&lt;Pms&gt; pmsPage = new PageImpl&lt;&gt;(Arrays.asList(pms));</span>
        
<span class="fc" id="L832">        when(pmsRepository.findByActivoFalseOrderByFechaInicioDesc(pageable))</span>
<span class="fc" id="L833">            .thenReturn(pmsPage);</span>
        
        
<span class="fc" id="L836">        var resultado = pmsService.obtenerPmsPaginadasConFiltro(pageable, &quot;inactivos&quot;);</span>
        
        
<span class="fc" id="L839">        assertNotNull(resultado);</span>
<span class="fc" id="L840">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L841">        verify(pmsRepository, times(1)).findByActivoFalseOrderByFechaInicioDesc(pageable);</span>
<span class="fc" id="L842">    }</span>

    @Test
    @DisplayName(&quot;obtenerPmsPaginadasConFiltro - filtro 'todos'&quot;)
    void obtenerPmsPaginadasConFiltro_todos() {
        
<span class="fc" id="L848">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L849">        Page&lt;Pms&gt; pmsPage = new PageImpl&lt;&gt;(Arrays.asList(pms));</span>
        
<span class="fc" id="L851">        when(pmsRepository.findAllByOrderByFechaInicioDesc(pageable))</span>
<span class="fc" id="L852">            .thenReturn(pmsPage);</span>
        
        
<span class="fc" id="L855">        var resultado = pmsService.obtenerPmsPaginadasConFiltro(pageable, &quot;todos&quot;);</span>
        
        
<span class="fc" id="L858">        assertNotNull(resultado);</span>
<span class="fc" id="L859">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L860">        verify(pmsRepository, times(1)).findAllByOrderByFechaInicioDesc(pageable);</span>
<span class="fc" id="L861">    }</span>

    @Test
    @DisplayName(&quot;obtenerPmsPaginadasConFiltros - con filtros dinámicos&quot;)
    void obtenerPmsPaginadasConFiltros_conFiltrosDinamicos() {
        
<span class="fc" id="L867">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L868">        Page&lt;Pms&gt; pmsPage = new PageImpl&lt;&gt;(Arrays.asList(pms));</span>
        
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L871">        Specification&lt;Pms&gt; anySpec = any(Specification.class);</span>
<span class="fc" id="L872">        when(pmsRepository.findAll(anySpec, eq(pageable)))</span>
<span class="fc" id="L873">            .thenReturn(pmsPage);</span>
        
        
<span class="fc" id="L876">        var resultado = pmsService.obtenerPmsPaginadasConFiltros(</span>
<span class="fc" id="L877">            pageable, &quot;LOTE-001&quot;, true, &quot;EN_PROCESO&quot;, 1L);</span>
        
        
<span class="fc" id="L880">        assertNotNull(resultado);</span>
<span class="fc" id="L881">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L882">    }</span>

    @Test
    @DisplayName(&quot;crear PMS con lote inactivo - debe lanzar excepción&quot;)
    void crearPms_conLoteInactivo_debeLanzarExcepcion() {
        
<span class="fc" id="L888">        lote.setActivo(false);</span>
<span class="fc" id="L889">        when(loteRepository.findById(1L)).thenReturn(Optional.of(lote));</span>
        
        
<span class="fc" id="L892">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L893">            pmsService.crearPms(pmsRequestDTO);</span>
<span class="nc" id="L894">        });</span>
        
<span class="fc" id="L896">        assertTrue(exception.getMessage().contains(&quot;activo&quot;));</span>
<span class="fc" id="L897">        verify(pmsRepository, never()).save(any(Pms.class));</span>
<span class="fc" id="L898">    }</span>

    @Test
    @DisplayName(&quot;mapeo DTO completo - con cultivar y especie&quot;)
    void mapeoDTO_conCultivarYEspecie() {
        
<span class="fc" id="L904">        Especie especie = new Especie();</span>
<span class="fc" id="L905">        especie.setNombreComun(&quot;Trigo&quot;);</span>
<span class="fc" id="L906">        especie.setNombreCientifico(&quot;Triticum aestivum&quot;);</span>
        
<span class="fc" id="L908">        Cultivar cultivar = new Cultivar();</span>
<span class="fc" id="L909">        cultivar.setNombre(&quot;Cultivar Test&quot;);</span>
<span class="fc" id="L910">        cultivar.setEspecie(especie);</span>
        
<span class="fc" id="L912">        lote.setCultivar(cultivar);</span>
<span class="fc" id="L913">        lote.setFicha(&quot;FICHA-001&quot;);</span>
        
<span class="fc" id="L915">        pms.setLote(lote);</span>
<span class="fc" id="L916">        pms.setPromedio100g(new BigDecimal(&quot;10.5&quot;));</span>
<span class="fc" id="L917">        pms.setDesvioStd(new BigDecimal(&quot;0.5&quot;));</span>
<span class="fc" id="L918">        pms.setCoefVariacion(new BigDecimal(&quot;4.76&quot;));</span>
<span class="fc" id="L919">        pms.setPmssinRedon(new BigDecimal(&quot;105.0&quot;));</span>
<span class="fc" id="L920">        pms.setPmsconRedon(new BigDecimal(&quot;105&quot;));</span>
        
<span class="fc" id="L922">        List&lt;AnalisisHistorialDTO&gt; historial = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L923">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L924">        when(analisisHistorialService.obtenerHistorialAnalisis(1L)).thenReturn(historial);</span>
        
        
<span class="fc" id="L927">        PmsDTO resultado = pmsService.obtenerPorId(1L);</span>
        
        
<span class="fc" id="L930">        assertNotNull(resultado);</span>
<span class="fc" id="L931">        assertEquals(&quot;Cultivar Test&quot;, resultado.getCultivarNombre());</span>
<span class="fc" id="L932">        assertEquals(&quot;Trigo&quot;, resultado.getEspecieNombre());</span>
<span class="fc" id="L933">        assertEquals(&quot;FICHA-001&quot;, resultado.getFicha());</span>
<span class="fc" id="L934">    }</span>

    @Test
    @DisplayName(&quot;actualizarPmsConRedondeo - con estado PENDIENTE_APROBACION&quot;)
    void actualizarPmsConRedondeo_estadoPendienteAprobacion() {
        
<span class="fc" id="L940">        pms.setEstado(Estado.PENDIENTE_APROBACION);</span>
<span class="fc" id="L941">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L942">        pms.setNumTandas(1);</span>
<span class="fc" id="L943">        pms.setEsSemillaBrozosa(false);</span>
        
<span class="fc" id="L945">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L946" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L947">            RepPms rep = new RepPms();</span>
<span class="fc" id="L948">            rep.setNumRep(i);</span>
<span class="fc" id="L949">            rep.setNumTanda(1);</span>
<span class="fc" id="L950">            rep.setPeso(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L951">            rep.setValido(true);</span>
<span class="fc" id="L952">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L955">        PmsRedondeoRequestDTO request = new PmsRedondeoRequestDTO();</span>
<span class="fc" id="L956">        request.setPmsconRedon(new BigDecimal(&quot;100.0&quot;));</span>
        
<span class="fc" id="L958">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L959">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L960">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L963">        PmsDTO resultado = pmsService.actualizarPmsConRedondeo(1L, request);</span>
        
        
<span class="fc" id="L966">        assertNotNull(resultado);</span>
<span class="fc" id="L967">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L968">    }</span>

    @Test
    @DisplayName(&quot;actualizarPmsConRedondeo - con estado APROBADO&quot;)
    void actualizarPmsConRedondeo_estadoAprobado() {
        
<span class="fc" id="L974">        pms.setEstado(Estado.APROBADO);</span>
<span class="fc" id="L975">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L976">        pms.setNumTandas(1);</span>
<span class="fc" id="L977">        pms.setEsSemillaBrozosa(false);</span>
        
<span class="fc" id="L979">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L980" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L981">            RepPms rep = new RepPms();</span>
<span class="fc" id="L982">            rep.setNumRep(i);</span>
<span class="fc" id="L983">            rep.setNumTanda(1);</span>
<span class="fc" id="L984">            rep.setPeso(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L985">            rep.setValido(true);</span>
<span class="fc" id="L986">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L989">        PmsRedondeoRequestDTO request = new PmsRedondeoRequestDTO();</span>
<span class="fc" id="L990">        request.setPmsconRedon(new BigDecimal(&quot;100.0&quot;));</span>
        
<span class="fc" id="L992">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L993">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L994">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L997">        PmsDTO resultado = pmsService.actualizarPmsConRedondeo(1L, request);</span>
        
        
<span class="fc" id="L1000">        assertNotNull(resultado);</span>
<span class="fc" id="L1001">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L1002">    }</span>

    @Test
    @DisplayName(&quot;validarTodasLasRepeticiones - con CV alto incrementa tandas&quot;)
    void validarTodasLasRepeticiones_CVAlto_incrementaTandas() {
        
<span class="fc" id="L1008">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L1009">        pms.setNumTandas(1);</span>
<span class="fc" id="L1010">        pms.setEsSemillaBrozosa(false);</span>
        
        
<span class="fc" id="L1013">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1014">        BigDecimal[] pesos = {new BigDecimal(&quot;8.0&quot;), new BigDecimal(&quot;10.0&quot;), </span>
                             new BigDecimal(&quot;12.0&quot;), new BigDecimal(&quot;14.0&quot;)};
<span class="fc bfc" id="L1016" title="All 2 branches covered.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="fc" id="L1017">            RepPms rep = new RepPms();</span>
<span class="fc" id="L1018">            rep.setNumRep(i + 1);</span>
<span class="fc" id="L1019">            rep.setNumTanda(1);</span>
<span class="fc" id="L1020">            rep.setPeso(pesos[i]);</span>
<span class="fc" id="L1021">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L1024">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L1025">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L1026">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L1027">        when(repPmsRepository.countByPmsId(1L)).thenReturn(4L);</span>
<span class="fc" id="L1028">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L1031">        pmsService.validarTodasLasRepeticiones(1L);</span>
        
        
<span class="fc" id="L1034">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L1035">    }</span>

    @Test
    @DisplayName(&quot;procesarCalculosTanda - con semilla brozosa usa umbral CV 6.0&quot;)
    void procesarCalculosTanda_semillaBrozosa_umbralCV6() {
        
<span class="fc" id="L1041">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L1042">        pms.setNumTandas(1);</span>
<span class="fc" id="L1043">        pms.setEsSemillaBrozosa(true); </span>
        
<span class="fc" id="L1045">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L1046" title="All 2 branches covered.">        for (int i = 1; i &lt;= 4; i++) {</span>
<span class="fc" id="L1047">            RepPms rep = new RepPms();</span>
<span class="fc" id="L1048">            rep.setNumRep(i);</span>
<span class="fc" id="L1049">            rep.setNumTanda(1);</span>
<span class="fc" id="L1050">            rep.setPeso(new BigDecimal(&quot;10.&quot; + i));</span>
<span class="fc" id="L1051">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L1054">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L1055">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L1056">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L1057">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L1060">        pmsService.procesarCalculosTanda(1L, 1);</span>
        
        
<span class="fc" id="L1063">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L1064">    }</span>

    @Test
    @DisplayName(&quot;procesarCalculosTanda - alcanza límite de 16 repeticiones&quot;)
    void procesarCalculosTanda_alcanzaLimite16_noIncrementaTandas() {
        
<span class="fc" id="L1070">        pms.setNumRepeticionesEsperadas(4);</span>
<span class="fc" id="L1071">        pms.setNumTandas(4);</span>
<span class="fc" id="L1072">        pms.setEsSemillaBrozosa(false);</span>
        
<span class="fc" id="L1074">        List&lt;RepPms&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1075">        BigDecimal[] pesos = {new BigDecimal(&quot;8.0&quot;), new BigDecimal(&quot;10.0&quot;), </span>
                             new BigDecimal(&quot;12.0&quot;), new BigDecimal(&quot;14.0&quot;)};
<span class="fc bfc" id="L1077" title="All 2 branches covered.">        for (int i = 0; i &lt; 4; i++) {</span>
<span class="fc" id="L1078">            RepPms rep = new RepPms();</span>
<span class="fc" id="L1079">            rep.setNumRep(i + 1);</span>
<span class="fc" id="L1080">            rep.setNumTanda(4);</span>
<span class="fc" id="L1081">            rep.setPeso(pesos[i]);</span>
<span class="fc" id="L1082">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L1085">        when(pmsRepository.findById(1L)).thenReturn(Optional.of(pms));</span>
<span class="fc" id="L1086">        when(repPmsRepository.findByPmsId(1L)).thenReturn(repeticiones);</span>
<span class="fc" id="L1087">        when(repPmsRepository.saveAll(anyList())).thenReturn(repeticiones);</span>
<span class="fc" id="L1088">        when(repPmsRepository.countByPmsId(1L)).thenReturn(16L); </span>
<span class="fc" id="L1089">        when(pmsRepository.save(any(Pms.class))).thenReturn(pms);</span>
        
        
<span class="fc" id="L1092">        pmsService.procesarCalculosTanda(1L, 4);</span>
        
        
<span class="fc" id="L1095">        verify(pmsRepository, times(1)).save(any(Pms.class));</span>
<span class="fc" id="L1096">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>