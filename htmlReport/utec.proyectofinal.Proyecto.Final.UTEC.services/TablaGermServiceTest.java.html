<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TablaGermServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">TablaGermServiceTest.java</span></div><h1>TablaGermServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.RepGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.TablaGerm;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.RepGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TablaGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ValoresGermRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.PorcentajesRedondeoRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.TablaGermRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.TablaGermDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Instituto;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de TablaGermService&quot;)
<span class="fc" id="L37">class TablaGermServiceTest {</span>

    @Mock
    private TablaGermRepository tablaGermRepository;

    @Mock
    private GerminacionRepository germinacionRepository;

    @Mock
    private RepGermRepository repGermRepository;

    @Mock
    private ValoresGermRepository valoresGermRepository;

    @Mock
    private AnalisisService analisisService;

    @InjectMocks
    private TablaGermService tablaGermService;

    private Germinacion germinacion;
    private TablaGerm tablaGerm;
    private TablaGermRequestDTO requestDTO;

    @BeforeEach
    void setUp() {
<span class="fc" id="L63">        germinacion = new Germinacion();</span>
<span class="fc" id="L64">        germinacion.setAnalisisID(1L);</span>

<span class="fc" id="L66">        tablaGerm = new TablaGerm();</span>
<span class="fc" id="L67">        tablaGerm.setTablaGermID(15L);</span>
<span class="fc" id="L68">        tablaGerm.setFinalizada(false);</span>
<span class="fc" id="L69">        tablaGerm.setTratamiento(&quot;Agar&quot;);</span>
<span class="fc" id="L70">        tablaGerm.setProductoYDosis(&quot;Sin producto&quot;);</span>
<span class="fc" id="L71">        tablaGerm.setNumSemillasPRep(100);</span>
<span class="fc" id="L72">        tablaGerm.setMetodo(&quot;Entre papel&quot;);</span>
<span class="fc" id="L73">        tablaGerm.setTemperatura(&quot;25&quot;);</span>
<span class="fc" id="L74">        tablaGerm.setTienePrefrio(false);</span>
<span class="fc" id="L75">        tablaGerm.setTienePretratamiento(false);</span>
<span class="fc" id="L76">        tablaGerm.setDiasPrefrio(0);</span>
<span class="fc" id="L77">        tablaGerm.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L78">        tablaGerm.setFechaGerminacion(LocalDate.of(2024, 1, 15));</span>
<span class="fc" id="L79">        tablaGerm.setFechaConteos(Arrays.asList(LocalDate.of(2024, 1, 18), LocalDate.of(2024, 1, 22), LocalDate.of(2024, 1, 25)));</span>
<span class="fc" id="L80">        tablaGerm.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L81">        tablaGerm.setNumDias(&quot;10&quot;);</span>
<span class="fc" id="L82">        tablaGerm.setNumeroRepeticiones(8);</span>
<span class="fc" id="L83">        tablaGerm.setNumeroConteos(3);</span>
<span class="fc" id="L84">        tablaGerm.setGerminacion(germinacion);</span>

<span class="fc" id="L86">        requestDTO = new TablaGermRequestDTO();</span>
<span class="fc" id="L87">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L88">        requestDTO.setTratamiento(&quot;Agar&quot;);</span>
<span class="fc" id="L89">        requestDTO.setProductoYDosis(&quot;Sin producto&quot;);</span>
<span class="fc" id="L90">        requestDTO.setNumSemillasPRep(100);</span>
<span class="fc" id="L91">        requestDTO.setMetodo(&quot;Entre papel&quot;);</span>
<span class="fc" id="L92">        requestDTO.setTemperatura(&quot;25&quot;);</span>
<span class="fc" id="L93">        requestDTO.setTienePrefrio(false);</span>
<span class="fc" id="L94">        requestDTO.setTienePretratamiento(false);</span>
<span class="fc" id="L95">        requestDTO.setDiasPrefrio(0);</span>
<span class="fc" id="L96">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L97">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 15));</span>
<span class="fc" id="L98">        requestDTO.setFechaConteos(Arrays.asList(LocalDate.of(2024, 1, 18), LocalDate.of(2024, 1, 22), LocalDate.of(2024, 1, 25)));</span>
<span class="fc" id="L99">        requestDTO.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L100">        requestDTO.setNumDias(&quot;10&quot;);</span>
<span class="fc" id="L101">        requestDTO.setNumeroRepeticiones(8);</span>
<span class="fc" id="L102">        requestDTO.setNumeroConteos(3);</span>
<span class="fc" id="L103">    }</span>

    @Test
    @DisplayName(&quot;Crear tabla - debe crear exitosamente&quot;)
    void crearTablaGerm_debeCrearExitosamente() {
        
<span class="fc" id="L109">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>
<span class="fc" id="L110">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>

        
<span class="fc" id="L113">        TablaGermDTO resultado = tablaGermService.crearTablaGerm(1L, requestDTO);</span>

        
<span class="fc" id="L116">        assertNotNull(resultado);</span>
<span class="fc" id="L117">        assertEquals(15L, resultado.getTablaGermID());</span>
<span class="fc" id="L118">        assertEquals(&quot;Agar&quot;, resultado.getTratamiento());</span>
<span class="fc" id="L119">        verify(tablaGermRepository, times(1)).save(any(TablaGerm.class));</span>
<span class="fc" id="L120">    }</span>

    @Test
    @DisplayName(&quot;Crear tabla - debe lanzar excepción si germinación no existe&quot;)
    void crearTablaGerm_debeLanzarExcepcionSiGerminacionNoExiste() {
        
<span class="fc" id="L126">        when(germinacionRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L129">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L130">            tablaGermService.crearTablaGerm(999L, requestDTO);</span>
<span class="nc" id="L131">        });</span>
        
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;no encontrada&quot;) || </span>
<span class="pc bnc" id="L134" title="All 2 branches missed.">                   exception.getMessage().contains(&quot;no existe&quot;));</span>
<span class="fc" id="L135">        verify(tablaGermRepository, never()).save(any(TablaGerm.class));</span>
<span class="fc" id="L136">    }</span>

    @Test
    @DisplayName(&quot;Obtener tabla por ID - debe retornar si existe&quot;)
    void obtenerTablaGermPorId_debeRetornarSiExiste() {
        
<span class="fc" id="L142">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>

        
<span class="fc" id="L145">        TablaGermDTO resultado = tablaGermService.obtenerTablaGermPorId(15L);</span>

        
<span class="fc" id="L148">        assertNotNull(resultado);</span>
<span class="fc" id="L149">        assertEquals(15L, resultado.getTablaGermID());</span>
<span class="fc" id="L150">        verify(tablaGermRepository, times(1)).findById(15L);</span>
<span class="fc" id="L151">    }</span>

    @Test
    @DisplayName(&quot;Obtener tabla por ID - debe lanzar excepción si no existe&quot;)
    void obtenerTablaGermPorId_debeLanzarExcepcionSiNoExiste() {
        
<span class="fc" id="L157">        when(tablaGermRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L160">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L161">            tablaGermService.obtenerTablaGermPorId(999L);</span>
<span class="nc" id="L162">        });</span>
        
<span class="fc" id="L164">        assertTrue(exception.getMessage().contains(&quot;no encontrada&quot;));</span>
<span class="fc" id="L165">    }</span>

    @Test
    @DisplayName(&quot;Actualizar tabla - debe actualizar correctamente&quot;)
    void actualizarTablaGerm_debeActualizarCorrectamente() {
        
<span class="fc" id="L171">        requestDTO.setTemperatura(&quot;28&quot;);</span>
<span class="fc" id="L172">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L173">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L174">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L177">        TablaGermDTO resultado = tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L180">        assertNotNull(resultado);</span>
<span class="fc" id="L181">        verify(tablaGermRepository, times(1)).save(any(TablaGerm.class));</span>
<span class="fc" id="L182">    }</span>

    @Test
    @DisplayName(&quot;Eliminar tabla - debe eliminar correctamente&quot;)
    void eliminarTablaGerm_debeEliminarCorrectamente() {
        
<span class="fc" id="L188">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L189">        when(valoresGermRepository.findByTablaGermId(15L)).thenReturn(Arrays.asList());</span>
<span class="fc" id="L190">        doNothing().when(tablaGermRepository).deleteById(15L);</span>

        
<span class="fc" id="L193">        tablaGermService.eliminarTablaGerm(15L);</span>

        
<span class="fc" id="L196">        verify(tablaGermRepository, times(1)).deleteById(15L);</span>
<span class="fc" id="L197">    }</span>

    @Test
    @DisplayName(&quot;Eliminar tabla - debe lanzar excepción si no existe&quot;)
    void eliminarTablaGerm_debeLanzarExcepcionSiNoExiste() {
        
<span class="fc" id="L203">        when(tablaGermRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L206">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L207">            tablaGermService.eliminarTablaGerm(999L);</span>
<span class="nc" id="L208">        });</span>
        
<span class="fc" id="L210">        assertTrue(exception.getMessage().contains(&quot;no encontrada&quot;));</span>
<span class="fc" id="L211">        verify(tablaGermRepository, never()).deleteById(anyLong());</span>
<span class="fc" id="L212">    }</span>

    @Test
    @DisplayName(&quot;Finalizar tabla - debe marcar como finalizada&quot;)
    void finalizarTabla_debMarcarComoFinalizada() {
        
        
<span class="fc" id="L219">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L221">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L222">            rep.setNormales(Arrays.asList(10, 15, 20)); </span>
<span class="fc" id="L223">            rep.setAnormales(10); </span>
<span class="fc" id="L224">            rep.setDuras(0);</span>
<span class="fc" id="L225">            rep.setFrescas(0);</span>
<span class="fc" id="L226">            rep.setMuertas(5);</span>
<span class="fc" id="L227">            rep.setTablaGerm(tablaGerm); </span>
<span class="fc" id="L228">            repeticiones.add(rep);</span>
        }
<span class="fc" id="L230">        tablaGerm.setRepGerm(repeticiones);</span>
        
        
<span class="fc" id="L233">        tablaGerm.setPorcentajeNormalesConRedondeo(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L234">        tablaGerm.setPorcentajeAnormalesConRedondeo(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L235">        tablaGerm.setPorcentajeDurasConRedondeo(new BigDecimal(&quot;0.0&quot;));</span>
<span class="fc" id="L236">        tablaGerm.setPorcentajeFrescasConRedondeo(new BigDecimal(&quot;0.0&quot;));</span>
<span class="fc" id="L237">        tablaGerm.setPorcentajeMuertasConRedondeo(new BigDecimal(&quot;5.0&quot;));</span>
        
<span class="fc" id="L239">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L240">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>

        
<span class="fc" id="L243">        TablaGermDTO resultado = tablaGermService.finalizarTabla(15L);</span>

        
<span class="fc" id="L246">        assertNotNull(resultado);</span>
<span class="fc" id="L247">        verify(tablaGermRepository).save(argThat(tabla -&gt; tabla.getFinalizada()));</span>
<span class="fc" id="L248">    }</span>

    @Test
    @DisplayName(&quot;Obtener tablas por germinación - debe retornar lista&quot;)
    void obtenerTablasPorGerminacion_debeRetornarLista() {
        
<span class="fc" id="L254">        TablaGerm tabla2 = new TablaGerm();</span>
<span class="fc" id="L255">        tabla2.setTablaGermID(16L);</span>
        
<span class="fc" id="L257">        when(tablaGermRepository.findByGerminacionId(1L))</span>
<span class="fc" id="L258">            .thenReturn(Arrays.asList(tablaGerm, tabla2));</span>

        
<span class="fc" id="L261">        List&lt;TablaGermDTO&gt; resultado = tablaGermService.obtenerTablasPorGerminacion(1L);</span>

        
<span class="fc" id="L264">        assertNotNull(resultado);</span>
<span class="fc" id="L265">        assertEquals(2, resultado.size());</span>
<span class="fc" id="L266">        assertEquals(15L, resultado.get(0).getTablaGermID());</span>
<span class="fc" id="L267">        assertEquals(16L, resultado.get(1).getTablaGermID());</span>
<span class="fc" id="L268">    }</span>

    @Test
    @DisplayName(&quot;Contar tablas por germinación - debe retornar cantidad&quot;)
    void contarTablasPorGerminacion_debeRetornarCantidad() {
        
<span class="fc" id="L274">        when(tablaGermRepository.countByGerminacionId(1L)).thenReturn(2L);</span>

        
<span class="fc" id="L277">        Long resultado = tablaGermService.contarTablasPorGerminacion(1L);</span>

        
<span class="fc" id="L280">        assertEquals(2L, resultado);</span>
<span class="fc" id="L281">        verify(tablaGermRepository, times(1)).countByGerminacionId(1L);</span>
<span class="fc" id="L282">    }</span>

    @Test
    @DisplayName(&quot;Puede ingresar porcentajes - debe retornar false si tabla no finalizada&quot;)
    void puedeIngresarPorcentajes_debeRetornarTrueSiTablaFinalizada() {
        
<span class="fc" id="L288">        tablaGerm.setFinalizada(false); </span>
<span class="fc" id="L289">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>

        
<span class="fc" id="L292">        Boolean resultado = tablaGermService.puedeIngresarPorcentajes(15L);</span>

        
<span class="fc" id="L295">        assertFalse(resultado); </span>
<span class="fc" id="L296">    }</span>

    @Test
    @DisplayName(&quot;Actualizar porcentajes - debe actualizar correctamente&quot;)
    void actualizarPorcentajes_debeActualizarCorrectamente() {
        
<span class="fc" id="L302">        PorcentajesRedondeoRequestDTO porcentajesDTO = new PorcentajesRedondeoRequestDTO();</span>
<span class="fc" id="L303">        porcentajesDTO.setPorcentajeNormalesConRedondeo(new BigDecimal(&quot;85.5&quot;));</span>
<span class="fc" id="L304">        porcentajesDTO.setPorcentajeAnormalesConRedondeo(new BigDecimal(&quot;8.2&quot;));</span>
<span class="fc" id="L305">        porcentajesDTO.setPorcentajeDurasConRedondeo(new BigDecimal(&quot;3.1&quot;));</span>
<span class="fc" id="L306">        porcentajesDTO.setPorcentajeFrescasConRedondeo(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L307">        porcentajesDTO.setPorcentajeMuertasConRedondeo(new BigDecimal(&quot;1.2&quot;));</span>

        
<span class="fc" id="L310">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L312">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L313">            rep.setNormales(Arrays.asList(10, 15, 20)); </span>
<span class="fc" id="L314">            rep.setAnormales(10); </span>
<span class="fc" id="L315">            rep.setDuras(0);</span>
<span class="fc" id="L316">            rep.setFrescas(0);</span>
<span class="fc" id="L317">            rep.setMuertas(5);</span>
<span class="fc" id="L318">            rep.setTablaGerm(tablaGerm); </span>
<span class="fc" id="L319">            repeticiones.add(rep);</span>
        }
<span class="fc" id="L321">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L322">        tablaGerm.setFinalizada(true);</span>
        
<span class="fc" id="L324">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L325">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L326">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L329">        TablaGermDTO resultado = tablaGermService.actualizarPorcentajes(15L, porcentajesDTO);</span>

        
<span class="fc" id="L332">        assertNotNull(resultado);</span>
<span class="fc" id="L333">        verify(tablaGermRepository, times(1)).save(any(TablaGerm.class));</span>
<span class="fc" id="L334">    }</span>

    @Test
    @DisplayName(&quot;Validar fechas - debe lanzar excepción si fecha germinación es anterior a fecha ingreso&quot;)
    void crearTablaGerm_debeValidarFechas() {
        
<span class="fc" id="L340">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 20));</span>
<span class="fc" id="L341">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 15));</span>
        
<span class="fc" id="L343">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        
        
<span class="fc" id="L347">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L348">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L349">        });</span>
        
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;fecha de germinación&quot;) || </span>
<span class="pc bnc" id="L352" title="All 2 branches missed.">                   exception.getMessage().contains(&quot;fecha de ingreso&quot;));</span>
<span class="fc" id="L353">    }</span>

    

    @Test
    @DisplayName(&quot;reiniciarDatosConteo - debe reiniciar datos cuando fecha de conteo cambia a futuro&quot;)
    void reiniciarDatosConteo_debeReiniciarCuandoCambiaFechaConteo() {
        
<span class="fc" id="L361">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L362">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L363">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L364">        rep1.setNumRep(1);</span>
<span class="fc" id="L365">        rep1.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L366">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L367">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L369">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L370">        tablaGerm.setFechaGerminacion(LocalDate.of(2024, 1, 17));</span>
<span class="fc" id="L371">        tablaGerm.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
        
        
<span class="fc" id="L374">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 17));</span>
<span class="fc" id="L375">        requestDTO.getFechaConteos().set(1, LocalDate.of(2024, 1, 23));</span>
<span class="fc" id="L376">        requestDTO.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L377">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 26));</span>
        
<span class="fc" id="L379">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L380">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L381">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L382">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L385">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L388">        verify(repGermRepository, atLeastOnce()).save(any(RepGerm.class));</span>
<span class="fc" id="L389">    }</span>

    @Test
    @DisplayName(&quot;validarFechasConteosEnEdicion - debe validar primer conteo posterior a germinación&quot;)
    void validarFechasConteosEnEdicion_debeValidarPrimerConteo() {
        
<span class="fc" id="L395">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 17));</span>
<span class="fc" id="L396">        requestDTO.getFechaConteos().set(0, LocalDate.of(2024, 1, 17)); </span>
        
<span class="fc" id="L398">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L399">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L402">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L403">            tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>
<span class="nc" id="L404">        });</span>
        
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;primer conteo&quot;) || </span>
<span class="pc bnc" id="L407" title="All 2 branches missed.">                   exception.getMessage().contains(&quot;debe ser posterior&quot;));</span>
<span class="fc" id="L408">    }</span>

    @Test
    @DisplayName(&quot;mapearValoresGermADTO - debe mapear correctamente al actualizar valores&quot;)
    void mapearValoresGermADTO_debeMapeaCorrectamente() {
        
        
<span class="fc" id="L415">        utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm valoresInia = </span>
            new utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm();
<span class="fc" id="L417">        valoresInia.setValoresGermID(1L);</span>
<span class="fc" id="L418">        valoresInia.setInstituto(Instituto.INIA);</span>
<span class="fc" id="L419">        valoresInia.setNormales(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L420">        valoresInia.setAnormales(new BigDecimal(&quot;10.0&quot;));</span>
<span class="fc" id="L421">        valoresInia.setDuras(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L422">        valoresInia.setFrescas(new BigDecimal(&quot;1.0&quot;));</span>
<span class="fc" id="L423">        valoresInia.setMuertas(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L424">        valoresInia.setGerminacion(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L425">        valoresInia.setTablaGerm(tablaGerm);</span>
        
<span class="fc" id="L427">        tablaGerm.setValoresGerm(Arrays.asList(valoresInia));</span>
        
<span class="fc" id="L429">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>

        
<span class="fc" id="L432">        TablaGermDTO resultado = tablaGermService.obtenerTablaGermPorId(15L);</span>

        
<span class="fc" id="L435">        assertNotNull(resultado.getValoresGerm());</span>
<span class="fc" id="L436">        assertEquals(1, resultado.getValoresGerm().size());</span>
<span class="fc" id="L437">        assertEquals(Instituto.INIA, resultado.getValoresGerm().get(0).getInstituto());</span>
<span class="fc" id="L438">        assertEquals(new BigDecimal(&quot;85.0&quot;), resultado.getValoresGerm().get(0).getNormales());</span>
<span class="fc" id="L439">    }</span>

    @Test
    @DisplayName(&quot;reiniciarCamposUltimoConteo - debe reiniciar cuando fecha último conteo cambia a futuro&quot;)
    void reiniciarCamposUltimoConteo_debeReiniciarCuandoFechaCambiaAFuturo() {
        
<span class="fc" id="L445">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L446">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L447">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L448">        rep1.setNumRep(1);</span>
<span class="fc" id="L449">        rep1.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L450">        rep1.setAnormales(10);</span>
<span class="fc" id="L451">        rep1.setDuras(2);</span>
<span class="fc" id="L452">        rep1.setFrescas(1);</span>
<span class="fc" id="L453">        rep1.setMuertas(3);</span>
<span class="fc" id="L454">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L455">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L457">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L458">        tablaGerm.setFechaUltConteo(LocalDate.now().minusDays(1)); </span>
<span class="fc" id="L459">        tablaGerm.setFechaFinal(LocalDate.now().plusDays(10)); </span>
        
        
<span class="fc" id="L462">        requestDTO.setFechaUltConteo(LocalDate.now().plusDays(5));</span>
<span class="fc" id="L463">        requestDTO.setFechaFinal(LocalDate.now().plusDays(10)); </span>
        
<span class="fc" id="L465">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L466">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L467">        when(repGermRepository.findByTablaGermId(15L)).thenReturn(repeticiones);</span>
<span class="fc" id="L468">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L469">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L472">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L475">        verify(repGermRepository, atLeastOnce()).save(argThat(rep -&gt; </span>
<span class="pc bpc" id="L476" title="2 of 4 branches missed.">            rep.getAnormales() == 0 &amp;&amp; rep.getDuras() == 0 &amp;&amp; </span>
<span class="pc bpc" id="L477" title="2 of 4 branches missed.">            rep.getFrescas() == 0 &amp;&amp; rep.getMuertas() == 0</span>
        ));
<span class="fc" id="L479">    }</span>

    @Test
    @DisplayName(&quot;actualizarValoresInia - debe actualizar valores cuando se finalizan porcentajes&quot;)
    void actualizarValoresInia_debeActualizarCuandoSeFinalizanPorcentajes() {
        
<span class="fc" id="L485">        PorcentajesRedondeoRequestDTO porcentajesDTO = new PorcentajesRedondeoRequestDTO();</span>
<span class="fc" id="L486">        porcentajesDTO.setPorcentajeNormalesConRedondeo(new BigDecimal(&quot;85.0&quot;));</span>
<span class="fc" id="L487">        porcentajesDTO.setPorcentajeAnormalesConRedondeo(new BigDecimal(&quot;8.0&quot;));</span>
<span class="fc" id="L488">        porcentajesDTO.setPorcentajeDurasConRedondeo(new BigDecimal(&quot;3.0&quot;));</span>
<span class="fc" id="L489">        porcentajesDTO.setPorcentajeFrescasConRedondeo(new BigDecimal(&quot;2.0&quot;));</span>
<span class="fc" id="L490">        porcentajesDTO.setPorcentajeMuertasConRedondeo(new BigDecimal(&quot;2.0&quot;));</span>

<span class="fc" id="L492">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L493" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L494">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L495">            rep.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L496">            rep.setAnormales(10);</span>
<span class="fc" id="L497">            rep.setDuras(0);</span>
<span class="fc" id="L498">            rep.setFrescas(0);</span>
<span class="fc" id="L499">            rep.setMuertas(5);</span>
<span class="fc" id="L500">            rep.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L501">            repeticiones.add(rep);</span>
        }
<span class="fc" id="L503">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L504">        tablaGerm.setFinalizada(true);</span>
        
        
<span class="fc" id="L507">        utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm valoresInia = </span>
            new utec.proyectofinal.Proyecto.Final.UTEC.business.entities.ValoresGerm();
<span class="fc" id="L509">        valoresInia.setInstituto(Instituto.INIA);</span>
<span class="fc" id="L510">        valoresInia.setTablaGerm(tablaGerm);</span>
        
<span class="fc" id="L512">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L513">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L514">        when(valoresGermRepository.findByTablaGermIdAndInstituto(15L, Instituto.INIA))</span>
<span class="fc" id="L515">            .thenReturn(Optional.of(valoresInia));</span>
<span class="fc" id="L516">        when(valoresGermRepository.save(any())).thenReturn(valoresInia);</span>
<span class="fc" id="L517">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L520">        tablaGermService.actualizarPorcentajes(15L, porcentajesDTO);</span>

        
<span class="fc" id="L523">        verify(valoresGermRepository).save(argThat(valores -&gt; </span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">            valores.getInstituto() == Instituto.INIA &amp;&amp;</span>
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">            valores.getNormales().compareTo(new BigDecimal(&quot;85.0&quot;)) == 0 &amp;&amp;</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">            valores.getGerminacion().compareTo(new BigDecimal(&quot;85.0&quot;)) == 0</span>
        ));
<span class="fc" id="L528">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe actualizar prefrío cuando está activo&quot;)
    void actualizarEntidadDesdeSolicitud_debeActualizarPrefrio() {
        
<span class="fc" id="L534">        requestDTO.setTienePrefrio(true);</span>
<span class="fc" id="L535">        requestDTO.setDiasPrefrio(7);</span>
<span class="fc" id="L536">        requestDTO.setDescripcionPrefrio(&quot;7 días a 4°C&quot;);</span>
<span class="fc" id="L537">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L538">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 20)); </span>
<span class="fc" id="L539">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L540">            LocalDate.of(2024, 1, 22), </span>
<span class="fc" id="L541">            LocalDate.of(2024, 1, 23),</span>
<span class="fc" id="L542">            LocalDate.of(2024, 1, 24)</span>
        ));
<span class="fc" id="L544">        requestDTO.setFechaUltConteo(LocalDate.of(2024, 1, 25));</span>
<span class="fc" id="L545">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 26));</span>
        
<span class="fc" id="L547">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L548">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L549">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L552">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L555">        verify(tablaGermRepository).save(argThat(tabla -&gt; </span>
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">            tabla.getTienePrefrio() &amp;&amp; </span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">            tabla.getDiasPrefrio() == 7 &amp;&amp;</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">            &quot;7 días a 4°C&quot;.equals(tabla.getDescripcionPrefrio())</span>
        ));
<span class="fc" id="L560">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe limpiar prefrío cuando está inactivo&quot;)
    void actualizarEntidadDesdeSolicitud_debeLimpiarPrefrioInactivo() {
        
<span class="fc" id="L566">        tablaGerm.setTienePrefrio(true);</span>
<span class="fc" id="L567">        tablaGerm.setDiasPrefrio(7);</span>
<span class="fc" id="L568">        tablaGerm.setDescripcionPrefrio(&quot;7 días a 4°C&quot;);</span>
        
<span class="fc" id="L570">        requestDTO.setTienePrefrio(false);</span>
<span class="fc" id="L571">        requestDTO.setDiasPrefrio(null);</span>
<span class="fc" id="L572">        requestDTO.setDescripcionPrefrio(null);</span>
        
<span class="fc" id="L574">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L575">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L576">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L579">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L582">        verify(tablaGermRepository).save(argThat(tabla -&gt; </span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">            !tabla.getTienePrefrio() &amp;&amp; </span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">            tabla.getDiasPrefrio() == 0 &amp;&amp;</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">            tabla.getDescripcionPrefrio() == null</span>
        ));
<span class="fc" id="L587">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe actualizar pretratamiento cuando está activo&quot;)
    void actualizarEntidadDesdeSolicitud_debeActualizarPretratamiento() {
        
<span class="fc" id="L593">        requestDTO.setTienePretratamiento(true);</span>
<span class="fc" id="L594">        requestDTO.setDescripcionPretratamiento(&quot;Escarificación química&quot;);</span>
        
<span class="fc" id="L596">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L597">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L598">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L601">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L604">        verify(tablaGermRepository).save(argThat(tabla -&gt; </span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">            tabla.getTienePretratamiento() &amp;&amp;</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">            &quot;Escarificación química&quot;.equals(tabla.getDescripcionPretratamiento())</span>
        ));
<span class="fc" id="L608">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe aumentar número de conteos&quot;)
    void actualizarEntidadDesdeSolicitud_debeAumentarNumeroConteos() {
        
<span class="fc" id="L614">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L615">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L616">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L617">        rep1.setNumRep(1);</span>
<span class="fc" id="L618">        rep1.setNormales(new ArrayList&lt;&gt;(Arrays.asList(10, 15, 20))); </span>
<span class="fc" id="L619">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L620">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L622">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L623">        tablaGerm.setNumeroConteos(3);</span>
        
<span class="fc" id="L625">        requestDTO.setNumeroConteos(5); </span>
<span class="fc" id="L626">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L627">            LocalDate.of(2024, 1, 18), </span>
<span class="fc" id="L628">            LocalDate.of(2024, 1, 20),</span>
<span class="fc" id="L629">            LocalDate.of(2024, 1, 22), </span>
<span class="fc" id="L630">            LocalDate.of(2024, 1, 24),</span>
<span class="fc" id="L631">            LocalDate.of(2024, 1, 25)</span>
        ));
        
<span class="fc" id="L634">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L635">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L636">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L637">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L640">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L643">        verify(repGermRepository, atLeastOnce()).save(argThat(rep -&gt; </span>
<span class="pc bpc" id="L644" title="2 of 4 branches missed.">            rep.getNormales() != null &amp;&amp; rep.getNormales().size() == 5</span>
        ));
<span class="fc" id="L646">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe disminuir número de conteos&quot;)
    void actualizarEntidadDesdeSolicitud_debeDisminuirNumeroConteos() {
        
<span class="fc" id="L652">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L653">        RepGerm rep1 = new RepGerm();</span>
<span class="fc" id="L654">        rep1.setRepGermID(1L);</span>
<span class="fc" id="L655">        rep1.setNumRep(1);</span>
<span class="fc" id="L656">        rep1.setNormales(new ArrayList&lt;&gt;(Arrays.asList(10, 15, 20, 25, 30))); </span>
<span class="fc" id="L657">        rep1.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L658">        repeticiones.add(rep1);</span>
        
<span class="fc" id="L660">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L661">        tablaGerm.setNumeroConteos(5);</span>
        
<span class="fc" id="L663">        requestDTO.setNumeroConteos(3); </span>
<span class="fc" id="L664">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L665">            LocalDate.of(2024, 1, 18), </span>
<span class="fc" id="L666">            LocalDate.of(2024, 1, 22), </span>
<span class="fc" id="L667">            LocalDate.of(2024, 1, 25)</span>
        ));
        
<span class="fc" id="L670">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L671">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L672">        when(repGermRepository.save(any(RepGerm.class))).thenReturn(rep1);</span>
<span class="fc" id="L673">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L676">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L679">        verify(repGermRepository, atLeastOnce()).save(argThat(rep -&gt; </span>
<span class="pc bpc" id="L680" title="2 of 4 branches missed.">            rep.getNormales() != null &amp;&amp; rep.getNormales().size() == 3</span>
        ));
<span class="fc" id="L682">    }</span>

    @Test
    @DisplayName(&quot;actualizarEntidadDesdeSolicitud - debe disminuir número de repeticiones&quot;)
    void actualizarEntidadDesdeSolicitud_debeDisminuirNumeroRepeticiones() {
        
<span class="fc" id="L688">        List&lt;RepGerm&gt; repeticiones = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">        for (int i = 1; i &lt;= 8; i++) {</span>
<span class="fc" id="L690">            RepGerm rep = new RepGerm();</span>
<span class="fc" id="L691">            rep.setRepGermID((long) i);</span>
<span class="fc" id="L692">            rep.setNumRep(i);</span>
<span class="fc" id="L693">            rep.setNormales(Arrays.asList(10, 15, 20));</span>
<span class="fc" id="L694">            rep.setTablaGerm(tablaGerm);</span>
<span class="fc" id="L695">            repeticiones.add(rep);</span>
        }
        
<span class="fc" id="L698">        tablaGerm.setRepGerm(repeticiones);</span>
<span class="fc" id="L699">        tablaGerm.setNumeroRepeticiones(8);</span>
        
<span class="fc" id="L701">        requestDTO.setNumeroRepeticiones(4); </span>
        
<span class="fc" id="L703">        when(tablaGermRepository.findById(15L)).thenReturn(Optional.of(tablaGerm));</span>
<span class="fc" id="L704">        when(tablaGermRepository.save(any(TablaGerm.class))).thenReturn(tablaGerm);</span>
<span class="fc" id="L705">        when(repGermRepository.findByTablaGermId(15L)).thenReturn(repeticiones);</span>
<span class="fc" id="L706">        doNothing().when(repGermRepository).delete(any(RepGerm.class));</span>
<span class="fc" id="L707">        doNothing().when(analisisService).manejarEdicionAnalisisFinalizado(any());</span>

        
<span class="fc" id="L710">        tablaGermService.actualizarTablaGerm(15L, requestDTO);</span>

        
<span class="fc" id="L713">        verify(repGermRepository, times(4)).delete(any(RepGerm.class));</span>
<span class="fc" id="L714">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar días de prefrío suficientes&quot;)
    void validarDatosTablaGerm_debeValidarDiasPrefrio() {
        
<span class="fc" id="L720">        requestDTO.setTienePrefrio(true);</span>
<span class="fc" id="L721">        requestDTO.setDiasPrefrio(10);</span>
<span class="fc" id="L722">        requestDTO.setFechaIngreso(LocalDate.of(2024, 1, 10));</span>
<span class="fc" id="L723">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 15)); </span>
        
<span class="fc" id="L725">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        
<span class="fc" id="L728">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L729">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L730">        });</span>
        
<span class="fc" id="L732">        assertTrue(exception.getMessage().contains(&quot;días de prefrío&quot;));</span>
<span class="fc" id="L733">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar fechaFinal posterior a fechaGerminacion&quot;)
    void validarDatosTablaGerm_debeValidarFechaFinalPosteriorAGerminacion() {
        
<span class="fc" id="L739">        requestDTO.setFechaGerminacion(LocalDate.of(2024, 1, 20));</span>
<span class="fc" id="L740">        requestDTO.setFechaFinal(LocalDate.of(2024, 1, 15)); </span>
        
<span class="fc" id="L742">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        
<span class="fc" id="L745">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L746">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L747">        });</span>
        
<span class="fc" id="L749">        assertTrue(exception.getMessage().contains(&quot;fecha final&quot;));</span>
<span class="fc" id="L750">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar número de repeticiones en rango 1-20&quot;)
    void validarDatosTablaGerm_debeValidarRangoRepeticiones() {
        
<span class="fc" id="L756">        requestDTO.setNumeroRepeticiones(25); </span>
        
<span class="fc" id="L758">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        
<span class="fc" id="L761">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L762">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L763">        });</span>
        
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;repeticiones&quot;) &amp;&amp; </span>
<span class="pc bpc" id="L766" title="1 of 2 branches missed.">                   exception.getMessage().contains(&quot;20&quot;));</span>
<span class="fc" id="L767">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar número de conteos en rango 1-15&quot;)
    void validarDatosTablaGerm_debeValidarRangoConteos() {
        
<span class="fc" id="L773">        requestDTO.setNumeroConteos(20); </span>
        
<span class="fc" id="L775">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        
<span class="fc" id="L778">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L779">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L780">        });</span>
        
<span class="pc bpc" id="L782" title="1 of 2 branches missed.">        assertTrue(exception.getMessage().contains(&quot;conteos&quot;) &amp;&amp; </span>
<span class="pc bpc" id="L783" title="1 of 2 branches missed.">                   exception.getMessage().contains(&quot;15&quot;));</span>
<span class="fc" id="L784">    }</span>

    @Test
    @DisplayName(&quot;validarDatosTablaGerm - debe validar orden cronológico de fechas de conteos&quot;)
    void validarDatosTablaGerm_debeValidarOrdenCronologicoConteos() {
        
<span class="fc" id="L790">        requestDTO.setFechaConteos(Arrays.asList(</span>
<span class="fc" id="L791">            LocalDate.of(2024, 1, 25), </span>
<span class="fc" id="L792">            LocalDate.of(2024, 1, 18), </span>
<span class="fc" id="L793">            LocalDate.of(2024, 1, 22)</span>
        ));
        
<span class="fc" id="L796">        when(germinacionRepository.findById(1L)).thenReturn(Optional.of(germinacion));</span>

        
<span class="fc" id="L799">        RuntimeException exception = assertThrows(RuntimeException.class, () -&gt; {</span>
<span class="nc" id="L800">            tablaGermService.crearTablaGerm(1L, requestDTO);</span>
<span class="nc" id="L801">        });</span>
        
<span class="fc" id="L803">        assertTrue(exception.getMessage().contains(&quot;posterior&quot;));</span>
<span class="fc" id="L804">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>