<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificacionServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">NotificacionServiceTest.java</span></div><h1>NotificacionServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.*;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.*;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.NotificacionRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.NotificacionDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.EstadoUsuario;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Rol;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoNotificacion;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyInt;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de NotificacionService&quot;)
<span class="fc" id="L38">class NotificacionServiceTest {</span>

    @Mock
    private NotificacionRepository notificacionRepository;

    @Mock
    private UsuarioRepository usuarioRepository;

    @Mock
    private AnalisisRepository analisisRepository;

    @Mock
    private AnalisisHistorialRepository analisisHistorialRepository;

    @Mock
    private NotificationWebSocketService wsService;

    @Mock
    private SecurityContext securityContext;

    @Mock
    private Authentication authentication;

    @InjectMocks
    private NotificacionService notificacionService;

    private Usuario usuarioTest;
    private Usuario adminTest;
    private Lote loteTest;
    private Analisis analisisTest;

    @BeforeEach
    void setUp() {
        // Usuario normal
<span class="fc" id="L72">        usuarioTest = new Usuario();</span>
<span class="fc" id="L73">        usuarioTest.setUsuarioID(1);</span>
<span class="fc" id="L74">        usuarioTest.setNombre(&quot;testuser&quot;);</span>
<span class="fc" id="L75">        usuarioTest.setNombres(&quot;Test&quot;);</span>
<span class="fc" id="L76">        usuarioTest.setApellidos(&quot;User&quot;);</span>
<span class="fc" id="L77">        usuarioTest.setRol(Rol.ANALISTA);</span>
<span class="fc" id="L78">        usuarioTest.setEstado(EstadoUsuario.ACTIVO);</span>

        // Usuario administrador
<span class="fc" id="L81">        adminTest = new Usuario();</span>
<span class="fc" id="L82">        adminTest.setUsuarioID(2);</span>
<span class="fc" id="L83">        adminTest.setNombre(&quot;admin&quot;);</span>
<span class="fc" id="L84">        adminTest.setNombres(&quot;Admin&quot;);</span>
<span class="fc" id="L85">        adminTest.setApellidos(&quot;User&quot;);</span>
<span class="fc" id="L86">        adminTest.setRol(Rol.ADMIN);</span>
<span class="fc" id="L87">        adminTest.setEstado(EstadoUsuario.ACTIVO);</span>

        // Lote de prueba
<span class="fc" id="L90">        loteTest = new Lote();</span>
<span class="fc" id="L91">        loteTest.setLoteID(1L);</span>
<span class="fc" id="L92">        loteTest.setFicha(&quot;LOTE-2024-001&quot;);</span>

        // Análisis de prueba
<span class="fc" id="L95">        analisisTest = new Germinacion();</span>
<span class="fc" id="L96">        analisisTest.setAnalisisID(1L);</span>
<span class="fc" id="L97">        analisisTest.setLote(loteTest);</span>
<span class="fc" id="L98">    }</span>

    @Test
    @DisplayName(&quot;Crear notificación manual - debe crear correctamente&quot;)
    void crearNotificacion_debeCrearCorrectamente() {
        
<span class="fc" id="L104">        NotificacionRequestDTO request = new NotificacionRequestDTO();</span>
<span class="fc" id="L105">        request.setUsuarioId(1L);</span>
<span class="fc" id="L106">        request.setNombre(&quot;Notificación de prueba&quot;);</span>
<span class="fc" id="L107">        request.setMensaje(&quot;Mensaje de prueba&quot;);</span>
<span class="fc" id="L108">        request.setTipo(TipoNotificacion.USUARIO_REGISTRO);</span>

<span class="fc" id="L110">        Notificacion notificacionGuardada = new Notificacion();</span>
<span class="fc" id="L111">        notificacionGuardada.setId(1L);</span>
<span class="fc" id="L112">        notificacionGuardada.setNombre(request.getNombre());</span>
<span class="fc" id="L113">        notificacionGuardada.setMensaje(request.getMensaje());</span>
<span class="fc" id="L114">        notificacionGuardada.setUsuario(usuarioTest);</span>
<span class="fc" id="L115">        notificacionGuardada.setTipo(request.getTipo());</span>

<span class="fc" id="L117">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuarioTest));</span>
<span class="fc" id="L118">        when(notificacionRepository.save(any(Notificacion.class))).thenReturn(notificacionGuardada);</span>

        
<span class="fc" id="L121">        NotificacionDTO resultado = notificacionService.crearNotificacion(request);</span>

        
<span class="fc" id="L124">        assertNotNull(resultado);</span>
<span class="fc" id="L125">        assertEquals(&quot;Notificación de prueba&quot;, resultado.getNombre());</span>
<span class="fc" id="L126">        assertEquals(&quot;Mensaje de prueba&quot;, resultado.getMensaje());</span>
<span class="fc" id="L127">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L128">    }</span>

    @Test
    @DisplayName(&quot;Crear notificación - usuario no encontrado debe lanzar excepción&quot;)
    void crearNotificacion_usuarioNoEncontrado_debeLanzarExcepcion() {
        
<span class="fc" id="L134">        NotificacionRequestDTO request = new NotificacionRequestDTO();</span>
<span class="fc" id="L135">        request.setUsuarioId(999L);</span>
<span class="fc" id="L136">        request.setNombre(&quot;Test&quot;);</span>
<span class="fc" id="L137">        request.setMensaje(&quot;Test&quot;);</span>

<span class="fc" id="L139">        when(usuarioRepository.findById(999)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L142">        assertThrows(RuntimeException.class, </span>
<span class="nc" id="L143">            () -&gt; notificacionService.crearNotificacion(request));</span>
<span class="fc" id="L144">        verify(notificacionRepository, never()).save(any(Notificacion.class));</span>
<span class="fc" id="L145">    }</span>

    @Test
    @DisplayName(&quot;Notificar nuevo usuario - debe notificar a todos los administradores&quot;)
    void notificarNuevoUsuario_debeNotificarATodosLosAdministradores() {
        
<span class="fc" id="L151">        Usuario nuevoUsuario = new Usuario();</span>
<span class="fc" id="L152">        nuevoUsuario.setUsuarioID(3);</span>
<span class="fc" id="L153">        nuevoUsuario.setNombres(&quot;Nuevo&quot;);</span>
<span class="fc" id="L154">        nuevoUsuario.setApellidos(&quot;Usuario&quot;);</span>

<span class="fc" id="L156">        when(usuarioRepository.findById(3)).thenReturn(Optional.of(nuevoUsuario));</span>
<span class="fc" id="L157">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L158">            .thenReturn(Arrays.asList(adminTest, usuarioTest)); // 1 admin, 1 analista</span>
<span class="fc" id="L159">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L160">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L161">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(anyInt()))</span>
<span class="fc" id="L162">            .thenReturn(1L);</span>

        
<span class="fc" id="L165">        notificacionService.notificarNuevoUsuario(3L);</span>

        
<span class="fc" id="L168">        verify(notificacionRepository, times(1)).save(any(Notificacion.class)); // Solo al admin</span>
<span class="fc" id="L169">        verify(wsService, times(1)).sendToUser(any(), any(NotificacionDTO.class));</span>
<span class="fc" id="L170">    }</span>

    @Test
    @DisplayName(&quot;Notificar usuario aprobado - debe enviar notificación al usuario&quot;)
    void notificarUsuarioAprobado_debeEnviarNotificacionAlUsuario() {
        
<span class="fc" id="L176">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuarioTest));</span>
<span class="fc" id="L177">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L178">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L179">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L180">            .thenReturn(1L);</span>

        
<span class="fc" id="L183">        notificacionService.notificarUsuarioAprobado(1L);</span>

        
<span class="fc" id="L186">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L187">        verify(wsService).sendToUser(eq(1), any(NotificacionDTO.class));</span>
<span class="fc" id="L188">        verify(wsService).sendUnreadCount(eq(1), eq(1L));</span>
<span class="fc" id="L189">    }</span>

    @Test
    @DisplayName(&quot;Notificar usuario rechazado - debe enviar notificación al usuario&quot;)
    void notificarUsuarioRechazado_debeEnviarNotificacionAlUsuario() {
        
<span class="fc" id="L195">        when(usuarioRepository.findById(1)).thenReturn(Optional.of(usuarioTest));</span>
<span class="fc" id="L196">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L197">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L198">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L199">            .thenReturn(1L);</span>

        
<span class="fc" id="L202">        notificacionService.notificarUsuarioRechazado(1L);</span>

        
<span class="fc" id="L205">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L206">        verify(wsService).sendToUser(eq(1), any(NotificacionDTO.class));</span>
<span class="fc" id="L207">    }</span>

    @Test
    @DisplayName(&quot;Notificar análisis finalizado - debe notificar a todos los administradores&quot;)
    void notificarAnalisisFinalizado_debeNotificarATodosLosAdministradores() {
        
<span class="fc" id="L213">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L214">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L215">            .thenReturn(Collections.singletonList(adminTest));</span>
<span class="fc" id="L216">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L217">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L218">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(2))</span>
<span class="fc" id="L219">            .thenReturn(1L);</span>

        
<span class="fc" id="L222">        notificacionService.notificarAnalisisFinalizado(1L);</span>

        
<span class="fc" id="L225">        verify(notificacionRepository).save(any(Notificacion.class));</span>
<span class="fc" id="L226">        verify(wsService).sendToUser(eq(2), any(NotificacionDTO.class));</span>
<span class="fc" id="L227">    }</span>

    @Test
    @DisplayName(&quot;Obtener notificaciones por usuario - debe retornar página de notificaciones&quot;)
    void obtenerNotificacionesPorUsuario_debeRetornarPagina() {
        
<span class="fc" id="L233">        Pageable pageable = PageRequest.of(0, 10);</span>
        
<span class="fc" id="L235">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L236">        notif1.setId(1L);</span>
<span class="fc" id="L237">        notif1.setNombre(&quot;Notificación 1&quot;);</span>
<span class="fc" id="L238">        notif1.setMensaje(&quot;Mensaje 1&quot;);</span>
<span class="fc" id="L239">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L240">        notif1.setLeido(false);</span>
<span class="fc" id="L241">        notif1.setActivo(true);</span>
<span class="fc" id="L242">        notif1.setTipo(TipoNotificacion.USUARIO_APROBADO);</span>

<span class="fc" id="L244">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L245">        notif2.setId(2L);</span>
<span class="fc" id="L246">        notif2.setNombre(&quot;Notificación 2&quot;);</span>
<span class="fc" id="L247">        notif2.setMensaje(&quot;Mensaje 2&quot;);</span>
<span class="fc" id="L248">        notif2.setUsuario(usuarioTest);</span>
<span class="fc" id="L249">        notif2.setLeido(true);</span>
<span class="fc" id="L250">        notif2.setActivo(true);</span>
<span class="fc" id="L251">        notif2.setTipo(TipoNotificacion.ANALISIS_APROBADO);</span>

<span class="fc" id="L253">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Arrays.asList(notif1, notif2));</span>

<span class="fc" id="L255">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L256">            .thenReturn(page);</span>

        
<span class="fc" id="L259">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesPorUsuario(1L, pageable);</span>

        
<span class="fc" id="L262">        assertNotNull(resultado);</span>
<span class="fc" id="L263">        assertEquals(2, resultado.getContent().size());</span>
<span class="fc" id="L264">        assertEquals(&quot;Notificación 1&quot;, resultado.getContent().get(0).getNombre());</span>
<span class="fc" id="L265">    }</span>

    @Test
    @DisplayName(&quot;Obtener notificaciones no leídas - debe retornar solo las no leídas&quot;)
    void obtenerNotificacionesNoLeidas_debeRetornarSoloNoLeidas() {
        
<span class="fc" id="L271">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L272">        notif1.setId(1L);</span>
<span class="fc" id="L273">        notif1.setNombre(&quot;No leída 1&quot;);</span>
<span class="fc" id="L274">        notif1.setMensaje(&quot;Mensaje 1&quot;);</span>
<span class="fc" id="L275">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L276">        notif1.setLeido(false);</span>
<span class="fc" id="L277">        notif1.setActivo(true);</span>
<span class="fc" id="L278">        notif1.setTipo(TipoNotificacion.USUARIO_APROBADO);</span>

<span class="fc" id="L280">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrueOrderByFechaCreacionDesc(1))</span>
<span class="fc" id="L281">            .thenReturn(Collections.singletonList(notif1));</span>

        
<span class="fc" id="L284">        List&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesNoLeidas(1L);</span>

        
<span class="fc" id="L287">        assertNotNull(resultado);</span>
<span class="fc" id="L288">        assertEquals(1, resultado.size());</span>
<span class="fc" id="L289">        assertEquals(&quot;No leída 1&quot;, resultado.get(0).getNombre());</span>
<span class="fc" id="L290">        assertFalse(resultado.get(0).getLeido());</span>
<span class="fc" id="L291">    }</span>

    @Test
    @DisplayName(&quot;Marcar como leída - debe actualizar el estado&quot;)
    void marcarComoLeida_debeActualizarEstado() {
        
<span class="fc" id="L297">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L298">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L299">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L300">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L302">        Notificacion notificacion = new Notificacion();</span>
<span class="fc" id="L303">        notificacion.setId(1L);</span>
<span class="fc" id="L304">        notificacion.setNombre(&quot;Test&quot;);</span>
<span class="fc" id="L305">        notificacion.setMensaje(&quot;Mensaje&quot;);</span>
<span class="fc" id="L306">        notificacion.setUsuario(usuarioTest);</span>
<span class="fc" id="L307">        notificacion.setLeido(false);</span>
<span class="fc" id="L308">        notificacion.setActivo(true);</span>
<span class="fc" id="L309">        notificacion.setTipo(TipoNotificacion.USUARIO_APROBADO);</span>

<span class="fc" id="L311">        when(notificacionRepository.findById(1L)).thenReturn(Optional.of(notificacion));</span>
<span class="fc" id="L312">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L313">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        
<span class="fc" id="L316">        NotificacionDTO resultado = notificacionService.marcarComoLeida(1L);</span>

        
<span class="fc" id="L319">        assertNotNull(resultado);</span>
<span class="fc" id="L320">        assertTrue(notificacion.getLeido());</span>
<span class="fc" id="L321">        verify(notificacionRepository).save(notificacion);</span>
<span class="fc" id="L322">    }</span>

    @Test
    @DisplayName(&quot;Marcar todas como leídas - debe actualizar todas las notificaciones&quot;)
    void marcarTodasComoLeidas_debeActualizarTodas() {
        
<span class="fc" id="L328">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L329">        notif1.setLeido(false);</span>
        
<span class="fc" id="L331">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L332">        notif2.setLeido(false);</span>

<span class="fc" id="L334">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L335">            .thenReturn(Arrays.asList(notif1, notif2));</span>

        
<span class="fc" id="L338">        notificacionService.marcarTodasComoLeidas(1L);</span>

        
<span class="fc" id="L341">        assertTrue(notif1.getLeido());</span>
<span class="fc" id="L342">        assertTrue(notif2.getLeido());</span>
<span class="fc" id="L343">        verify(notificacionRepository).saveAll(any());</span>
<span class="fc" id="L344">    }</span>

    @Test
    @DisplayName(&quot;Eliminar notificación - debe marcar como inactiva&quot;)
    void eliminarNotificacion_debeMarcarComoInactiva() {
        
<span class="fc" id="L350">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L351">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L352">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L353">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L355">        Notificacion notificacion = new Notificacion();</span>
<span class="fc" id="L356">        notificacion.setId(1L);</span>
<span class="fc" id="L357">        notificacion.setUsuario(usuarioTest);</span>
<span class="fc" id="L358">        notificacion.setActivo(true);</span>

<span class="fc" id="L360">        when(notificacionRepository.findById(1L)).thenReturn(Optional.of(notificacion));</span>

        
<span class="fc" id="L363">        notificacionService.eliminarNotificacion(1L);</span>

        
<span class="fc" id="L366">        assertFalse(notificacion.getActivo());</span>
<span class="fc" id="L367">        verify(notificacionRepository).save(notificacion);</span>
<span class="fc" id="L368">    }</span>

    @Test
    @DisplayName(&quot;Contar notificaciones no leídas - debe retornar cantidad correcta&quot;)
    void contarNotificacionesNoLeidas_debeRetornarCantidadCorrecta() {
        
<span class="fc" id="L374">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L375">            .thenReturn(5L);</span>

        
<span class="fc" id="L378">        Long count = notificacionService.contarNotificacionesNoLeidas(1L);</span>

        
<span class="fc" id="L381">        assertEquals(5L, count);</span>
<span class="fc" id="L382">    }</span>

    @Test
    @DisplayName(&quot;Eliminar notificación de otro usuario - debe lanzar excepción&quot;)
    void eliminarNotificacion_deOtroUsuario_debeLanzarExcepcion() {
        
<span class="fc" id="L388">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L389">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L390">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L391">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L393">        Usuario otroUsuario = new Usuario();</span>
<span class="fc" id="L394">        otroUsuario.setUsuarioID(2);</span>
<span class="fc" id="L395">        otroUsuario.setRol(Rol.ANALISTA);</span>

<span class="fc" id="L397">        Notificacion notificacion = new Notificacion();</span>
<span class="fc" id="L398">        notificacion.setId(1L);</span>
<span class="fc" id="L399">        notificacion.setUsuario(otroUsuario);</span>
<span class="fc" id="L400">        notificacion.setActivo(true);</span>

<span class="fc" id="L402">        when(notificacionRepository.findById(1L)).thenReturn(Optional.of(notificacion));</span>

        
<span class="fc" id="L405">        assertThrows(RuntimeException.class, </span>
<span class="nc" id="L406">            () -&gt; notificacionService.eliminarNotificacion(1L));</span>
<span class="fc" id="L407">        verify(notificacionRepository, never()).save(any(Notificacion.class));</span>
<span class="fc" id="L408">    }</span>

    // ========== TESTS PARA NOTIFICACIONES DE ANÁLISIS ==========

    @Test
    @DisplayName(&quot;notificarAnalisisAprobado - debe notificar a usuarios involucrados (no admins)&quot;)
    void notificarAnalisisAprobado_debeNotificarAUsuariosInvolucrados() {
        
<span class="fc" id="L416">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L417">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L418">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L419">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>
        
<span class="fc" id="L421">        AnalisisHistorial historial1 = new AnalisisHistorial();</span>
<span class="fc" id="L422">        historial1.setUsuario(usuarioTest); // Analista</span>
        
<span class="fc" id="L424">        AnalisisHistorial historial2 = new AnalisisHistorial();</span>
<span class="fc" id="L425">        historial2.setUsuario(adminTest); // Admin (debe ser excluido)</span>

<span class="fc" id="L427">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(1L))</span>
<span class="fc" id="L428">            .thenReturn(Arrays.asList(historial1, historial2));</span>
<span class="fc" id="L429">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L430">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L431">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L432">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L433">            .thenReturn(1L);</span>

        
<span class="fc" id="L436">        notificacionService.notificarAnalisisAprobado(1L);</span>

        
<span class="fc" id="L439">        verify(notificacionRepository, times(1)).save(argThat(notif -&gt; </span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">            notif.getNombre().equals(&quot;Análisis aprobado&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">            notif.getUsuario().equals(usuarioTest) &amp;&amp;</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">            notif.getAnalisisId().equals(1L) &amp;&amp;</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">            notif.getTipo() == TipoNotificacion.ANALISIS_APROBADO</span>
        ));
<span class="fc" id="L445">        verify(wsService, times(1)).sendToUser(eq(1), any(NotificacionDTO.class));</span>
<span class="fc" id="L446">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisAprobado - sin usuarios involucrados no debe crear notificaciones&quot;)
    void notificarAnalisisAprobado_sinUsuariosInvolucrados_noDebeCrearNotificaciones() {
        
<span class="fc" id="L452">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L453">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L454">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L455">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>
        
<span class="fc" id="L457">        AnalisisHistorial historial1 = new AnalisisHistorial();</span>
<span class="fc" id="L458">        historial1.setUsuario(adminTest); // Solo admin</span>

<span class="fc" id="L460">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(1L))</span>
<span class="fc" id="L461">            .thenReturn(Collections.singletonList(historial1));</span>
<span class="fc" id="L462">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>

        
<span class="fc" id="L465">        notificacionService.notificarAnalisisAprobado(1L);</span>

        
<span class="fc" id="L468">        verify(notificacionRepository, never()).save(any(Notificacion.class));</span>
<span class="fc" id="L469">        verify(wsService, never()).sendToUser(any(), any(NotificacionDTO.class));</span>
<span class="fc" id="L470">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisRepetir - debe notificar a usuarios involucrados&quot;)
    void notificarAnalisisRepetir_debeNotificarAUsuariosInvolucrados() {
        
<span class="fc" id="L476">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L477">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L478">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L479">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>
        
<span class="fc" id="L481">        Usuario analista2 = new Usuario();</span>
<span class="fc" id="L482">        analista2.setUsuarioID(3);</span>
<span class="fc" id="L483">        analista2.setNombres(&quot;Analista&quot;);</span>
<span class="fc" id="L484">        analista2.setApellidos(&quot;Dos&quot;);</span>
<span class="fc" id="L485">        analista2.setRol(Rol.ANALISTA);</span>

<span class="fc" id="L487">        AnalisisHistorial historial1 = new AnalisisHistorial();</span>
<span class="fc" id="L488">        historial1.setUsuario(usuarioTest);</span>
        
<span class="fc" id="L490">        AnalisisHistorial historial2 = new AnalisisHistorial();</span>
<span class="fc" id="L491">        historial2.setUsuario(analista2);</span>
        
<span class="fc" id="L493">        AnalisisHistorial historial3 = new AnalisisHistorial();</span>
<span class="fc" id="L494">        historial3.setUsuario(usuarioTest); // Duplicado, debe filtrar</span>

<span class="fc" id="L496">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(1L))</span>
<span class="fc" id="L497">            .thenReturn(Arrays.asList(historial1, historial2, historial3));</span>
<span class="fc" id="L498">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L499">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L500">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>
<span class="fc" id="L501">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(anyInt()))</span>
<span class="fc" id="L502">            .thenReturn(1L);</span>

        
<span class="fc" id="L505">        notificacionService.notificarAnalisisRepetir(1L);</span>

        
<span class="fc" id="L508">        verify(notificacionRepository, times(2)).save(argThat(notif -&gt; </span>
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">            notif.getNombre().equals(&quot;Análisis marcado para repetir&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">            notif.getTipo() == TipoNotificacion.ANALISIS_REPETIR</span>
        ));
<span class="fc" id="L512">        verify(wsService, times(2)).sendToUser(any(), any(NotificacionDTO.class));</span>
<span class="fc" id="L513">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisPendienteAprobacion - debe notificar a todos los admins&quot;)
    void notificarAnalisisPendienteAprobacion_debeNotificarATodosLosAdmins() {
        
<span class="fc" id="L519">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L520">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L521">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L522">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>
        
<span class="fc" id="L524">        Usuario admin2 = new Usuario();</span>
<span class="fc" id="L525">        admin2.setUsuarioID(3);</span>
<span class="fc" id="L526">        admin2.setNombres(&quot;Admin&quot;);</span>
<span class="fc" id="L527">        admin2.setApellidos(&quot;Dos&quot;);</span>
<span class="fc" id="L528">        admin2.setRol(Rol.ADMIN);</span>
<span class="fc" id="L529">        admin2.setEstado(EstadoUsuario.ACTIVO);</span>

<span class="fc" id="L531">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L532">            .thenReturn(Arrays.asList(adminTest, admin2, usuarioTest)); // 2 admins, 1 analista</span>
<span class="fc" id="L533">        when(analisisRepository.findById(1L)).thenReturn(Optional.of(analisisTest));</span>
<span class="fc" id="L534">        when(notificacionRepository.save(any(Notificacion.class)))</span>
<span class="fc" id="L535">            .thenAnswer(invocation -&gt; invocation.getArgument(0));</span>

        
<span class="fc" id="L538">        notificacionService.notificarAnalisisPendienteAprobacion(1L);</span>

        
<span class="fc" id="L541">        verify(notificacionRepository, times(2)).save(argThat(notif -&gt; </span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">            notif.getNombre().equals(&quot;Análisis modificado - Requiere nueva aprobación&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">            notif.getMensaje().contains(&quot;ha sido modificado y requiere nueva aprobación&quot;)</span>
        ));
<span class="fc" id="L545">    }</span>

    // ========== TESTS PARA MÉTODOS CON VALIDACIÓN DE ACCESO ==========

    @Test
    @DisplayName(&quot;validarAccesoANotificaciones - admin puede acceder a cualquier usuario&quot;)
    void validarAccesoANotificaciones_adminPuedeAccederACualquierUsuario() {
        
<span class="fc" id="L553">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L554">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L555">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L556">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>

<span class="fc" id="L558">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L559">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Collections.emptyList());</span>

<span class="fc" id="L561">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L562">            .thenReturn(page);</span>

        
<span class="fc" id="L565">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesPorUsuarioConValidacion(1L, pageable);</span>

        
<span class="fc" id="L568">        assertNotNull(resultado);</span>
<span class="fc" id="L569">        verify(notificacionRepository).findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable);</span>
<span class="fc" id="L570">    }</span>

    @Test
    @DisplayName(&quot;validarAccesoANotificaciones - usuario normal solo puede acceder a sus propias notificaciones&quot;)
    void validarAccesoANotificaciones_usuarioNormalSoloPuedeAccederASusPropias() {
        
<span class="fc" id="L576">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L577">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L578">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L579">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L581">        Pageable pageable = PageRequest.of(0, 10);</span>

        
<span class="fc" id="L584">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L585">            notificacionService.obtenerNotificacionesPorUsuarioConValidacion(2L, pageable));</span>
<span class="fc" id="L586">    }</span>

    @Test
    @DisplayName(&quot;obtenerMisNotificaciones - debe retornar notificaciones del usuario autenticado&quot;)
    void obtenerMisNotificaciones_debeRetornarNotificacionesDelUsuarioAutenticado() {
        
<span class="fc" id="L592">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L593">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L594">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L595">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L597">        Pageable pageable = PageRequest.of(0, 10);</span>
        
<span class="fc" id="L599">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L600">        notif1.setId(1L);</span>
<span class="fc" id="L601">        notif1.setNombre(&quot;Mi notificación 1&quot;);</span>
<span class="fc" id="L602">        notif1.setMensaje(&quot;Mensaje 1&quot;);</span>
<span class="fc" id="L603">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L604">        notif1.setLeido(false);</span>
<span class="fc" id="L605">        notif1.setActivo(true);</span>
<span class="fc" id="L606">        notif1.setTipo(TipoNotificacion.ANALISIS_APROBADO);</span>

<span class="fc" id="L608">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Collections.singletonList(notif1));</span>

<span class="fc" id="L610">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L611">            .thenReturn(page);</span>

        
<span class="fc" id="L614">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerMisNotificaciones(pageable);</span>

        
<span class="fc" id="L617">        assertNotNull(resultado);</span>
<span class="fc" id="L618">        assertEquals(1, resultado.getContent().size());</span>
<span class="fc" id="L619">        assertEquals(&quot;Mi notificación 1&quot;, resultado.getContent().get(0).getNombre());</span>
<span class="fc" id="L620">        verify(notificacionRepository).findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable);</span>
<span class="fc" id="L621">    }</span>

    @Test
    @DisplayName(&quot;marcarTodasMisNotificacionesComoLeidas - debe marcar todas del usuario autenticado&quot;)
    void marcarTodasMisNotificacionesComoLeidas_debeMarcaTodasDelUsuarioAutenticado() {
        
<span class="fc" id="L627">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L628">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L629">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L630">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L632">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L633">        notif1.setLeido(false);</span>
        
<span class="fc" id="L635">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L636">        notif2.setLeido(false);</span>

<span class="fc" id="L638">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L639">            .thenReturn(Arrays.asList(notif1, notif2));</span>

        
<span class="fc" id="L642">        notificacionService.marcarTodasMisNotificacionesComoLeidas();</span>

        
<span class="fc" id="L645">        assertTrue(notif1.getLeido());</span>
<span class="fc" id="L646">        assertTrue(notif2.getLeido());</span>
<span class="fc" id="L647">        verify(notificacionRepository).saveAll(any());</span>
<span class="fc" id="L648">    }</span>

    @Test
    @DisplayName(&quot;obtenerNotificacionesPorUsuarioConValidacion - debe validar y retornar notificaciones&quot;)
    void obtenerNotificacionesPorUsuarioConValidacion_debeValidarYRetornar() {
        
<span class="fc" id="L654">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L655">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L656">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L657">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L659">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L660">        Page&lt;Notificacion&gt; page = new PageImpl&lt;&gt;(Collections.emptyList());</span>

<span class="fc" id="L662">        when(notificacionRepository.findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable))</span>
<span class="fc" id="L663">            .thenReturn(page);</span>

        
<span class="fc" id="L666">        Page&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesPorUsuarioConValidacion(1L, pageable);</span>

        
<span class="fc" id="L669">        assertNotNull(resultado);</span>
<span class="fc" id="L670">        verify(notificacionRepository).findByUsuarioUsuarioIDAndActivoTrueOrderByFechaCreacionDesc(1, pageable);</span>
<span class="fc" id="L671">    }</span>

    @Test
    @DisplayName(&quot;contarMisNotificacionesNoLeidas - debe contar solo del usuario autenticado&quot;)
    void contarMisNotificacionesNoLeidas_debeContarSoloDelUsuarioAutenticado() {
        
<span class="fc" id="L677">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L678">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L679">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L680">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L682">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L683">            .thenReturn(3L);</span>

        
<span class="fc" id="L686">        Long count = notificacionService.contarMisNotificacionesNoLeidas();</span>

        
<span class="fc" id="L689">        assertEquals(3L, count);</span>
<span class="fc" id="L690">        verify(notificacionRepository).countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1);</span>
<span class="fc" id="L691">    }</span>

    @Test
    @DisplayName(&quot;obtenerNotificacionesNoLeidasConValidacion - debe validar acceso y retornar no leídas&quot;)
    void obtenerNotificacionesNoLeidasConValidacion_debeValidarYRetornar() {
        
<span class="fc" id="L697">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L698">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L699">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L700">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L702">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L703">        notif1.setId(1L);</span>
<span class="fc" id="L704">        notif1.setNombre(&quot;No leída&quot;);</span>
<span class="fc" id="L705">        notif1.setMensaje(&quot;Mensaje&quot;);</span>
<span class="fc" id="L706">        notif1.setUsuario(usuarioTest);</span>
<span class="fc" id="L707">        notif1.setLeido(false);</span>
<span class="fc" id="L708">        notif1.setActivo(true);</span>
<span class="fc" id="L709">        notif1.setTipo(TipoNotificacion.ANALISIS_APROBADO);</span>

<span class="fc" id="L711">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrueOrderByFechaCreacionDesc(1))</span>
<span class="fc" id="L712">            .thenReturn(Collections.singletonList(notif1));</span>

        
<span class="fc" id="L715">        List&lt;NotificacionDTO&gt; resultado = notificacionService.obtenerNotificacionesNoLeidasConValidacion(1L);</span>

        
<span class="fc" id="L718">        assertNotNull(resultado);</span>
<span class="fc" id="L719">        assertEquals(1, resultado.size());</span>
<span class="fc" id="L720">        assertFalse(resultado.get(0).getLeido());</span>
<span class="fc" id="L721">    }</span>

    @Test
    @DisplayName(&quot;obtenerNotificacionesNoLeidasConValidacion - usuario sin permisos debe lanzar excepción&quot;)
    void obtenerNotificacionesNoLeidasConValidacion_sinPermisos_debeLanzarExcepcion() {
        
<span class="fc" id="L727">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L728">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L729">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L730">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

        
<span class="fc" id="L733">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L734">            notificacionService.obtenerNotificacionesNoLeidasConValidacion(2L));</span>
<span class="fc" id="L735">    }</span>

    @Test
    @DisplayName(&quot;contarNotificacionesNoLeidasConValidacion - debe validar acceso y contar&quot;)
    void contarNotificacionesNoLeidasConValidacion_debeValidarYContar() {
        
<span class="fc" id="L741">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L742">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L743">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L744">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>

<span class="fc" id="L746">        when(notificacionRepository.countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L747">            .thenReturn(5L);</span>

        
<span class="fc" id="L750">        Long count = notificacionService.contarNotificacionesNoLeidasConValidacion(1L);</span>

        
<span class="fc" id="L753">        assertEquals(5L, count);</span>
<span class="fc" id="L754">        verify(notificacionRepository).countByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1);</span>
<span class="fc" id="L755">    }</span>

    @Test
    @DisplayName(&quot;contarNotificacionesNoLeidasConValidacion - usuario sin permisos debe lanzar excepción&quot;)
    void contarNotificacionesNoLeidasConValidacion_sinPermisos_debeLanzarExcepcion() {
        
<span class="fc" id="L761">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L762">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L763">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L764">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

        
<span class="fc" id="L767">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L768">            notificacionService.contarNotificacionesNoLeidasConValidacion(2L));</span>
<span class="fc" id="L769">    }</span>

    @Test
    @DisplayName(&quot;marcarTodasComoLeidasConValidacion - debe validar acceso y marcar todas&quot;)
    void marcarTodasComoLeidasConValidacion_debeValidarYMarcarTodas() {
        
<span class="fc" id="L775">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L776">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L777">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L778">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

<span class="fc" id="L780">        Notificacion notif1 = new Notificacion();</span>
<span class="fc" id="L781">        notif1.setLeido(false);</span>
        
<span class="fc" id="L783">        Notificacion notif2 = new Notificacion();</span>
<span class="fc" id="L784">        notif2.setLeido(false);</span>

<span class="fc" id="L786">        when(notificacionRepository.findByUsuarioUsuarioIDAndLeidoFalseAndActivoTrue(1))</span>
<span class="fc" id="L787">            .thenReturn(Arrays.asList(notif1, notif2));</span>

        
<span class="fc" id="L790">        notificacionService.marcarTodasComoLeidasConValidacion(1L);</span>

        
<span class="fc" id="L793">        assertTrue(notif1.getLeido());</span>
<span class="fc" id="L794">        assertTrue(notif2.getLeido());</span>
<span class="fc" id="L795">        verify(notificacionRepository).saveAll(any());</span>
<span class="fc" id="L796">    }</span>

    @Test
    @DisplayName(&quot;marcarTodasComoLeidasConValidacion - usuario sin permisos debe lanzar excepción&quot;)
    void marcarTodasComoLeidasConValidacion_sinPermisos_debeLanzarExcepcion() {
        
<span class="fc" id="L802">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L803">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L804">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L805">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>

        
<span class="fc" id="L808">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L809">            notificacionService.marcarTodasComoLeidasConValidacion(2L));</span>
<span class="fc" id="L810">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisAprobado - análisis no encontrado debe lanzar excepción&quot;)
    void notificarAnalisisAprobado_analisisNoEncontrado_debeLanzarExcepcion() {
        
<span class="fc" id="L816">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L817">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L818">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L819">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>
        
<span class="fc" id="L821">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(999L))</span>
<span class="fc" id="L822">            .thenReturn(Collections.emptyList());</span>
<span class="fc" id="L823">        when(analisisRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L826">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L827">            notificacionService.notificarAnalisisAprobado(999L));</span>
<span class="fc" id="L828">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisRepetir - análisis no encontrado debe lanzar excepción&quot;)
    void notificarAnalisisRepetir_analisisNoEncontrado_debeLanzarExcepcion() {
        
<span class="fc" id="L834">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L835">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L836">        when(authentication.getName()).thenReturn(&quot;admin&quot;);</span>
<span class="fc" id="L837">        when(usuarioRepository.findByNombre(&quot;admin&quot;)).thenReturn(Optional.of(adminTest));</span>
        
<span class="fc" id="L839">        when(analisisHistorialRepository.findByAnalisisIdOrderByFechaHoraDesc(999L))</span>
<span class="fc" id="L840">            .thenReturn(Collections.emptyList());</span>
<span class="fc" id="L841">        when(analisisRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L844">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L845">            notificacionService.notificarAnalisisRepetir(999L));</span>
<span class="fc" id="L846">    }</span>

    @Test
    @DisplayName(&quot;notificarAnalisisPendienteAprobacion - análisis no encontrado debe lanzar excepción&quot;)
    void notificarAnalisisPendienteAprobacion_analisisNoEncontrado_debeLanzarExcepcion() {
        
<span class="fc" id="L852">        SecurityContextHolder.setContext(securityContext);</span>
<span class="fc" id="L853">        when(securityContext.getAuthentication()).thenReturn(authentication);</span>
<span class="fc" id="L854">        when(authentication.getName()).thenReturn(&quot;testuser&quot;);</span>
<span class="fc" id="L855">        when(usuarioRepository.findByNombre(&quot;testuser&quot;)).thenReturn(Optional.of(usuarioTest));</span>
        
<span class="fc" id="L857">        when(usuarioRepository.findByEstado(EstadoUsuario.ACTIVO))</span>
<span class="fc" id="L858">            .thenReturn(Collections.singletonList(adminTest));</span>
<span class="fc" id="L859">        when(analisisRepository.findById(999L)).thenReturn(Optional.empty());</span>

        
<span class="fc" id="L862">        assertThrows(RuntimeException.class, () -&gt; </span>
<span class="nc" id="L863">            notificacionService.notificarAnalisisPendienteAprobacion(999L));</span>
<span class="fc" id="L864">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>