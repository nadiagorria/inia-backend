<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DashboardServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">DashboardServiceTest.java</span></div><h1>DashboardServiceTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;

import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.AnalisisPendienteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.AnalisisPorAprobarRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.AnalisisRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.projections.AnalisisPendienteProjection;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.projections.AnalisisPorAprobarProjection;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.AnalisisPendienteDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.AnalisisPorAprobarDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.DashboardStatsDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis;

import java.time.LocalDate;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;


@ExtendWith(MockitoExtension.class)
@DisplayName(&quot;Tests de DashboardService&quot;)
<span class="fc" id="L38">class DashboardServiceTest {</span>

    @Mock
    private LoteRepository loteRepository;

    @Mock
    private AnalisisRepository analisisRepository;

    @Mock
    private AnalisisPendienteRepository analisisPendienteRepository;

    @Mock
    private AnalisisPorAprobarRepository analisisPorAprobarRepository;

    @Mock
    private LoteService loteService;

    @InjectMocks
    private DashboardService dashboardService;

    private AnalisisPendienteProjection analisisPendienteProjection;
    private AnalisisPorAprobarProjection analisisPorAprobarProjection;

    @BeforeEach
    void setUp() {
        // ARRANGE: Preparar datos de prueba
<span class="fc" id="L64">        analisisPendienteProjection = new AnalisisPendienteProjection() {</span>
            @Override
<span class="fc" id="L66">            public Long getLoteID() { return 1L; }</span>
            
            @Override
<span class="fc" id="L69">            public String getNomLote() { return &quot;LOTE-001&quot;; }</span>
            
            @Override
<span class="fc" id="L72">            public String getFicha() { return &quot;F-001&quot;; }</span>
            
            @Override
<span class="fc" id="L75">            public String getEspecieNombre() { return &quot;Trigo&quot;; }</span>
            
            @Override
<span class="fc" id="L78">            public String getCultivarNombre() { return &quot;Cultivar 1&quot;; }</span>
            
            @Override
<span class="fc" id="L81">            public String getTipoAnalisis() { return &quot;PUREZA&quot;; }</span>
        };

<span class="fc" id="L84">        analisisPorAprobarProjection = new AnalisisPorAprobarProjection() {</span>
            @Override
<span class="fc" id="L86">            public Long getAnalisisID() { return 1L; }</span>
            
            @Override
<span class="fc" id="L89">            public String getTipoAnalisis() { return &quot;GERMINACION&quot;; }</span>
            
            @Override
<span class="fc" id="L92">            public Long getLoteID() { return 1L; }</span>
            
            @Override
<span class="fc" id="L95">            public String getNomLote() { return &quot;LOTE-001&quot;; }</span>
            
            @Override
<span class="fc" id="L98">            public String getFicha() { return &quot;F-001&quot;; }</span>
            
            @Override
<span class="fc" id="L101">            public String getFechaInicio() { return &quot;2024-01-01 10:00:00&quot;; }</span>
            
            @Override
<span class="fc" id="L104">            public String getFechaFin() { return &quot;2024-01-08 10:00:00&quot;; }</span>
            
            @Override
<span class="nc" id="L107">            public String getEspecieNombre() { return &quot;Trigo&quot;; }</span>
            
            @Override
<span class="nc" id="L110">            public String getCultivarNombre() { return &quot;Cultivar 1&quot;; }</span>
        };
<span class="fc" id="L112">    }</span>

    @Test
    @DisplayName(&quot;Obtener estadísticas - debe retornar todas las métricas del dashboard&quot;)
    void obtenerEstadisticas_debeRetornarTodasLasMetricas() {
        
<span class="fc" id="L118">        when(loteRepository.countLotesActivos()).thenReturn(25L);</span>
<span class="fc" id="L119">        when(loteService.contarAnalisisPendientes()).thenReturn(12L);</span>
<span class="fc" id="L120">        when(analisisRepository.countCompletadosEnFecha(any(LocalDate.class), eq(Estado.APROBADO)))</span>
<span class="fc" id="L121">            .thenReturn(5L);</span>
<span class="fc" id="L122">        when(analisisRepository.countByEstado(Estado.PENDIENTE_APROBACION)).thenReturn(8L);</span>

        
<span class="fc" id="L125">        DashboardStatsDTO resultado = dashboardService.obtenerEstadisticas();</span>

        
<span class="fc" id="L128">        assertNotNull(resultado);</span>
<span class="fc" id="L129">        assertEquals(25L, resultado.getLotesActivos());</span>
<span class="fc" id="L130">        assertEquals(12L, resultado.getAnalisisPendientes());</span>
<span class="fc" id="L131">        assertEquals(5L, resultado.getCompletadosHoy());</span>
<span class="fc" id="L132">        assertEquals(8L, resultado.getAnalisisPorAprobar());</span>
        
<span class="fc" id="L134">        verify(loteRepository, times(1)).countLotesActivos();</span>
<span class="fc" id="L135">        verify(loteService, times(1)).contarAnalisisPendientes();</span>
<span class="fc" id="L136">        verify(analisisRepository, times(1)).countCompletadosEnFecha(any(LocalDate.class), eq(Estado.APROBADO));</span>
<span class="fc" id="L137">        verify(analisisRepository, times(1)).countByEstado(Estado.PENDIENTE_APROBACION);</span>
<span class="fc" id="L138">    }</span>

    @Test
    @DisplayName(&quot;Obtener estadísticas sin datos - debe retornar ceros&quot;)
    void obtenerEstadisticas_sinDatos_debeRetornarCeros() {
        
<span class="fc" id="L144">        when(loteRepository.countLotesActivos()).thenReturn(0L);</span>
<span class="fc" id="L145">        when(loteService.contarAnalisisPendientes()).thenReturn(0L);</span>
<span class="fc" id="L146">        when(analisisRepository.countCompletadosEnFecha(any(LocalDate.class), eq(Estado.APROBADO)))</span>
<span class="fc" id="L147">            .thenReturn(0L);</span>
<span class="fc" id="L148">        when(analisisRepository.countByEstado(Estado.PENDIENTE_APROBACION)).thenReturn(0L);</span>

        
<span class="fc" id="L151">        DashboardStatsDTO resultado = dashboardService.obtenerEstadisticas();</span>

        
<span class="fc" id="L154">        assertNotNull(resultado);</span>
<span class="fc" id="L155">        assertEquals(0L, resultado.getLotesActivos());</span>
<span class="fc" id="L156">        assertEquals(0L, resultado.getAnalisisPendientes());</span>
<span class="fc" id="L157">        assertEquals(0L, resultado.getCompletadosHoy());</span>
<span class="fc" id="L158">        assertEquals(0L, resultado.getAnalisisPorAprobar());</span>
<span class="fc" id="L159">    }</span>

    @Test
    @DisplayName(&quot;Listar análisis pendientes paginados - debe retornar página correcta&quot;)
    void listarAnalisisPendientesPaginados_debeRetornarPaginaCorrecta() {
        
<span class="fc" id="L165">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L166">        Page&lt;AnalisisPendienteProjection&gt; proyeccionesPage = </span>
<span class="fc" id="L167">            new PageImpl&lt;&gt;(Arrays.asList(analisisPendienteProjection));</span>
        
<span class="fc" id="L169">        when(analisisPendienteRepository.findAllPaginado(any(Pageable.class)))</span>
<span class="fc" id="L170">            .thenReturn(proyeccionesPage);</span>

        
<span class="fc" id="L173">        Page&lt;AnalisisPendienteDTO&gt; resultado = dashboardService.listarAnalisisPendientesPaginados(pageable);</span>

        
<span class="fc" id="L176">        assertNotNull(resultado);</span>
<span class="fc" id="L177">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L178">        assertEquals(1, resultado.getContent().size());</span>
        
<span class="fc" id="L180">        AnalisisPendienteDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L181">        assertEquals(1L, dto.getLoteID());</span>
<span class="fc" id="L182">        assertEquals(&quot;LOTE-001&quot;, dto.getNomLote());</span>
<span class="fc" id="L183">        assertEquals(&quot;F-001&quot;, dto.getFicha());</span>
<span class="fc" id="L184">        assertEquals(&quot;Trigo&quot;, dto.getEspecieNombre());</span>
<span class="fc" id="L185">        assertEquals(&quot;Cultivar 1&quot;, dto.getCultivarNombre());</span>
<span class="fc" id="L186">        assertEquals(TipoAnalisis.PUREZA, dto.getTipoAnalisis());</span>
        
<span class="fc" id="L188">        verify(analisisPendienteRepository, times(1)).findAllPaginado(pageable);</span>
<span class="fc" id="L189">    }</span>

    @Test
    @DisplayName(&quot;Listar análisis pendientes vacío - debe retornar página vacía&quot;)
    void listarAnalisisPendientesPaginados_vacio_debeRetornarPaginaVacia() {
        
<span class="fc" id="L195">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L196">        Page&lt;AnalisisPendienteProjection&gt; proyeccionesPage = Page.empty();</span>
        
<span class="fc" id="L198">        when(analisisPendienteRepository.findAllPaginado(any(Pageable.class)))</span>
<span class="fc" id="L199">            .thenReturn(proyeccionesPage);</span>

        
<span class="fc" id="L202">        Page&lt;AnalisisPendienteDTO&gt; resultado = dashboardService.listarAnalisisPendientesPaginados(pageable);</span>

        
<span class="fc" id="L205">        assertNotNull(resultado);</span>
<span class="fc" id="L206">        assertEquals(0, resultado.getTotalElements());</span>
<span class="fc" id="L207">        assertTrue(resultado.getContent().isEmpty());</span>
<span class="fc" id="L208">    }</span>

    @Test
    @DisplayName(&quot;Listar análisis por aprobar paginados - debe retornar página correcta&quot;)
    void listarAnalisisPorAprobarPaginados_debeRetornarPaginaCorrecta() {
        
<span class="fc" id="L214">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L215">        Page&lt;AnalisisPorAprobarProjection&gt; proyeccionesPage = </span>
<span class="fc" id="L216">            new PageImpl&lt;&gt;(Arrays.asList(analisisPorAprobarProjection));</span>
        
<span class="fc" id="L218">        when(analisisPorAprobarRepository.findAllPaginado(any(Pageable.class)))</span>
<span class="fc" id="L219">            .thenReturn(proyeccionesPage);</span>

        
<span class="fc" id="L222">        Page&lt;AnalisisPorAprobarDTO&gt; resultado = dashboardService.listarAnalisisPorAprobarPaginados(pageable);</span>

        
<span class="fc" id="L225">        assertNotNull(resultado);</span>
<span class="fc" id="L226">        assertEquals(1, resultado.getTotalElements());</span>
<span class="fc" id="L227">        assertEquals(1, resultado.getContent().size());</span>
        
<span class="fc" id="L229">        AnalisisPorAprobarDTO dto = resultado.getContent().get(0);</span>
<span class="fc" id="L230">        assertEquals(1L, dto.getAnalisisID());</span>
<span class="fc" id="L231">        assertEquals(TipoAnalisis.GERMINACION, dto.getTipo());</span>
<span class="fc" id="L232">        assertEquals(1L, dto.getLoteID());</span>
<span class="fc" id="L233">        assertEquals(&quot;LOTE-001&quot;, dto.getNomLote());</span>
<span class="fc" id="L234">        assertEquals(&quot;F-001&quot;, dto.getFicha());</span>
        
<span class="fc" id="L236">        verify(analisisPorAprobarRepository, times(1)).findAllPaginado(pageable);</span>
<span class="fc" id="L237">    }</span>

    @Test
    @DisplayName(&quot;Listar análisis por aprobar vacío - debe retornar página vacía&quot;)
    void listarAnalisisPorAprobarPaginados_vacio_debeRetornarPaginaVacia() {
        
<span class="fc" id="L243">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L244">        Page&lt;AnalisisPorAprobarProjection&gt; proyeccionesPage = Page.empty();</span>
        
<span class="fc" id="L246">        when(analisisPorAprobarRepository.findAllPaginado(any(Pageable.class)))</span>
<span class="fc" id="L247">            .thenReturn(proyeccionesPage);</span>

        
<span class="fc" id="L250">        Page&lt;AnalisisPorAprobarDTO&gt; resultado = dashboardService.listarAnalisisPorAprobarPaginados(pageable);</span>

        
<span class="fc" id="L253">        assertNotNull(resultado);</span>
<span class="fc" id="L254">        assertEquals(0, resultado.getTotalElements());</span>
<span class="fc" id="L255">        assertTrue(resultado.getContent().isEmpty());</span>
<span class="fc" id="L256">    }</span>

    @Test
    @DisplayName(&quot;Obtener estadísticas debe calcular correctamente completados hoy&quot;)
    void obtenerEstadisticas_debeCalcularCompletadosHoyCorrectamente() {
        
<span class="fc" id="L262">        LocalDate hoy = LocalDate.now();</span>
<span class="fc" id="L263">        when(loteRepository.countLotesActivos()).thenReturn(10L);</span>
<span class="fc" id="L264">        when(loteService.contarAnalisisPendientes()).thenReturn(5L);</span>
<span class="fc" id="L265">        when(analisisRepository.countCompletadosEnFecha(hoy, Estado.APROBADO)).thenReturn(3L);</span>
<span class="fc" id="L266">        when(analisisRepository.countByEstado(Estado.PENDIENTE_APROBACION)).thenReturn(2L);</span>

        
<span class="fc" id="L269">        DashboardStatsDTO resultado = dashboardService.obtenerEstadisticas();</span>

        
<span class="fc" id="L272">        assertEquals(3L, resultado.getCompletadosHoy());</span>
<span class="fc" id="L273">        verify(analisisRepository, times(1)).countCompletadosEnFecha(hoy, Estado.APROBADO);</span>
<span class="fc" id="L274">    }</span>

    @Test
    @DisplayName(&quot;Análisis pendientes debe incluir todos los tipos de análisis&quot;)
    void listarAnalisisPendientes_debeIncluirTodosLosTipos() {
        
<span class="fc" id="L280">        Pageable pageable = PageRequest.of(0, 10);</span>
<span class="fc" id="L281">        Page&lt;AnalisisPendienteProjection&gt; proyeccionesPage = </span>
<span class="fc" id="L282">            new PageImpl&lt;&gt;(Arrays.asList(analisisPendienteProjection));</span>
        
<span class="fc" id="L284">        when(analisisPendienteRepository.findAllPaginado(pageable))</span>
<span class="fc" id="L285">            .thenReturn(proyeccionesPage);</span>

        
<span class="fc" id="L288">        Page&lt;AnalisisPendienteDTO&gt; resultado = dashboardService.listarAnalisisPendientesPaginados(pageable);</span>

        
<span class="fc" id="L291">        assertNotNull(resultado);</span>
<span class="fc" id="L292">        assertFalse(resultado.getContent().isEmpty());</span>
        // Verificar que el tipo de análisis se mapea correctamente
<span class="fc" id="L294">        assertEquals(TipoAnalisis.PUREZA, resultado.getContent().get(0).getTipoAnalisis());</span>
<span class="fc" id="L295">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>