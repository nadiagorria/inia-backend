<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoteService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.services</a> &gt; <span class="el_source">LoteService.java</span></div><h1>LoteService.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.services;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;

import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Catalogo;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Contacto;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Cultivar;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.DatosHumedad;
import utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Lote;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.ContactoRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.CultivarRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.DosnRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.GerminacionRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.LoteRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PmsRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.PurezaRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.repositories.TetrazolioRepository;
import utec.proyectofinal.Proyecto.Final.UTEC.business.specifications.LoteSpecification;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.LoteRequestDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.request.ValidacionLoteDTO;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.*;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.Estado;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoAnalisis;
import utec.proyectofinal.Proyecto.Final.UTEC.enums.TipoLote;
import utec.proyectofinal.Proyecto.Final.UTEC.responses.ResponseListadoLoteSimple;

@Service
<span class="fc" id="L38">public class LoteService {</span>

    @Autowired
    private LoteRepository loteRepository;
    
    
    public ValidacionLoteResponseDTO validarCamposUnicos(ValidacionLoteDTO solicitud) {
<span class="fc" id="L45">        ValidacionLoteResponseDTO resultado = new ValidacionLoteResponseDTO();</span>
        
        
<span class="fc bfc" id="L48" title="All 4 branches covered.">        if (solicitud.getFicha() != null &amp;&amp; !solicitud.getFicha().isEmpty()) {</span>
<span class="fc" id="L49">            boolean fichaExiste = loteRepository.findByFicha(solicitud.getFicha())</span>
<span class="fc" id="L50">                .stream()</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">                .anyMatch(lote -&gt; !lote.getLoteID().equals(solicitud.getLoteID()));</span>
<span class="fc" id="L52">            resultado.setFichaExiste(fichaExiste);</span>
        }
        
        
<span class="pc bpc" id="L56" title="1 of 4 branches missed.">        if (solicitud.getNomLote() != null &amp;&amp; !solicitud.getNomLote().isEmpty()) {</span>
<span class="fc" id="L57">            boolean nomLoteExiste = loteRepository.findByNomLote(solicitud.getNomLote())</span>
<span class="fc" id="L58">                .stream()</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">                .anyMatch(lote -&gt; !lote.getLoteID().equals(solicitud.getLoteID()));</span>
<span class="fc" id="L60">            resultado.setNomLoteExiste(nomLoteExiste);</span>
        }
        
<span class="fc" id="L63">        return resultado;</span>
    }

    @Autowired
    private CultivarRepository cultivarRepository;
    
    @Autowired
    private ContactoRepository contactoRepository;
    
    @Autowired
    private CatalogoService catalogoService;
    
    
    @Autowired
    private PmsRepository pmsRepository;
    
    @Autowired
    private GerminacionRepository germinacionRepository;
    
    @Autowired
    private DosnRepository dosnRepository;
    
    @Autowired
    private TetrazolioRepository tetrazolioRepository;
    
    @Autowired
    private PurezaRepository purezaRepository;

    
    public LoteDTO crearLote(LoteRequestDTO solicitud) {
        try {
<span class="fc" id="L94">            System.out.println(&quot;Creando lote con solicitud: &quot; + solicitud);</span>
            
            
<span class="fc" id="L97">            validarFechaRecibo(solicitud.getFechaRecibo());</span>
<span class="fc" id="L98">            validarFechaCosecha(solicitud.getFechaCosecha());</span>
            
<span class="fc" id="L100">            Lote lote = mapearSolicitudAEntidad(solicitud);</span>
<span class="fc" id="L101">            lote.setActivo(true);</span>
            
<span class="fc" id="L103">            System.out.println(&quot;Lote mapeado, guardando...&quot;);</span>
<span class="fc" id="L104">            Lote loteGuardado = loteRepository.save(lote);</span>
<span class="fc" id="L105">            System.out.println(&quot;Lote guardado con ID: &quot; + loteGuardado.getLoteID());</span>
<span class="fc" id="L106">            return mapearEntidadADTO(loteGuardado);</span>
<span class="fc" id="L107">        } catch (Exception e) {</span>
<span class="fc" id="L108">            System.err.println(&quot;Error al crear lote: &quot; + e.getMessage());</span>
<span class="fc" id="L109">            throw new RuntimeException(&quot;Error al crear lote: &quot; + e.getMessage(), e);</span>
        }
    }

    
    public LoteDTO actualizarLote(Long id, LoteRequestDTO solicitud) {
<span class="fc" id="L115">        Optional&lt;Lote&gt; loteExistente = loteRepository.findById(id);</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (loteExistente.isPresent()) {</span>
<span class="fc" id="L117">            Lote lote = loteExistente.get();</span>
            
            
<span class="fc bfc" id="L120" title="All 2 branches covered.">            if (!lote.getActivo()) {</span>
<span class="fc" id="L121">                throw new RuntimeException(&quot;No se puede editar un lote inactivo. Debe reactivarlo primero.&quot;);</span>
            }
            
            
<span class="fc" id="L125">            validarFechaRecibo(solicitud.getFechaRecibo());</span>
<span class="fc" id="L126">            validarFechaCosecha(solicitud.getFechaCosecha());</span>
            
            
<span class="fc bfc" id="L129" title="All 2 branches covered.">            if (solicitud.getTiposAnalisisAsignados() != null) {</span>
<span class="nc" id="L130">                validarCambiosTiposAnalisis(lote, solicitud.getTiposAnalisisAsignados());</span>
            }
            
<span class="fc" id="L133">            actualizarEntidadDesdeSolicitud(lote, solicitud);</span>
<span class="fc" id="L134">            Lote loteActualizado = loteRepository.save(lote);</span>
<span class="fc" id="L135">            return mapearEntidadADTO(loteActualizado);</span>
        }
<span class="nc" id="L137">        throw new RuntimeException(&quot;Lote no encontrado con id: &quot; + id);</span>
    }
    
    
    public boolean puedeRemoverTipoAnalisis(Long loteId, TipoAnalisis tipoAnalisis) {
        
<span class="pc bpc" id="L143" title="1 of 6 branches missed.">        return switch (tipoAnalisis) {</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">            case PMS -&gt; !pmsRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">            case GERMINACION -&gt; !germinacionRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            case DOSN -&gt; !dosnRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">            case TETRAZOLIO -&gt; !tetrazolioRepository.existsByLoteLoteID(loteId);</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">            case PUREZA -&gt; !purezaRepository.existsByLoteLoteID(loteId);</span>
<span class="nc" id="L149">            default -&gt; true;</span>
        };
    }

    
    private void validarCambiosTiposAnalisis(Lote loteExistente, List&lt;TipoAnalisis&gt; nuevosTypes) {
<span class="fc" id="L155">        List&lt;TipoAnalisis&gt; tiposActuales = loteExistente.getTiposAnalisisAsignados();</span>
        
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (tiposActuales == null) {</span>
<span class="nc" id="L158">            tiposActuales = new ArrayList&lt;&gt;();</span>
        }
        
        
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        for (TipoAnalisis tipoActual : tiposActuales) {</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (!nuevosTypes.contains(tipoActual)) {</span>
                
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">                if (!puedeRemoverTipoAnalisis(loteExistente.getLoteID(), tipoActual)) {</span>
<span class="fc" id="L166">                    throw new RuntimeException(&quot;No se puede remover el tipo de análisis &quot; + tipoActual.name() + </span>
                                             &quot; porque ya existen análisis creados de este tipo para el lote&quot;);
                }
            }
<span class="nc" id="L170">        }</span>
        
        
        
<span class="nc" id="L174">    }</span>

    
    public void eliminarLote(Long id) {
<span class="fc" id="L178">        Optional&lt;Lote&gt; loteExistente = loteRepository.findById(id);</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (loteExistente.isPresent()) {</span>
<span class="fc" id="L180">            Lote lote = loteExistente.get();</span>
<span class="fc" id="L181">            lote.setActivo(false);</span>
<span class="fc" id="L182">            loteRepository.save(lote);</span>
<span class="fc" id="L183">        } else {</span>
<span class="fc" id="L184">            throw new RuntimeException(&quot;Lote no encontrado con id: &quot; + id);</span>
        }
<span class="fc" id="L186">    }</span>

    
    public LoteDTO reactivarLote(Long id) {
<span class="fc" id="L190">        Lote lote = loteRepository.findById(id)</span>
<span class="pc" id="L191">                .orElseThrow(() -&gt; new RuntimeException(&quot;Lote no encontrado con ID: &quot; + id));</span>
        
<span class="fc bfc" id="L193" title="All 2 branches covered.">        if (lote.getActivo()) {</span>
<span class="fc" id="L194">            throw new RuntimeException(&quot;El lote ya está activo&quot;);</span>
        }
        
<span class="fc" id="L197">        lote.setActivo(true);</span>
<span class="fc" id="L198">        Lote loteReactivado = loteRepository.save(lote);</span>
<span class="fc" id="L199">        return mapearEntidadADTO(loteReactivado);</span>
    }

    
    public ResponseListadoLoteSimple obtenerTodosLotesActivos() {
<span class="fc" id="L204">        List&lt;Lote&gt; lotes = loteRepository.findByActivoTrue();</span>
<span class="fc" id="L205">        List&lt;LoteSimpleDTO&gt; loteDTOs = lotes.stream()</span>
<span class="fc" id="L206">                .map(this::mapearEntidadASimpleDTO)</span>
<span class="fc" id="L207">                .collect(Collectors.toList());</span>
        
<span class="fc" id="L209">        ResponseListadoLoteSimple respuesta = new ResponseListadoLoteSimple();</span>
<span class="fc" id="L210">        respuesta.setLotes(loteDTOs);</span>
<span class="fc" id="L211">        return respuesta;</span>
    }

    
    public ResponseListadoLoteSimple obtenerTodosLotesInactivos() {
<span class="fc" id="L216">        List&lt;Lote&gt; lotes = loteRepository.findByActivoFalse();</span>
<span class="fc" id="L217">        List&lt;LoteSimpleDTO&gt; loteDTOs = lotes.stream()</span>
<span class="fc" id="L218">                .map(this::mapearEntidadASimpleDTO)</span>
<span class="fc" id="L219">                .collect(Collectors.toList());</span>
        
<span class="fc" id="L221">        ResponseListadoLoteSimple respuesta = new ResponseListadoLoteSimple();</span>
<span class="fc" id="L222">        respuesta.setLotes(loteDTOs);</span>
<span class="fc" id="L223">        return respuesta;</span>
    }

    
    public LoteDTO obtenerLotePorId(Long id) {
        
<span class="fc" id="L229">        Optional&lt;Lote&gt; lote = loteRepository.findByIdWithCultivarAndEspecie(id);</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">        if (lote.isPresent()) {</span>
<span class="fc" id="L231">            return mapearEntidadADTO(lote.get());</span>
        }
<span class="fc" id="L233">        throw new RuntimeException(&quot;Lote no encontrado con id: &quot; + id);</span>
    }

    
    public Page&lt;LoteListadoDTO&gt; obtenerLotesPaginadas(Pageable pageable) {
<span class="fc" id="L238">        Page&lt;Lote&gt; lotePage = loteRepository.findByActivo(true, pageable);</span>
<span class="fc" id="L239">        return lotePage.map(this::mapearEntidadAListadoDTO);</span>
    }

    
    public Page&lt;LoteSimpleDTO&gt; obtenerLotesSimplePaginadas(Pageable pageable) {
        
<span class="fc" id="L245">        Page&lt;Lote&gt; lotePage = loteRepository.findAll(pageable);</span>
        
        
<span class="fc" id="L248">        return lotePage.map(this::mapearEntidadASimpleDTO);</span>
    }

    
    public Page&lt;LoteSimpleDTO&gt; obtenerLotesSimplePaginadasConFiltros(
            Pageable pageable, 
            String searchTerm, 
            Boolean activo, 
            String cultivarNombre) {
        
        
<span class="fc" id="L259">        Specification&lt;Lote&gt; spec = LoteSpecification.conFiltros(searchTerm, activo, cultivarNombre);</span>
        
        
<span class="fc" id="L262">        Page&lt;Lote&gt; lotePage = loteRepository.findAll(spec, pageable);</span>
        
        
<span class="fc" id="L265">        return lotePage.map(this::mapearEntidadASimpleDTO);</span>
    }

    private LoteListadoDTO mapearEntidadAListadoDTO(Lote lote) {
<span class="fc" id="L269">        LoteListadoDTO dto = new LoteListadoDTO();</span>
<span class="fc" id="L270">        dto.setLoteID(lote.getLoteID());</span>
<span class="fc" id="L271">        dto.setFicha(lote.getFicha());</span>
<span class="fc" id="L272">        dto.setFechaCosecha(lote.getFechaCosecha());</span>
<span class="fc" id="L273">        dto.setActivo(lote.getActivo());</span>
<span class="fc" id="L274">        return dto;</span>
    }

    
    private Lote mapearSolicitudAEntidad(LoteRequestDTO solicitud) {
        try {
<span class="fc" id="L280">            System.out.println(&quot;Iniciando mapeo de solicitud a entidad&quot;);</span>
<span class="fc" id="L281">            Lote lote = new Lote();</span>
            
<span class="fc" id="L283">            System.out.println(&quot;Mapeando campos básicos...&quot;);</span>
<span class="fc" id="L284">            lote.setFicha(solicitud.getFicha());</span>
<span class="fc" id="L285">            lote.setNomLote(solicitud.getNomLote());</span>
            
            
<span class="fc bfc" id="L288" title="All 2 branches covered.">            if (solicitud.getTipo() != null) {</span>
<span class="fc" id="L289">                lote.setTipo(TipoLote.valueOf(solicitud.getTipo().toUpperCase()));</span>
            }
            
            
<span class="fc bfc" id="L293" title="All 2 branches covered.">            if (solicitud.getEmpresaID() != null) {</span>
                try {
<span class="fc" id="L295">                    System.out.println(&quot;Buscando empresa con ID: &quot; + solicitud.getEmpresaID());</span>
<span class="fc" id="L296">                    Optional&lt;Contacto&gt; empresaOpt = contactoRepository.findById(solicitud.getEmpresaID());</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">                    if (empresaOpt.isPresent()) {</span>
<span class="fc" id="L298">                        lote.setEmpresa(empresaOpt.get());</span>
<span class="fc" id="L299">                        System.out.println(&quot;Empresa encontrada y asignada&quot;);</span>
                    } else {
<span class="nc" id="L301">                        System.out.println(&quot;Empresa no encontrada con ID: &quot; + solicitud.getEmpresaID());</span>
                    }
<span class="nc" id="L303">                } catch (Exception e) {</span>
<span class="nc" id="L304">                    System.err.println(&quot;Error al buscar empresa: &quot; + e.getMessage());</span>
<span class="fc" id="L305">                }</span>
            }
            
<span class="fc" id="L308">            lote.setCodigoCC(solicitud.getCodigoCC());</span>
<span class="fc" id="L309">            lote.setCodigoFF(solicitud.getCodigoFF());</span>
<span class="fc" id="L310">            lote.setFechaEntrega(solicitud.getFechaEntrega());</span>
<span class="fc" id="L311">            lote.setFechaRecibo(solicitud.getFechaRecibo());</span>
<span class="fc" id="L312">            lote.setUnidadEmbolsado(solicitud.getUnidadEmbolsado());</span>
<span class="fc" id="L313">            lote.setRemitente(solicitud.getRemitente());</span>
<span class="fc" id="L314">            lote.setObservaciones(solicitud.getObservaciones());</span>
<span class="fc" id="L315">            lote.setKilosLimpios(solicitud.getKilosLimpios());</span>
            
            
<span class="pc bpc" id="L318" title="1 of 4 branches missed.">            if (solicitud.getDatosHumedad() != null &amp;&amp; !solicitud.getDatosHumedad().isEmpty()) {</span>
<span class="fc" id="L319">                List&lt;DatosHumedad&gt; datosHumedad = solicitud.getDatosHumedad().stream()</span>
<span class="fc" id="L320">                    .map(dhr -&gt; {</span>
<span class="fc" id="L321">                        DatosHumedad dh = new DatosHumedad();</span>
                        
                        
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">                        if (dhr.getTipoHumedadID() != null) {</span>
<span class="fc" id="L325">                            Catalogo tipoHumedad = catalogoService.obtenerEntidadPorId(dhr.getTipoHumedadID());</span>
<span class="fc" id="L326">                            dh.setTipoHumedad(tipoHumedad);</span>
                        }
                        
<span class="fc" id="L329">                        dh.setValor(dhr.getValor());</span>
<span class="fc" id="L330">                        dh.setLote(lote);</span>
<span class="fc" id="L331">                        return dh;</span>
                    })
<span class="fc" id="L333">                    .collect(Collectors.toList());</span>
<span class="fc" id="L334">                lote.setDatosHumedad(datosHumedad);</span>
            }
            
            
<span class="fc bfc" id="L338" title="All 2 branches covered.">            if (solicitud.getNumeroArticuloID() != null) {</span>
<span class="fc" id="L339">                Catalogo numeroArticulo = catalogoService.obtenerEntidadPorId(solicitud.getNumeroArticuloID());</span>
<span class="fc" id="L340">                lote.setNumeroArticulo(numeroArticulo);</span>
            }
            
            
<span class="fc bfc" id="L344" title="All 2 branches covered.">            if (solicitud.getOrigenID() != null) {</span>
                try {
<span class="fc" id="L346">                    System.out.println(&quot;Buscando origen con ID: &quot; + solicitud.getOrigenID());</span>
<span class="fc" id="L347">                    Catalogo origen = catalogoService.obtenerEntidadPorId(solicitud.getOrigenID());</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">                    if (origen != null) {</span>
<span class="fc" id="L349">                        lote.setOrigen(origen);</span>
<span class="fc" id="L350">                        System.out.println(&quot;Origen encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L352">                        System.out.println(&quot;Origen no encontrado con ID: &quot; + solicitud.getOrigenID());</span>
                    }
<span class="nc" id="L354">                } catch (Exception e) {</span>
<span class="nc" id="L355">                    System.err.println(&quot;Error al buscar origen: &quot; + e.getMessage());</span>
<span class="fc" id="L356">                }</span>
            }
            
            
<span class="fc bfc" id="L360" title="All 2 branches covered.">            if (solicitud.getEstadoID() != null) {</span>
                try {
<span class="fc" id="L362">                    System.out.println(&quot;Buscando estado con ID: &quot; + solicitud.getEstadoID());</span>
<span class="fc" id="L363">                    Catalogo estado = catalogoService.obtenerEntidadPorId(solicitud.getEstadoID());</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">                    if (estado != null) {</span>
<span class="fc" id="L365">                        lote.setEstado(estado);</span>
<span class="fc" id="L366">                        System.out.println(&quot;Estado encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L368">                        System.out.println(&quot;Estado no encontrado con ID: &quot; + solicitud.getEstadoID());</span>
                    }
<span class="nc" id="L370">                } catch (Exception e) {</span>
<span class="nc" id="L371">                    System.err.println(&quot;Error al buscar estado: &quot; + e.getMessage());</span>
<span class="fc" id="L372">                }</span>
            }
            
<span class="fc" id="L375">            lote.setFechaCosecha(solicitud.getFechaCosecha());</span>

<span class="fc" id="L377">            System.out.println(&quot;Mapeando entidades relacionadas...&quot;);</span>
            
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">            if (solicitud.getCultivarID() != null) {</span>
                try {
<span class="fc" id="L381">                    System.out.println(&quot;Buscando cultivar con ID: &quot; + solicitud.getCultivarID());</span>
<span class="fc" id="L382">                    Optional&lt;Cultivar&gt; cultivarOpt = cultivarRepository.findById(solicitud.getCultivarID());</span>
<span class="fc bfc" id="L383" title="All 2 branches covered.">                    if (cultivarOpt.isPresent()) {</span>
<span class="fc" id="L384">                        lote.setCultivar(cultivarOpt.get());</span>
<span class="fc" id="L385">                        System.out.println(&quot;Cultivar encontrado y asignado&quot;);</span>
                    } else {
<span class="fc" id="L387">                        System.out.println(&quot;Cultivar no encontrado con ID: &quot; + solicitud.getCultivarID());</span>
                    }
<span class="nc" id="L389">                } catch (Exception e) {</span>
<span class="nc" id="L390">                    System.err.println(&quot;Error al buscar cultivar: &quot; + e.getMessage());</span>
<span class="fc" id="L391">                }</span>
            }

<span class="fc bfc" id="L394" title="All 2 branches covered.">            if (solicitud.getClienteID() != null) {</span>
                try {
<span class="fc" id="L396">                    System.out.println(&quot;Buscando cliente con ID: &quot; + solicitud.getClienteID());</span>
<span class="fc" id="L397">                    Optional&lt;Contacto&gt; clienteOpt = contactoRepository.findById(solicitud.getClienteID());</span>
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">                    if (clienteOpt.isPresent()) {</span>
<span class="fc" id="L399">                        lote.setCliente(clienteOpt.get());</span>
<span class="fc" id="L400">                        System.out.println(&quot;Cliente encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L402">                        System.out.println(&quot;Cliente no encontrado con ID: &quot; + solicitud.getClienteID());</span>
                    }
<span class="nc" id="L404">                } catch (Exception e) {</span>
<span class="nc" id="L405">                    System.err.println(&quot;Error al buscar cliente: &quot; + e.getMessage());</span>
<span class="fc" id="L406">                }</span>
            }

<span class="fc bfc" id="L409" title="All 2 branches covered.">            if (solicitud.getDepositoID() != null) {</span>
                try {
<span class="fc" id="L411">                    System.out.println(&quot;Buscando deposito con ID: &quot; + solicitud.getDepositoID());</span>
<span class="fc" id="L412">                    Catalogo deposito = catalogoService.obtenerEntidadPorId(solicitud.getDepositoID());</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">                    if (deposito != null) {</span>
<span class="fc" id="L414">                        lote.setDeposito(deposito);</span>
<span class="fc" id="L415">                        System.out.println(&quot;Deposito encontrado y asignado&quot;);</span>
                    } else {
<span class="nc" id="L417">                        System.out.println(&quot;Deposito no encontrado con ID: &quot; + solicitud.getDepositoID());</span>
                    }
<span class="nc" id="L419">                } catch (Exception e) {</span>
<span class="nc" id="L420">                    System.err.println(&quot;Error al buscar deposito: &quot; + e.getMessage());</span>
<span class="fc" id="L421">                }</span>
            }

            
<span class="pc bpc" id="L425" title="1 of 4 branches missed.">            if (solicitud.getTiposAnalisisAsignados() != null &amp;&amp; !solicitud.getTiposAnalisisAsignados().isEmpty()) {</span>
                
<span class="fc" id="L427">                lote.setTiposAnalisisAsignados(solicitud.getTiposAnalisisAsignados());</span>
<span class="fc" id="L428">                System.out.println(&quot;Tipos de análisis asignados (sin duplicados): &quot; + lote.getTiposAnalisisAsignados());</span>
            }

<span class="fc" id="L431">            System.out.println(&quot;Mapeo completado exitosamente&quot;);</span>
<span class="fc" id="L432">            return lote;</span>
            
<span class="nc" id="L434">        } catch (Exception e) {</span>
<span class="nc" id="L435">            System.err.println(&quot;Error durante el mapeo: &quot; + e.getMessage());</span>
<span class="nc" id="L436">            throw new RuntimeException(&quot;Error durante el mapeo de la solicitud&quot;, e);</span>
        }
    }

    
    private void actualizarEntidadDesdeSolicitud(Lote lote, LoteRequestDTO solicitud) {
<span class="fc" id="L442">        lote.setFicha(solicitud.getFicha());</span>
<span class="fc" id="L443">        lote.setNomLote(solicitud.getNomLote());</span>
        
        
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">        if (solicitud.getTipo() != null) {</span>
<span class="nc" id="L447">            lote.setTipo(TipoLote.valueOf(solicitud.getTipo().toUpperCase()));</span>
        }
        
        
<span class="fc bfc" id="L451" title="All 2 branches covered.">        if (solicitud.getEmpresaID() != null) {</span>
<span class="fc" id="L452">            Optional&lt;Contacto&gt; empresaOpt = contactoRepository.findById(solicitud.getEmpresaID());</span>
<span class="fc bfc" id="L453" title="All 2 branches covered.">            if (empresaOpt.isPresent()) {</span>
<span class="fc" id="L454">                lote.setEmpresa(empresaOpt.get());</span>
            } else {
<span class="fc" id="L456">                throw new RuntimeException(&quot;Empresa no encontrada con ID: &quot; + solicitud.getEmpresaID());</span>
            }
        }
        
<span class="fc" id="L460">        lote.setCodigoCC(solicitud.getCodigoCC());</span>
<span class="fc" id="L461">        lote.setCodigoFF(solicitud.getCodigoFF());</span>
<span class="fc" id="L462">        lote.setFechaEntrega(solicitud.getFechaEntrega());</span>
<span class="fc" id="L463">        lote.setFechaRecibo(solicitud.getFechaRecibo());</span>
<span class="fc" id="L464">        lote.setUnidadEmbolsado(solicitud.getUnidadEmbolsado());</span>
<span class="fc" id="L465">        lote.setRemitente(solicitud.getRemitente());</span>
<span class="fc" id="L466">        lote.setObservaciones(solicitud.getObservaciones());</span>
<span class="fc" id="L467">        lote.setKilosLimpios(solicitud.getKilosLimpios());</span>
        
        
<span class="fc bfc" id="L470" title="All 2 branches covered.">        if (solicitud.getDatosHumedad() != null) {</span>
            
<span class="pc bpc" id="L472" title="1 of 2 branches missed.">            if (lote.getDatosHumedad() != null) {</span>
<span class="nc" id="L473">                lote.getDatosHumedad().clear();</span>
            }
            
            
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">            if (!solicitud.getDatosHumedad().isEmpty()) {</span>
<span class="fc" id="L478">                List&lt;DatosHumedad&gt; datosHumedad = solicitud.getDatosHumedad().stream()</span>
<span class="fc" id="L479">                    .map(dhr -&gt; {</span>
<span class="fc" id="L480">                        DatosHumedad dh = new DatosHumedad();</span>
                        
                        
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">                        if (dhr.getTipoHumedadID() != null) {</span>
<span class="fc" id="L484">                            Catalogo tipoHumedad = catalogoService.obtenerEntidadPorId(dhr.getTipoHumedadID());</span>
<span class="fc" id="L485">                            dh.setTipoHumedad(tipoHumedad);</span>
                        }
                        
<span class="fc" id="L488">                        dh.setValor(dhr.getValor());</span>
<span class="fc" id="L489">                        dh.setLote(lote);</span>
<span class="fc" id="L490">                        return dh;</span>
                    })
<span class="fc" id="L492">                    .collect(Collectors.toList());</span>
<span class="fc" id="L493">                lote.setDatosHumedad(datosHumedad);</span>
            }
        }
        
        
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">        if (solicitud.getNumeroArticuloID() != null) {</span>
<span class="nc" id="L499">            Catalogo numeroArticulo = catalogoService.obtenerEntidadPorId(solicitud.getNumeroArticuloID());</span>
<span class="nc" id="L500">            lote.setNumeroArticulo(numeroArticulo);</span>
<span class="nc" id="L501">        } else {</span>
<span class="fc" id="L502">            lote.setNumeroArticulo(null);</span>
        }
        
        
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">        if (solicitud.getOrigenID() != null) {</span>
<span class="nc" id="L507">            Catalogo origen = catalogoService.obtenerEntidadPorId(solicitud.getOrigenID());</span>
<span class="nc" id="L508">            lote.setOrigen(origen);</span>
<span class="nc" id="L509">        } else {</span>
<span class="fc" id="L510">            lote.setOrigen(null);</span>
        }
        
        
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">        if (solicitud.getEstadoID() != null) {</span>
<span class="nc" id="L515">            Catalogo estado = catalogoService.obtenerEntidadPorId(solicitud.getEstadoID());</span>
<span class="nc" id="L516">            lote.setEstado(estado);</span>
<span class="nc" id="L517">        } else {</span>
<span class="fc" id="L518">            lote.setEstado(null);</span>
        }
        
<span class="fc" id="L521">        lote.setFechaCosecha(solicitud.getFechaCosecha());</span>

        
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">        if (solicitud.getCultivarID() != null) {</span>
            try {
<span class="fc" id="L526">                Optional&lt;Cultivar&gt; cultivarOpt = cultivarRepository.findById(solicitud.getCultivarID());</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">                if (cultivarOpt.isPresent()) {</span>
<span class="fc" id="L528">                    lote.setCultivar(cultivarOpt.get());</span>
                }
<span class="nc" id="L530">            } catch (Exception e) {</span>
                
<span class="pc" id="L532">            }</span>
        } else {
<span class="nc" id="L534">            lote.setCultivar(null);</span>
        }

<span class="pc bpc" id="L537" title="1 of 2 branches missed.">        if (solicitud.getClienteID() != null) {</span>
            try {
<span class="nc" id="L539">                Optional&lt;Contacto&gt; clienteOpt = contactoRepository.findById(solicitud.getClienteID());</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">                if (clienteOpt.isPresent()) {</span>
<span class="nc" id="L541">                    lote.setCliente(clienteOpt.get());</span>
                }
<span class="nc" id="L543">            } catch (Exception e) {</span>
                
<span class="nc" id="L545">            }</span>
        } else {
<span class="fc" id="L547">            lote.setCliente(null);</span>
        }

<span class="pc bpc" id="L550" title="1 of 2 branches missed.">        if (solicitud.getDepositoID() != null) {</span>
            try {
<span class="nc" id="L552">                Catalogo deposito = catalogoService.obtenerEntidadPorId(solicitud.getDepositoID());</span>
<span class="nc" id="L553">                lote.setDeposito(deposito);</span>
<span class="nc" id="L554">            } catch (Exception e) {</span>
                
<span class="nc" id="L556">            }</span>
        } else {
<span class="fc" id="L558">            lote.setDeposito(null);</span>
        }
        
        
<span class="pc bpc" id="L562" title="3 of 4 branches missed.">        if (solicitud.getTiposAnalisisAsignados() != null &amp;&amp; !solicitud.getTiposAnalisisAsignados().isEmpty()) {</span>
            
<span class="nc" id="L564">            lote.setTiposAnalisisAsignados(solicitud.getTiposAnalisisAsignados());</span>
        }
<span class="fc" id="L566">    }</span>

    
    private LoteDTO mapearEntidadADTO(Lote lote) {
<span class="fc" id="L570">        LoteDTO dto = new LoteDTO();</span>
        
<span class="fc" id="L572">        dto.setLoteID(lote.getLoteID());</span>
<span class="fc" id="L573">        dto.setFicha(lote.getFicha());</span>
<span class="fc" id="L574">        dto.setNomLote(lote.getNomLote());</span>
        
        
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">        if (lote.getTipo() != null) {</span>
<span class="nc" id="L578">            dto.setTipo(lote.getTipo().name());</span>
        }
        
        
<span class="fc bfc" id="L582" title="All 2 branches covered.">        if (lote.getEmpresa() != null) {</span>
<span class="fc" id="L583">            dto.setEmpresaID(lote.getEmpresa().getContactoID());</span>
<span class="fc" id="L584">            dto.setEmpresaNombre(lote.getEmpresa().getNombre());</span>
        }
        
<span class="fc" id="L587">        dto.setCodigoCC(lote.getCodigoCC());</span>
<span class="fc" id="L588">        dto.setCodigoFF(lote.getCodigoFF());</span>
<span class="fc" id="L589">        dto.setFechaEntrega(lote.getFechaEntrega());</span>
<span class="fc" id="L590">        dto.setFechaRecibo(lote.getFechaRecibo());</span>
<span class="fc" id="L591">        dto.setUnidadEmbolsado(lote.getUnidadEmbolsado());</span>
<span class="fc" id="L592">        dto.setRemitente(lote.getRemitente());</span>
<span class="fc" id="L593">        dto.setObservaciones(lote.getObservaciones());</span>
<span class="fc" id="L594">        dto.setKilosLimpios(lote.getKilosLimpios());</span>
        
        
<span class="pc bpc" id="L597" title="1 of 4 branches missed.">        if (lote.getDatosHumedad() != null &amp;&amp; !lote.getDatosHumedad().isEmpty()) {</span>
<span class="fc" id="L598">            List&lt;DatosHumedadDTO&gt; datosHumedadDTO = lote.getDatosHumedad().stream()</span>
<span class="fc" id="L599">                .map(dh -&gt; {</span>
<span class="fc" id="L600">                    DatosHumedadDTO dhDTO = new DatosHumedadDTO();</span>
<span class="fc" id="L601">                    dhDTO.setDatosHumedadID(dh.getDatosHumedadID());</span>
                    
<span class="pc bpc" id="L603" title="1 of 2 branches missed.">                    if (dh.getTipoHumedad() != null) {</span>
<span class="fc" id="L604">                        dhDTO.setTipoHumedadID(dh.getTipoHumedad().getId());</span>
<span class="fc" id="L605">                        dhDTO.setTipoHumedadValor(dh.getTipoHumedad().getValor());</span>
                    }
                    
<span class="fc" id="L608">                    dhDTO.setValor(dh.getValor());</span>
<span class="fc" id="L609">                    return dhDTO;</span>
                })
<span class="fc" id="L611">                .collect(Collectors.toList());</span>
<span class="fc" id="L612">            dto.setDatosHumedad(datosHumedadDTO);</span>
        }
        
        
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">        if (lote.getNumeroArticulo() != null) {</span>
<span class="nc" id="L617">            dto.setNumeroArticuloID(lote.getNumeroArticulo().getId());</span>
<span class="nc" id="L618">            dto.setNumeroArticuloValor(lote.getNumeroArticulo().getValor());</span>
        }
<span class="fc" id="L620">        dto.setFechaCosecha(lote.getFechaCosecha());</span>
<span class="fc" id="L621">        dto.setActivo(lote.getActivo());</span>

        
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">        if (lote.getCultivar() != null) {</span>
<span class="fc" id="L625">            dto.setCultivarID(lote.getCultivar().getCultivarID());</span>
<span class="fc" id="L626">            dto.setCultivarNombre(lote.getCultivar().getNombre());</span>
            
            
<span class="pc bpc" id="L629" title="1 of 2 branches missed.">            if (lote.getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L630">                dto.setEspecieNombre(lote.getCultivar().getEspecie().getNombreComun());</span>
            }
        }

<span class="pc bpc" id="L634" title="1 of 2 branches missed.">        if (lote.getCliente() != null) {</span>
<span class="nc" id="L635">            dto.setClienteID(lote.getCliente().getContactoID());</span>
<span class="nc" id="L636">            dto.setClienteNombre(lote.getCliente().getNombre());</span>
        }

<span class="pc bpc" id="L639" title="1 of 2 branches missed.">        if (lote.getDeposito() != null) {</span>
<span class="nc" id="L640">            dto.setDepositoID(lote.getDeposito().getId());</span>
<span class="nc" id="L641">            dto.setDepositoValor(lote.getDeposito().getValor());</span>
        }
        
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">        if (lote.getOrigen() != null) {</span>
<span class="nc" id="L645">            dto.setOrigenID(lote.getOrigen().getId());</span>
<span class="nc" id="L646">            dto.setOrigenValor(lote.getOrigen().getValor());</span>
        }
        
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">        if (lote.getEstado() != null) {</span>
<span class="nc" id="L650">            dto.setEstadoID(lote.getEstado().getId());</span>
<span class="nc" id="L651">            dto.setEstadoValor(lote.getEstado().getValor());</span>
        }
        
        
<span class="fc" id="L655">        List&lt;TipoAnalisis&gt; tiposAnalisis = lote.getTiposAnalisisAsignados();</span>
<span class="pc bpc" id="L656" title="2 of 4 branches missed.">        if (tiposAnalisis != null &amp;&amp; !tiposAnalisis.isEmpty()) {</span>
<span class="nc" id="L657">            dto.setTiposAnalisisAsignados(tiposAnalisis);</span>
        }

<span class="fc" id="L660">        return dto;</span>
    }

    
    private LoteSimpleDTO mapearEntidadASimpleDTO(Lote lote) {
<span class="fc" id="L665">        LoteSimpleDTO dto = new LoteSimpleDTO();</span>
<span class="fc" id="L666">        dto.setLoteID(lote.getLoteID());</span>
<span class="fc" id="L667">        dto.setFicha(lote.getFicha());</span>
<span class="fc" id="L668">        dto.setNomLote(lote.getNomLote());</span>
<span class="fc" id="L669">        dto.setActivo(lote.getActivo());</span>
        
        
<span class="pc bpc" id="L672" title="1 of 2 branches missed.">        if (lote.getCultivar() != null) {</span>
<span class="fc" id="L673">            dto.setCultivarNombre(lote.getCultivar().getNombre());</span>
        }
        
        
<span class="pc bpc" id="L677" title="2 of 4 branches missed.">        if (lote.getCultivar() != null &amp;&amp; lote.getCultivar().getEspecie() != null) {</span>
<span class="fc" id="L678">            dto.setEspecieNombre(lote.getCultivar().getEspecie().getNombreComun());</span>
        }
        
<span class="fc" id="L681">        return dto;</span>
    }
    
    private void validarFechaRecibo(LocalDate fechaRecibo) {
<span class="pc bpc" id="L685" title="1 of 4 branches missed.">        if (fechaRecibo != null &amp;&amp; fechaRecibo.isAfter(LocalDate.now())) {</span>
<span class="fc" id="L686">            throw new RuntimeException(&quot;La fecha de recibo no puede ser posterior a la fecha actual&quot;);</span>
        }
<span class="fc" id="L688">    }</span>
    
    private void validarFechaCosecha(LocalDate fechaCosecha) {
<span class="pc bpc" id="L691" title="1 of 4 branches missed.">        if (fechaCosecha != null &amp;&amp; fechaCosecha.isAfter(LocalDate.now())) {</span>
<span class="nc" id="L692">            throw new RuntimeException(&quot;La fecha de cosecha no puede ser posterior a la fecha actual&quot;);</span>
        }
<span class="fc" id="L694">    }</span>
    
    
    public boolean esLoteElegibleParaTipoAnalisis(Long loteId, TipoAnalisis tipoAnalisis) {
<span class="fc" id="L698">        Optional&lt;Lote&gt; loteOpt = loteRepository.findById(loteId);</span>
<span class="fc bfc" id="L699" title="All 2 branches covered.">        if (loteOpt.isEmpty()) {</span>
<span class="fc" id="L700">            return false;</span>
        }
        
<span class="fc" id="L703">        Lote lote = loteOpt.get();</span>
        
        
<span class="fc bfc" id="L706" title="All 2 branches covered.">        if (!lote.getActivo()) {</span>
<span class="fc" id="L707">            return false;</span>
        }
        
        
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">        if (lote.getTiposAnalisisAsignados() == null || </span>
<span class="fc bfc" id="L712" title="All 2 branches covered.">            !lote.getTiposAnalisisAsignados().contains(tipoAnalisis)) {</span>
<span class="fc" id="L713">            return false;</span>
        }
        
        
<span class="fc" id="L717">        return puedeCrearAnalisisDelTipo(loteId, tipoAnalisis);</span>
    }
    
    
    public boolean puedeCrearAnalisisDelTipo(Long loteId, TipoAnalisis tipoAnalisis) {
        
<span class="pc bpc" id="L723" title="1 of 6 branches missed.">        return switch (tipoAnalisis) {</span>
<span class="fc bfc" id="L724" title="All 2 branches covered.">            case PMS -&gt; !pmsRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">                       pmsRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L726" title="All 2 branches covered.">            case GERMINACION -&gt; !germinacionRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L727" title="1 of 2 branches missed.">                       germinacionRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L728" title="All 2 branches covered.">            case DOSN -&gt; !dosnRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L729" title="1 of 2 branches missed.">                       dosnRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L730" title="All 2 branches covered.">            case TETRAZOLIO -&gt; !tetrazolioRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">                       tetrazolioRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="fc bfc" id="L732" title="All 2 branches covered.">            case PUREZA -&gt; !purezaRepository.existsByLoteLoteID(loteId) || </span>
<span class="pc bpc" id="L733" title="1 of 2 branches missed.">                       purezaRepository.existsByLoteLoteIDAndEstado(loteId, Estado.A_REPETIR);</span>
<span class="nc" id="L734">            default -&gt; true;</span>
        };
    }
    
    
    public ResponseListadoLoteSimple obtenerLotesElegiblesParaTipoAnalisis(TipoAnalisis tipoAnalisis) {
<span class="fc" id="L740">        List&lt;Lote&gt; todosLosLotes = loteRepository.findByActivoTrue();</span>
        
<span class="fc" id="L742">        List&lt;LoteSimpleDTO&gt; lotesElegibles = todosLosLotes.stream()</span>
<span class="fc" id="L743">                .filter(lote -&gt; esLoteElegibleParaTipoAnalisis(lote.getLoteID(), tipoAnalisis))</span>
<span class="fc" id="L744">                .map(this::mapearEntidadASimpleDTO)</span>
<span class="fc" id="L745">                .collect(Collectors.toList());</span>
        
<span class="fc" id="L747">        ResponseListadoLoteSimple respuesta = new ResponseListadoLoteSimple();</span>
<span class="fc" id="L748">        respuesta.setLotes(lotesElegibles);</span>
<span class="fc" id="L749">        return respuesta;</span>
    }
    
    
    public long contarAnalisisPendientes() {
<span class="fc" id="L754">        List&lt;Lote&gt; lotesActivos = loteRepository.findByActivoTrue();</span>
<span class="fc" id="L755">        long totalPendientes = 0;</span>
        
<span class="fc bfc" id="L757" title="All 2 branches covered.">        for (Lote lote : lotesActivos) {</span>
<span class="pc bpc" id="L758" title="1 of 2 branches missed.">            if (lote.getTiposAnalisisAsignados() == null) continue;</span>
            
<span class="fc bfc" id="L760" title="All 2 branches covered.">            for (TipoAnalisis tipo : lote.getTiposAnalisisAsignados()) {</span>
                
<span class="pc bpc" id="L762" title="1 of 6 branches missed.">                boolean pendiente = switch (tipo) {</span>
                    case PMS -&gt; {
                        
<span class="fc bfc" id="L765" title="All 2 branches covered.">                        if (!pmsRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L766">                            yield true;</span>
                        }
                        
<span class="fc" id="L769">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pms&gt; analisis = </span>
<span class="fc" id="L770">                            pmsRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="fc bfc" id="L771" title="All 2 branches covered.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case GERMINACION -&gt; {
<span class="fc bfc" id="L774" title="All 2 branches covered.">                        if (!germinacionRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L775">                            yield true;</span>
                        }
<span class="fc" id="L777">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Germinacion&gt; analisis = </span>
<span class="fc" id="L778">                            germinacionRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case DOSN -&gt; {
<span class="fc bfc" id="L782" title="All 2 branches covered.">                        if (!dosnRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L783">                            yield true;</span>
                        }
<span class="fc" id="L785">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Dosn&gt; analisis = </span>
<span class="fc" id="L786">                            dosnRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L787" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case TETRAZOLIO -&gt; {
<span class="fc bfc" id="L790" title="All 2 branches covered.">                        if (!tetrazolioRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L791">                            yield true;</span>
                        }
<span class="fc" id="L793">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Tetrazolio&gt; analisis = </span>
<span class="fc" id="L794">                            tetrazolioRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L795" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
                    case PUREZA -&gt; {
<span class="fc bfc" id="L798" title="All 2 branches covered.">                        if (!purezaRepository.existsByLoteLoteID(lote.getLoteID())) {</span>
<span class="fc" id="L799">                            yield true;</span>
                        }
<span class="fc" id="L801">                        List&lt;utec.proyectofinal.Proyecto.Final.UTEC.business.entities.Pureza&gt; analisis = </span>
<span class="fc" id="L802">                            purezaRepository.findByLoteLoteID(lote.getLoteID());</span>
<span class="pc bpc" id="L803" title="1 of 2 branches missed.">                        yield analisis.stream().allMatch(a -&gt; a.getEstado() == Estado.A_REPETIR);</span>
                    }
<span class="nc" id="L805">                    default -&gt; false;</span>
                };
                
<span class="fc bfc" id="L808" title="All 2 branches covered.">                if (pendiente) {</span>
<span class="fc" id="L809">                    totalPendientes++;</span>
                }
<span class="fc" id="L811">            }</span>
<span class="fc" id="L812">        }</span>
        
<span class="fc" id="L814">        return totalPendientes;</span>
    }
    
    
    public java.util.Map&lt;String, Long&gt; obtenerEstadisticasLotes() {
<span class="fc" id="L819">        long total = loteRepository.count();</span>
<span class="fc" id="L820">        long activos = loteRepository.countLotesActivos();</span>
<span class="fc" id="L821">        long inactivos = loteRepository.countLotesInactivos();</span>
        
<span class="fc" id="L823">        java.util.Map&lt;String, Long&gt; stats = new java.util.HashMap&lt;&gt;();</span>
<span class="fc" id="L824">        stats.put(&quot;total&quot;, total);</span>
<span class="fc" id="L825">        stats.put(&quot;activos&quot;, activos);</span>
<span class="fc" id="L826">        stats.put(&quot;inactivos&quot;, inactivos);</span>
        
<span class="fc" id="L828">        return stats;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>