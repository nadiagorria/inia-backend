<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReporteControllerIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in Proyecto-Final-UTEC Coverage Results</a> &gt; <a href="index.source.html" class="el_package">utec.proyectofinal.Proyecto.Final.UTEC.controllers</a> &gt; <span class="el_source">ReporteControllerIntegrationTest.java</span></div><h1>ReporteControllerIntegrationTest.java</h1><pre class="source lang-java linenums">package utec.proyectofinal.Proyecto.Final.UTEC.controllers;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;
import utec.proyectofinal.Proyecto.Final.UTEC.dtos.response.*;
import utec.proyectofinal.Proyecto.Final.UTEC.services.ReporteService;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.Map;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.when;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(ReporteController.class)
@DisplayName(&quot;Tests de integraci贸n para ReporteController&quot;)
<span class="fc" id="L26">class ReporteControllerIntegrationTest {</span>

    @Autowired
    private MockMvc mockMvc;

    @MockitoBean
    private ReporteService reporteService;

    private ReporteGeneralDTO reporteGeneralDTO;
    private ReporteGerminacionDTO reporteGerminacionDTO;
    private ReportePMSDTO reportePMSDTO;
    private ReportePurezaDTO reportePurezaDTO;
    private ReporteTetrazolioDTO reporteTetrazolioDTO;

    @BeforeEach
    void setUp() {
<span class="fc" id="L42">        Map&lt;String, Long&gt; analisisPorPeriodo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L43">        analisisPorPeriodo.put(&quot;2024-01&quot;, 10L);</span>
<span class="fc" id="L44">        analisisPorPeriodo.put(&quot;2024-02&quot;, 15L);</span>

<span class="fc" id="L46">        Map&lt;String, Long&gt; analisisPorEstado = new HashMap&lt;&gt;();</span>
<span class="fc" id="L47">        analisisPorEstado.put(&quot;APROBADO&quot;, 20L);</span>
<span class="fc" id="L48">        analisisPorEstado.put(&quot;EN_PROCESO&quot;, 5L);</span>

<span class="fc" id="L50">        Map&lt;String, Double&gt; porcentajeCompletitud = new HashMap&lt;&gt;();</span>
<span class="fc" id="L51">        porcentajeCompletitud.put(&quot;completitud&quot;, 80.0);</span>

<span class="fc" id="L53">        Map&lt;String, Long&gt; topAnalisisProblemas = new HashMap&lt;&gt;();</span>
<span class="fc" id="L54">        topAnalisisProblemas.put(&quot;Germinacion&quot;, 3L);</span>
<span class="fc" id="L55">        topAnalisisProblemas.put(&quot;PMS&quot;, 2L);</span>

<span class="fc" id="L57">        reporteGeneralDTO = new ReporteGeneralDTO(</span>
<span class="fc" id="L58">            25L,</span>
            analisisPorPeriodo,
            analisisPorEstado,
            porcentajeCompletitud,
<span class="fc" id="L62">            7.5,</span>
            topAnalisisProblemas
        );

<span class="fc" id="L66">        Map&lt;String, Double&gt; mediaGerminacionPorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L67">        mediaGerminacionPorEspecie.put(&quot;Trigo&quot;, 85.5);</span>
<span class="fc" id="L68">        mediaGerminacionPorEspecie.put(&quot;Cebada&quot;, 78.3);</span>

<span class="fc" id="L70">        Map&lt;String, Double&gt; tiempoPromedioPrimerConteo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L71">        tiempoPromedioPrimerConteo.put(&quot;Trigo&quot;, 5.0);</span>

<span class="fc" id="L73">        Map&lt;String, Double&gt; tiempoPromedioUltimoConteo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">        tiempoPromedioUltimoConteo.put(&quot;Trigo&quot;, 10.0);</span>

<span class="fc" id="L76">        reporteGerminacionDTO = new ReporteGerminacionDTO(</span>
            mediaGerminacionPorEspecie,
            tiempoPromedioPrimerConteo,
            tiempoPromedioUltimoConteo,
<span class="fc" id="L80">            15L</span>
        );

<span class="fc" id="L83">        reportePMSDTO = new ReportePMSDTO(</span>
<span class="fc" id="L84">            100L,</span>
<span class="fc" id="L85">            10L,</span>
<span class="fc" id="L86">            10.0,</span>
<span class="fc" id="L87">            5L,</span>
            new HashMap&lt;&gt;()
        );

<span class="fc" id="L91">        Map&lt;String, Long&gt; contaminantesPorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L92">        contaminantesPorEspecie.put(&quot;Trigo&quot;, 8L);</span>

<span class="fc" id="L94">        Map&lt;String, Double&gt; porcentajeMalezas = new HashMap&lt;&gt;();</span>
<span class="fc" id="L95">        porcentajeMalezas.put(&quot;Trigo&quot;, 2.5);</span>

<span class="fc" id="L97">        Map&lt;String, Double&gt; porcentajeOtrasSemillas = new HashMap&lt;&gt;();</span>
<span class="fc" id="L98">        porcentajeOtrasSemillas.put(&quot;Trigo&quot;, 1.5);</span>

<span class="fc" id="L100">        Map&lt;String, Double&gt; porcentajeCumpleEstandar = new HashMap&lt;&gt;();</span>
<span class="fc" id="L101">        porcentajeCumpleEstandar.put(&quot;Trigo&quot;, 90.0);</span>

<span class="fc" id="L103">        reportePurezaDTO = new ReportePurezaDTO(</span>
            contaminantesPorEspecie,
            porcentajeMalezas,
            porcentajeOtrasSemillas,
            porcentajeCumpleEstandar,
<span class="fc" id="L108">            100L</span>
        );

<span class="fc" id="L111">        Map&lt;String, Double&gt; mediaViabilidadIniaPorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L112">        mediaViabilidadIniaPorEspecie.put(&quot;Trigo&quot;, 88.0);</span>

<span class="fc" id="L114">        Map&lt;String, Double&gt; mediaViabilidadInasePorEspecie = new HashMap&lt;&gt;();</span>
<span class="fc" id="L115">        mediaViabilidadInasePorEspecie.put(&quot;Trigo&quot;, 90.0);</span>

<span class="fc" id="L117">        reporteTetrazolioDTO = new ReporteTetrazolioDTO(</span>
            mediaViabilidadIniaPorEspecie,
            mediaViabilidadInasePorEspecie,
<span class="fc" id="L120">            20L</span>
        );
<span class="fc" id="L122">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Obtener reporte general sin filtros&quot;)
    void obtenerReporteGeneral_sinFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L128">        when(reporteService.obtenerReporteGeneral(null, null)).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L130">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L131">                .with(csrf()))</span>
<span class="fc" id="L132">                .andExpect(status().isOk())</span>
<span class="fc" id="L133">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25))</span>
<span class="fc" id="L134">                .andExpect(jsonPath(&quot;$.tiempoMedioFinalizacion&quot;).value(7.5))</span>
<span class="fc" id="L135">                .andExpect(jsonPath(&quot;$.analisisPorEstado.APROBADO&quot;).value(20));</span>
<span class="fc" id="L136">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Obtener reporte general con filtros de fecha&quot;)
    void obtenerReporteGeneral_conFiltrosFecha_debeRetornarReporte() throws Exception {
<span class="fc" id="L142">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L143">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L145">        when(reporteService.obtenerReporteGeneral(fechaInicio, fechaFin)).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L147">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L148">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L149">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L150">                .with(csrf()))</span>
<span class="fc" id="L151">                .andExpect(status().isOk())</span>
<span class="fc" id="L152">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25));</span>
<span class="fc" id="L153">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/germinacion - Obtener reporte de germinaci贸n&quot;)
    void obtenerReporteGerminacion_debeRetornarReporte() throws Exception {
<span class="fc" id="L159">        when(reporteService.obtenerReporteGerminacion(null, null)).thenReturn(reporteGerminacionDTO);</span>

<span class="fc" id="L161">        mockMvc.perform(get(&quot;/api/reportes/germinacion&quot;)</span>
<span class="fc" id="L162">                .with(csrf()))</span>
<span class="fc" id="L163">                .andExpect(status().isOk())</span>
<span class="fc" id="L164">                .andExpect(jsonPath(&quot;$.totalGerminaciones&quot;).value(15))</span>
<span class="fc" id="L165">                .andExpect(jsonPath(&quot;$.mediaGerminacionPorEspecie.Trigo&quot;).value(85.5))</span>
<span class="fc" id="L166">                .andExpect(jsonPath(&quot;$.mediaGerminacionPorEspecie.Cebada&quot;).value(78.3));</span>
<span class="fc" id="L167">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/germinacion - Obtener reporte de germinaci贸n con filtros&quot;)
    void obtenerReporteGerminacion_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L173">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L174">        LocalDate fechaFin = LocalDate.of(2024, 6, 30);</span>

<span class="fc" id="L176">        when(reporteService.obtenerReporteGerminacion(fechaInicio, fechaFin)).thenReturn(reporteGerminacionDTO);</span>

<span class="fc" id="L178">        mockMvc.perform(get(&quot;/api/reportes/germinacion&quot;)</span>
<span class="fc" id="L179">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L180">                .param(&quot;fechaFin&quot;, &quot;2024-06-30&quot;)</span>
<span class="fc" id="L181">                .with(csrf()))</span>
<span class="fc" id="L182">                .andExpect(status().isOk())</span>
<span class="fc" id="L183">                .andExpect(jsonPath(&quot;$.totalGerminaciones&quot;).value(15));</span>
<span class="fc" id="L184">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/pms - Obtener reporte de PMS&quot;)
    void obtenerReportePms_debeRetornarReporte() throws Exception {
<span class="fc" id="L190">        when(reporteService.obtenerReportePms(null, null)).thenReturn(reportePMSDTO);</span>

<span class="fc" id="L192">        mockMvc.perform(get(&quot;/api/reportes/pms&quot;)</span>
<span class="fc" id="L193">                .with(csrf()))</span>
<span class="fc" id="L194">                .andExpect(status().isOk())</span>
<span class="fc" id="L195">                .andExpect(jsonPath(&quot;$.totalPms&quot;).value(100))</span>
<span class="fc" id="L196">                .andExpect(jsonPath(&quot;$.muestrasConCVSuperado&quot;).value(10))</span>
<span class="fc" id="L197">                .andExpect(jsonPath(&quot;$.porcentajeMuestrasConCVSuperado&quot;).value(10.0))</span>
<span class="fc" id="L198">                .andExpect(jsonPath(&quot;$.muestrasConRepeticionesMaximas&quot;).value(5));</span>
<span class="fc" id="L199">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/pms - Obtener reporte de PMS con filtros&quot;)
    void obtenerReportePms_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L205">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L206">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L208">        when(reporteService.obtenerReportePms(fechaInicio, fechaFin)).thenReturn(reportePMSDTO);</span>

<span class="fc" id="L210">        mockMvc.perform(get(&quot;/api/reportes/pms&quot;)</span>
<span class="fc" id="L211">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L212">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L213">                .with(csrf()))</span>
<span class="fc" id="L214">                .andExpect(status().isOk())</span>
<span class="fc" id="L215">                .andExpect(jsonPath(&quot;$.totalPms&quot;).value(100));</span>
<span class="fc" id="L216">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza - Obtener reporte de pureza&quot;)
    void obtenerReportePureza_debeRetornarReporte() throws Exception {
<span class="fc" id="L222">        when(reporteService.obtenerReportePureza(null, null)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L224">        mockMvc.perform(get(&quot;/api/reportes/pureza&quot;)</span>
<span class="fc" id="L225">                .with(csrf()))</span>
<span class="fc" id="L226">                .andExpect(status().isOk())</span>
<span class="fc" id="L227">                .andExpect(jsonPath(&quot;$.contaminantesPorEspecie.Trigo&quot;).value(8))</span>
<span class="fc" id="L228">                .andExpect(jsonPath(&quot;$.porcentajeMalezas.Trigo&quot;).value(2.5))</span>
<span class="fc" id="L229">                .andExpect(jsonPath(&quot;$.porcentajeOtrasSemillas.Trigo&quot;).value(1.5))</span>
<span class="fc" id="L230">                .andExpect(jsonPath(&quot;$.porcentajeCumpleEstandar.Trigo&quot;).value(90.0));</span>
<span class="fc" id="L231">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza - Obtener reporte de pureza con filtros&quot;)
    void obtenerReportePureza_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L237">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L238">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L240">        when(reporteService.obtenerReportePureza(fechaInicio, fechaFin)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L242">        mockMvc.perform(get(&quot;/api/reportes/pureza&quot;)</span>
<span class="fc" id="L243">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L244">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L245">                .with(csrf()))</span>
<span class="fc" id="L246">                .andExpect(status().isOk())</span>
<span class="fc" id="L247">                .andExpect(jsonPath(&quot;$.contaminantesPorEspecie.Trigo&quot;).value(8));</span>
<span class="fc" id="L248">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/tetrazolio - Obtener reporte de tetrazolio&quot;)
    void obtenerReporteTetrazolio_debeRetornarReporte() throws Exception {
<span class="fc" id="L254">        when(reporteService.obtenerReporteTetrazolio(null, null)).thenReturn(reporteTetrazolioDTO);</span>

<span class="fc" id="L256">        mockMvc.perform(get(&quot;/api/reportes/tetrazolio&quot;)</span>
<span class="fc" id="L257">                .with(csrf()))</span>
<span class="fc" id="L258">                .andExpect(status().isOk())</span>
<span class="fc" id="L259">                .andExpect(jsonPath(&quot;$.totalTetrazolios&quot;).value(20))</span>
<span class="fc" id="L260">                .andExpect(jsonPath(&quot;$.viabilidadIniaPorEspecie.Trigo&quot;).value(88.0))</span>
<span class="fc" id="L261">                .andExpect(jsonPath(&quot;$.viabilidadInasePorEspecie.Trigo&quot;).value(90.0));</span>
<span class="fc" id="L262">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/tetrazolio - Obtener reporte de tetrazolio con filtros&quot;)
    void obtenerReporteTetrazolio_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L268">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L269">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L271">        when(reporteService.obtenerReporteTetrazolio(fechaInicio, fechaFin)).thenReturn(reporteTetrazolioDTO);</span>

<span class="fc" id="L273">        mockMvc.perform(get(&quot;/api/reportes/tetrazolio&quot;)</span>
<span class="fc" id="L274">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L275">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L276">                .with(csrf()))</span>
<span class="fc" id="L277">                .andExpect(status().isOk())</span>
<span class="fc" id="L278">                .andExpect(jsonPath(&quot;$.totalTetrazolios&quot;).value(20));</span>
<span class="fc" id="L279">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn - Obtener reporte de DOSN&quot;)
    void obtenerReporteDosn_debeRetornarReporte() throws Exception {
<span class="fc" id="L285">        when(reporteService.obtenerReporteDosn(null, null)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L287">        mockMvc.perform(get(&quot;/api/reportes/dosn&quot;)</span>
<span class="fc" id="L288">                .with(csrf()))</span>
<span class="fc" id="L289">                .andExpect(status().isOk())</span>
<span class="fc" id="L290">                .andExpect(jsonPath(&quot;$.contaminantesPorEspecie.Trigo&quot;).value(8));</span>
<span class="fc" id="L291">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn - Obtener reporte de DOSN con filtros&quot;)
    void obtenerReporteDosn_conFiltros_debeRetornarReporte() throws Exception {
<span class="fc" id="L297">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L298">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L300">        when(reporteService.obtenerReporteDosn(fechaInicio, fechaFin)).thenReturn(reportePurezaDTO);</span>

<span class="fc" id="L302">        mockMvc.perform(get(&quot;/api/reportes/dosn&quot;)</span>
<span class="fc" id="L303">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L304">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L305">                .with(csrf()))</span>
<span class="fc" id="L306">                .andExpect(status().isOk())</span>
<span class="fc" id="L307">                .andExpect(jsonPath(&quot;$.porcentajeMalezas.Trigo&quot;).value(2.5));</span>
<span class="fc" id="L308">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza/contaminantes/{especie} - Obtener contaminantes de pureza por especie&quot;)
    void obtenerContaminantesPureza_debeRetornarMapa() throws Exception {
<span class="fc" id="L314">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L315">        contaminantes.put(&quot;Malezas&quot;, 2.5);</span>
<span class="fc" id="L316">        contaminantes.put(&quot;OtrasSemillas&quot;, 1.5);</span>

<span class="fc" id="L318">        when(reporteService.obtenerContaminantesPorEspeciePureza(eq(&quot;Trigo&quot;), isNull(), isNull())).thenReturn(contaminantes);</span>

<span class="fc" id="L320">        mockMvc.perform(get(&quot;/api/reportes/pureza/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L321">                .with(csrf()))</span>
<span class="fc" id="L322">                .andExpect(status().isOk())</span>
<span class="fc" id="L323">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(2.5))</span>
<span class="fc" id="L324">                .andExpect(jsonPath(&quot;$.OtrasSemillas&quot;).value(1.5));</span>
<span class="fc" id="L325">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/pureza/contaminantes/{especie} - Obtener contaminantes de pureza por especie con filtros&quot;)
    void obtenerContaminantesPureza_conFiltros_debeRetornarMapa() throws Exception {
<span class="fc" id="L331">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L332">        contaminantes.put(&quot;Malezas&quot;, 3.0);</span>
<span class="fc" id="L333">        contaminantes.put(&quot;OtrasSemillas&quot;, 2.0);</span>

<span class="fc" id="L335">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L336">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L338">        when(reporteService.obtenerContaminantesPorEspeciePureza(eq(&quot;Trigo&quot;), eq(fechaInicio), eq(fechaFin))).thenReturn(contaminantes);</span>

<span class="fc" id="L340">        mockMvc.perform(get(&quot;/api/reportes/pureza/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L341">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L342">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L343">                .with(csrf()))</span>
<span class="fc" id="L344">                .andExpect(status().isOk())</span>
<span class="fc" id="L345">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(3.0));</span>
<span class="fc" id="L346">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn/contaminantes/{especie} - Obtener contaminantes de DOSN por especie&quot;)
    void obtenerContaminantesDosn_debeRetornarMapa() throws Exception {
<span class="fc" id="L352">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L353">        contaminantes.put(&quot;Malezas&quot;, 1.8);</span>
<span class="fc" id="L354">        contaminantes.put(&quot;OtrasSemillas&quot;, 1.2);</span>

<span class="fc" id="L356">        when(reporteService.obtenerContaminantesPorEspecieDosn(eq(&quot;Trigo&quot;), isNull(), isNull())).thenReturn(contaminantes);</span>

<span class="fc" id="L358">        mockMvc.perform(get(&quot;/api/reportes/dosn/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L359">                .with(csrf()))</span>
<span class="fc" id="L360">                .andExpect(status().isOk())</span>
<span class="fc" id="L361">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(1.8))</span>
<span class="fc" id="L362">                .andExpect(jsonPath(&quot;$.OtrasSemillas&quot;).value(1.2));</span>
<span class="fc" id="L363">    }</span>

    @Test
    @WithMockUser(roles = &quot;ANALISTA&quot;)
    @DisplayName(&quot;GET /api/reportes/dosn/contaminantes/{especie} - Obtener contaminantes de DOSN por especie con filtros&quot;)
    void obtenerContaminantesDosn_conFiltros_debeRetornarMapa() throws Exception {
<span class="fc" id="L369">        Map&lt;String, Double&gt; contaminantes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L370">        contaminantes.put(&quot;Malezas&quot;, 2.2);</span>
<span class="fc" id="L371">        contaminantes.put(&quot;OtrasSemillas&quot;, 1.8);</span>

<span class="fc" id="L373">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>
<span class="fc" id="L374">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L376">        when(reporteService.obtenerContaminantesPorEspecieDosn(eq(&quot;Trigo&quot;), eq(fechaInicio), eq(fechaFin))).thenReturn(contaminantes);</span>

<span class="fc" id="L378">        mockMvc.perform(get(&quot;/api/reportes/dosn/contaminantes/Trigo&quot;)</span>
<span class="fc" id="L379">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L380">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L381">                .with(csrf()))</span>
<span class="fc" id="L382">                .andExpect(status().isOk())</span>
<span class="fc" id="L383">                .andExpect(jsonPath(&quot;$.Malezas&quot;).value(2.2));</span>
<span class="fc" id="L384">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Observador puede ver reportes&quot;)
    void obtenerReporteGeneral_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L390">        when(reporteService.obtenerReporteGeneral(null, null)).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L392">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L393">                .with(csrf()))</span>
<span class="fc" id="L394">                .andExpect(status().isOk());</span>
<span class="fc" id="L395">    }</span>

    @Test
    @WithMockUser(roles = &quot;OBSERVADOR&quot;)
    @DisplayName(&quot;GET /api/reportes/germinacion - Observador puede ver reportes de germinaci贸n&quot;)
    void obtenerReporteGerminacion_conRolObservador_debeRetornarOk() throws Exception {
<span class="fc" id="L401">        when(reporteService.obtenerReporteGerminacion(null, null)).thenReturn(reporteGerminacionDTO);</span>

<span class="fc" id="L403">        mockMvc.perform(get(&quot;/api/reportes/germinacion&quot;)</span>
<span class="fc" id="L404">                .with(csrf()))</span>
<span class="fc" id="L405">                .andExpect(status().isOk());</span>
<span class="fc" id="L406">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Solo fechaInicio especificada&quot;)
    void obtenerReporteGeneral_soloFechaInicio_debeRetornarReporte() throws Exception {
<span class="fc" id="L412">        LocalDate fechaInicio = LocalDate.of(2024, 1, 1);</span>

<span class="fc" id="L414">        when(reporteService.obtenerReporteGeneral(eq(fechaInicio), isNull())).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L416">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L417">                .param(&quot;fechaInicio&quot;, &quot;2024-01-01&quot;)</span>
<span class="fc" id="L418">                .with(csrf()))</span>
<span class="fc" id="L419">                .andExpect(status().isOk())</span>
<span class="fc" id="L420">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25));</span>
<span class="fc" id="L421">    }</span>

    @Test
    @WithMockUser(roles = &quot;ADMIN&quot;)
    @DisplayName(&quot;GET /api/reportes/general - Solo fechaFin especificada&quot;)
    void obtenerReporteGeneral_soloFechaFin_debeRetornarReporte() throws Exception {
<span class="fc" id="L427">        LocalDate fechaFin = LocalDate.of(2024, 12, 31);</span>

<span class="fc" id="L429">        when(reporteService.obtenerReporteGeneral(isNull(), eq(fechaFin))).thenReturn(reporteGeneralDTO);</span>

<span class="fc" id="L431">        mockMvc.perform(get(&quot;/api/reportes/general&quot;)</span>
<span class="fc" id="L432">                .param(&quot;fechaFin&quot;, &quot;2024-12-31&quot;)</span>
<span class="fc" id="L433">                .with(csrf()))</span>
<span class="fc" id="L434">                .andExpect(status().isOk())</span>
<span class="fc" id="L435">                .andExpect(jsonPath(&quot;$.totalAnalisis&quot;).value(25));</span>
<span class="fc" id="L436">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>